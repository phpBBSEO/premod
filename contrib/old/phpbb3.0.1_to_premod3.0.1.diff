Index: language/en/install.php
===================================================================
--- language/en/install.php	(revision 159)
+++ language/en/install.php	(revision 161)
@@ -79,7 +79,7 @@
 	'CONTINUE_OLD_CONVERSION'	=> 'Continue previously started conversion',
 	'CONVERT'					=> 'Convert',
 	'CONVERT_COMPLETE'			=> 'Conversion completed',
-	'CONVERT_COMPLETE_EXPLAIN'	=> 'You have now successfully converted your board to phpBB 3.0. You can now login and <a href="../">access your board</a>. Please ensure that the settings were transferred correctly before enabling your board by deleting the install directory. Remember that help on using phpBB is available online via the <a href="http://www.phpbb.com/support/documentation/3.0/">Documentation</a> and the <a href="http://www.phpbb.com/community/viewforum.php?f=46">support forums</a>.',
+	'CONVERT_COMPLETE_EXPLAIN'	=> 'You have now successfully converted your board to phpBB 3.0. You can now login and <a href="../">access your board</a>. Please ensure that the settings were transferred correctly before enabling your board by deleting the install directory. Remember that help on using phpBB is available online via the <a href="http://www.phpbb.com/support/documentation/3.0/">Documentation</a> and the <a href="http://www.phpbb-seo.com/boards/phpbb-seo-premod-vf61/">support forums</a>.',
 	'CONVERT_INTRO'				=> 'Welcome to the phpBB Unified Convertor Framework',
 	'CONVERT_INTRO_BODY'		=> 'From here, you are able to import data from other (installed) board systems. The list below shows all the conversion modules currently available. If there is no convertor shown in this list for the board software you wish to convert from, please check our website where further conversion modules may be available for download.',
 	'CONVERT_NEW_CONVERSION'	=> 'New conversion',
@@ -188,10 +188,10 @@
 		<h2>Convert an existing board to phpBB3</h2>
 		<p>The phpBB Unified Convertor Framework supports the conversion of phpBB 2.0.x and other board systems to phpBB3. If you have an existing board that you wish to convert, please <a href="%2$s">proceed on to the convertor</a>.</p>
 		<h2>Go live with your phpBB3!</h2>
-		<p>Clicking the button below will take you to your Administration Control Panel (ACP). Take some time to examine the options available to you. Remember that help is available online via the <a href="http://www.phpbb.com/support/documentation/3.0/">Documentation</a> and the <a href="http://www.phpbb.com/community/viewforum.php?f=46">support forums</a>, see the <a href="%3$s">README</a> for further information.</p><p><strong>Please now delete, move or rename the install directory before you use your board. If this directory is still present, only the Administration Control Panel (ACP) will be accessible.</strong></p>',
+		<p>Clicking the button below will take you to your Administration Control Panel (ACP). Take some time to examine the options available to you. Remember that help is available online via the <a href="http://www.phpbb.com/support/documentation/3.0/">Documentation</a> and the <a href="http://www.phpbb-seo.com/boards/phpbb-seo-premod-vf61/">support forums</a>, see the <a href="%3$s">README</a> for further information.</p><p><strong>Please now delete, move or rename the install directory before you use your board. If this directory is still present, only the Administration Control Panel (ACP) will be accessible.</strong></p>',
 	'INSTALL_INTRO'				=> 'Welcome to Installation',
 
-	'INSTALL_INTRO_BODY'		=> 'With this option, it is possible to install phpBB3 onto your server.</p><p>In order to proceed, you will need your database settings. If you do not know your database settings, please contact your host and ask for them. You will not be able to continue without them. You need:</p>
+	'INSTALL_INTRO_BODY'		=> 'With this option, it is possible to install the phpBB SEO premod onto your server.</p><p>In order to proceed, you will need your database settings. If you do not know your database settings, please contact your host and ask for them. You will not be able to continue without them. You need:</p>
 
 	<ul>
 		<li>The Database Type - the database you will be using.</li>
@@ -453,7 +453,7 @@
 	'NO_ERRORS'						=> 'No errors',
 	'NO_UPDATE_FILES'				=> 'Not updating the following files',
 	'NO_UPDATE_FILES_EXPLAIN'		=> 'The following files are new or modified but the directory they normally reside in could not be found on your installation. If this list contains files to other directories than language/ or styles/ than you may have modified your directory structure and the update may be incomplete.',
-	'NO_UPDATE_FILES_OUTDATED'		=> 'No valid update directory was found, please make sure you uploaded the relevant files.<br /><br />Your installation does <strong>not</strong> seem to be up to date. Updates are available for your version of phpBB %1$s, please visit <a href="http://www.phpbb.com/downloads/" rel="external">http://www.phpbb.com/downloads/</a> to obtain the correct package to update from Version %2$s to Version %3$s.',
+	'NO_UPDATE_FILES_OUTDATED'		=> 'No valid update directory was found, please make sure you uploaded the relevant files.<br /><br />Your installation does <strong>not</strong> seem to be up to date. Updates are available for your version of phpBB %1$s, please visit <a href="http://www.phpbb-seo.com/boards/phpbb-seo-premod-vf61/" rel="external">http://www.phpbb-seo.com/boards/phpbb-seo-premod-vf61/</a> to obtain the correct package to update from Version %2$s to Version %3$s.',
 	'NO_UPDATE_FILES_UP_TO_DATE'	=> 'Your version is up to date. There is no need to run the update tool. If you want to make an integrity check on your files make sure you uploaded the correct update files.',
 	'NO_UPDATE_INFO'				=> 'Update file information could not be found.',
 	'NO_UPDATES_REQUIRED'			=> 'No updates required',
@@ -519,7 +519,7 @@
 		<p>The recommended way of updating your installation listed here is only valid for the automatic update package. You are also able to update your installation using the methods listed within the INSTALL.html document. The steps for updating phpBB3 automatically are:</p>
 
 		<ul style="margin-left: 20px; font-size: 1.1em;">
-			<li>Go to the <a href="http://www.phpbb.com/downloads/" title="http://www.phpbb.com/downloads/">phpBB.com downloads page</a> and download the "Automatic Update Package" archive.<br /><br /></li>
+			<li>Go to the <a href="http://www.phpbb-seo.com/boards/phpbb-seo-premod-vf61/" title="http://www.phpbb-seo.com/boards/phpbb-seo-premod-vf61/">support forum</a> and download the "Automatic Update Package" archive.<br /><br /></li>
 			<li>Unpack the archive.<br /><br /></li>
 			<li>Upload the complete uncompressed install folder to your phpBB root directory (where your config.php file is).<br /><br /></li>
 		</ul>
Index: language/en/acp/phpbb_seo.php
===================================================================
--- language/en/acp/phpbb_seo.php	(revision 0)
+++ language/en/acp/phpbb_seo.php	(revision 161)
@@ -0,0 +1,209 @@
+<?php
+/** 
+*
+* phpbb_seo [English]
+*
+* @package phpbb_seo
+* @version $Id: phpbb_seo.php, 2007/08/30 13:48:48 fds Exp $
+* @copyright (c) 2007 phpBB SEO
+*
+*/
+/**
+* DO NOT CHANGE
+*/
+if (empty($lang) || !is_array($lang))
+{
+	$lang = array();
+}
+// DEVELOPERS PLEASE NOTE
+//
+// All language files should use UTF-8 as their encoding and the files must not contain a BOM.
+//
+// Placeholders can now contain order information, e.g. instead of
+// 'Page %s of %s' you can (and should) write 'Page %1$s of %2$s', this allows
+// translators to re-order the output of data while ensuring it remains correct
+//
+// You do not need this where single placeholders are used, e.g. 'Message %d' is fine
+// equally where a string contains only two placeholders which are used to wrap text
+// in a url you again do not need to specify an order e.g., 'Click %sHERE%s' is fine
+$lang = array_merge($lang, array(
+	// ACP Main CAT
+	'ACP_CAT_PHPBB_SEO'	=> 'phpBB SEO',
+	'ACP_MOD_REWRITE'	=> 'URL Rewriting settings',
+	// ACP sub Cat
+	'ACP_PHPBB_SEO_CLASS'	=> 'phpBB SEO Class settings',
+	'ACP_PHPBB_SEO_CLASS_EXPLAIN'	=> 'You can here set up various options of the phpBB SEO mod rewrite.<br/>The various default settings such as the delimiters and suffixes still must be set up in phpbb_seo_class.php, since changing these implies an .htaccess update and most likely appropriate redirections.%s',
+	'ACP_PHPBB_SEO_VERSION' => 'Version',
+	'ACP_SEO_SUPPORT_FORUM' => 'Support Forum',
+	// ACP sub Cat
+	'ACP_FORUM_URL'	=> 'Forum URL Management',
+	'ACP_FORUM_URL_EXPLAIN'		=> 'You can here see what\'s in the cache file containing the forum title to inject in their URLs.<br/>Forum in green colors are cached, the one in red are not yet.<br/><br/><b style="color:red">Please Note</b><ul><b>any-title-fxx/</b> will always be properly redirected with the Zero Duplicate but it won\'t be the case if you edit <b>any-title/</b> to <b>something-else/</b>.<br/> In such case, <b>any-title/</b> will for now be treated as a forum that does not exist if you do not set appropriate redirections.</ul>',
+	'ACP_NO_FORUM_URL'	=> '<b>Forum URL Management disabled<b><br/>The forum URL management is only available in advanced and Mixed mode and when Forum URL caching is activated.<br/>Forum URLs already configured will stay active in advanced and Mixed mode.',
+	// ACP sub Cat
+	'ACP_HTACCESS'	=> '.htaccess',
+	'ACP_HTACCESS_EXPLAIN'	=> 'This tool will help you out building your .htacess.<br/>The version proposed bellow is based on your phpbb_seo/phpbb_seo_class.php settings.<br/>You can edit the $seo_ext and $seo_static values before you install the .htaccess to get personalized URLs.<br/>You can for example choose to use .htm instead of .html, \'message\' instead of \'post\' \'mysite-team\' instead of \'the-team\' and so on.<br/>If you edit these while they where already indexed in SE, you\'ll need personalized redirections.<br/>The default settings are not bad at all, you can skip this step without worries if you prefer.<br/>It\'s though the best time to do it, doing it after a while will require some personalized redirections.<br/>By default the following .htaccess shall be uploaded in the domain\'s root (eg where www.example.com is linked).<br/>If phpBB is installed in a sub folder, hitting the more option below will add an option to upload it in the phpBB folder instead.',
+	'SEO_HTACCESS_RBASE'	=> '.htaccess location',
+	'SEO_HTACCESS_RBASE_EXPLAIN' => 'Put the .htaccess in the phpBB folder ?<br/>The RewriteBase setting allow to put the forum\'s .htaccess in it\'s folder. It\'s usually more convenient to put the .htaccess in the domain\'s root folder even when phpBB is installed in a sub-folder, but you may prefer to put it in the forum folder instead.',
+	'SEO_HTACCESS_SLASH'	=> 'RegEx Right Slash',
+	'SEO_HTACCESS_SLASH_EXPLAIN'	=> 'Depending on the specific host you are using, you might have to get rid of or add the slash ("/") at the beginning of the right part of each rewriterules. This particular slash is used by default when .htaccess are located at the root level. It\'s the contrary for when phpBB would be installed in a sub-folder and you\'d want to use an .htaccess in the same folder.<br/>Default settings should generally work, but if it\'s not the case, try regenerating an .htaccess by hitting the "Re-generate" button.',
+	'SEO_HTACCESS_WSLASH'	=> 'RegEx Left Slash',
+	'SEO_HTACCESS_WSLASH_EXPLAIN'	=> 'Depending on the specific host you are using, you might have to add a slash ("/") at the beginning of the left part of each rewriterules. This particular slash ("/") is never used by default.<br/>Default settings should generally work, but if it\'s not the case, try regenerating an .htaccess by hitting the "Re-generate" button.',
+	'SEO_MORE_OPTION'	=> 'More Options',
+	'SEO_MORE_OPTION_EXPLAIN' => 'If the first suggested .htaccess does not work.<br/>First make sure mod_rewrite is activated on your server.<br/>Then, make sure you uploaded it in the right folder, and that another one is not perturbing.<br/>If not enough, hit the "more option" button.',
+	'SEO_HTACCESS_SAVE' => 'Save the .htaccess',
+	'SEO_HTACCESS_SAVE_EXPLAIN' => 'If checked, an .htaccess files will be generated upon submit in the phpbb_seo/cache/ folder. It\'s ready to go with your last settings, bou will still have to move it in the right place.',
+	'SEO_HTACCESS_ROOT_MSG'	=> 'Once you are ready, you can select the .htaccess code, and paste it in a .htaccess file or use the "Save .htaccess" option bellow.<br/> This .htaccess is meant to be used in the domain\'s root folder (eg : in the folder where www.example.com/ is installed).',
+	'SEO_HTACCESS_FOLDER_MSG' => 'Once you are ready, you can select the .htaccess code, and paste it in a .htaccess file or use the "Save .htaccess" option bellow.<br/> This .htaccess is meant to be used in the phpBB folder (eg : in the folder where phpBB is installed www.example.com/phpbb/).',
+	'SEO_HTACCESS_CAPTION' => 'Caption',
+	'SEO_HTACCESS_CAPTION_COMMENT' => 'Comments',
+	'SEO_HTACCESS_CAPTION_STATIC' => 'Static parts, editable in phpbb_seo_class.php',
+	'SEO_HTACCESS_CAPTION_DELIM' => 'Delimiters, editable in phpbb_seo_class.php',
+	'SEO_HTACCESS_CAPTION_SUFFIX' => 'Suffixes, editable in phpbb_seo_class.php',
+	'SEO_HTACCESS_CAPTION_SLASH' => 'Optional slashes',
+	'SEO_SLASH_DEFAULT'	=> 'Default',
+	'SEO_SLASH_ALT'		=> 'Alternate',
+	'SEO_MOD_TYPE_ER'	=> 'The mod rewrite type is not set up properly in phpbb_seo/phpbb_seo_class.php.', 
+	'SEO_SHOW'		=> 'Show',
+	'SEO_HIDE'		=> 'Hide',
+	'SEO_SELECT_ALL'	=> 'Select all',
+	// Install
+	'SEO_INSTALL_PANEL'	=> 'phpBB SEO Installation Panel',
+	'SEO_ERROR_INSTALL'	=> 'An error occured during the installtion process. Uninstall once is safer before you retry.',
+	'SEO_ERROR_INSTALLED'	=> 'The %s module is already installed.',
+	'SEO_ERROR_ID'	=> 'The %1$ moldule had no ID.',
+	'SEO_ERROR_UNINSTALLED'	=> 'The %s module is already uninstalled.',
+	'SEO_ERROR_INFO'	=> 'Information :',
+	'SEO_FINAL_INSTALL_PHPBB_SEO'	=> 'Login to ACP',
+	'SEO_FINAL_UNINSTALL_PHPBB_SEO'	=> 'Return to forum index',
+	'CAT_INSTALL_PHPBB_SEO'	=> 'Installation',
+	'CAT_UNINSTALL_PHPBB_SEO'	=> 'Un-Installation',
+	'SEO_OVERVIEW_TITLE'	=> 'phpBB SEO Mod rewrite Overview',
+	'SEO_OVERVIEW_BODY'	=> 'Welcome to our public release candidate of the %1$s phpBB3 SEO mod rewrite %2$s.</p><p>Please read <a href="%3$s" title="Check the release thread" target="_phpBBSEO"><b>the release thread</b></a> for more information</p><p><strong style="text-transform: uppercase;">Note:</strong> You must have already perfomed the required code changes and uploaded all the new files before you can proceed with this install wizard.</p><p>This installation system will guide you through the process of installing the phpBB3 SEO mod rewrite admin control panel. It will allow you to accurately chose your phpBB rewritten URL standard for the best results in search engines</p>.',
+	'CAT_SEO_PREMOD'	=> 'phpBB SEO Premod',
+	'SEO_PREMOD_TITLE'	=> 'phpBB SEO Premod overview',
+	'SEO_PREMOD_BODY'	=> 'Welcome to our public release candidate of the phpBB SEO Premod.</p><p>Please read <a href="http://www.phpbb-seo.com/boards/phpbb-seo-premod/seo-url-premod-vt1549.html" title="Check the release thread" target="_phpBBSEO"><b>the release thread</b></a> for more information</p><p><strong style="text-transform: uppercase;">Note:</strong> You will be able to chose between the three phpBB3 SEO mod rewrites.<br/><br/><b>The three different URL rewriting standards available :</b><ul><li><a href="http://www.phpbb-seo.com/boards/simple-seo-url/simple-phpbb3-seo-url-vt1566.html" title="More details about the Simple mod"><b>The Simple mod</b></a>,</li><li><a href="http://www.phpbb-seo.com/boards/mixed-seo-url/mixed-phpbb3-seo-url-vt1565.html" title="More details about the Mixed mod"><b>The Mixed mod</b></a>,</li><li><a href="http://www.phpbb-seo.com/boards/advanced-seo-url/advanced-phpbb3-seo-url-vt1219.html" title="More details about the Advanced mod"><b>Advanced</b></a>.</li></ul>This choice is very important, we encourage you to take the time to fully discover the SEO features of this premod before you go online.<br/>This premod is as simple to install as phpBB3, just follow the regular process.<br/><br/>
+	<p>Requirements for URL rewriting :</p>
+	<ul>
+		<li>Apache server (linux OS) with mod_rewrite module.</li>
+		<li>IIS server (windows OS) with isapi_rewrite module, but you will need to adapt the rewriterules in the httpd.ini</li>
+	</ul>
+	<p>Once installed, you will need to go to the ACP to set up and activate the mod.</p>',
+	'SEO_LICENCE_TITLE'	=> 'RECIPROCAL PUBLIC LICENSE',
+	'SEO_LICENCE_BODY'	=> 'The phpBB SEO mod rewrites are released under the RPL licence which states you cannot remove the phpBB SEO credits.<br/>For more details about possible exceptions, please contact a phpBB SEO administrator (primarily SeO or dcz).',
+	'SEO_PREMOD_LICENCE'	=> 'The phpBB SEO mod rewrites and the Zero duplicate included in this Premod are released under the RPL licence which states you cannot remove the phpBB SEO credits.<br/>For more details about possible exceptions, please contact a phpBB SEO administrator (primarily SeO or dcz).',
+	'SEO_SUPPORT_TITLE'	=> 'Support',
+	'SEO_SUPPORT_BODY'	=> 'Full support will be given in the <a href="%1$s" title="Visit the %2$s SEO URL forum" target="_phpBBSEO"><b>%2$s SEO URL forum</b></a>. We will provide answers to general setup questions, configuration problems, and support for determining common problems.</p><p>Be sure to visit our <a href="http://www.phpbb-seo.com/boards/" title="SEO Forum" target="_phpBBSEO"><b>Search Engine Optimization forums</b></a>.</p><p>You should <a href="http://www.phpbb-seo.com/boards/profile.php?mode=register" title="Register to phpBB SEO" target="_phpBBSEO"><b>register</b></a>, log in and <a href="%3$s" title="Be notified about updates" target="_phpBBSEO"><b>subscribe to the release thread</b></a> to be notified by mail upon each update.',
+	'SEO_PREMOD_SUPPORT_BODY'	=> 'Full support will be given in the <a href="http://www.phpbb-seo.com/boards/phpbb-seo-premod-vf61/" title="Visit the phpBB SEO Premod forum" target="_phpBBSEO"><b>phpBB SEO Premod forum</b></a>. We will provide answers to general setup questions, configuration problems, and support for determining common problems.</p><p>Be sure to visit our <a href="http://www.phpbb-seo.com/boards/" title="SEO Forum" target="_phpBBSEO"><b>Search Engine Optimization forums</b></a>.</p><p>You should <a href="http://www.phpbb-seo.com/boards/profile.php?mode=register" title="Register to phpBB SEO" target="_phpBBSEO"><b>register</b></a>, log in and <a href="http://www.phpbb-seo.com/boards/viewtopic.php?t=1549&watch=topic" title="Be notified about updates" target="_phpBBSEO"><b>subscribe to the release thread</b></a> to be notified by mail upon each update.',
+	'SEO_INSTALL_INTRO'		=> 'Welcome to the phpBB SEO Installation Wizard',
+	'SEO_INSTALL_INTRO_BODY'	=> '<p>You are about to install the %1$s phpBB SEO mod rewrite %2$s. This install tool will activate the phpBB SEO mod rewrite control panel in phpBB ACP.</p><p>Once installed, you will need to go to the ACP to set up and activate the mod.</p>
+	<p><strong>Note:</strong> If it\'s the first time you try this mod, we strongly encourage you to take the time to test the various url standard this mod can output on a local or private test serveur. This way, you won\'t show different URL to bots every other day while testing. And you won\'t discover a month after that you would have prefered different URLs. Patience is virtue SEO wise and even if the zero duplicate makes the HTTP redirecting very easy, you don\'t want to redirect all your forum\'s URL too often.</p><br/>
+	<p>Requirements :</p>
+	<ul>
+		<li>Apache server (linux OS) with mod_rewrite module.</li>
+		<li>IIS server (windows OS) with isapi_rewrite module, but you will need to adapt the rewriterules in the httpd.ini</li>
+	</ul>',
+	'SEO_INSTALL'		=> 'Install',
+	'UN_SEO_INSTALL_INTRO'		=> 'Welcome to the phpBB SEO uninstall Wizard',
+	'UN_SEO_INSTALL_INTRO_BODY'	=> '<p>You are about to uninstall the %1$s phpBB SEO mod rewrite %2$s ACP module.</p>
+	<p><strong>Note:</strong> This will not desactivate URL rewriting on your board as long as the phpBB files are still modded.</p>',
+	'UN_SEO_INSTALL'		=> 'Uninstall',
+	'SEO_INSTALL_CONGRATS'			=> 'Congratulations!',
+	'SEO_INSTALL_CONGRATS_EXPLAIN'	=> '<p>You have now successfully installed the %1$s phpBB3 SEO mod rewrite %2$s. You should now go to phpBB ACP and proceed with the mod rewrite settings.<p>
+	<p>In the new phpBB SEO category, you will be able to :</p>
+	<h2>Set up and activate URL rewriting</h2>
+		<p>Take your time, that\'s where you will chose how your URLs will look like. The zero duplicate options will as well be set up from here when installed.</p>
+	<h2>Accurately chose your forum\'s URL</h2>
+		<p>Using the Mixed or the Advanced mod, you will be able to dissociate Forum URLs from their titles and elect to use whatever keyword you may like in them</p>
+	<h2>Generate a personalized .htaccess</h2>
+	<p>Once you will have set up the above options, you will be able to generate a personalized .htaccess within no time and save it directly on the server.</p>',
+	'UN_SEO_INSTALL_CONGRATS'	=> 'The phpBB SEO ACP module was removed.',
+	'UN_SEO_INSTALL_CONGRATS_EXPLAIN'	=> '<p>You have now successfully uninstalled the %1$s phpBB3 SEO mod rewrite %2$s.<p>
+	<p>This will not desactivate URL rewriting on your board as long as the phpBB files are still modded.</p>',
+	'SEO_VALIDATE_INFO'	=> 'Validation Info :',
+	// Security
+	'SEO_LOGIN'		=> 'The board requires you to be registered and logged in to view this page.',
+	'SEO_LOGIN_ADMIN'	=> 'The board requires you to be logged in as admin to view this page.<br/>Your session has been destroyed for security purposes.',
+	'SEO_LOGIN_FOUNDER'	=> 'The board requires you to be logged in as the founder to view this page.',
+	'SEO_LOGIN_SESSION'	=> 'Session Check failed.<br/>The Settings were not altered.<br/>Your session has been destroyed for security purposes.',
+	// Cache status
+	'SEO_CACHE_FILE_TITLE'	=> 'Cache file status',
+	'SEO_CACHE_STATUS'	=> 'The cache folder configured is : <b>%s</b>',
+	'SEO_CACHE_FOUND'	=> 'The cache folder was successfully found.',
+	'SEO_CACHE_NOT_FOUND'	=> 'The cache folder was not found.',
+	'SEO_CACHE_WRITABLE'	=> 'The cache folder is writable.',
+	'SEO_CACHE_UNWRITABLE'	=> 'The cache folder is unwritable. You need to CHMOD it to 0777.',
+	'SEO_CACHE_FORUM_NAME'	=> 'Forum name',
+	'SEO_CACHE_URL_OK'	=> 'URL Cached',
+	'SEO_CACHE_URL_NOT_OK'	=> 'This Forum URL is not cached',
+	'SEO_CACHE_URL'		=> 'Final URL',
+	'SEO_CACHE_MSG_OK'	=> 'The cache file was updated successfully.',
+	'SEO_CACHE_MSG_FAIL'	=> 'An error occurred while updating the cache file.',
+	'SEO_CACHE_UPDATE_FAIL'	=> 'The URL you entered cannot be used, the cache was left untouched.',
+	// Seo advices
+	'SEO_ADVICE_DUPE'	=> 'A duplicate entry in title was detected for a forum URL : <b>%1$s</b>.<br/>It will stay unchanged until you update it.',
+	'SEO_ADVICE_RESERVED'	=> 'A reserved (used by other urls, such as members profiles and such) entry in title was detected for a forum URL : <b>%1$s</b>.<br/>It will stay unchanged until you update it.',
+	'SEO_ADVICE_LENGTH'	=> 'The URL cached is a bit too long.<br/>Consider using a smaller one',
+	'SEO_ADVICE_DELIM'	=> 'The URL cached contains the SEO delimiter and ID.<br/>Consider setting up an original one.',
+	'SEO_ADVICE_WORDS'	=> 'The URL cached contains a bit too many words.<br/>Consider setting up an better one.',
+	'SEO_ADVICE_DEFAULT'	=> 'The ending URL, after formatting, is the default.<br/>Consider setting up an original one.',
+	'SEO_ADVICE_START'	=> 'Forum URLs cannot end with a pagination parameter.<br/>They where thus removed from the one submitted.',
+	'SEO_ADVICE_DELIM_REM'	=> 'Submitted forum URLs cannot end with a forum delimiter.<br/>They where thus removed from one submitted.',
+	// Mod Rewrite type
+	'ACP_SEO_SIMPLE'	=> 'Simple',
+	'ACP_SEO_MIXED'		=> 'Mixed',
+	'ACP_SEO_ADVANCED'	=> 'Advanced',
+	// phpBB SEO Class option
+	'url_rewrite' => 'Activate URL rewriting',
+	'url_rewrite_explain' => 'Once you will have set up the below options, and generated your personalized .htaccess, you can activate URL rewriting and check if your rewritten URLs do work properly. If you get 404 errors, it\'s most likely an .htaccess issue, try some of the .htaccess tool option to generate a new one.',
+	'modrtype' => 'URL rewriting type',
+	'modrtype_explain' => 'The phpBB SEO premod is compatible with the three phpBB SEO mod rewrite.<br/>The <a href="http://www.phpbb-seo.com/boards/simple-seo-url/simple-phpbb3-seo-url-vt1566.html" title="More details about the Simple mod"><b>Simple</b></a> one,the <a href="http://www.phpbb-seo.com/boards/mixed-seo-url/mixed-phpbb3-seo-url-vt1565.html" title="More details about the Mixed mod"><b>Mixed</b></a>one and the <a href="http://www.phpbb-seo.com/boards/advanced-seo-url/advanced-phpbb3-seo-url-vt1219.html" title="More details about the Advanced mod"><b>Advanced</b></a> one.<br/><b style="color:red">Please Note</b><br/><ul style="margin-left:20px">Modifying this option will change all your URLs in your web site.<br/>Doing it with an already indexed web site should thus be considered	with as much care as when migrating and not to often.<br/>So you\'d better be decided to go for it or not.</ul>',
+	'profile_inj' => 'Profiles and groups injection',
+	'profile_inj_explain' => 'You can here chose to inject nicknames, group names and user messages page (optional see below) in their URLs instead of the default static rewriting, <b>phpBB/nickname-uxx.html</b> instead of <b>phpBB/memberxx.html</b>.<br/><b style="color:red">Please Note</b><br/><ul style="margin-left:20px">Changing this option requires and .htaccess update</ul>',
+	'profile_vfolder' => 'Virtual folder Profiles',
+	'profile_vfolder_explain' => 'You can here chose to simulate a folder structure for profiles and user messages page (optional see below) URLs, <b>phpBB/nickname-uxx/(topics/)</b> or <b>phpBB/memberxx/(topics/)</b> instead of <b>phpBB/nickname-uxx(-topics).html</b> and <b>phpBB/memberxx(-topics).html</b>.<br/><b style="color:red">Please Note</b><br/><ul style="margin-left:20px">Profile ID removing will override this setting.<br/>Changing this option requires and .htaccess update</ul>',
+	'profile_noids' => 'Profiles ID removing',
+	'profile_noids_explain' => 'When Profiles and groups injection is activated, you can here chose to use <b>example.com/phpBB/member/nickname</b> instead of the default <b>example.com/phpBB/nickname-uxx.html</b>. phpBB Uses an extra, but light, SQL query on such pages without user id.<br/><b style="color:red">Please Note</b><br/><ul style="margin-left:20px">Special characters won\'t be hadled the same by all browser. FF always urlencodes (<a href="http://www.php.net/urlencode">urlencode()</a>), and as it seems using Latin1 first, when IE and Opera do not. For advanced urlencoding options, please read the install file.<br/>Changing this option requires and .htaccess update</ul>',
+	'rewrite_usermsg' => 'Common Search and User messages pages rewriting',
+	'rewrite_usermsg_explain' => 'This option mostly makes sens if you allow public access to both profiles and search pages.<br/> Using this option most likely implies a greater use of the search functions and thus a heavier server load.<br/> The URL rewriting type (with and without ID) follows the one set for profiles and groups.<br/><b>phpBB/messages/nickname/topics/</b> VS <b>phpBB/nickname-uxx-topics.html</b> VS <b>phpBB/memberxx-topics.html</b>.<br/>Additionally this options will activate the common search page rewriting, such as active topics, unanswered and newposts pages.<br/><b style="color:red">Please Note</b><br/><ul style="margin-left:20px">ID removing on these links will imply the same limitation as per the user profiles.<br/>Changing this option requires and .htaccess update</ul>',
+	'rem_sid' => 'SID Removing',
+	'rem_sid_explain' => 'SID will be removed from 100% of the URLs passing through the phpbb_seo class, for guests thus bots.<br/>This ensure bots won\'t see any SID on forum, topic and post URLs, but visitors that do not accept cookies will most likely create more than one session.<br/>The Zero duplicate http 301 redirect url with SID for guest and bots by default.',
+	'rem_hilit' => 'Highlights Removing',
+	'rem_hilit_explain' => 'Highlights will be removed from 100% of the URLs passing through the phpbb_seo class, for guests thus bots.<br/>This ensure bots won\'t see any Highlights on forum, topic and post URLs.<br/>The Zero duplicate will automatically follow this setting, eg http 301 redirect url with highlights for guest and bots.',
+	'rem_small_words' => 'Remove small words',
+	'rem_small_words_explain' => 'Allow to remove all words of less than three letters in rewritten URLs.<br/><b style="color:red">Please Note</b><br/><ul style="margin-left:20px">The filtering will change potentially a lot of URLs in your web site.<br/>Even though the zero duplicate mod would take care of all the required redirecting when changing this option, starting to use it with an already indexed web site should thus be considered	with as much care as when migrating and not to often.<br/>So you\'d better be decided to go for it or not.</ul>',
+	'virtual_folder' => 'Virtual Folder',
+	'virtual_folder_explain' => 'Allow to add the forum URL as a virtual folder in topic URLs.<br/><u>Example :</u><ul style="margin-left:20px"><b>forum-title-fxx/topic-title-txx.html</b> VS <b>topic-title-txx.html</b><br/>for a topic URL.</ul><br/><b style="color:red">Please Note</b><br/><ul style="margin-left:20px">The Virtual folder injection option can change all your web site\'s URLs almost too easily.<br/>Starting to use it with an already indexed web site should thus be considered with as much care as when migrating and not to often.<br/>So you\'d better be decided to go for it or not.</ul>',
+	'virtual_root' => 'Virtual Root',
+	'virtual_root_explain' => 'If phpBB is installed in a sud folder (example phpBB3/), you can simulate a root install for rewritten links.<br/><u>Example :</u><ul style="margin-left:20px"><b>phpBB3/forum-title-fxx/topic-title-txx.html</b> VS <b>forum-title-fxx/topic-title-txx.html</b><br/>for a topic URL.</ul><br/>This can be handy to shorten URLs a bit, especially if you are using the "Virtual Folder" feature. UnRewritten links will continue to appear and work in the phpBB folder.<br/><br/><b style="color:red">Please Note :</b><br/><ul style="margin-left:20px">Using this option requires to use a home page for the forum index (like forum.html).<br/> This option can change all your web site\'s URLs almost too easily.<br/>Starting to use it with an already indexed web site should thus be considered with as much care as when migrating and not to often.<br/>So you\'d better be decided to go for it or not.</ul>',
+	'cache_layer' => 'Forum URL caching',
+	'cache_layer_explain' => 'Turns on the cache for forum URLs and allow to separate forum titles from their URL<br/><u>Example :</u><ul style="margin-left:20px"><b>forum-title-fxx/</b> VS <b>any-title-fxx/</b><br/>for a forum URL.</ul><br/><b style="color:red">Please Note</b><br/><ul style="margin-left:20px">This option will allow you to change your forum URL, thus potentially many topic URLS if you are using the Virtual Folder option.<br/>The topic URLs will always be redirected properly with the Zero Duplicate.<br/>It will as well be the case for forum URL as long as you keep the delimiter and IDs, see below.</ul>',
+	'rem_ids' => 'Forum ID Removing',
+	'rem_ids_explain' => 'Get rid of the IDs and delimiters in forum URLs. Only apply if Forum URL caching is activated.<br/><u>Example :</u><ul style="margin-left:20px"><b>any-title-fxx/</b> VS <b>any-title/</b><br/>for a forum URL.</ul><br/><b style="color:red">Please Note</b><br/><ul style="margin-left:20px">This option will allow you to change your forum URL, thus potentially many topic URLS if you are using the Virtual Folder option.<br/>The topic URLs will always be redirected properly with the Zero Duplicate.<br/><u>It will not always be the case with the forum URLs :</u><br/><ul style="margin-left:20px"><b>any-title-fxx/</b> will always be properly redirected with the Zero Duplicate but it won\'t be the case if you edit <b>any-title/</b> to <b>something-else/</b>.<br/> In such case, <b>any-title/</b> will for now be treated as a forum that does not exist.<br/>So you\'d better be decided to go for it or not, but it can really be powerful SEO wise.</ul></ul>',
+	// copytrights
+	'copyrights' => 'Copyrights',
+	'copyrights_img' => 'Link image',
+	'copyrights_img_explain' => 'You can here chose to display the phpBB SEO copyright link as an image or as a text links.',
+	'copyrights_txt' => 'Link text',
+	'copyrights_txt_explain' => 'You can here chose the text to be used as the phpBB SEO copyright link text anchor. Leave empty for defaults.',
+	'copyrights_title' => 'Link title',
+	'copyrights_title_explain' => 'You can here chose the text to be used as the phpBB SEO copyright link title. Leave empty for defaults.',
+	// Zero duplicate
+	// Options 
+	'ACP_ZERO_DUPE_OFF' => 'Off',
+	'ACP_ZERO_DUPE_MSG' => 'Post',
+	'ACP_ZERO_DUPE_GUEST' => 'Guest',
+	'ACP_ZERO_DUPE_ALL' => 'All',
+	'zero_dupe' =>'Zero duplictate',
+	'zero_dupe_explain' => 'The following settings concerns the Zero duplicate, you can modify them upon your needs.<br/>These do not imply any .htacess update.',
+	'zero_dupe_on' => 'Activate the Zero duplictate',
+	'zero_dupe_on_explain' => 'Allow to activate and desactivate the Zero duplicate redirections.',
+	'zero_dupe_strict' => 'Strict Mode',
+	'zero_dupe_strict_explain' => 'When activated, the zero dupe will check if the requested URL exactly matches the one attended.<br/>When set to no, the zero dupe will make sure the attended url is the fist part of the one requested.<br/>The interest is to make it easier to deal with mods that could interfere with the zero dupe by adding GET vars.',
+	'zero_dupe_post_redir' => 'Posts Redirections',
+	'zero_dupe_post_redir_explain' => 'This option will determine how to handle post urls; it can take four values :<ul style="margin-left:20px"><li><b>&nbsp;off</b>, do not redirect post url, whatever the case,</li><li><b>&nbsp;post</b>, only make sure postxx.html is used for a post url,</li><li><b>&nbsp;guest</b>, redirect guests if required to the corresponding topic url rather than to the postxx.html, and only make sure postxx.html is used for logged users,<li><b>&nbsp;all</b>, redirect if required to the corresponding topic url.</li></ul><br/><b style="color:red">Please Note</b><br/><ul style="margin-left:20px">Keeping the <b>postxx.html</b> URLs is harmless SEO wise as long as you keep the disallow on post urls in your robots.txt.<br/>Redirecting them all will most likely produce the most redirections among all.<br/>If you redirect postxx.html in all cases, this as well mean that a message that would be posted in a thread and then moved in another one will see it\'s url changing, which thanks to the zero duplicate mod is of no harm SEO wise, but the previous link to the post won\'t link to it anymore in such case.</ul>.',
+	// no duplicate
+	'no_dupe' => 'No duplictate',
+	'no_dupe_on' => 'Activate The No duplictate',
+	'no_dupe_on_explain' => 'The No duplicate mod remplaces posts URLs with the corresponding Topic URL (with pagination).<br/>It does not add any SQL, just a LEFT JOIN on a query already being performed, this could still mean a bit more work but should not be a problem for server load.',
+));
+?>
Index: language/en/acp/common.php
===================================================================
--- language/en/acp/common.php	(revision 159)
+++ language/en/acp/common.php	(revision 161)
@@ -682,5 +682,23 @@
 	'LOG_WORD_DELETE'		=> '<strong>Deleted word censor</strong><br />» %s',
 	'LOG_WORD_EDIT'			=> '<strong>Edited word censor</strong><br />» %s',
 ));
-
-?>
\ No newline at end of file
+// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+$lang = array_merge($lang, array(
+	'ACP_CAT_PHPBB_SEO' => 'phpBB SEO',
+	'ACP_MOD_REWRITE' => 'URL Rewriting settings',
+	'ACP_PHPBB_SEO_CLASS' => 'phpBB SEO Class settings',
+	'ACP_FORUM_URL' => 'Forum URL Management',
+	'ACP_HTACCESS' => '.htaccess',
+	'ACP_PREMOD_UPDATE' => '<h1>Release announcement</h1>
+	<p>This update does only concern the premod, not the phpBB core.</p>
+	<p>A new version of the phpBB SEO premod is thus available : %1$s<br/>Make sure you visit<a href="%2$s" title="The release thread"><b>the release thread</b></a> and update your installation.</p>',
+	'SEO_LOG_INSTALL_PHPBB_SEO' => '<strong>phpBB SEO mod rewrite installed</strong>',
+	'SEO_LOG_INSTALL_PHPBB_SEO_FAIL' => '<strong>phpBB SEO mod rewrite install attempt failed</strong>',
+	'SEO_LOG_UNINSTALL_PHPBB_SEO' => '<strong>phpBB SEO mod rewrite uninstalled</strong>',
+	'SEO_LOG_UNINSTALL_PHPBB_SEO_FAIL' => '<strong>phpBB SEO mod rewrite uninstall attempts failed</strong>',
+	'SEO_LOG_CONFIG_SETTINGS' => '<strong>Altered phpBB SEO Class settings</strong>',
+	'SEO_LOG_CONFIG_FORUM_URL' => '<strong>Altered Forum URLs</strong>',
+	'SEO_LOG_CONFIG_HTACCESS' => '<strong>Generated new .htaccess</strong>',
+));
+// www.phpBB-SEO.com SEO TOOLKIT END
+?>
Index: language/en/common.php
===================================================================
--- language/en/common.php	(revision 159)
+++ language/en/common.php	(revision 161)
@@ -828,5 +828,7 @@
 	'default_dateformat'	=> 'D M d, Y g:i a', // Mon Jan 01, 2007 1:37 pm
 
 ));
-
-?>
\ No newline at end of file
+// www.phpBB-SEO.com SEO TOOLKIT BEGIN - TITLE
+$lang['Page'] = 'Page ';
+// www.phpBB-SEO.com SEO TOOLKIT END - TITLE
+?>
Index: styles/subsilver2/template/overall_header.html
===================================================================
--- styles/subsilver2/template/overall_header.html	(revision 159)
+++ styles/subsilver2/template/overall_header.html	(revision 161)
@@ -1,18 +1,14 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
 <html xmlns="http://www.w3.org/1999/xhtml" dir="{S_CONTENT_DIRECTION}" lang="{S_USER_LANG}" xml:lang="{S_USER_LANG}">
 <head>
-
+{SEO_BASE_HREF}
 <meta http-equiv="content-type" content="text/html; charset={S_CONTENT_ENCODING}" />
+<title>{PAGE_TITLE}<!-- IF S_IN_MCP -->{L_MCP} &bull; <!-- ELSEIF S_IN_UCP -->{L_UCP} &bull; <!-- ENDIF --></title>
+<meta http-equiv="content-style-type" content="text/css" />
 <meta http-equiv="content-language" content="{S_USER_LANG}" />
-<meta http-equiv="content-style-type" content="text/css" />
 <meta http-equiv="imagetoolbar" content="no" />
-<meta name="resource-type" content="document" />
-<meta name="distribution" content="global" />
-<meta name="copyright" content="2000, 2002, 2005, 2007 phpBB Group" />
-<meta name="keywords" content="" />
-<meta name="description" content="" />
+{META_TAG}
 {META}
-<title>{SITENAME} &bull; <!-- IF S_IN_MCP -->{L_MCP} &bull; <!-- ELSEIF S_IN_UCP -->{L_UCP} &bull; <!-- ENDIF -->{PAGE_TITLE}</title>
 
 <link rel="stylesheet" href="{T_STYLESHEET_LINK}" type="text/css" />
 
@@ -36,17 +32,35 @@
 	return false;
 }
 
+// www.phpBB-SEO.com SEO TOOLKIT BEGIN
 function jumpto()
 {
 	var page = prompt('{LA_JUMP_PAGE}:', '{ON_PAGE}');
 	var perpage = '{PER_PAGE}';
 	var base_url = '{A_BASE_URL}';
+	var seo_delim_start = '{SEO_START_DELIM}';
+	var seo_static_pagination = '{SEO_SATIC_PAGE}';
+	var seo_ext_pagination = '{SEO_EXT_PAGE}';
 
-	if (page !== null && !isNaN(page) && page > 0)
-	{
-		document.location.href = base_url.replace(/&amp;/g, '&') + '&start=' + ((page - 1) * perpage);
+	if (page !== null && !isNaN(page) && page > 0) {
+		var seo_page = (page - 1) * per_page;
+		if ( base_url.indexOf('?') >= 0 ) {
+			document.location.href = base_url.replace(/&amp;/g, '&') + '&start=' + seo_page;
+		} else if ( seo_page > 0 ) {
+			var seo_type1 = base_url.match(/\.[a-z0-9]+$/i);
+			if (seo_type1 !== null) {
+				document.location.href = base_url.replace(/\.[a-z0-9]+$/i, '') + seo_delim_start + seo_page + seo_type1;
+			}
+			var seo_type2 = base_url.match(/\/$/);
+			if (seo_type2 !== null) {
+				document.location.href = base_url + seo_static_pagination + seo_page + seo_ext_pagination;
+			}
+		} else {
+			document.location.href = base_url;
+		}
 	}
 }
+// www.phpBB-SEO.com SEO TOOLKIT END
 
 /**
 * Find a member
Index: styles/subsilver2/template/forumlist_body.html
===================================================================
--- styles/subsilver2/template/forumlist_body.html	(revision 159)
+++ styles/subsilver2/template/forumlist_body.html	(revision 161)
@@ -58,6 +58,9 @@
 			<td class="row2" align="center"><p class="topicdetails">{forumrow.POSTS}</p></td>
 			<td class="row2" align="center" nowrap="nowrap">
 				<!-- IF forumrow.LAST_POST_TIME -->
+					<!-- IF forumrow.LAST_POST_LINK -->
+					<p class="topicdetails"><i>{forumrow.LAST_POST_LINK}</i></p>
+					<!-- ENDIF -->
 					<p class="topicdetails">{forumrow.LAST_POST_TIME}</p>
 					<p class="topicdetails">{forumrow.LAST_POSTER_FULL}
 						<a href="{forumrow.U_LAST_POST}">{LAST_POST_IMG}</a>
Index: styles/subsilver2/template/viewtopic_body.html
===================================================================
--- styles/subsilver2/template/viewtopic_body.html	(revision 159)
+++ styles/subsilver2/template/viewtopic_body.html	(revision 161)
@@ -279,7 +279,7 @@
 
 		<!-- IF postrow.S_ROW_COUNT is even --><tr class="row1"><!-- ELSE --><tr class="row2"><!-- ENDIF -->
 
-			<td class="profile"><strong><a href="#wrapheader">{L_BACK_TO_TOP}</a></strong></td>
+			<td class="profile"><strong><a href="{U_VIEW_TOPIC}#wrapheader">{L_BACK_TO_TOP}</a></strong></td>
 			<td><div class="gensmall" style="float: {S_CONTENT_FLOW_BEGIN};">&nbsp;<!-- IF postrow.U_PROFILE --><a href="{postrow.U_PROFILE}">{PROFILE_IMG}</a> <!-- ENDIF --> <!-- IF postrow.U_PM --><a href="{postrow.U_PM}">{PM_IMG}</a> <!-- ENDIF --> <!-- IF postrow.U_EMAIL --><a href="{postrow.U_EMAIL}">{EMAIL_IMG}</a> <!-- ENDIF -->&nbsp;</div> <div class="gensmall" style="float: {S_CONTENT_FLOW_END};"><!-- IF not S_IS_BOT --><!-- IF postrow.U_EDIT --><a href="{postrow.U_EDIT}">{EDIT_IMG}</a> <!-- ENDIF --> <!-- IF postrow.U_QUOTE --><a href="{postrow.U_QUOTE}">{QUOTE_IMG}</a> <!-- ENDIF --> <!-- ENDIF -->&nbsp;</div></td>
 	<!-- ENDIF -->
 		</tr>
Index: styles/prosilver/template/overall_header.html
===================================================================
--- styles/prosilver/template/overall_header.html	(revision 159)
+++ styles/prosilver/template/overall_header.html	(revision 161)
@@ -1,18 +1,14 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
 <html xmlns="http://www.w3.org/1999/xhtml" dir="{S_CONTENT_DIRECTION}" lang="{S_USER_LANG}" xml:lang="{S_USER_LANG}">
 <head>
-
+{SEO_BASE_HREF}
 <meta http-equiv="content-type" content="text/html; charset={S_CONTENT_ENCODING}" />
+<title>{PAGE_TITLE}<!-- IF S_IN_MCP -->{L_MCP} &bull; <!-- ELSEIF S_IN_UCP -->{L_UCP} &bull; <!-- ENDIF --></title>
 <meta http-equiv="content-style-type" content="text/css" />
 <meta http-equiv="content-language" content="{S_USER_LANG}" />
 <meta http-equiv="imagetoolbar" content="no" />
-<meta name="resource-type" content="document" />
-<meta name="distribution" content="global" />
-<meta name="copyright" content="2000, 2002, 2005, 2007 phpBB Group" />
-<meta name="keywords" content="" />
-<meta name="description" content="" />
+{META_TAG}
 {META}
-<title>{SITENAME} &bull; <!-- IF S_IN_MCP -->{L_MCP} &bull; <!-- ELSEIF S_IN_UCP -->{L_UCP} &bull; <!-- ENDIF -->{PAGE_TITLE}</title>
 
 <!--
 	phpBB style name: prosilver
@@ -34,7 +30,11 @@
 	var style_cookie = 'phpBBstyle';
 	var onload_functions = new Array();
 	var onunload_functions = new Array();
-
+	// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+	var seo_delim_start = '{SEO_START_DELIM}';
+	var seo_static_pagination = '{SEO_SATIC_PAGE}';
+	var seo_ext_pagination = '{SEO_EXT_PAGE}';
+	// www.phpBB-SEO.com SEO TOOLKIT END
 	<!-- IF S_USER_PM_POPUP -->
 		if ({S_NEW_PM})
 		{
Index: styles/prosilver/template/forumlist_body.html
===================================================================
--- styles/prosilver/template/forumlist_body.html	(revision 159)
+++ styles/prosilver/template/forumlist_body.html	(revision 161)
@@ -41,7 +41,7 @@
 					<dd class="topics">{forumrow.TOPICS} <dfn>{L_TOPICS}</dfn></dd>
 					<dd class="posts">{forumrow.POSTS} <dfn>{L_POSTS}</dfn></dd>
 					<dd class="lastpost"><span>
-						<!-- IF forumrow.LAST_POST_TIME --><dfn>{L_LAST_POST}</dfn> {L_POST_BY_AUTHOR} {forumrow.LAST_POSTER_FULL}
+						<!-- IF forumrow.LAST_POST_TIME --><dfn>{L_LAST_POST}</dfn><!-- IF forumrow.LAST_POST_LINK --><i>{forumrow.LAST_POST_LINK}</i><br/><!-- ENDIF --> {L_POST_BY_AUTHOR} {forumrow.LAST_POSTER_FULL}
 						<a href="{forumrow.U_LAST_POST}">{LAST_POST_IMG}</a> <br />{L_POSTED_ON_DATE} {forumrow.LAST_POST_TIME}<!-- ELSE -->{L_NO_POSTS}<!-- ENDIF --></span>
 					</dd>
 				<!-- ENDIF -->
Index: styles/prosilver/template/forum_fn.js
===================================================================
--- styles/prosilver/template/forum_fn.js	(revision 159)
+++ styles/prosilver/template/forum_fn.js	(revision 161)
@@ -19,15 +19,28 @@
 /**
 * Jump to page
 */
-function jumpto()
-{
+// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+function jumpto() {
 	var page = prompt(jump_page, on_page);
-
-	if (page !== null && !isNaN(page) && page > 0)
-	{
-		document.location.href = base_url.replace(/&amp;/g, '&') + '&start=' + ((page - 1) * per_page);
+	if (page !== null && !isNaN(page) && page > 0) {
+		var seo_page = (page - 1) * per_page;
+		if ( base_url.indexOf('?') >= 0 ) {
+			document.location.href = base_url.replace(/&amp;/g, '&') + '&start=' + seo_page;
+		} else if ( seo_page > 0 ) {
+			var seo_type1 = base_url.match(/\.[a-z0-9]+$/i);
+			if (seo_type1 !== null) {
+				document.location.href = base_url.replace(/\.[a-z0-9]+$/i, '') + seo_delim_start + seo_page + seo_type1;
+			}
+			var seo_type2 = base_url.match(/\/$/);
+			if (seo_type2 !== null) {
+				document.location.href = base_url + seo_static_pagination + seo_page + seo_ext_pagination;
+			}
+		} else {
+			document.location.href = base_url;
+		}
 	}
 }
+// www.phpBB-SEO.com SEO TOOLKIT END
 
 /**
 * Mark/unmark checklist
Index: styles/prosilver/template/viewtopic_body.html
===================================================================
--- styles/prosilver/template/viewtopic_body.html	(revision 159)
+++ styles/prosilver/template/viewtopic_body.html	(revision 161)
@@ -135,7 +135,7 @@
 			<!-- ENDIF -->
 		<!-- ENDIF -->
 
-			<h3 <!-- IF postrow.S_FIRST_ROW -->class="first"<!-- ENDIF -->><!-- IF postrow.POST_ICON_IMG --><img src="{T_ICONS_PATH}{postrow.POST_ICON_IMG}" width="{postrow.POST_ICON_IMG_WIDTH}" height="{postrow.POST_ICON_IMG_HEIGHT}" alt="" /> <!-- ENDIF --><a href="#p{postrow.POST_ID}">{postrow.POST_SUBJECT}</a></h3>
+			<h3 <!-- IF postrow.S_FIRST_ROW -->class="first"<!-- ENDIF -->><!-- IF postrow.POST_ICON_IMG --><img src="{T_ICONS_PATH}{postrow.POST_ICON_IMG}" width="{postrow.POST_ICON_IMG_WIDTH}" height="{postrow.POST_ICON_IMG_HEIGHT}" alt="" /> <!-- ENDIF --><a href="{U_VIEW_TOPIC}#p{postrow.POST_ID}">{postrow.POST_SUBJECT}</a></h3>
 			<p class="author"><!-- IF S_IS_BOT -->{postrow.MINI_POST_IMG}<!-- ELSE --><a href="{postrow.U_MINI_POST}">{postrow.MINI_POST_IMG}</a><!-- ENDIF -->{L_POST_BY_AUTHOR} <strong>{postrow.POST_AUTHOR_FULL}</strong> {L_POSTED_ON_DATE} {postrow.POST_DATE} </p>
 
 			<!-- IF postrow.S_POST_UNAPPROVED or postrow.S_POST_REPORTED -->
@@ -215,7 +215,7 @@
 		</dl>
 	<!-- ENDIF -->
 
-		<div class="back2top"><a href="#wrap" class="top" title="{L_BACK_TO_TOP}">{L_BACK_TO_TOP}</a></div>
+		<div class="back2top"><a href="{U_VIEW_TOPIC}#wrap" class="top" title="{L_BACK_TO_TOP}">{L_BACK_TO_TOP}</a></div>
 
 		<span class="corners-bottom"><span></span></span></div>
 	</div>
Index: docs/header_bg.jpg
===================================================================
Cannot display: file marked as a binary type.
svn:mime-type = application/octet-stream

Property changes on: G:\web\phpbb-seo.com\aTEAM\phpbb3\0.4.2\premod\svn_premod\docs\header_bg.jpg
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Index: docs/header_left.jpg
===================================================================
Cannot display: file marked as a binary type.
svn:mime-type = application/octet-stream

Property changes on: G:\web\phpbb-seo.com\aTEAM\phpbb3\0.4.2\premod\svn_premod\docs\header_left.jpg
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Index: memberlist.php
===================================================================
--- memberlist.php	(revision 159)
+++ memberlist.php	(revision 161)
@@ -21,7 +21,14 @@
 $user->session_begin();
 $auth->acl($user->data);
 $user->setup(array('memberlist', 'groups'));
-
+// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+if (!empty($_REQUEST['un'])) {
+	$_REQUEST['un'] = rawurldecode($_REQUEST['un']);
+	if (!$phpbb_seo->is_utf8($_REQUEST['un']) && function_exists('utf8_encode')) {
+		$_REQUEST['un'] = utf8_normalize_nfc(utf8_encode($_REQUEST['un']));
+	}
+}
+// www.phpBB-SEO.com SEO TOOLKIT END
 // Grab data
 $mode		= request_var('mode', '');
 $action		= request_var('action', '');
@@ -429,7 +436,16 @@
 		}
 
 		$user_id = (int) $member['user_id'];
-
+		// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+		$phpbb_seo->set_user_url( $member['username'], $user_id );
+		// www.phpBB-SEO.com SEO TOOLKIT END
+		// www.phpBB-SEO.com SEO TOOLKIT BEGIN - Zero dupe
+		$phpbb_seo->seo_opt['zero_dupe']['redir_def'] = array(
+			'mode' => array('val' => 'viewprofile', 'keep' => true),
+			'u' => array('val' => $user_id, 'keep' => true, 'force' => true),
+		);
+		$phpbb_seo->seo_chk_dupe();
+		// www.phpBB-SEO.com SEO TOOLKIT END - Zero dupe
 		// Do the SQL thang
 		$sql = 'SELECT g.group_id, g.group_name, g.group_type
 			FROM ' . GROUPS_TABLE . ' g, ' . USER_GROUP_TABLE . " ug
@@ -1076,7 +1092,18 @@
 			{
 				trigger_error('NO_GROUP');
 			}
-
+			// www.phpBB-SEO.com SEO TOOLKIT BEGIN - Zero dupe
+			if ( empty($phpbb_seo->seo_url['group'][$group_row['group_id']]) ) {
+				$phpbb_seo->seo_url['group'][$group_row['group_id']] = $phpbb_seo->format_url($group_row['group_name'], $phpbb_seo->seo_static['group']);
+			}
+			$phpbb_seo->seo_opt['zero_dupe']['start'] = $phpbb_seo->seo_chk_start( $start, $config['topics_per_page'] );
+			$phpbb_seo->seo_opt['zero_dupe']['redir_def'] = array(
+				'mode' => array('val' => 'group', 'keep' => true),
+				'g' => array('val' => (int) $group_row['group_id'], 'keep' => true),
+				'start' => array('val' => $phpbb_seo->seo_opt['zero_dupe']['start'], 'keep' => true),
+			);
+			$phpbb_seo->seo_chk_dupe();
+			// www.phpBB-SEO.com SEO TOOLKIT END - Zero dupe
 			switch ($group_row['group_type'])
 			{
 				case GROUP_OPEN:
@@ -1421,7 +1448,9 @@
 				unset($id_cache[$user_id]);
 			}
 		}
-
+		// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+		$seo_sep = strpos($sort_url, '?') === false ? '?' : '&amp;';
+		// www.phpBB-SEO.com SEO TOOLKIT END
 		// Generate page
 		$template->assign_vars(array(
 			'PAGINATION'	=> generate_pagination($pagination_url, $total_users, $config['topics_per_page'], $start),
@@ -1441,20 +1470,22 @@
 
 			'U_FIND_MEMBER'			=> ($config['load_search'] || $auth->acl_get('a_')) ? append_sid("{$phpbb_root_path}memberlist.$phpEx", 'mode=searchuser') : '',
 			'U_HIDE_FIND_MEMBER'	=> ($mode == 'searchuser') ? $u_hide_find_member : '',
-			'U_SORT_USERNAME'		=> $sort_url . '&amp;sk=a&amp;sd=' . (($sort_key == 'a' && $sort_dir == 'a') ? 'd' : 'a'),
-			'U_SORT_FROM'			=> $sort_url . '&amp;sk=b&amp;sd=' . (($sort_key == 'b' && $sort_dir == 'a') ? 'd' : 'a'),
-			'U_SORT_JOINED'			=> $sort_url . '&amp;sk=c&amp;sd=' . (($sort_key == 'c' && $sort_dir == 'a') ? 'd' : 'a'),
-			'U_SORT_POSTS'			=> $sort_url . '&amp;sk=d&amp;sd=' . (($sort_key == 'd' && $sort_dir == 'a') ? 'd' : 'a'),
-			'U_SORT_EMAIL'			=> $sort_url . '&amp;sk=e&amp;sd=' . (($sort_key == 'e' && $sort_dir == 'a') ? 'd' : 'a'),
-			'U_SORT_WEBSITE'		=> $sort_url . '&amp;sk=f&amp;sd=' . (($sort_key == 'f' && $sort_dir == 'a') ? 'd' : 'a'),
-			'U_SORT_LOCATION'		=> $sort_url . '&amp;sk=b&amp;sd=' . (($sort_key == 'b' && $sort_dir == 'a') ? 'd' : 'a'),
-			'U_SORT_ICQ'			=> $sort_url . '&amp;sk=g&amp;sd=' . (($sort_key == 'g' && $sort_dir == 'a') ? 'd' : 'a'),
-			'U_SORT_AIM'			=> $sort_url . '&amp;sk=h&amp;sd=' . (($sort_key == 'h' && $sort_dir == 'a') ? 'd' : 'a'),
-			'U_SORT_MSN'			=> $sort_url . '&amp;sk=i&amp;sd=' . (($sort_key == 'i' && $sort_dir == 'a') ? 'd' : 'a'),
-			'U_SORT_YIM'			=> $sort_url . '&amp;sk=j&amp;sd=' . (($sort_key == 'j' && $sort_dir == 'a') ? 'd' : 'a'),
-			'U_SORT_ACTIVE'			=> ($auth->acl_get('u_viewonline')) ? $sort_url . '&amp;sk=l&amp;sd=' . (($sort_key == 'l' && $sort_dir == 'a') ? 'd' : 'a') : '',
-			'U_SORT_RANK'			=> $sort_url . '&amp;sk=m&amp;sd=' . (($sort_key == 'm' && $sort_dir == 'a') ? 'd' : 'a'),
-			'U_LIST_CHAR'			=> $sort_url . '&amp;sk=a&amp;sd=' . (($sort_key == 'l' && $sort_dir == 'a') ? 'd' : 'a'),
+			// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+			'U_SORT_USERNAME'		=> $sort_url . $seo_sep . 'sk=a&amp;sd=' . (($sort_key == 'a' && $sort_dir == 'a') ? 'd' : 'a'),
+			'U_SORT_FROM'			=> $sort_url . $seo_sep . 'sk=b&amp;sd=' . (($sort_key == 'b' && $sort_dir == 'a') ? 'd' : 'a'),
+			'U_SORT_JOINED'			=> $sort_url . $seo_sep . 'sk=c&amp;sd=' . (($sort_key == 'c' && $sort_dir == 'a') ? 'd' : 'a'),
+			'U_SORT_POSTS'			=> $sort_url . $seo_sep . 'sk=d&amp;sd=' . (($sort_key == 'd' && $sort_dir == 'a') ? 'd' : 'a'),
+			'U_SORT_EMAIL'			=> $sort_url . $seo_sep . 'sk=e&amp;sd=' . (($sort_key == 'e' && $sort_dir == 'a') ? 'd' : 'a'),
+			'U_SORT_WEBSITE'		=> $sort_url . $seo_sep . 'sk=f&amp;sd=' . (($sort_key == 'f' && $sort_dir == 'a') ? 'd' : 'a'),
+			'U_SORT_LOCATION'		=> $sort_url . $seo_sep . 'sk=b&amp;sd=' . (($sort_key == 'b' && $sort_dir == 'a') ? 'd' : 'a'),
+			'U_SORT_ICQ'			=> $sort_url . $seo_sep . 'sk=g&amp;sd=' . (($sort_key == 'g' && $sort_dir == 'a') ? 'd' : 'a'),
+			'U_SORT_AIM'			=> $sort_url . $seo_sep . 'sk=h&amp;sd=' . (($sort_key == 'h' && $sort_dir == 'a') ? 'd' : 'a'),
+			'U_SORT_MSN'			=> $sort_url . $seo_sep . 'sk=i&amp;sd=' . (($sort_key == 'i' && $sort_dir == 'a') ? 'd' : 'a'),
+			'U_SORT_YIM'			=> $sort_url . $seo_sep . 'sk=j&amp;sd=' . (($sort_key == 'j' && $sort_dir == 'a') ? 'd' : 'a'),
+			'U_SORT_ACTIVE'			=> ($auth->acl_get('u_viewonline')) ? $sort_url . $seo_sep . 'sk=l&amp;sd=' . (($sort_key == 'l' && $sort_dir == 'a') ? 'd' : 'a') : '',
+			'U_SORT_RANK'			=> $sort_url . $seo_sep . 'sk=m&amp;sd=' . (($sort_key == 'm' && $sort_dir == 'a') ? 'd' : 'a'),
+			'U_LIST_CHAR'			=> $sort_url . $seo_sep . 'sk=a&amp;sd=' . (($sort_key == 'l' && $sort_dir == 'a') ? 'd' : 'a'),
+			// www.phpBB-SEO.com SEO TOOLKIT END
 
 			'S_SHOW_GROUP'		=> ($mode == 'group') ? true : false,
 			'S_VIEWONLINE'		=> $auth->acl_get('u_viewonline'),
@@ -1587,4 +1618,4 @@
 	);
 }
 
-?>
\ No newline at end of file
+?>
Index: search.php
===================================================================
--- search.php	(revision 159)
+++ search.php	(revision 161)
@@ -20,7 +20,18 @@
 $user->session_begin();
 $auth->acl($user->data);
 $user->setup('search');
-
+// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+$can_encode = function_exists('utf8_encode') ? true : false;
+$clean_request = array('keywords', 'author', 'add_keywords');
+foreach ($clean_request as $request) {
+	if (!empty($_REQUEST[$request])) {
+		$_REQUEST[$request] = rawurldecode($_REQUEST[$request]);
+		if (!$phpbb_seo->is_utf8($_REQUEST[$request]) && $can_encode) {
+			$_REQUEST[$request] = utf8_normalize_nfc(utf8_encode($_REQUEST[$request]));
+		}
+	}
+}
+// www.phpBB-SEO.com SEO TOOLKIT END
 // Define initial vars
 $mode			= request_var('mode', '');
 $search_id		= request_var('search_id', '');
@@ -271,6 +282,14 @@
 				$sort_key = 't';
 				$sort_dir = 'd';
 				$sort_days = request_var('st', 7);
+				// www.phpBB-SEO.com SEO TOOLKIT BEGIN - Zero dupe
+				$phpbb_seo->seo_opt['zero_dupe']['redir_def'] = array(
+					'search_id' => array('val' => 'active_topics', 'keep' => true),
+					'st' => array('val' => $sort_days, 'keep' => (boolean) ($sort_days != 7) ),
+					'start' => array('val' => $phpbb_seo->seo_chk_start( $start, $config['topics_per_page'] ), 'keep' => true),
+				);
+				$phpbb_seo->seo_chk_dupe();
+				// www.phpBB-SEO.com SEO TOOLKIT END - Zero dupe
 				$sort_by_sql['t'] = 't.topic_last_post_time';
 
 				gen_sort_selects($limit_days, $sort_by_text, $sort_days, $sort_key, $sort_dir, $s_limit_days, $s_sort_key, $s_sort_dir, $u_sort_param);
@@ -292,6 +311,17 @@
 				$l_search_title = $user->lang['SEARCH_UNANSWERED'];
 				$show_results = request_var('sr', 'topics');
 				$show_results = ($show_results == 'posts') ? 'posts' : 'topics';
+				// www.phpBB-SEO.com SEO TOOLKIT BEGIN - Zero dupe
+				$phpbb_seo->seo_opt['zero_dupe']['redir_def'] = array(
+					'sr' => array('val' => $show_results, 'keep' => (boolean) ($show_results == 'posts') ),
+					'st' => array('val' => $sort_days, 'keep' => true),
+					'sk' => array('val' => $sort_key, 'keep' => true),
+					'sd' => array('val' => $sort_dir, 'keep' => true),
+					'search_id' => array('val' => 'unanswered', 'keep' => true),
+					'start' => array('val' => $phpbb_seo->seo_chk_start( $start, ($show_results == 'posts' ? $config['posts_per_page'] : $config['topics_per_page']) ), 'keep' => true),
+				);
+				$phpbb_seo->seo_chk_dupe();
+				// www.phpBB-SEO.com SEO TOOLKIT END - Zero dupe
 				$sort_by_sql['t'] = ($show_results == 'posts') ? 'p.post_time' : 't.topic_last_post_time';
 				$sort_by_sql['s'] = ($show_results == 'posts') ? 'p.post_subject' : 't.topic_title';
 				$sql_sort = 'ORDER BY ' . $sort_by_sql[$sort_key] . (($sort_dir == 'a') ? ' ASC' : ' DESC');
@@ -345,6 +375,14 @@
 				$l_search_title = $user->lang['SEARCH_NEW'];
 				// force sorting
 				$show_results = (request_var('sr', 'topics') == 'posts') ? 'posts' : 'topics';
+				// www.phpBB-SEO.com SEO TOOLKIT BEGIN - Zero dupe
+				$phpbb_seo->seo_opt['zero_dupe']['redir_def'] = array(
+					'search_id' => array('val' => 'newposts', 'keep' => true),
+					'sr' => array('val' => $show_results, 'keep' => (boolean) ($show_results == 'posts') ),
+					'start' => array('val' => $phpbb_seo->seo_chk_start( $start, $config['topics_per_page'] ), 'keep' => true),
+				);
+				$phpbb_seo->seo_chk_dupe();
+				// www.phpBB-SEO.com SEO TOOLKIT END - Zero dupe
 				$sort_key = 't';
 				$sort_dir = 'd';
 				$sort_by_sql['t'] = ($show_results == 'posts') ? 'p.post_time' : 't.topic_last_post_time';
@@ -470,7 +508,9 @@
 	$u_show_results = ($show_results != 'posts') ? '&amp;sr=' . $show_results : '';
 	$u_search_forum = implode('&amp;fid%5B%5D=', $search_forum);
 
-	$u_search = append_sid("{$phpbb_root_path}search.$phpEx", $u_sort_param . $u_show_results);
+	// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+	//$u_search = append_sid("{$phpbb_root_path}search.$phpEx", $u_sort_param . $u_show_results);
+	$u_search = $u_sort_param . $u_show_results;
 	$u_search .= ($search_id) ? '&amp;search_id=' . $search_id : '';
 	$u_search .= ($u_hilit) ? '&amp;keywords=' . urlencode(htmlspecialchars_decode($search->search_query)) : '';
 	$u_search .= ($topic_id) ? '&amp;t=' . $topic_id : '';
@@ -480,7 +520,43 @@
 	$u_search .= (!$search_child) ? '&amp;sc=0' : '';
 	$u_search .= ($search_fields != 'all') ? '&amp;sf=' . $search_fields : '';
 	$u_search .= ($return_chars != 300) ? '&amp;ch=' . $return_chars : '';
-
+	$u_search = trim($u_search, '&amp;');
+	if ( $phpbb_seo->seo_opt['rewrite_usermsg'] && (!empty($author) || !empty($author_id)) ) {
+		$author_name = '';
+		if (!empty($author_id)) {
+			$sql = $sql = 'SELECT username
+				FROM ' . USERS_TABLE . "
+				WHERE user_id = $author_id
+				AND user_type IN (" . USER_NORMAL . ', ' . USER_FOUNDER . ')';
+			$result = $db->sql_query($sql);
+			if ($row = $db->sql_fetchrow($result)) {
+				$author_name = $row['username'];
+				$phpbb_seo->set_user_url( $author_name, $author_id );
+			}
+		}
+		if (!empty($author) && (strpos($author, '*') === false) ) {
+			$sql = $sql = 'SELECT user_id
+				FROM ' . USERS_TABLE . "
+				WHERE username_clean = '" . $db->sql_escape(utf8_clean_string($author)) . "'
+				AND user_type IN (" . USER_NORMAL . ', ' . USER_FOUNDER . ')';
+			$result = $db->sql_query($sql);
+			if ($row = $db->sql_fetchrow($result)) {
+				$phpbb_seo->set_user_url( $author, $row['user_id'] );
+			}
+		}
+		$author = empty($author) ? $author_name : $author;
+		// www.phpBB-SEO.com SEO TOOLKIT BEGIN - Zero dupe
+		if (!$submit) {
+			$seo_search_params = (!empty($u_search) ? '?' . $u_search . '&amp;': '?') .  'start=' .  $phpbb_seo->seo_chk_start( $start, $per_page );
+			$phpbb_seo->seo_chk_dupe("{$phpbb_root_path}search.$phpEx$seo_search_params");
+		}
+		// www.phpBB-SEO.com SEO TOOLKIT END - Zero dupe
+	}
+	$u_search = append_sid( "{$phpbb_root_path}search.$phpEx" . (!empty($u_search) ? '?' . $u_search : '') );
+	// www.phpBB-SEO.com SEO TOOLKIT END
+	// www.phpBB-SEO.com SEO TOOLKIT BEGIN - TITLE
+	$l_search_title = empty($l_search_title) && !empty($author) ? $author  . ' - ' . ($show_results != 'posts' ? $user->lang['TOPICS'] : $user->lang['POSTS']) : $l_search_title;
+	// www.phpBB-SEO.com SEO TOOLKIT END - TITLE
 	$template->assign_vars(array(
 		'SEARCH_TITLE'		=> $l_search_title,
 		'SEARCH_MATCHES'	=> $l_search_matches,
@@ -762,7 +838,17 @@
 			{
 				$u_forum_id = $forum_id;
 			}
-
+			// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+			if ($row['topic_type'] == POST_GLOBAL) {
+				$phpbb_seo->seo_opt['topic_type'][$result_topic_id] = POST_GLOBAL;
+			}
+			if ( empty($phpbb_seo->seo_url['topic'][$result_topic_id]) ) {
+				$phpbb_seo->seo_url['topic'][$result_topic_id] = $phpbb_seo->format_url($topic_title);
+			}
+			if ( empty($phpbb_seo->seo_url['forum'][$u_forum_id]) ) {
+				$phpbb_seo->seo_url['forum'][$u_forum_id] = $phpbb_seo->set_url($row['forum_name'], $u_forum_id, $phpbb_seo->seo_static['forum']);
+			}
+			// www.phpBB-SEO.com SEO TOOLKIT END
 			$view_topic_url = append_sid("{$phpbb_root_path}viewtopic.$phpEx", "f=$u_forum_id&amp;t=$result_topic_id" . (($u_hilit) ? "&amp;hilit=$u_hilit" : ''));
 
 			$replies = ($auth->acl_get('m_approve', $forum_id)) ? $row['topic_replies_real'] : $row['topic_replies'];
@@ -812,10 +898,14 @@
 					'S_TOPIC_UNAPPROVED'	=> $topic_unapproved,
 					'S_POSTS_UNAPPROVED'	=> $posts_unapproved,
 
-					'U_LAST_POST'			=> $view_topic_url . '&amp;p=' . $row['topic_last_post_id'] . '#p' . $row['topic_last_post_id'],
+					// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+					'U_LAST_POST'			=> append_sid("{$phpbb_root_path}viewtopic.$phpEx", "f=$u_forum_id&amp;t=$result_topic_id&amp;hilit=$u_hilit" . '&amp;p=' . $row['topic_last_post_id']) . '#p' . $row['topic_last_post_id'],
+					// www.phpBB-SEO.com SEO TOOLKIT END
 					'U_LAST_POST_AUTHOR'	=> get_username_string('profile', $row['topic_last_poster_id'], $row['topic_last_poster_name'], $row['topic_last_poster_colour']),
 					'U_TOPIC_AUTHOR'		=> get_username_string('profile', $row['topic_poster'], $row['topic_first_poster_name'], $row['topic_first_poster_colour']),
-					'U_NEWEST_POST'			=> $view_topic_url . '&amp;view=unread#unread',
+					// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+					'U_NEWEST_POST'			=> append_sid("{$phpbb_root_path}viewtopic.$phpEx", "f=$u_forum_id&amp;t=$result_topic_id&amp;hilit=$u_hilit" . '&amp;view=unread') . '#unread',
+					// www.phpBB-SEO.com SEO TOOLKIT END
 					'U_MCP_REPORT'			=> append_sid("{$phpbb_root_path}mcp.$phpEx", 'i=reports&amp;mode=reports&amp;t=' . $result_topic_id, true, $user->session_id),
 					'U_MCP_QUEUE'			=> $u_mcp_queue,
 				);
@@ -907,7 +997,10 @@
 	}
 	unset($rowset);
 
-	page_header(($l_search_title) ? $l_search_title : $user->lang['SEARCH']);
+	// www.phpBB-SEO.com SEO TOOLKIT BEGIN - TITLE
+	$extra_title = ($start > 0) ? ' - ' . $user->lang['Page'] . ( floor( $start / $per_page ) + 1 ) : '';
+	page_header( ( ($l_search_title) ? $l_search_title . (!empty($search->search_query) ? ' : ' . $search->search_query : '' ): $user->lang['SEARCH'] ) . $extra_title );
+	// www.phpBB-SEO.com SEO TOOLKIT END - TITLE
 
 	$template->set_filenames(array(
 		'body' => 'search_results.html')
@@ -1098,4 +1191,4 @@
 
 page_footer();
 
-?>
\ No newline at end of file
+?>
Index: index.php
===================================================================
--- index.php	(revision 159)
+++ index.php	(revision 161)
@@ -2,7 +2,7 @@
 /**
 *
 * @package phpBB3
-* @version $Id: index.php 8479 2008-03-29 00:22:48Z naderman $
+* @version $Id: index.php,v 1.176 2007/10/05 14:30:06 acydburn Exp $
 * @copyright (c) 2005 phpBB Group
 * @license http://opensource.org/licenses/gpl-license.php GNU Public License
 *
@@ -24,7 +24,21 @@
 $user->session_begin();
 $auth->acl($user->data);
 $user->setup('viewforum');
-
+// www.phpBB-SEO.com SEO TOOLKIT BEGIN -> Zero dupe
+$seo_mark = request_var('mark', '');
+$keep_mark = in_array($seo_mark, array('topics', 'forums', 'all')) ? (boolean) ($user->data['is_registered'] || $config['load_anon_lastread']) : false;
+$phpbb_seo->seo_opt['zero_dupe']['redir_def'] = array(
+	'mark' => array('val' => $seo_mark, 'keep' => $keep_mark),
+);
+if ( !$phpbb_seo->seo_opt['zero_dupe']['strict'] ) { // strict mode is here a bit faster
+	if ( !empty($phpbb_seo->seo_static['index']) ) {
+		$phpbb_seo->set_cond( (boolean) (utf8_strpos($phpbb_seo->seo_path['uri'], $phpbb_seo->seo_static['index']) === false), 'do_redir', (empty($_GET) || (!empty($seo_mark) && !$keep_mark)));
+	} else {
+		$phpbb_seo->set_cond( (boolean) (utf8_strpos($phpbb_seo->seo_path['uri'], "index.$phpEx") !== false), 'do_redir', (empty($_GET) || (!empty($seo_mark) && !$keep_mark)));
+	}
+}
+$phpbb_seo->seo_chk_dupe();
+// www.phpBB-SEO.com SEO TOOLKIT END -> Zero dupe
 display_forums('', $config['load_moderators']);
 
 // Set some stats, get posts count from forums data if we... hum... retrieve all forums data
@@ -71,6 +85,11 @@
 	}
 	else
 	{
+		// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+		if ( $phpbb_seo->seo_opt['profile_inj'] && empty($phpbb_seo->seo_url['group'][$row['group_id']]) ) {
+			$phpbb_seo->seo_url['group'][$row['group_id']] = $phpbb_seo->format_url($row['group_name'], $phpbb_seo->seo_static['group']);
+		}
+		// www.phpBB-SEO.com SEO TOOLKIT END
 		$legend .= (($legend != '') ? ', ' : '') . '<a' . $colour_text . ' href="' . append_sid("{$phpbb_root_path}memberlist.$phpEx", 'mode=group&amp;g=' . $row['group_id']) . '">' . (($row['group_type'] == GROUP_SPECIAL) ? $user->lang['G_' . $row['group_name']] : $row['group_name']) . '</a>';
 	}
 }
@@ -122,6 +141,10 @@
 );
 
 // Output page
+// www.phpBB-SEO.com SEO TOOLKIT BEGIN - META
+$seo_meta->meta['meta_desc'] = $seo_meta->meta_filter_txt($config['sitename'] . ' : ' .  $config['site_desc']);
+$seo_meta->meta['keywords'] = $seo_meta->make_keywords($seo_meta->meta['meta_desc']);
+// www.phpBB-SEO.com SEO TOOLKIT END - META
 page_header($user->lang['INDEX']);
 
 $template->set_filenames(array(
@@ -130,4 +153,4 @@
 
 page_footer();
 
-?>
\ No newline at end of file
+?>
Index: viewtopic.php
===================================================================
--- viewtopic.php	(revision 159)
+++ viewtopic.php	(revision 161)
@@ -17,7 +17,20 @@
 include($phpbb_root_path . 'common.' . $phpEx);
 include($phpbb_root_path . 'includes/functions_display.' . $phpEx);
 include($phpbb_root_path . 'includes/bbcode.' . $phpEx);
-
+// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+if (empty($_REQUEST['f'])) {
+	$phpbb_seo->get_forum_id($session_forum_id);
+	if ($session_forum_id > 0) {
+		$_REQUEST['f'] = (int) $session_forum_id;
+	}
+}
+if (!empty($_REQUEST['hilit'])) {
+	$_REQUEST['hilit'] = urldecode($_REQUEST['hilit']);
+	if (!$phpbb_seo->is_utf8($_REQUEST['hilit']) && function_exists('utf8_encode')) {
+		$_REQUEST['hilit'] = utf8_normalize_nfc(utf8_encode($_REQUEST['hilit']));
+	}
+}
+// www.phpBB-SEO.com SEO TOOLKIT END
 // Start session management
 $user->session_begin();
 $auth->acl($user->data);
@@ -296,7 +309,18 @@
 
 $forum_id = (int) $topic_data['forum_id'];
 $topic_id = (int) $topic_data['topic_id'];
-
+// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+if ( empty($phpbb_seo->seo_url['topic'][$topic_id]) ) {
+	if ($topic_data['topic_type'] == POST_GLOBAL) {
+		$phpbb_seo->seo_opt['topic_type'][$topic_id] = POST_GLOBAL;
+	}
+	$phpbb_seo->seo_censored[$topic_id] = censor_text($topic_data['topic_title']);
+	$phpbb_seo->seo_url['topic'][$topic_id] = $phpbb_seo->format_url($phpbb_seo->seo_censored[$topic_id]);
+}
+if ( empty($phpbb_seo->seo_url['forum'][$topic_data['forum_id']]) ) {
+	$phpbb_seo->seo_url['forum'][$topic_data['forum_id']] = $phpbb_seo->set_url($topic_data['forum_name'], $topic_data['forum_id'], $phpbb_seo->seo_static['forum']);
+}
+// www.phpBB-SEO.com SEO TOOLKIT END
 //
 $topic_replies = ($auth->acl_get('m_approve', $forum_id)) ? $topic_data['topic_replies_real'] : $topic_data['topic_replies'];
 
@@ -343,17 +367,23 @@
 {
 	$jump_to = request_var('e', 0);
 
-	$redirect_url = append_sid("{$phpbb_root_path}viewtopic.$phpEx", "f=$forum_id&amp;t=$topic_id");
+	// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+	//$redirect_url = append_sid("{$phpbb_root_path}viewtopic.$phpEx", "f=$forum_id&amp;t=$topic_id");
+	// www.phpBB-SEO.com SEO TOOLKIT END
 
 	if ($user->data['user_id'] == ANONYMOUS)
 	{
-		login_box($redirect_url . "&amp;p=$post_id&amp;e=$jump_to", $user->lang['LOGIN_NOTIFY_TOPIC']);
+		// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+		login_box(append_sid("{$phpbb_root_path}viewtopic.$phpEx", "f=$forum_id&amp;t=$topic_id&amp;p=$post_id&amp;e=$jump_to"), $user->lang['LOGIN_NOTIFY_TOPIC']);
+		// www.phpBB-SEO.com SEO TOOLKIT END
 	}
 
 	if ($jump_to > 0)
 	{
 		// We direct the already logged in user to the correct post...
-		redirect($redirect_url . ((!$post_id) ? "&amp;p=$jump_to" : "&amp;p=$post_id") . "#p$jump_to");
+		// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+		redirect(append_sid("{$phpbb_root_path}viewtopic.$phpEx", "f=$forum_id&amp;t=$topic_id" . ((!$post_id) ? "&amp;p=$jump_to" : "&amp;p=$post_id")) . "#p$jump_to");
+		// www.phpBB-SEO.com SEO TOOLKIT END
 	}
 }
 
@@ -440,7 +470,36 @@
 {
 	$start = ($start < 0) ? 0 : floor(($total_posts - 1) / $config['posts_per_page']) * $config['posts_per_page'];
 }
-
+// www.phpBB-SEO.com SEO TOOLKIT BEGIN -> Zero dupe
+$phpbb_seo->seo_opt['zero_dupe']['start'] = $phpbb_seo->seo_chk_start( $start, $config['posts_per_page'] );
+if ( $post_id && !$phpbb_seo->set_do_redir_post()) {
+	$phpbb_seo->seo_opt['zero_dupe']['redir_def'] = array(
+		'p' => array('val' => $post_id, 'keep' => true),
+		'hilit' => array('val' => (($highlight_match) ? $highlight : ''), 'keep' => !empty($highlight)),
+	);
+} else {
+	$seo_watch = request_var('watch', '');
+	$seo_unwatch = request_var('unwatch', '');
+	$seo_bookmark = request_var('bookmark', 0);
+	$keep_watch = (boolean) ($seo_watch == 'topic' && $user->data['is_registered']);
+	$keep_unwatch = (boolean) ($seo_unwatch == 'topic' && $user->data['is_registered']);
+	$phpbb_seo->seo_opt['zero_dupe']['redir_def'] = array(
+		'f' => array('val' => $forum_id, 'keep' => true, 'force' => true),
+		't' => array('val' => $topic_id, 'keep' => true, 'force' => true),
+		'p' => array('val' => $post_id, 'keep' =>  ($view == 'show' ? true : false)),
+		'watch' => array('val' => $seo_watch, 'keep' => $keep_watch),
+		'unwatch' => array('val' => $seo_unwatch, 'keep' => $keep_unwatch),
+		'bookmark' => array('val' => $seo_bookmark, 'keep' => (boolean) ($user->data['is_registered'] && $config['allow_bookmarks'] && $seo_bookmark)),
+		'start' => array('val' => $phpbb_seo->seo_opt['zero_dupe']['start'], 'keep' => true, 'force' => true),
+		'st' => array('val' => $sort_days, 'keep' => true),
+		'sk' => array('val' => $sort_key, 'keep' => true),
+		'sd' => array('val' => $sort_dir, 'keep' => true),
+		'view' => array('val' => $view, 'keep' => $view == 'print' ? (boolean) $auth->acl_get('f_print', $forum_id) : true),
+		'hilit' => array('val' => (($highlight_match) ? $highlight : ''), 'keep' => (boolean) !(!$user->data['is_registered'] && $phpbb_seo->seo_opt['rem_hilit'])),
+	);
+}
+$phpbb_seo->seo_chk_dupe();
+// www.phpBB-SEO.com SEO TOOLKIT END -> Zero dupe
 // General Viewtopic URL for return links
 $viewtopic_url = append_sid("{$phpbb_root_path}viewtopic.$phpEx", "f=$forum_id&amp;t=$topic_id&amp;start=$start&amp;$u_sort_param" . (($highlight_match) ? "&amp;hilit=$highlight" : ''));
 
@@ -596,14 +655,18 @@
 	'U_VIEW_FORUM' 			=> append_sid("{$phpbb_root_path}viewforum.$phpEx", 'f=' . $forum_id),
 	'U_VIEW_OLDER_TOPIC'	=> append_sid("{$phpbb_root_path}viewtopic.$phpEx", "f=$forum_id&amp;t=$topic_id&amp;view=previous"),
 	'U_VIEW_NEWER_TOPIC'	=> append_sid("{$phpbb_root_path}viewtopic.$phpEx", "f=$forum_id&amp;t=$topic_id&amp;view=next"),
-	'U_PRINT_TOPIC'			=> ($auth->acl_get('f_print', $forum_id)) ? $viewtopic_url . '&amp;view=print' : '',
+	// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+	'U_PRINT_TOPIC'			=> ($auth->acl_get('f_print', $forum_id)) ? append_sid("{$phpbb_root_path}viewtopic.$phpEx", "f=$forum_id&amp;t=$topic_id&amp;start=$start&amp;$u_sort_param&amp;view=print" . (($highlight_match) ? "&amp;hilit=$highlight" : '')) : '',
+	// www.phpBB-SEO.com SEO TOOLKIT END
 	'U_EMAIL_TOPIC'			=> ($auth->acl_get('f_email', $forum_id) && $config['email_enable']) ? append_sid("{$phpbb_root_path}memberlist.$phpEx", "mode=email&amp;t=$topic_id") : '',
 
 	'U_WATCH_TOPIC' 		=> $s_watching_topic['link'],
 	'L_WATCH_TOPIC' 		=> $s_watching_topic['title'],
 	'S_WATCHING_TOPIC'		=> $s_watching_topic['is_watching'],
 
-	'U_BOOKMARK_TOPIC'		=> ($user->data['is_registered'] && $config['allow_bookmarks']) ? $viewtopic_url . '&amp;bookmark=1' : '',
+	// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+	'U_BOOKMARK_TOPIC'		=> ($user->data['is_registered'] && $config['allow_bookmarks']) ? append_sid("{$phpbb_root_path}viewtopic.$phpEx", "f=$forum_id&amp;t=$topic_id&amp;bookmark=1") : '',
+	// www.phpBB-SEO.com SEO TOOLKIT END
 	'L_BOOKMARK_TOPIC'		=> ($user->data['is_registered'] && $config['allow_bookmarks'] && $topic_data['bookmarked']) ? $user->lang['BOOKMARK_TOPIC_REMOVE'] : $user->lang['BOOKMARK_TOPIC'],
 
 	'U_POST_NEW_TOPIC' 		=> ($auth->acl_get('f_post', $forum_id) || $user->data['user_id'] == ANONYMOUS) ? append_sid("{$phpbb_root_path}posting.$phpEx", "mode=post&amp;f=$forum_id") : '',
@@ -826,7 +889,9 @@
 		'S_IS_MULTI_CHOICE'	=> ($topic_data['poll_max_options'] > 1) ? true : false,
 		'S_POLL_ACTION'		=> $viewtopic_url,
 
-		'U_VIEW_RESULTS'	=> $viewtopic_url . '&amp;view=viewpoll')
+		// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+		'U_VIEW_RESULTS'	=> append_sid("{$phpbb_root_path}viewtopic.$phpEx", "f=$forum_id&amp;t=$topic_id&amp;view=viewpoll") )
+		// www.phpBB-SEO.com SEO TOOLKIT END
 	);
 
 	unset($poll_end, $poll_info, $voted_id);
@@ -930,7 +995,9 @@
 	}
 
 	$poster_id = $row['poster_id'];
-
+	// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+	$phpbb_seo->set_user_url( $row['username'], $poster_id );
+	// www.phpBB-SEO.com SEO TOOLKIT END
 	// Does post have an attachment? If so, add it to the list
 	if ($row['post_attachment'] && $config['allow_attachments'])
 	{
@@ -1259,7 +1326,24 @@
 
 	// Parse the message and subject
 	$message = censor_text($row['post_text']);
-
+	// www.phpBB-SEO.com SEO TOOLKIT BEGIN  - META
+	if ($i == 0) {
+		$m_kewrd = '';
+		$seo_meta->meta['meta_desc'] = $seo_meta->meta_filter_txt($message);
+		$sql = "SELECT w.word_text
+			FROM " . SEARCH_WORDMATCH_TABLE . " m, " . SEARCH_WORDLIST_TABLE . " w
+			WHERE m.post_id = {$row['post_id']}
+				AND w.word_id = m.word_id
+				ORDER BY w.word_count DESC";
+		if( ($result = $db->sql_query_limit($sql, 15)) ) {
+			while ( $meta_row = $db->sql_fetchrow($result) ) {
+				$m_kewrd .= " " . $meta_row['word_text'];
+			}
+		}
+		$db->sql_freeresult($result);
+		$seo_meta->meta['keywords'] = !empty($m_kewrd) ? $seo_meta->make_keywords( $m_kewrd ) : $seo_meta->make_keywords($seo_meta->meta['meta_desc']);
+	}
+	// www.phpBB-SEO.com SEO TOOLKIT END  - META
 	// Second parse bbcode here
 	if ($row['bbcode_bitfield'])
 	{
@@ -1431,7 +1515,9 @@
 		'U_REPORT'			=> ($auth->acl_get('f_report', $forum_id)) ? append_sid("{$phpbb_root_path}report.$phpEx", 'f=' . $forum_id . '&amp;p=' . $row['post_id']) : '',
 		'U_MCP_REPORT'		=> ($auth->acl_get('m_report', $forum_id)) ? append_sid("{$phpbb_root_path}mcp.$phpEx", 'i=reports&amp;mode=report_details&amp;f=' . $forum_id . '&amp;p=' . $row['post_id'], true, $user->session_id) : '',
 		'U_MCP_APPROVE'		=> ($auth->acl_get('m_approve', $forum_id)) ? append_sid("{$phpbb_root_path}mcp.$phpEx", 'i=queue&amp;mode=approve_details&amp;f=' . $forum_id . '&amp;p=' . $row['post_id'], true, $user->session_id) : '',
-		'U_MINI_POST'		=> append_sid("{$phpbb_root_path}viewtopic.$phpEx", 'p=' . $row['post_id']) . (($topic_data['topic_type'] == POST_GLOBAL) ? '&amp;f=' . $forum_id : '') . '#p' . $row['post_id'],
+		// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+		'U_MINI_POST'		=> $phpbb_seo->seo_opt['no_dupe']['on'] ? append_sid("{$phpbb_root_path}viewtopic.$phpEx", 't=' . $topic_id . '&amp;f=' . $forum_id . '&amp;start=' . $start ) . '#p' . $row['post_id'] : append_sid("{$phpbb_root_path}viewtopic.$phpEx", 'p=' . $row['post_id'] . (($topic_data['topic_type'] == POST_GLOBAL) ? '&amp;f=' . $forum_id : '')) . '#p' . $row['post_id'],
+		// www.phpBB-SEO.com SEO TOOLKIT END
 		'U_NEXT_POST_ID'	=> ($i < $i_total && isset($rowset[$post_list[$i + 1]])) ? $rowset[$post_list[$i + 1]]['post_id'] : '',
 		'U_PREV_POST_ID'	=> $prev_post_id,
 		'U_NOTES'			=> ($auth->acl_getf_global('m_')) ? append_sid("{$phpbb_root_path}mcp.$phpEx", 'i=notes&amp;mode=user_notes&amp;u=' . $poster_id, true, $user->session_id) : '',
@@ -1451,7 +1537,9 @@
 		'S_TOPIC_POSTER'	=> ($topic_data['topic_poster'] == $poster_id) ? true : false,
 
 		'S_IGNORE_POST'		=> ($row['hide_post']) ? true : false,
-		'L_IGNORE_POST'		=> ($row['hide_post']) ? sprintf($user->lang['POST_BY_FOE'], get_username_string('full', $poster_id, $row['username'], $row['user_colour'], $row['post_username']), '<a href="' . $viewtopic_url . "&amp;p={$row['post_id']}&amp;view=show#p{$row['post_id']}" . '">', '</a>') : '',
+		// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+		'L_IGNORE_POST'		=> ($row['hide_post']) ? sprintf($user->lang['POST_BY_FOE'], get_username_string('full', $poster_id, $row['username'], $row['user_colour'], $row['post_username']), '<a href="' . append_sid("{$phpbb_root_path}viewtopic.$phpEx", "f=$forum_id&amp;t=$topic_id&amp;p={$row['post_id']}&amp;view=show") . '#p' . $row['post_id'] . '">', '</a>') : '',
+		// www.phpBB-SEO.com SEO TOOLKIT END
 	);
 
 	if (isset($cp_row['row']) && sizeof($cp_row['row']))
@@ -1525,7 +1613,9 @@
 	if ($post_unread)
 	{
 		$template->assign_vars(array(
-			'U_VIEW_UNREAD_POST'	=> '#unread',
+			// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+			'U_VIEW_UNREAD_POST'	=> append_sid("{$phpbb_root_path}viewtopic.$phpEx", "f=$forum_id&amp;t=$topic_id&amp;start=$start") . '#unread',
+			// www.phpBB-SEO.com SEO TOOLKIT END
 		));
 	}
 	else if (isset($topic_tracking_info[$topic_id]) && $topic_data['topic_last_post_time'] > $topic_tracking_info[$topic_id])
@@ -1543,7 +1633,9 @@
 	if ($last_page && $post_unread)
 	{
 		$template->assign_vars(array(
-			'U_VIEW_UNREAD_POST'	=> '#unread',
+			// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+			'U_VIEW_UNREAD_POST'	=> append_sid("{$phpbb_root_path}viewtopic.$phpEx", "f=$forum_id&amp;t=$topic_id&amp;start=$start") . '#unread',
+			// www.phpBB-SEO.com SEO TOOLKIT END
 		));
 	}
 	else if (!$last_page)
@@ -1563,7 +1655,10 @@
 }
 
 // Output the page
-page_header($user->lang['VIEW_TOPIC'] .' - ' . $topic_data['topic_title']);
+// www.phpBB-SEO.com SEO TOOLKIT BEGIN - TITLE
+$extra_title = ($start > 0) ? ' - ' . $user->lang['Page'] . ( floor( ($start / $config['posts_per_page']) ) + 1 ) : '';
+page_header($topic_data['topic_title'] . ' : ' .  $topic_data['forum_name'] . $extra_title);
+// www.phpBB-SEO.com SEO TOOLKIT END - TITLE
 
 $template->set_filenames(array(
 	'body' => ($view == 'print') ? 'viewtopic_print.html' : 'viewtopic_body.html')
@@ -1572,4 +1667,4 @@
 
 page_footer();
 
-?>
\ No newline at end of file
+?>
Index: phpbb_seo/docs/COPYING
===================================================================
--- phpbb_seo/docs/COPYING	(revision 0)
+++ phpbb_seo/docs/COPYING	(revision 161)
@@ -0,0 +1,620 @@
+
+RECIPROCAL PUBLIC LICENSE
+
+Version 1.1, November 1, 2002
+
+Copyright (C) 2001-2002
+
+Technical Pursuit Inc.,
+
+All Rights Reserved.
+
+PREAMBLE
+
+This Preamble is intended to describe, in plain English, the nature,
+intent, and scope of this License. However, this Preamble is not a part
+of this License. The legal effect of this License is dependent only upon
+the terms of the License and not this Preamble.
+
+This License is based on the concept of reciprocity. In exchange for
+being granted certain rights under the terms of this License to
+Licensor's Software, whose Source Code You have access to, You are
+required to reciprocate by providing equal access and rights to all
+third parties to the Source Code of any Modifications, Derivative Works,
+and Required Components for execution of same (collectively defined as
+Extensions) that You Deploy by Deploying Your Extensions under the terms
+of this License. In this fashion the available Source Code related to
+the original Licensed Software is enlarged for the benefit of everyone.
+
+Under the terms of this License You may:
+
+a. Distribute the Licensed Software exactly as You received it under the
+terms of this License either alone or as a component of an aggregate
+software distribution containing programs from several different
+sources without payment of a royalty or other fee.
+
+b. Use the Licensed Software for any purpose consistent with the rights
+granted by this License, but the Licensor is not providing You any
+warranty whatsoever, nor is the Licensor accepting any liability in
+the event that the Licensed Software doesn't work properly or causes
+You any injury or damages.
+
+c. Create Extensions to the Licensed Software consistent with the rights
+granted by this License, provided that You make the Source Code to
+any Extensions You Deploy available to all third parties under the
+terms of this License, document Your Modifications clearly, and title
+all Extensions distinctly from the Licensed Software.
+
+d. Charge a fee for warranty or support, or for accepting indemnity or
+liability obligations for Your customers.
+
+Under the terms of this License You may not:
+
+a. Charge for the Source Code to the Licensed Software, or Your
+Extensions, other than a nominal fee not to exceed Your cost for
+reproduction and distribution where such reproduction and
+distribution involve physical media.
+
+b. Modify or delete any pre-existing copyright notices, change notices,
+or License text in the Licensed Software.
+
+c. Assert any patent claims against the Licensor or Contributors, or
+which would in any way restrict the ability of any third party to use
+the Licensed Software or portions thereof in any form under the terms
+of this License, or Your rights to the Licensed Software under this
+License automatically terminate.
+
+d. Represent either expressly or by implication, appearance, or
+otherwise that You represent Licensor or Contributors in any capacity
+or that You have any form of legal association by virtue of this
+License.
+
+Under the terms of this License You must:
+
+a. Document any Modifications You make to the Licensed Software
+including the nature of the change, the authors of the change, and
+the date of the change. This documentation must appear both in the
+Source Code and in a text file titled "CHANGES" distributed with the
+Licensed Software and Your Extensions.
+
+b. Make the Source Code for any Extensions You Deploy available in a
+timely fashion via an Electronic Distribution Mechanism such as FTP
+or HTTP download.
+
+c. Notify the Licensor of the availability of Source Code to Your
+Extensions in a timely fashion and include in such notice a brief
+description of the Extensions, the distinctive title used, and
+instructions on how to acquire the Source Code and future updates.
+
+d. Grant Licensor and all third parties a world-wide, non-exclusive,
+royalty-free license under any intellectual property rights owned or
+controlled by You to use, reproduce, display, perform, modify,
+sublicense, and distribute Your Extensions, in any form, under the
+terms of this License.
+
+LICENSE TERMS
+
+1.0 General; Applicability & Definitions. This Reciprocal Public License
+Version 1.1 ("License") applies to any programs or other works as well
+as any and all updates or maintenance releases of said programs or works
+("Software") not already covered by this License which the Software
+copyright holder ("Licensor") makes publicly available containing a
+Notice (hereinafter defined) from the Licensor specifying or allowing
+use or distribution under the terms of this License. As used in this
+License and Preamble:
+
+1.1 "Contributor" means any person or entity who created or contributed
+to the creation of an Extension.
+
+1.2 "Deploy" means to use, Serve, sublicense or distribute Licensed
+Software other than for Your internal Research and/or Personal Use, and
+includes without limitation, any and all internal use or distribution of
+Licensed Software within Your business or organization other than for
+Research and/or Personal Use, as well as direct or indirect sublicensing
+or distribution of Licensed Software by You to any third party in any
+form or manner.
+
+1.3 "Derivative Works" as used in this License is defined under U.S.
+copyright law.
+
+1.4 "Electronic Distribution Mechanism" means a mechanism generally
+accepted in the software development community for the electronic
+transfer of data such as download from an FTP or web site, where such
+mechanism is publicly accessible.
+
+1.5 "Extensions" means any Modifications, Derivative Works, or Required
+Components as those terms are defined in this License.
+
+1.6 "License" means this Reciprocal Public License.
+
+1.7 "Licensed Software" means any Software licensed pursuant to this
+License. Licensed Software also includes all previous Extensions from
+any Contributor that You receive.
+
+1.8 "Licensor" means the copyright holder of any Software previously
+uncovered by this License who releases the Software under the terms of
+this License.
+
+1.9 "Modifications" means any additions to or deletions from the
+substance or structure of (i) a file or other storage containing
+Licensed Software, or (ii) any new file or storage that contains any
+part of Licensed Software, or (iii) any file or storage which replaces
+or otherwise alters the original functionality of Licensed Software at
+runtime.
+
+1.10 "Notice" means the notice contained in EXHIBIT A.
+
+1.11 "Personal Use" means use of Licensed Software by an individual
+solely for his or her personal, private and non-commercial purposes. An
+individual's use of Licensed Software in his or her capacity as an
+officer, employee, member, independent contractor or agent of a
+corporation, business or organization (commercial or non-commercial)
+does not qualify as Personal Use.
+
+1.12 "Required Components" means any text, programs, scripts, schema,
+interface definitions, control files, or other works created by You
+which are required by a third party of average skill to successfully
+install and run Licensed Software containing Your Modifications, or to
+install and run Your Derivative Works.
+
+1.13 "Research" means investigation or experimentation for the purpose
+of understanding the nature and limits of the Licensed Software and its
+potential uses.
+
+1.14 "Serve" means to deliver Licensed Software and/or Your Extensions
+by means of a computer network to one or more computers for purposes of
+execution of Licensed Software and/or Your Extensions.
+
+1.15 "Software" means any computer programs or other works as well as
+any updates or maintenance releases of those programs or works which are
+distributed publicly by Licensor.
+
+1.16 "Source Code" means the preferred form for making modifications to
+the Licensed Software and/or Your Extensions, including all modules
+contained therein, plus any associated text, interface definition files,
+scripts used to control compilation and installation of an executable
+program or other components required by a third party of average skill
+to build a running version of the Licensed Software or Your Extensions.
+
+1.17 "You" or "Your" means an individual or a legal entity exercising
+rights under this License. For legal entities, "You" or "Your" includes
+any entity which controls, is controlled by, or is under common control
+with, You, where "control" means (a) the power, direct or indirect, to
+cause the direction or management of such entity, whether by contract
+or otherwise, or (b) ownership of fifty percent (50%) or more of the
+outstanding shares or beneficial ownership of such entity.
+
+2.0 Acceptance Of License. You are not required to accept this License
+since you have not signed it, however nothing else grants you permission
+to use, copy, distribute, modify, or create derivatives of either the
+Software or any Extensions created by a Contributor. These actions are
+prohibited by law if you do not accept this License. Therefore, by
+performing any of these actions You indicate Your acceptance of this
+License and Your agreement to be bound by all its terms and conditions.
+IF YOU DO NOT AGREE WITH ALL THE TERMS AND CONDITIONS OF THIS LICENSE DO
+NOT USE, MODIFY, CREATE DERIVATIVES, OR DISTRIBUTE THE SOFTWARE. IF IT
+IS IMPOSSIBLE FOR YOU TO COMPLY WITH ALL THE TERMS AND CONDITIONS OF
+THIS LICENSE THEN YOU CAN NOT USE, MODIFY, CREATE DERIVATIVES, OR
+DISTRIBUTE THE SOFTWARE.
+
+3.0 Grant of License From Licensor. Subject to the terms and conditions
+of this License, Licensor hereby grants You a world-wide, royalty-free,
+non-exclusive license, subject to Licensor's intellectual property
+rights, and any third party intellectual property claims derived from
+the Licensed Software under this License, to do the following:
+
+3.1 Use, reproduce, modify, display, perform, sublicense and distribute
+Licensed Software and Your Extensions in both Source Code form or as an
+executable program.
+
+3.2 Create Derivative Works (as that term is defined under U.S.
+copyright law) of Licensed Software by adding to or deleting from the
+substance or structure of said Licensed Software.
+
+3.3 Under claims of patents now or hereafter owned or controlled by
+Licensor, to make, use, have made, and/or otherwise dispose of Licensed
+Software or portions thereof, but solely to the extent that any such
+claim is necessary to enable You to make, use, have made, and/or
+otherwise dispose of Licensed Software or portions thereof.
+
+3.4 Licensor reserves the right to release new versions of the Software
+with different features, specifications, capabilities, functions,
+licensing terms, general availability or other characteristics. Title,
+ownership rights, and intellectual property rights in and to the
+Licensed Software shall remain in Licensor and/or its Contributors.
+
+4.0 Grant of License From Contributor. By application of the provisions
+in Section 6 below, each Contributor hereby grants You a world-wide,
+royalty-free, non-exclusive license, subject to said Contributor's
+intellectual property rights, and any third party intellectual property
+claims derived from the Licensed Software under this License, to do the
+following:
+
+4.1 Use, reproduce, modify, display, perform, sublicense and distribute
+any Extensions Deployed by such Contributor or portions thereof, in both
+Source Code form or as an executable program, either on an unmodified
+basis or as part of Derivative Works.
+
+4.2 Under claims of patents now or hereafter owned or controlled by
+Contributor, to make, use, have made, and/or otherwise dispose of
+Extensions or portions thereof, but solely to the extent that any such
+claim is necessary to enable You to make, use, have made, and/or
+otherwise dispose of Contributor's Extensions or portions thereof.
+
+5.0 Exclusions From License Grant. Nothing in this License shall be
+deemed to grant any rights to trademarks, copyrights, patents, trade
+secrets or any other intellectual property of Licensor or any
+Contributor except as expressly stated herein. Except as expressly
+stated in Sections 3 and 4, no other patent rights, express or implied,
+are granted herein. Your Extensions may require additional patent
+licenses from Licensor or Contributors which each may grant in its sole
+discretion. No right is granted to the trademarks of Licensor or any
+Contributor even if such marks are included in the Licensed Software.
+Nothing in this License shall be interpreted to prohibit Licensor from
+licensing under different terms from this License any code that Licensor
+otherwise would have a right to license.
+
+5.1 You expressly acknowledge and agree that although Licensor and each
+Contributor grants the licenses to their respective portions of the
+Licensed Software set forth herein, no assurances are provided by
+Licensor or any Contributor that the Licensed Software does not infringe
+the patent or other intellectual property rights of any other entity.
+Licensor and each Contributor disclaim any liability to You for claims
+brought by any other entity based on infringement of intellectual
+property rights or otherwise. As a condition to exercising the rights
+and licenses granted hereunder, You hereby assume sole responsibility to
+secure any other intellectual property rights needed, if any. For
+example, if a third party patent license is required to allow You to
+distribute the Licensed Software, it is Your responsibility to acquire
+that license before distributing the Licensed Software.
+
+6.0 Your Obligations And Grants. In consideration of, and as an express
+condition to, the licenses granted to You under this License You hereby
+agree that any Modifications, Derivative Works, or Required Components
+(collectively Extensions) that You create or to which You contribute are
+governed by the terms of this License including, without limitation,
+Section 4. Any Extensions that You create or to which You contribute
+must be Deployed under the terms of this License or a future version
+of this License released under Section 7. You hereby grant to Licensor
+and all third parties a world-wide, non-exclusive, royalty-free license
+under those intellectual property rights You own or control to use,
+reproduce, display, perform, modify, create derivatives, sublicense, and
+distribute Your Extensions, in any form. Any Extensions You make and
+Deploy must have a distinct title so as to readily tell any subsequent
+user or Contributor that the Extensions are by You. You must include a
+copy of this License with every copy of the Extensions You distribute.
+You agree not to offer or impose any terms on any Source Code or
+executable version of the Licensed Software, or its Extensions that
+alter or restrict the applicable version of this License or the
+recipients' rights hereunder.
+
+6.1 Availability of Source Code. You must make available, under the
+terms of this License, the Source Code of the Licensed Software and any
+Extensions that You Deploy, either on the same media as You distribute
+any executable or other form of the Licensed Software, or via an
+Electronic Distribution Mechanism. The Source Code for any version of
+Licensed Software, or its Extensions that You Deploy must be made
+available at the time of Deployment and must remain available for as
+long as You Deploy the Extensions or at least twelve (12) months after
+the date You Deploy, whichever is longer. You are responsible for
+ensuring that the Source Code version remains available even if the
+Electronic Distribution Mechanism is maintained by a third party. You
+may not charge a fee for the Source Code distributed under this Section
+in excess of Your actual cost of duplication and distribution where such
+duplication and distribution involve physical media.
+
+6.2 Description of Modifications. You must cause any Modifications that
+You create or to which You contribute, to update the file titled
+"CHANGES" distributed with Licensed Software documenting the additions,
+changes or deletions You made, the authors of such Modifications, and
+the dates of any such additions, changes or deletions. You must also
+cause a cross-reference to appear in the Source Code at the location of
+each change. You must include a prominent statement that the
+Modifications are derived, directly or indirectly, from the Licensed
+Software and include the names of the Licensor and any Contributor to
+the Licensed Software in (i) the Source Code and (ii) in any notice
+displayed by the Licensed Software You distribute or in related
+documentation in which You describe the origin or ownership of the
+Licensed Software. You may not modify or delete any pre-existing
+copyright notices, change notices or License text in the Licensed
+Software.
+
+6.3 Intellectual Property Matters.
+
+a. Third Party Claims. If You have knowledge that a license to a third
+party's intellectual property right is required to exercise the
+rights granted by this License, You must include a text file with the
+Source Code distribution titled "LEGAL" that describes the claim and
+the party making the claim in sufficient detail that a recipient will
+know whom to contact. If You obtain such knowledge after You make any
+Extensions available as described in Section 6.1, You shall promptly
+modify the LEGAL file in all copies You make available thereafter and
+shall take other steps (such as notifying appropriate mailing lists
+or newsgroups) reasonably calculated to inform those who received the
+Licensed Software from You that new knowledge has been obtained.
+
+b. Contributor APIs. If Your Extensions include an application
+programming interface ("API") and You have knowledge of patent
+licenses that are reasonably necessary to implement that API, You
+must also include this information in the LEGAL file.
+
+c. Representations. You represent that, except as disclosed pursuant to
+6.3(a) above, You believe that any Extensions You distribute are Your
+original creations and that You have sufficient rights to grant the
+rights conveyed by this License.
+
+6.4 Required Notices.
+
+a. License Text. You must duplicate this License in any documentation
+You provide along with the Source Code of any Extensions You create
+or to which You contribute, wherever You describe recipients' rights
+relating to Licensed Software. You must duplicate the notice
+contained in EXHIBIT A (the "Notice") in each file of the Source Code
+of any copy You distribute of the Licensed Software and Your
+Extensions. If You create an Extension, You may add Your name as a
+Contributor to the text file titled "CONTRIB" distributed with the
+Licensed Software along with a description of the contribution. If it
+is not possible to put the Notice in a particular Source Code file
+due to its structure, then You must include such Notice in a location
+(such as a relevant directory file) where a user would be likely to
+look for such a notice.
+
+b. Source Code Availability. You must notify Licensor within one (1)
+month of the date You initially Deploy of the availability of Source
+Code to Your Extensions and include in such notification the name
+under which you Deployed Your Extensions, a description of the
+Extensions, and instructions on how to acquire the Source Code,
+including instructions on how to acquire updates over time. Should
+such instructions change you must provide Licensor with revised
+instructions within one (1) month of the date of change. Should you
+be unable to notify Licensor directly, you must provide notification
+by posting to appropriate news groups, mailing lists, or web sites
+where a search engine would reasonably be expected to index them.
+
+6.5 Additional Terms. You may choose to offer, and charge a fee for,
+warranty, support, indemnity or liability obligations to one or more
+recipients of Licensed Software. However, You may do so only on Your
+own behalf, and not on behalf of the Licensor or any Contributor. You
+must make it clear that any such warranty, support, indemnity or
+liability obligation is offered by You alone, and You hereby agree to
+indemnify the Licensor and every Contributor for any liability plus
+attorney fees, costs, and related expenses due to any such action or
+claim incurred by the Licensor or such Contributor as a result of
+warranty, support, indemnity or liability terms You offer.
+
+6.6 Conflicts With Other Licenses. Where any portion of Your Extensions,
+by virtue of being Derivative Works of another product or similar
+circumstance, fall under the terms of another license, the terms of that
+license should be honored however You must also make Your Extensions
+available under this License. If the terms of this License continue to
+conflict with the terms of the other license you may write the Licensor
+for permission to resolve the conflict in a fashion that remains
+consistent with the intent of this License. Such permission will be
+granted at the sole discretion of the Licensor.
+
+7.0 Versions of This License. Licensor may publish from time to time
+revised and/or new versions of the License. Once Licensed Software has
+been published under a particular version of the License, You may always
+continue to use it under the terms of that version. You may also choose
+to use such Licensed Software under the terms of any subsequent version
+of the License published by Licensor. No one other than Licensor has the
+right to modify the terms applicable to Licensed Software created under
+this License.
+
+7.1 If You create or use a modified version of this License, which You
+may do only in order to apply it to software that is not already
+Licensed Software under this License, You must rename Your license so
+that it is not confusingly similar to this License, and must make it
+clear that Your license contains terms that differ from this License. In
+so naming Your license, You may not use any trademark of Licensor or of
+any Contributor. Should Your modifications to this License be limited to
+alteration of EXHIBIT A purely for purposes of adjusting the Notice You
+require of licensees, You may continue to refer to Your License as the
+Reciprocal Public License or simply the RPL.
+
+8.0 Disclaimer of Warranty. LICENSED SOFTWARE IS PROVIDED UNDER THIS
+LICENSE ON AN "AS IS" BASIS, WITHOUT WARRANTY OF ANY KIND, EITHER
+EXPRESS OR IMPLIED, INCLUDING, WITHOUT LIMITATION, WARRANTIES THAT THE
+LICENSED SOFTWARE IS FREE OF DEFECTS, MERCHANTABLE, FIT FOR A PARTICULAR
+PURPOSE OR NON-INFRINGING. FURTHER THERE IS NO WARRANTY MADE AND ALL
+IMPLIED WARRANTIES ARE DISCLAIMED THAT THE LICENSED SOFTWARE MEETS OR
+COMPLIES WITH ANY DESCRIPTION OF PERFORMANCE OR OPERATION, SAID
+COMPATIBILITY AND SUITABILITY BEING YOUR RESPONSIBILITY. LICENSOR
+DISCLAIMS ANY WARRANTY, IMPLIED OR EXPRESSED, THAT ANY CONTRIBUTOR'S
+EXTENSIONS MEET ANY STANDARD OF COMPATIBILITY OR DESCRIPTION OF
+PERFORMANCE. THE ENTIRE RISK AS TO THE QUALITY AND PERFORMANCE OF THE
+LICENSED SOFTWARE IS WITH YOU. SHOULD LICENSED SOFTWARE PROVE DEFECTIVE
+IN ANY RESPECT, YOU (AND NOT THE LICENSOR OR ANY OTHER CONTRIBUTOR)
+ASSUME THE COST OF ANY NECESSARY SERVICING, REPAIR OR CORRECTION. UNDER
+THE TERMS OF THIS LICENSOR WILL NOT SUPPORT THIS SOFTWARE AND IS UNDER
+NO OBLIGATION TO ISSUE UPDATES TO THIS SOFTWARE. LICENSOR HAS NO
+KNOWLEDGE OF ERRANT CODE OR VIRUS IN THIS SOFTWARE, BUT DOES NOT WARRANT
+THAT THE SOFTWARE IS FREE FROM SUCH ERRORS OR VIRUSES. THIS DISCLAIMER
+OF WARRANTY CONSTITUTES AN ESSENTIAL PART OF THIS LICENSE. NO USE OF
+LICENSED SOFTWARE IS AUTHORIZED HEREUNDER EXCEPT UNDER THIS DISCLAIMER.
+
+9.0 Limitation of Liability. UNDER NO CIRCUMSTANCES AND UNDER NO LEGAL
+THEORY, WHETHER TORT (INCLUDING NEGLIGENCE), CONTRACT, OR OTHERWISE,
+SHALL THE LICENSOR, ANY CONTRIBUTOR, OR ANY DISTRIBUTOR OF LICENSED
+SOFTWARE, OR ANY SUPPLIER OF ANY OF SUCH PARTIES, BE LIABLE TO ANY
+PERSON FOR ANY INDIRECT, SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES
+OF ANY CHARACTER INCLUDING, WITHOUT LIMITATION, DAMAGES FOR LOSS OF
+GOODWILL, WORK STOPPAGE, COMPUTER FAILURE OR MALFUNCTION, OR ANY AND ALL
+OTHER COMMERCIAL DAMAGES OR LOSSES, EVEN IF SUCH PARTY SHALL HAVE BEEN
+INFORMED OF THE POSSIBILITY OF SUCH DAMAGES. THIS LIMITATION OF
+LIABILITY SHALL NOT APPLY TO LIABILITY FOR DEATH OR PERSONAL INJURY
+RESULTING FROM SUCH PARTY'S NEGLIGENCE TO THE EXTENT APPLICABLE LAW
+PROHIBITS SUCH LIMITATION. SOME JURISDICTIONS DO NOT ALLOW THE EXCLUSION
+OR LIMITATION OF INCIDENTAL OR CONSEQUENTIAL DAMAGES, SO THIS EXCLUSION
+AND LIMITATION MAY NOT APPLY TO YOU.
+
+10.0 High Risk Activities. THE LICENSED SOFTWARE IS NOT FAULT-TOLERANT
+AND IS NOT DESIGNED, MANUFACTURED, OR INTENDED FOR USE OR DISTRIBUTION
+AS ON-LINE CONTROL EQUIPMENT IN HAZARDOUS ENVIRONMENTS REQUIRING
+FAIL-SAFE PERFORMANCE, SUCH AS IN THE OPERATION OF NUCLEAR FACILITIES,
+AIRCRAFT NAVIGATION OR COMMUNICATIONS SYSTEMS, AIR TRAFFIC CONTROL,
+DIRECT LIFE SUPPORT MACHINES, OR WEAPONS SYSTEMS, IN WHICH THE FAILURE
+OF THE LICENSED SOFTWARE COULD LEAD DIRECTLY TO DEATH, PERSONAL INJURY,
+OR SEVERE PHYSICAL OR ENVIRONMENTAL DAMAGE ("HIGH RISK ACTIVITIES").
+LICENSOR AND CONTRIBUTORS SPECIFICALLY DISCLAIM ANY EXPRESS OR IMPLIED
+WARRANTY OF FITNESS FOR HIGH RISK ACTIVITIES.
+
+11.0 Responsibility for Claims. As between Licensor and Contributors,
+each party is responsible for claims and damages arising, directly or
+indirectly, out of its utilization of rights under this License which
+specifically disclaims warranties and limits any liability of the
+Licensor. This paragraph is to be used in conjunction with and
+controlled by the Disclaimer Of Warranties of Section 8, the Limitation
+Of Damages in Section 9, and the disclaimer against use for High Risk
+Activities in Section 10. The Licensor has thereby disclaimed all
+warranties and limited any damages that it is or may be liable for. You
+agree to work with Licensor and Contributors to distribute such
+responsibility on an equitable basis consistent with the terms of this
+License including Sections 8, 9, and 10. Nothing herein is intended or
+shall be deemed to constitute any admission of liability.
+
+12.0 Termination. This License and all rights granted hereunder will
+terminate immediately in the event of the circumstances described in
+Section 13.6 or if applicable law prohibits or restricts You from
+fully and or specifically complying with Sections 3, 4 and/or 6, or
+prevents the enforceability of any of those Sections, and You must
+immediately discontinue any use of Licensed Software.
+
+12.1 Automatic Termination Upon Breach. This License and the rights
+granted hereunder will terminate automatically if You fail to comply
+with the terms herein and fail to cure such breach within thirty (30)
+days of becoming aware of the breach. All sublicenses to the Licensed
+Software that are properly granted shall survive any termination of this
+License. Provisions that, by their nature, must remain in effect beyond
+the termination of this License, shall survive.
+
+12.2 Termination Upon Assertion of Patent Infringement. If You initiate
+litigation by asserting a patent infringement claim (excluding
+declaratory judgment actions) against Licensor or a Contributor
+(Licensor or Contributor against whom You file such an action is
+referred to herein as "Respondent") alleging that Licensed Software
+directly or indirectly infringes any patent, then any and all rights
+granted by such Respondent to You under Sections 3 or 4 of this License
+shall terminate prospectively upon sixty (60) days notice from
+Respondent (the "Notice Period") unless within that Notice Period You
+either agree in writing (i) to pay Respondent a mutually agreeable
+reasonably royalty for Your past or future use of Licensed Software made
+by such Respondent, or (ii) withdraw Your litigation claim with respect
+to Licensed Software against such Respondent. If within said Notice
+Period a reasonable royalty and payment arrangement are not mutually
+agreed upon in writing by the parties or the litigation claim is not
+withdrawn, the rights granted by Licensor to You under Sections 3 and 4
+automatically terminate at the expiration of said Notice Period.
+
+12.3 Reasonable Value of This License. If You assert a patent
+infringement claim against Respondent alleging that Licensed Software
+directly or indirectly infringes any patent where such claim is resolved
+(such as by license or settlement) prior to the initiation of patent
+infringement litigation, then the reasonable value of the licenses
+granted by said Respondent under Sections 3 and 4 shall be taken into
+account in determining the amount or value of any payment or license.
+
+12.4 No Retroactive Effect of Termination. In the event of termination
+under this Section all end user license agreements (excluding licenses
+to distributors and resellers) that have been validly granted by You or
+any distributor hereunder prior to termination shall survive
+termination.
+
+13.0 Miscellaneous.
+
+13.1 U.S. Government End Users. The Licensed Software is a "commercial
+item," as that term is defined in 48 C.F.R. 2.101 (Oct. 1995),
+consisting of "commercial computer software" and "commercial computer
+software documentation," as such terms are used in 48 C.F.R. 12.212
+(Sept. 1995). Consistent with 48 C.F.R. 12.212 and 48 C.F.R. 227.7202-1
+through 227.7202-4 (June 1995), all U.S. Government End Users acquire
+Licensed Software with only those rights set forth herein.
+
+13.2 Relationship of Parties. This License will not be construed as
+creating an agency, partnership, joint venture, or any other form of
+legal association between or among You, Licensor, or any Contributor,
+and You will not represent to the contrary, whether expressly, by
+implication, appearance, or otherwise.
+
+13.3 Independent Development. Nothing in this License will impair
+Licensor's right to acquire, license, develop, subcontract, market, or
+distribute technology or products that perform the same or similar
+functions as, or otherwise compete with, Extensions that You may
+develop, produce, market, or distribute.
+
+13.4 Consent To Breach Not Waiver. Failure by Licensor or Contributor to
+enforce any provision of this License will not be deemed a waiver of
+future enforcement of that or any other provision.
+
+13.5 Severability. This License represents the complete agreement
+concerning the subject matter hereof. If any provision of this License
+is held to be unenforceable, such provision shall be reformed only to
+the extent necessary to make it enforceable.
+
+13.6 Inability to Comply Due to Statute or Regulation. If it is
+impossible for You to comply with any of the terms of this License with
+respect to some or all of the Licensed Software due to statute, judicial
+order, or regulation, then You cannot use, modify, or distribute the
+software.
+
+13.7 Export Restrictions. You may be restricted with respect to
+downloading or otherwise acquiring, exporting, or reexporting the
+Licensed Software or any underlying information or technology by United
+States and other applicable laws and regulations. By downloading or by
+otherwise obtaining the Licensed Software, You are agreeing to be
+responsible for compliance with all applicable laws and regulations.
+
+13.8 Arbitration, Jurisdiction & Venue. This License shall be governed
+by Colorado law provisions (except to the extent applicable law, if any,
+provides otherwise), excluding its conflict-of-law provisions. You
+expressly agree that any dispute relating to this License shall be
+submitted to binding arbitration under the rules then prevailing of the
+American Arbitration Association. You further agree that Adams County,
+Colorado USA is proper venue and grant such arbitration proceeding
+jurisdiction as may be appropriate for purposes of resolving any dispute
+under this License. Judgement upon any award made in arbitration may be
+entered and enforced in any court of competent jurisdiction. The
+arbitrator shall award attorney's fees and costs of arbitration to the
+prevailing party. Should either party find it necessary to enforce its
+arbitration award or seek specific performance of such award in a civil
+court of competent jurisdiction, the prevailing party shall be entitled
+to reasonable attorney's fees and costs. The application of the United
+Nations Convention on Contracts for the International Sale of Goods is
+expressly excluded. You and Licensor expressly waive any rights to a
+jury trial in any litigation concerning Licensed Software or this
+License. Any law or regulation that provides that the language of a
+contract shall be construed against the drafter shall not apply to this
+License.
+
+13.9 Entire Agreement. This License constitutes the entire agreement
+between the parties with respect to the subject matter hereof.
+
+EXHIBIT A
+
+The Notice below must appear in each file of the Source Code of any copy
+You distribute of the Licensed Software or any Extensions thereto,
+except as may be modified as allowed under the terms of Section 7.1
+
+    Copyright (C) 1999-2002 Technical Pursuit Inc., All Rights
+    Reserved. Patent Pending, Technical Pursuit Inc.
+
+    Unless explicitly acquired and licensed from Licensor under the
+    Technical Pursuit License ("TPL") Version 1.0 or greater, the
+    contents of this file are subject to the Reciprocal Public License
+    ("RPL") Version 1.1, or subsequent versions as allowed by the RPL,
+    and You may not copy or use this file in either source code or
+    executable form, except in compliance with the terms and conditions
+    of the RPL.
+
+    You may obtain a copy of both the TPL and the RPL (the "Licenses")
+    from Technical Pursuit Inc. at http://www.technicalpursuit.com.
+
+    All software distributed under the Licenses is provided strictly on
+    an "AS IS" basis, WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR
+    IMPLIED, AND TECHNICAL PURSUIT INC. HEREBY DISCLAIMS ALL SUCH
+    WARRANTIES, INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF
+    MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT,
+    OR NON-INFRINGEMENT. See the Licenses for specific language
+    governing rights and limitations under the Licenses. 
+
+
Index: phpbb_seo/.htaccess
===================================================================
--- phpbb_seo/.htaccess	(revision 0)
+++ phpbb_seo/.htaccess	(revision 161)
@@ -0,0 +1,13 @@
+<Files cache/*>
+Order Allow,Deny
+Deny from All
+</Files>
+<Files "phpbb_seo_class.php">
+Order Allow,Deny
+Deny from All
+</Files>
+<Limit PUT DELETE>
+Order Allow,Deny
+Deny from All
+</Limit>
+Options -Indexes
Index: phpbb_seo/phpbb_seo_class.php
===================================================================
--- phpbb_seo/phpbb_seo_class.php	(revision 0)
+++ phpbb_seo/phpbb_seo_class.php	(revision 161)
@@ -0,0 +1,990 @@
+<?php
+/** 
+*
+* @package Advanced phpBB3 SEO mod Rewrite
+* @version $Id: phpbb_seo_class.php dcz Exp $
+* @copyright (c) 2006, 2007, 2008 dcz - www.phpbb-seo.com
+* @license http://www.opensource.org/licenses/rpl.php RPL Public License 
+*
+*/
+/**
+* phpBB_SEO Class
+* www.phpBB-SEO.com
+* @package Advanced phpBB3 SEO mod Rewrite
+*/
+class phpbb_seo {
+	var	$version = '0.4.2';
+	var	$modrtype = 0;
+	var	$seo_paths = array();
+	var	$seo_url = array();
+	var	$seo_censored = array();
+	var	$seo_delim = array();
+	var	$seo_ext = array();
+	var	$seo_static = array();
+	var	$seo_url_filter = array();
+	var	$get_vars = array();
+	var	$path = '';
+	var	$start = '';
+	var	$filename = '';
+	var	$file = '';
+	var	$url_in = '';
+	var	$url = '';
+	var	$page_url = '';
+	var	$seo_opt = array();
+	var	$rewrite_functions = array();
+	var	$seo_cache = array();
+	var	$encoding = 'utf-8';
+	var	$cache_config = array();
+	/**
+	* constuctor
+	*/
+	function phpbb_seo() {
+		global $phpEx, $config, $phpbb_root_path;
+		// config
+		$this->modrtype =  3; // 3 = Advanced
+		$this->seo_cache = array();
+		$this->cache_config = array();
+		$this->seo_censored = array();
+		$this->start = $this->path = '';
+		// URL Settings
+		// The arrays where the preformated titles are stored.
+		$this->seo_url = array( 'forum' =>  array(), 'topic' =>  array(), 'user' => array(), 'username' => array(), 'group' => array() );
+		// URL Filters
+		$this->phpbb_filter = array( 'forum' => array('st' => 0, 'sk' => 't', 'sd' => 'd'),
+			'topic' => array('st' => 0, 'sk' => 't', 'sd' => 'a', 'hilit' => ''),
+			'search' => array('st' => 0, 'sk' => 't', 'sd' => 'd', 'ch' => ''),
+		);
+		// Stop files
+		$this->seo_stop_files = array('posting', 'faq', 'ucp', 'swatch', 'mcp');
+		// Stop vars
+		$this->seo_stop_vars = array('view=', 'mark=', 'watch=');
+		// reset GET var array
+		$this->get_vars = array();
+		// Delimiters : used as separators in the .htaccess RegEx
+		// can be edited, requires .htaccess update.
+		$this->seo_delim = array( 'forum' => '-f', 'topic' => '-t', 'user' => '-u', 'group' => '-g', 'start' => '-', 'sr' => '-');
+		// Default : Used as URL when format_url would return nothing or with simple URLs
+		// can be edited, requires .htaccess update.
+		$this->seo_static = array( 'forum' => 'forum', 'topic' => 'topic', 'post' => 'post', 'user' => 'member', 'group' => 'group', 'index' => '', 'global_announce' => 'announces', 'leaders' => 'the-team', 'atopic' => 'active-topics', 'utopic' => 'unanswered', 'npost' => 'newposts', 'pagination' => 'page', 'gz_ext' => '.gz' );
+		// URL suffixes, for the phpBB URLs
+		// can be edited, requires .htaccess update.
+		$this->seo_ext = array( 'forum' => '.html', 'topic' => '.html', 'post' => '.html', 'user' => '.html', 'group' => '.html',  'index' => '', 'global_announce' => '/', 'leaders' => '.html', 'atopic' => '.html', 'utopic' => '.html', 'npost' => '.html', 'pagination' => '.html', 'gz_ext' => '');
+		// These options can be set and bypassed from the phpBB SEO settings page
+		// You can safely mod the default values here.
+		$this->seo_opt = array( 'url_rewrite' => false,
+			'modrtype' => intval($this->modrtype),
+			'profile_inj' => false,
+			'profile_vfolder' => false,
+			'profile_noids' => false,
+			'rewrite_usermsg' => false,
+			'rem_sid' => false,
+			'rem_hilit' => true,
+			'rem_small_words' => false,
+			'virtual_folder' => false,
+			'virtual_root' => false,
+			'cache_layer' => true, // Forum url caching, by default
+			'rem_ids' => false,
+		);
+		// Options that may be bypassed by the cached settings.
+		$this->cache_config['dynamic_options'] = array_keys($this->seo_opt); // Do not change
+		// copyright notice, do not change
+		$this->cache_config['dynamic_options']['copyrights'] = $this->seo_opt['copyrights'] = array('img' => true,
+			'txt' => '',
+			'title' => '',
+		);
+		// --> No Dupe
+		$this->seo_opt['no_dupe']['on'] = $this->cache_config['dynamic_options']['no_dupe']['on'] = false;
+		// <-- No Dupe
+		// --> Zero Dupe
+		$this->seo_opt['zero_dupe'] = array( 'on' => false, // Activate or not the redirections : true / false
+			'strict' => false, // strict compare, == VS strpos() : true / false
+			'post_redir' => 'guest', // Redirect post urls if not valid ? : guest / all / post / off
+		);
+		$this->cache_config['dynamic_options']['zero_dupe'] = $this->seo_opt['zero_dupe']; // Do not change
+		$this->seo_opt['zero_dupe']['do_redir'] = false; // do not change
+		$this->seo_opt['zero_dupe']['go_redir'] = true; // do not change
+		$this->seo_opt['zero_dupe']['do_redir_post'] = false; // do not change
+		$this->seo_opt['zero_dupe']['start'] = 0; // do not change
+		$this->seo_opt['zero_dupe']['redir_def'] = array(); // do not change
+		// <-- Zero Dupe
+		// Caching config
+		$this->seo_opt['cache_folder'] = 'phpbb_seo/cache/'; // Folder where the cache file is stored
+		define('SEO_CACHE_PATH', rtrim(phpbb_realpath($phpbb_root_path . $this->seo_opt['cache_folder']), '/') . '/'); // do not change
+		$this->seo_opt['topic_type'] = array(); // do not change
+		$this->seo_opt['topic_last_page'] = array(); // do not change
+		$this->cache_config['cache_enable'] = true; // do not change
+		$this->cache_config['rem_ids'] = $this->seo_opt['rem_ids']; // do not change, set up above
+		$this->cache_config['files'] = array('forum' => 'phpbb_cache.' . $phpEx, 'htaccess' => '.htaccess');
+		$this->cache_config['cached'] = false; // do not change
+		$this->cache_config['forum'] = array(); // do not change
+		$this->cache_config['topic'] = array(); // do not change
+		$this->cache_config['settings'] = array(); // do not change
+		// -> Cache 
+		if ($this->check_cache()) {
+			foreach($this->cache_config['dynamic_options'] as $optionname => $optionvalue ) {
+				if (@is_array($this->cache_config['settings'][$optionname])) {
+					foreach ( $this->cache_config['settings'][$optionname] as $key => $value ) {
+						$this->seo_opt[$optionname][$key] = $this->cache_config['settings'][$optionname][$key];
+					}
+				} elseif ( @isset($this->cache_config['settings'][$optionvalue]) ) {
+					$this->seo_opt[$optionvalue] = $this->cache_config['settings'][$optionvalue];
+				}
+			}
+			$this->modrtype = @isset($this->seo_opt['modrtype']) ? $this->seo_opt['modrtype'] : $this->modrtype;
+			if ( $this->modrtype > 1 ) { // Load cached URLs	
+				$this->seo_url['forum'] = $this->cache_config['forum'];
+			}
+		}
+		// Special for lazy French
+		if ( strpos($config['default_lang'], 'fr') !== false ) {
+			// Vous pouvez modifier ces valeurs pour peu que vous modifiez le .htaccess en consquence
+			$this->seo_static['user'] = 'membre';
+			$this->seo_static['group'] = 'groupe';
+			$this->seo_static['global_announce'] = 'annonces';
+			$this->seo_static['leaders'] = 'equipe';
+			$this->seo_static['atopic'] = 'sujets-actifs';
+			$this->seo_static['utopic'] = 'sans-reponses';
+			$this->seo_static['npost'] = 'nouveaux-messages';
+		}
+		// Some more config
+		// For profiles and user messages pages, if we do not inject, we do not get rid of ids
+		$this->seo_opt['profile_noids'] = $this->seo_opt['profile_inj'] ? $this->seo_opt['profile_noids'] : false;
+		// If profile noids ...
+		if ($this->seo_opt['profile_noids']) {
+			$this->seo_ext['user'] = '/';
+		}
+		// Profile ans user messages virtual folder
+		if ($this->seo_opt['profile_vfolder']) {
+			$this->seo_ext['user'] = '/';
+		}
+		$this->seo_delim['sr'] = $this->seo_ext['user'] == '/' ? '/' : $this->seo_delim['sr'];
+		// If we use virtual folder, we need '/' at the end of the forum URLs
+		if ($this->seo_opt['virtual_folder']) {
+			$this->seo_ext['forum'] = $this->seo_ext['global_announce'] = '/';
+		}
+		// If the forum cache is not activated
+		if (!$this->seo_opt['cache_layer']) {
+			$this->seo_opt['rem_ids'] = false;
+		}
+		// In case the zero dupe is installed and mod_rewrite deactivated
+		if (!$this->seo_opt['url_rewrite']) {
+			$this->seo_opt['zero_dupe']['on'] = false;
+		}
+		$this->seo_opt['topic_per_page'] = ($config['posts_per_page'] <= 0) ? 1 : $config['posts_per_page']; // do not change
+		// preg_replace() pattern for format_url()
+		$this->seo_opt['url_pattern'] = array('`&(amp;|#)?[a-z0-9]+;`i', '`[^a-z0-9]`i'); // Do not remove : html/xml entities & non a-z chars
+		if ($this->seo_opt['rem_small_words']) {
+			$this->seo_opt['url_pattern'][] = '`(^|-)[a-z0-9]{1,2}(?=-|$)`i';
+		}
+		$this->seo_opt['url_pattern'][] ='`[-]+`'; // Do not remove : multi hyphen reduction
+		// Rewrite functions array : array('file_name' => 'function_name');
+		// Allow to add options without slowing down the URL rewrite process
+		$this->rewrite_functions = array( 
+			'viewforum' => $this->modrtype > 1 ? 'viewforum_adv' : 'viewforum_smpl',
+			'index' => 'index',
+			'memberlist' => $this->seo_opt['profile_inj'] ? 'memberlist_adv' : 'memberlist_smpl',
+			'search' => $this->seo_opt['rewrite_usermsg'] ? ($this->seo_opt['profile_inj'] ? 'search_adv' : 'search_smpl') : '',
+			// Now the pagination /pagexx.html vs -xx.html
+			'topic_pagination' => $this->seo_ext['topic'] === '/' ? 'rewrite_pagination_page' : 'rewrite_pagination',
+			'forum_pagination' => $this->seo_ext['forum'] === '/' ? 'rewrite_pagination_page' : 'rewrite_pagination',
+			'group_pagination' => $this->seo_ext['group'] === '/' ? 'rewrite_pagination_page' : 'rewrite_pagination',
+			'user_pagination' => $this->seo_ext['user'] === '/' ? 'rewrite_pagination_page' : 'rewrite_pagination',
+			'atopic_pagination' => $this->seo_ext['atopic'] === '/' ? 'rewrite_pagination_page' : 'rewrite_pagination',
+			'utopic_pagination' => $this->seo_ext['utopic'] === '/' ? 'rewrite_pagination_page' : 'rewrite_pagination',
+			'npost_pagination' => $this->seo_ext['npost'] === '/' ? 'rewrite_pagination_page' : 'rewrite_pagination',
+		);
+		if ($this->modrtype == 3) {
+			$this->rewrite_functions['viewtopic'] = $this->seo_opt['virtual_folder'] ? 'viewtopic_uadv' : 'viewtopic_adv';
+		} elseif ($this->modrtype == 2) {
+			$this->rewrite_functions['viewtopic'] = $this->seo_opt['virtual_folder'] ? 'viewtopic_umxd' : 'viewtopic_smpl';
+		} else {
+			$this->rewrite_functions['viewtopic'] = $this->seo_opt['virtual_folder'] ? 'viewtopic_usmpl' : 'viewtopic_smpl';
+		}
+		// --> DOMAIN SETTING <-- //
+		// Path Settings, only rely on DB
+		$server_protocol = ($config['server_protocol']) ? $config['server_protocol'] : (($config['cookie_secure']) ? 'https://' : 'http://');
+		$server_name = trim($config['server_name'], '/') . '/';
+		$server_port = (int) $config['server_port'];
+		$server_port = ($server_port <> 80) ? ':' . $server_port : '';
+		$script_path = trim($config['script_path'], '/');
+		$script_path = (empty($script_path) ) ? '' : $script_path . '/';
+		$this->seo_path['root_url'] =  $server_protocol . $server_name;
+		$this->seo_path['phpbb_urlR'] = $this->seo_path['phpbb_url'] =  $this->seo_path['root_url'] . $script_path;
+		$this->seo_path['phpbb_script'] =  $script_path;
+		// Array of the filenames that may require the use of a base href tag.
+		$this->seo_opt['file_hbase'] = array('viewtopic', 'viewforum', 'memberlist', 'search');
+		// virtual root option
+		if ($this->seo_opt['virtual_root']) {
+			$this->seo_path['phpbb_urlR'] = $this->seo_path['root_url'];
+			$this->seo_opt['file_hbase'][] = 'index';
+			$this->seo_static['index'] = empty($this->seo_static['index']) ? 'forum' : $this->seo_static['index'];
+		}
+		$this->seo_ext['index'] = empty($this->seo_static['index']) ? '' : ( empty($this->seo_ext['index']) ? '.html' : $this->seo_ext['index']);
+		// File setting
+		$this->seo_req_uri();
+		$this->seo_opt['seo_base_href'] = $this->seo_opt['req_file'] = '';
+		if ($script_name = (!empty($_SERVER['PHP_SELF'])) ? $_SERVER['PHP_SELF'] : getenv('PHP_SELF')) {
+			// From sessions.php
+			// Replace backslashes and doubled slashes (could happen on some proxy setups)
+			$script_name = str_replace(array('\\', '//'), '/', $script_name);
+			// basenamed page name (for example: index.php)
+			$script_name = basename($script_name);
+			$script_name = urlencode(htmlspecialchars($script_name));
+			$this->seo_opt['req_file'] = str_replace('.' . $phpEx, '', $script_name);
+		}
+		if ( !defined('ADMIN_START') && in_array($this->seo_opt['req_file'], $this->seo_opt['file_hbase'])) {	
+			$this->seo_opt['seo_base_href'] = '<base href="' . $this->seo_path['phpbb_url'] . '"/>';
+		}
+		return;
+	}
+	// --> URL rewriting functions <--
+	/**
+	* Prepare Titles for URL injection
+	*/
+	function format_url( $url, $type = 'topic' ) {
+		$url = preg_replace('`\[.*\]`U','',$url);
+		$url = htmlentities($url, ENT_COMPAT, $this->encoding);
+		$url = preg_replace( '`&([a-z]+)(acute|uml|circ|grave|ring|cedil|slash|tilde|caron|lig);`i', "\\1", $url );
+		$url = preg_replace( $this->seo_opt['url_pattern'] , '-', $url);
+		$url = strtolower(trim($url, '-'));
+		return empty($url) ? $type : $url;
+	}
+	/**
+	* Prepare url first part and checks cache
+	*/
+	function set_url( $url, $id = 0, $type = 'forum' ) {
+		return (!empty($this->cache_config[$type][$id])) ? $this->cache_config[$type][$id] : $this->format_url( $url, $type ) . $this->seo_delim[$type] . $id;
+	}
+	/**
+	* Prepare profile url
+	*/
+	function set_user_url( $username, $user_id = 0 ) {
+		if (empty($this->seo_url['user'][$user_id])) {
+			$this->seo_url['username'][$username] = $user_id;
+			if ( $this->seo_opt['profile_inj'] ) {
+				if ( $this->seo_opt['profile_noids'] ) {
+					$this->seo_url['user'][$user_id] = $this->seo_static['user'] . '/' . $this->seo_url_encode($username);
+				} else {
+					$this->seo_url['user'][$user_id] = $this->format_url($username,  $this->seo_delim['user']) . $this->seo_delim['user'] . $user_id;
+				}
+			}
+		}
+	}
+	/**
+	* custom urlencoding
+	*/
+	function seo_url_encode( $url ) {
+		// can be faster to return $url directly if you do not allow more chars than 
+		// [a-zA-Z0-9_\.-] in your usernames
+		// return $url;
+		// Here we hanlde the "&", "/", "+" and "#" case proper ( http://www.php.net/urlencode => http://issues.apache.org/bugzilla/show_bug.cgi?id=34602 )
+		static $find = array('&', '/', '#', '+');
+		static $replace = array('%26', '%2F', '%23', '%2b');
+		return rawurlencode(str_replace( $find, $replace, utf8_normalize_nfc(htmlspecialchars_decode(str_replace('&amp;amp;', '%26', rawurldecode($url))))));
+	}
+	/**
+	* Rewrite URLs.
+	* Allow adding of many more cases than just the
+	* regular phpBB URL rewritting without slowing up the process.
+	*/
+	function url_rewrite($url, $is_amp = true ) {
+		global $phpEx, $user;
+		$url = $is_amp ? str_replace('&amp;', '&', $url) : $url;
+		$this->url = $this->url_in = $url = str_replace('?&', '?', $url);
+		if (!empty($this->seo_cache[$url])) {
+			return $this->seo_cache[$url];
+		}
+		if ( !$this->seo_opt['url_rewrite'] || strpos($this->url, 'adm/') !== FALSE || defined('ADMIN_START') ) {
+			return ($is_amp) ? str_replace('&', '&amp;', $url) : $url;
+		}
+		// Grabb params
+		$parsed_url = parse_url($this->url);
+		@parse_str($parsed_url['query'], $this->get_vars);
+		$this->file = basename(@$parsed_url['path']);
+		$this->filename = trim(str_replace(".$phpEx", '', $this->file));
+		if ( in_array($this->filename, $this->seo_stop_files) ) {
+			return ($is_amp) ? str_replace('&', '&amp;', $url) : $url;
+		}
+		if (empty($user->data['is_registered'])) {
+			if ( $this->seo_opt['rem_sid'] ) {
+				unset($this->get_vars['sid']);
+			}
+			if ( $this->seo_opt['rem_hilit'] ) {
+				unset($this->get_vars['hilit']);
+			}
+		}
+		// Reset url
+		$this->url = $this->file;
+		if ( !empty($this->rewrite_functions[$this->filename]) ) {
+			$this->{$this->rewrite_functions[$this->filename]}();
+			// Assamble URL
+			$this->url .= $this->query_string($this->get_vars);
+			$this->url = ($is_amp) ? str_replace('&', '&amp;', $this->url) : $this->url;
+			$this->seo_cache[$url] = $this->path . $this->url . ((!empty($parsed_url['fragment'])) ? '#' . $parsed_url['fragment'] : '');
+			return  $this->seo_cache[$url];
+		} else {
+			$this->seo_cache[$url] = ($is_amp) ? str_replace('&', '&amp;', $url) : $url;
+			return $this->seo_cache[$url];
+		}
+	}
+	/**
+	* URL rewritting for viewtopic.php
+	* With Virtual Folder Injection
+	* @access private
+	*/
+	function viewtopic_uadv() {
+		$this->filter_url($this->seo_stop_vars);
+		$this->path = $this->seo_path['phpbb_urlR'];
+		if ( !empty($this->get_vars['p']) ) {
+			$this->url = $this->seo_static['post'] . $this->get_vars['p'] . $this->seo_ext['post'];
+			unset($this->get_vars['p'], $this->get_vars['f'], $this->get_vars['t'], $this->get_vars['start']);
+			return;
+		}
+		if ( !empty($this->get_vars['t']) && !empty($this->get_vars['f']) && !empty($this->seo_url['topic'][$this->get_vars['t']]) && !empty($this->seo_url['forum'][$this->get_vars['f']])) {
+			// Filter default params
+			$this->filter_get_var($this->phpbb_filter['topic']);
+			$this->{$this->rewrite_functions['topic_pagination']}($this->seo_ext['topic']);
+			$this->url = $this->seo_url['topic'][$this->get_vars['t']] . $this->seo_delim['topic'] . $this->get_vars['t'] . $this->start;
+			if (@$this->seo_opt['topic_type'][$this->get_vars['t']] == POST_GLOBAL) {
+				$this->url = $this->seo_static['global_announce'] . $this->seo_ext['global_announce'] . $this->url;
+			} else {
+				$this->url = $this->seo_url['forum'][$this->get_vars['f']] . $this->seo_ext['forum'] . $this->url;
+			}
+			unset($this->get_vars['t'], $this->get_vars['f'], $this->get_vars['p']);
+			return;
+		}
+		$this->path = $this->seo_path['phpbb_url'];
+		return;
+	}
+	/**
+	* URL rewritting for viewtopic.php
+	* With Virtual Folder Injection
+	* @access private
+	*/
+	function viewtopic_umxd() {
+		$this->filter_url($this->seo_stop_vars);
+		$this->path = $this->seo_path['phpbb_urlR'];
+		if ( !empty($this->get_vars['p']) ) {
+			$this->url = $this->seo_static['post'] . $this->get_vars['p'] . $this->seo_ext['post'];
+			unset($this->get_vars['p'], $this->get_vars['f'], $this->get_vars['t'], $this->get_vars['start']);
+			return;
+		}
+		if ( !empty($this->get_vars['t']) && !empty($this->get_vars['f']) && !empty($this->seo_url['forum'][$this->get_vars['f']]) ) {
+			// Filter default params
+			$this->filter_get_var($this->phpbb_filter['topic']);
+			$this->{$this->rewrite_functions['topic_pagination']}($this->seo_ext['topic']);
+			$this->url = $this->seo_static['topic'] . $this->get_vars['t'] . $this->start;
+			if (@$this->seo_opt['topic_type'][$this->get_vars['t']] == POST_GLOBAL) {
+				$this->url = $this->seo_static['global_announce'] . $this->seo_ext['global_announce'] . $this->url;
+			} else {
+				$this->url = $this->seo_url['forum'][$this->get_vars['f']] . $this->seo_ext['forum'] . $this->url;
+			}
+			unset($this->get_vars['t'], $this->get_vars['f'],$this->get_vars['p']);
+			return;
+		}
+		$this->path = $this->seo_path['phpbb_url'];
+		return;
+	}
+	/**
+	* URL rewritting for viewtopic.php
+	* With Virtual Folder Injection
+	* @access private
+	*/
+	function viewtopic_usmpl() {
+		$this->filter_url($this->seo_stop_vars);
+		$this->path = $this->seo_path['phpbb_urlR'];
+		if ( !empty($this->get_vars['p']) ) {
+			$this->url = $this->seo_static['post'] . $this->get_vars['p'] . $this->seo_ext['post'];
+			unset($this->get_vars['p'], $this->get_vars['f'], $this->get_vars['t'], $this->get_vars['start']);
+			return;
+		}
+		if ( !empty($this->get_vars['t']) && !empty($this->get_vars['f']) ) {
+			// Filter default params
+			$this->filter_get_var($this->phpbb_filter['topic']);
+			$this->{$this->rewrite_functions['topic_pagination']}($this->seo_ext['topic']);
+			$this->url = $this->seo_static['topic'] . $this->get_vars['t'] . $this->start;
+			if (@$this->seo_opt['topic_type'][$this->get_vars['t']] == POST_GLOBAL) {
+				$this->url = $this->seo_static['global_announce'] . $this->seo_ext['global_announce'] . $this->url;
+			} else {
+				$this->url = $this->seo_static['forum'] . $this->get_vars['f'] . $this->seo_ext['forum'] . $this->url;
+			}
+			unset($this->get_vars['t'], $this->get_vars['f'],$this->get_vars['p']);
+		}
+		$this->path = $this->seo_path['phpbb_url'];
+		return;
+	}
+	/**
+	* URL rewritting for viewtopic.php
+	* Without Virtual Folder Injection
+	* @access private
+	*/
+	function viewtopic_adv() {
+		$this->filter_url($this->seo_stop_vars);
+		$this->path = $this->seo_path['phpbb_urlR'];
+		if ( !empty($this->get_vars['p']) ) {
+			$this->url = $this->seo_static['post'] . $this->get_vars['p'] . $this->seo_ext['post'];
+			unset($this->get_vars['p'], $this->get_vars['f'], $this->get_vars['t'], $this->get_vars['start']);
+			return;
+		}
+		if ( !empty($this->get_vars['t']) && !empty($this->seo_url['topic'][$this->get_vars['t']]) ) {
+			// Filter default params
+			$this->filter_get_var($this->phpbb_filter['topic']);
+			$this->{$this->rewrite_functions['topic_pagination']}($this->seo_ext['topic']);
+			$this->url = $this->seo_url['topic'][$this->get_vars['t']] . $this->seo_delim['topic'] . $this->get_vars['t'] . $this->start;
+			unset($this->get_vars['t'], $this->get_vars['f'],$this->get_vars['p']);
+			return;
+		}
+		$this->path = $this->seo_path['phpbb_url'];
+		return;
+	}
+	/**
+	* URL rewritting for viewtopic.php
+	* Without Virtual Folder Injection
+	* @access private
+	*/
+	function viewtopic_smpl() {
+		$this->filter_url($this->seo_stop_vars);
+		$this->path = $this->seo_path['phpbb_urlR'];
+		if ( !empty($this->get_vars['p']) ) {
+			$this->url = $this->seo_static['post'] . $this->get_vars['p'] . $this->seo_ext['post'];
+			unset($this->get_vars['p'], $this->get_vars['f'], $this->get_vars['t'], $this->get_vars['start']);
+			return;
+		}
+		if ( !empty($this->get_vars['t']) ) {
+			// Filter default params
+			$this->filter_get_var($this->phpbb_filter['topic']);
+			$this->{$this->rewrite_functions['topic_pagination']}($this->seo_ext['topic']);
+			$this->url = $this->seo_static['topic'] . $this->get_vars['t'] . $this->start;
+			unset($this->get_vars['t'], $this->get_vars['f'],$this->get_vars['p']);
+		}
+		$this->path = $this->seo_path['phpbb_url'];
+		return;
+	}
+	/**
+	* URL rewritting for viewforum.php
+	* @access private
+	*/
+	function viewforum_adv() {
+		$this->path = $this->seo_path['phpbb_urlR'];
+		$this->filter_url($this->seo_stop_vars);
+		if ( !empty($this->get_vars['f']) && !empty($this->seo_url['forum'][$this->get_vars['f']]) ) {
+			// Filter default params
+			$this->filter_get_var($this->phpbb_filter['forum']);
+			$this->{$this->rewrite_functions['forum_pagination']}($this->seo_ext['forum']);
+			$this->url = $this->seo_url['forum'][$this->get_vars['f']] . $this->start;
+			unset($this->get_vars['f']);
+			return;
+		}
+		$this->path = $this->seo_path['phpbb_url'];
+		return;
+	}
+	/**
+	* URL rewritting for viewforum.php
+	* Without Virtual Folder Injection
+	* @access private
+	*/
+	function viewforum_smpl() {
+		$this->path = $this->seo_path['phpbb_urlR'];
+		$this->filter_url($this->seo_stop_vars);
+		if ( !empty($this->get_vars['f']) ) {
+			// Filter default params
+			$this->filter_get_var($this->phpbb_filter['forum']);
+			$this->{$this->rewrite_functions['forum_pagination']}($this->seo_ext['forum']);
+			$this->url = $this->seo_static['forum'] . $this->get_vars['f'] . $this->start;
+			unset($this->get_vars['f']);
+			return;
+		}
+		$this->path = $this->seo_path['phpbb_url'];
+		return;
+	}
+	/**
+	* URL rewritting for memberlist.php
+	* with nicknames and group name injection
+	* @access private
+	*/
+	function memberlist_adv() {
+		$this->path = $this->seo_path['phpbb_urlR'];
+		if ( !empty($this->get_vars['u']) && @$this->get_vars['mode'] === 'viewprofile' && !empty($this->seo_url['user'][$this->get_vars['u']]) ) {
+			$this->url = $this->seo_url['user'][$this->get_vars['u']] . $this->seo_ext['user'];
+			unset($this->get_vars['mode'], $this->get_vars['u']);
+			return;
+		} elseif ( !empty($this->get_vars['g']) && @$this->get_vars['mode'] === 'group' && !empty($this->seo_url['group'][$this->get_vars['g']]) ) {
+			$this->{$this->rewrite_functions['group_pagination']}($this->seo_ext['group']);
+			$this->url =  $this->seo_url['group'][$this->get_vars['g']] . $this->seo_delim['group'] . $this->get_vars['g'] . $this->start;
+			unset($this->get_vars['mode'], $this->get_vars['g']);
+			return;
+		} elseif (@$this->get_vars['mode'] === 'leaders') {
+			$this->url =  $this->seo_static['leaders'] . $this->seo_ext['leaders'];
+			unset($this->get_vars['mode']);
+			return;
+		}
+		$this->path = $this->seo_path['phpbb_url'];
+		return;
+	}
+	/**
+	* URL rewritting for memberlist.php
+	* Simple rewriting
+	* @access private
+	*/
+	function memberlist_smpl() {
+		$this->path = $this->seo_path['phpbb_urlR'];
+		if ( !empty($this->get_vars['u']) && @$this->get_vars['mode'] === 'viewprofile' ) {
+			$this->url =  $this->seo_static['user'] . $this->get_vars['u'] . $this->seo_ext['user'];
+			unset($this->get_vars['mode'], $this->get_vars['u']);
+			return;
+		} elseif ( !empty($this->get_vars['g']) && @$this->get_vars['mode'] === 'group' ) {
+			$this->{$this->rewrite_functions['group_pagination']}($this->seo_ext['group']);
+			$this->url = $this->seo_static['group'] . $this->get_vars['g'] . $this->start;
+			unset($this->get_vars['mode'], $this->get_vars['g']);
+			return;
+		} elseif (@$this->get_vars['mode'] === 'leaders') {
+			$this->url =  $this->seo_static['leaders'] . $this->seo_ext['leaders'];
+			unset($this->get_vars['mode']);
+			return;
+		}
+		$this->path = $this->seo_path['phpbb_url'];
+		return;
+	}
+	/**
+	* URL rewritting for search.php
+	* @access private
+	*/
+	function search_smpl() {
+		$this->path = $this->seo_path['phpbb_urlR'];
+		$user_id = !empty($this->get_vars['author_id']) ? $this->get_vars['author_id'] : ( !empty($this->seo_url['username'][rawurldecode(@$this->get_vars['author'])]) ? $this->seo_url['username'][rawurldecode($this->get_vars['author'])] : 0);
+		if ( $user_id ) {
+			// Filter default params
+			$this->filter_get_var($this->phpbb_filter['search']);
+			$this->{$this->rewrite_functions['user_pagination']}($this->seo_ext['user']);
+			$sr = (@$this->get_vars['sr'] == 'topics' ) ? 'topics' : 'posts';
+			$this->url = $this->seo_static['user'] . $user_id . $this->seo_delim['sr'] . $sr . $this->start;
+			unset($this->get_vars['author_id'], $this->get_vars['author'], $this->get_vars['sr']);
+			return;
+		} elseif (!empty($this->get_vars['search_id'])) {
+			switch ($this->get_vars['search_id']) {
+				case 'active_topics':
+					$this->filter_get_var($this->phpbb_filter['search']);
+					$this->{$this->rewrite_functions['atopic_pagination']}($this->seo_ext['atopic']);
+					$this->url = $this->seo_static['atopic'] . $this->start;
+					unset($this->get_vars['search_id'], $this->get_vars['sr']);
+					if (@$this->get_vars['st'] == 7) {
+						unset($this->get_vars['st']);
+					}
+					break;
+				case 'unanswered':
+					$this->filter_get_var($this->phpbb_filter['search']);
+					$this->{$this->rewrite_functions['utopic_pagination']}($this->seo_ext['utopic']);
+					$this->url = $this->seo_static['utopic'] . $this->start;
+					unset($this->get_vars['search_id']);
+					if (@$this->get_vars['sr'] == 'topics') {
+						unset($this->get_vars['sr']);
+					}
+					break;
+				case 'egosearch':
+					global $user;
+					$this->url =  $this->seo_static['user'] . $user->data['user_id'] . $this->seo_delim['sr'] . 'topics' . $this->seo_ext['user'];
+					unset($this->get_vars['search_id']);
+					break;
+				case 'newposts':
+					$this->filter_get_var($this->phpbb_filter['search']);
+					$this->{$this->rewrite_functions['npost_pagination']}($this->seo_ext['npost']);
+					$this->url = $this->seo_static['npost'] . $this->start;
+					unset($this->get_vars['search_id']);
+					if (@$this->get_vars['sr'] == 'topics') {
+						unset($this->get_vars['sr']);
+					}
+					break;
+			}
+		}
+		$this->path = $this->seo_path['phpbb_url'];
+		return;
+	}
+	/**
+	* URL rewritting for search.php
+	* @access private
+	*/
+	function search_adv() {
+		$this->path = $this->seo_path['phpbb_urlR'];
+		$user_id = !empty($this->get_vars['author_id']) ? $this->get_vars['author_id'] : ( !empty($this->seo_url['username'][rawurldecode(@$this->get_vars['author'])]) ? $this->seo_url['username'][rawurldecode($this->get_vars['author'])] : 0);
+		if ( $user_id && !empty($this->seo_url['user'][$user_id]) ) {
+			// Filter default params
+			$this->filter_get_var($this->phpbb_filter['search']);
+			$this->{$this->rewrite_functions['user_pagination']}($this->seo_ext['user']);
+			$sr = (@$this->get_vars['sr'] == 'topics' ) ? 'topics' : 'posts';
+			$this->url = $this->seo_url['user'][$user_id] . $this->seo_delim['sr'] . $sr . $this->start;
+			unset($this->get_vars['author_id'], $this->get_vars['author'], $this->get_vars['sr']);
+			return;
+		} elseif ( $this->seo_opt['profile_noids'] && !empty($this->get_vars['author']) ) {
+			// Filter default params
+			$this->filter_get_var($this->phpbb_filter['search']);
+			$this->rewrite_pagination_page();
+			$sr = (@$this->get_vars['sr'] == 'topics' ) ? '/topics' : '/posts';
+			$this->url = $this->seo_static['user'] . '/' . $this->seo_url_encode($this->get_vars['author']) . $sr . $this->start;
+			unset($this->get_vars['author'], $this->get_vars['author_id'], $this->get_vars['sr']);
+			return;
+		} elseif (!empty($this->get_vars['search_id'])) {
+			switch ($this->get_vars['search_id']) {
+				case 'active_topics':
+					$this->filter_get_var($this->phpbb_filter['search']);
+					$this->{$this->rewrite_functions['atopic_pagination']}($this->seo_ext['atopic']);
+					$this->url = $this->seo_static['atopic'] . $this->start;
+					unset($this->get_vars['search_id'], $this->get_vars['sr']);
+					if (@$this->get_vars['st'] == 7) {
+						unset($this->get_vars['st']);
+					}
+					break;
+				case 'unanswered':
+					$this->filter_get_var($this->phpbb_filter['search']);
+					$this->{$this->rewrite_functions['utopic_pagination']}($this->seo_ext['utopic']);
+					$this->url = $this->seo_static['utopic'] . $this->start;
+					unset($this->get_vars['search_id']);
+					if (@$this->get_vars['sr'] == 'topics') {
+						unset($this->get_vars['sr']);
+					}
+					break;
+				case 'egosearch':
+					global $user;
+					$this->set_user_url($user->data['username'], $user->data['user_id']);
+					$this->url = $this->seo_url['user'][$user->data['user_id']] . $this->seo_delim['sr'] . 'topics' . $this->seo_ext['user'];
+					unset($this->get_vars['search_id']);
+					break;
+				case 'newposts':
+					$this->filter_get_var($this->phpbb_filter['search']);
+					$this->{$this->rewrite_functions['npost_pagination']}($this->seo_ext['npost']);
+					$this->url = $this->seo_static['npost'] . $this->start;
+					unset($this->get_vars['search_id']);
+					if (@$this->get_vars['sr'] == 'topics') {
+						unset($this->get_vars['sr']);
+					}
+					break;
+			}
+		}
+		$this->path = $this->seo_path['phpbb_url'];
+		return;
+	}
+	/**
+	* URL rewritting for index.php
+	* @access private
+	*/
+	function index() {
+		$this->path = $this->seo_path['phpbb_urlR'];
+		if ($this->filter_url($this->seo_stop_vars)) {
+			$this->url = $this->seo_static['index'] . $this->seo_ext['index'];
+			return;
+		}
+		$this->path = $this->seo_path['phpbb_url'];
+		return;
+	}
+	/**
+	* Will break if a $filter pattern is foundin $url.
+	* Example $filter = array("view=", "mark=");
+	* @access private
+	*/
+	function filter_url($filter = array()) {
+		foreach ($filter as $patern ) {
+			if ( strpos($this->url_in, $patern) !== false ) {
+				$this->get_vars = array();
+				$this->url = $this->url_in;
+				return false;
+			}
+		}
+		return true;
+	}
+	/**
+	* Will unset all default var stored in $filter array.
+	* Example $filter = array('postdays' => 0, 'topicdays' => 0, 'postorder' => 'asc');
+	* @access private
+	*/
+	function filter_get_var($filter = array()) {
+		if ( !empty($this->get_vars) ) {
+			foreach ($this->get_vars as $paramkey => $paramval) {
+				if ( array_key_exists($paramkey, $filter) ) {
+					if ( $filter[$paramkey] ==  $this->get_vars[$paramkey] || empty( $this->get_vars[$paramkey])) {
+						unset($this->get_vars[$paramkey]);
+					}
+				}
+			}	
+		}
+		return;
+	}
+	/**
+	* Will return the remaining GET vars to take care of
+	* @access private
+	*/
+	function query_string() {
+		if(empty($this->get_vars)) {
+			return '';
+		}
+		$params = array();
+		foreach($this->get_vars as $key => $value) {
+			$params[] = $key . '=' . $value;
+		}
+		return '?' . implode('&', $params);
+	}
+	/**
+	* rewrite pagination, simple
+	* -xx.html
+	*/
+	function rewrite_pagination($suffix) {
+		$this->start = $this->seo_start( @$this->get_vars['start'] ) . $suffix;
+		unset($this->get_vars['start']);
+	}
+	/**
+	* rewrite pagination, virtual folder
+	* /pagexx.html
+	*/
+	function rewrite_pagination_page() {
+		$this->start = '/' . $this->seo_start_page( @$this->get_vars['start'] );
+		unset($this->get_vars['start']);
+	}
+	/**
+	* Returns usable start param
+	* -xx
+	*/
+	function seo_start($start) {
+		return ($start >= 1 ) ? $this->seo_delim['start'] . (int) $start : '';
+	}
+	/**
+	* Returns usable start param
+	* pagexx.html
+	* Only used in virtual folder mode
+	*/
+	function seo_start_page($start) {
+		return ($start >=1 ) ? $this->seo_static['pagination'] . (int) $start . $this->seo_ext['pagination'] : '';
+	}
+	/**
+	* Returns the full REQUEST_URI
+	*/
+	function seo_req_uri() {
+		if ( !empty($_SERVER['REQUEST_URI']) ) { // Apache mod_rewrite
+			$this->seo_path['uri'] = ltrim($_SERVER['REQUEST_URI'], '/');
+		} elseif ( !empty($_SERVER['HTTP_X_REWRITE_URL']) ) { // IIS  isapi_rewrite
+			$this->seo_path['uri'] = ltrim($_SERVER['HTTP_X_REWRITE_URL'], '/');
+		} else { // no mod rewrite
+			$this->seo_path['uri'] =  ltrim($_SERVER['SCRIPT_NAME'], '/') . ( ( !empty($_SERVER['QUERY_STRING']) ) ? '?'.$_SERVER['QUERY_STRING'] : '' );
+		}
+		$this->seo_path['uri'] = str_replace( '%26', '&', rawurldecode($this->seo_path['uri']));
+		// workaround for FF default iso encoding
+		if (!$this->is_utf8($this->seo_path['uri']) && function_exists('utf8_encode')) {
+			$this->seo_path['uri'] = utf8_normalize_nfc(utf8_encode($this->seo_path['uri']));
+		}
+		$this->seo_path['uri'] = $this->seo_path['root_url'] . $this->seo_path['uri'];
+		return $this->seo_path['uri'];
+	}
+	/**
+	* seo_end() : The last touch function
+	* Note : This mod is going to help your site a lot in Search Engines 
+	* We request that you keep this copyright notice as specified in the licence.
+	* If You really cannot put this link, you should at least provide us with one visible 
+	* (can be small but visible) link on your home page or your forum Index using this code for example :
+	* <a href="http://www.phpbb-seo.com/" title="Search Engine Optimization">phpBB SEO</a>
+	*/
+	function seo_end($return = false) {
+		global $user, $config;
+		if (empty($this->seo_opt['copyrights']['title'])) {
+			$this->seo_opt['copyrights']['title'] = strpos($config['default_lang'], 'fr') !== false  ?  'Optimisation du R&eacute;f&eacute;rencement' : 'Search Engine Optimization';
+		}
+		if (empty($this->seo_opt['copyrights']['txt'])) {
+			$this->seo_opt['copyrights']['txt'] = 'phpBB SEO';
+		}
+		if ($this->seo_opt['copyrights']['img']) {
+			$output = '<div style="padding-top:5px;text-align:middle"><a href="http://www.phpbb-seo.com/" title="' . $this->seo_opt['copyrights']['title'] . '"><img src="' . $this->seo_path['phpbb_url'] . 'images/phpbb-seo.png" alt="' . $this->seo_opt['copyrights']['txt'] . '"/></a></div>';
+		} else {
+			$output = '<div style="padding-top:5px;text-align:middle"><a href="http://www.phpbb-seo.com/" title="' . $this->seo_opt['copyrights']['title'] . '">' . $this->seo_opt['copyrights']['txt'] . '</a></div>';
+		}
+		if ($return) {
+			return $output;
+		} else {
+			$user->lang['TRANSLATION_INFO'] .= $output;
+		}
+		return;
+	}
+	// -> Cache functions
+	/**
+	* forum_id(&$forum_id, $forum_uri = '') 
+	* will tell the forum id from the uri or the forum_uri GET var by checking the cache.
+	*/
+	function get_forum_id(&$forum_id, $forum_uri = '') {
+		if (empty($forum_uri)) {
+			$forum_uri = request_var('forum_uri', '');
+			unset($_GET['forum_uri'], $_REQUEST['forum_uri']);
+		}
+		if ($id = @array_search($forum_uri, $this->cache_config['forum']) ) {
+			$forum_id = (int) $id;
+		}
+		return 0;
+	}
+	/**
+	* check_cache() will tell if the required file exists.
+	* @access private
+	*/
+	function check_cache( $type = 'forum', $from_bkp = false ) {
+		$file = SEO_CACHE_PATH . @$this->cache_config['files'][$type];
+		if( !$this->cache_config['cache_enable'] || !array_key_exists($type, $this->cache_config['files']) || !file_exists($file) ) {
+			$this->cache_config['cached'] = false;
+			return false;
+		}
+		include($file);
+		if (is_array($this->cache_config[$type]) ) {
+			$this->cache_config['cached'] = true;
+			return true;
+		} else {
+			if ( !$from_bkp ) {
+				// Try the current backup
+				@copy($file . '.current', $file);
+				$this->check_cache( $type, true );
+			}
+			$this->cache_config['cached'] = false;
+			return false;
+		}
+	}
+	/**
+	* is_utf8($string)
+	* Borrowed from php.net : http://www.php.net/mb_detect_encoding (detectUTF8)
+	*/
+	function is_utf8($string) {
+		// non-overlong 2-byte|excluding overlongs|straight 3-byte|excluding surrogates|planes 1-3|planes 4-15|plane 16
+		return preg_match('%(?:[\xC2-\xDF][\x80-\xBF]|\xE0[\xA0-\xBF][\x80-\xBF]|[\xE1-\xEC\xEE\xEF][\x80-\xBF]{2}|\xED[\x80-\x9F][\x80-\xBF] |\xF0[\x90-\xBF][\x80-\xBF]{2}|[\xF1-\xF3][\x80-\xBF]{3}|\xF4[\x80-\x8F][\x80-\xBF]{2})+%xs', $string);
+	}
+	// --> Add on Functions <--
+	// --> Gen stats
+	/**
+	* Returns usable microtime
+	* Borrowed from php.net
+	*/
+	function microtime_float() {
+		return array_sum(explode(' ',microtime()));
+	}
+	// --> Zero Duplicate
+	/**
+	* Custom HTTP 301 redirections.
+	* To kill duplicates
+	*/
+	function seo_redirect($url, $header = '301 Moved Permanently', $code = 301, $replace = TRUE) {
+		global $db;
+		if (!$this->seo_opt['zero_dupe']['on'] || headers_sent()) {
+			return;
+		}
+		garbage_collection();
+		$url = str_replace('&amp;', '&', $url);
+		// Make sure no linebreaks are there... to prevent http response splitting for PHP < 4.4.2
+		if (strpos(urldecode($url), "\n") !== false || strpos(urldecode($url), "\r") !== false || strpos($url, ';') !== false) {
+			trigger_error('Tried to redirect to potentially insecure url.', E_USER_ERROR);
+		}
+		$http = 'HTTP/1.1 ';
+		header($http . $header, $replace, $code);
+		header('Location: ' . $url);
+		exit();
+	}
+	/**
+	* Set the do_redir_post option right
+	*/
+	function set_do_redir_post() {
+		global $user;
+		switch ($this->seo_opt['zero_dupe']['post_redir']) {
+			case 'guest':
+				if (  !$user->data['is_registered'] ) {
+					$this->seo_opt['zero_dupe']['do_redir_post'] = true;
+				}
+				break;
+			case 'all':
+				$this->seo_opt['zero_dupe']['do_redir_post'] = true;
+				break;
+			case 'off': // Do not redirect
+				$this->seo_opt['zero_dupe']['do_redir'] = false;
+				$this->seo_opt['zero_dupe']['go_redir'] = false;
+				$this->seo_opt['zero_dupe']['do_redir_post'] = false;
+				break;
+			default:
+				$this->seo_opt['zero_dupe']['do_redir_post'] = false;
+				break;	
+		}
+		return $this->seo_opt['zero_dupe']['do_redir_post'];
+	}
+	/**
+	* Redirects if the uri sent does not match (fully) the 
+	* attended url
+	*/
+	function seo_chk_dupe($url = '', $uri = '') {
+		global $auth, $user, $_SID;
+		static $global_defs;
+		if (empty($this->seo_opt['req_file']) || (!$this->seo_opt['rewrite_usermsg'] && $this->seo_opt['req_file'] == 'search') ) {
+			return false;
+		}
+		$uri = !empty($uri) ? $uri : $this->seo_path['uri'];
+		$reg = !empty($user->data['is_registered']) ? true : false;
+		if (empty($global_defs)) {
+			$global_defs = array(
+				'sid' => array('val' => $_SID, 'keep' => $reg ? (boolean) !empty($_SID) :  (boolean) ( !empty($_SID) ? ($this->seo_opt['rem_sid'] ? false : true) : false)),
+				'explain' => array('val' => 1, 'keep' => $reg ? (boolean) ($auth->acl_get('a_') && defined('DEBUG_EXTRA')) : false),
+			);
+		}
+		$this->seo_opt['zero_dupe']['redir_def'] = array_merge($this->seo_opt['zero_dupe']['redir_def'], $global_defs);
+		$this->set_cond(!empty($_REQUEST['sid']) && ($_REQUEST['sid'] != $user->session_id || (!$reg && $this->seo_opt['rem_sid'])), 'do_redir');
+		if (empty($url)) {;
+			$url = $this->expected_url();
+		} else {
+			$url = str_replace('&amp;', '&', append_sid($url, false, true, 0));
+			if (!empty($_SID) && $global_defs['sid']['keep']) {
+				$url .=  (utf8_strpos( $url, '?' ) !== false ? '&' : '?') . 'sid=' . $_SID;
+			}
+			if (isset($_REQUEST['explain']) && $global_defs['explain']['keep']) {
+				$url .= (utf8_strpos( $url, '?' ) !== false ? '&' : '?') . 'explain=1';
+			}
+		}
+		$url = str_replace( '%26', '&', urldecode($url));
+		if ($this->seo_opt['zero_dupe']['do_redir']) {
+			$this->seo_redirect($url);
+		} elseif ($this->seo_opt['zero_dupe']['strict']) {
+			return $this->seo_opt['zero_dupe']['go_redir'] && ( ($uri != $url) ? $this->seo_redirect($url) : false );
+		} else {
+			return $this->seo_opt['zero_dupe']['go_redir'] && ( (utf8_strpos( $uri, $url ) === false) ? $this->seo_redirect($url) : false );
+		}
+	}
+	/**
+	* expected_url()
+	* build expected url
+	*/
+	function expected_url() {
+		global $phpEx;
+		$params = array();
+		foreach ($this->seo_opt['zero_dupe']['redir_def'] as $get => $def) {
+			if ((isset($_REQUEST[$get]) && $def['keep']) || !empty($def['force'])) {
+				$params[$get] = $def['val'];
+			}
+		}
+		$this->page_url = append_sid($this->seo_opt['req_file'] . ".$phpEx", $params, false, 0);
+		return $this->page_url;
+	}
+	/**
+	* set_cond($bool, $type = 'bool_redir', $or = true)
+	* Helps out grabbing boolean vars
+	*/
+	function set_cond($bool, $type = 'do_redir', $or = true) {
+		if ( $or ) {
+			$this->seo_opt['zero_dupe'][$type] = (boolean) ($bool || $this->seo_opt['zero_dupe'][$type]);
+		} else {
+			$this->seo_opt['zero_dupe'][$type] = (boolean) ($bool && $this->seo_opt['zero_dupe'][$type]);
+		}
+		return;
+	}
+	/**
+	* check start var consistency
+	* and return our best guess for $start, eg the first valid page 
+	* parameter according to pagination settings being lower
+	* than the one sent.
+	*/
+	function seo_chk_start($start = 0, $limit = 0) {
+		if ($limit > 0) {
+			$start = is_int($start/$limit) ? $start : intval($start/$limit)*$limit;
+		}
+		if ( $start >= 1 ) {
+			$this->start = $this->seo_delim['start'] . (int) $start;
+			return (int) $start;
+		}
+		$this->start = '';
+		return 0;
+	}
+	// <-- Zero Duplicate
+} // End of the phpbb_seo class 
+?>
Index: images/phpbb-seo.png
===================================================================
Cannot display: file marked as a binary type.
svn:mime-type = application/octet-stream

Property changes on: G:\web\phpbb-seo.com\aTEAM\phpbb3\0.4.2\premod\svn_premod\images\phpbb-seo.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Index: install/install_install.php
===================================================================
--- install/install_install.php	(revision 159)
+++ install/install_install.php	(revision 161)
@@ -105,7 +105,8 @@
 				$this->add_language($mode, $sub);
 				$this->add_bots($mode, $sub);
 				$this->email_admin($mode, $sub);
-
+				// SEO premod
+				set_config('seo_premod_version', '3.0.1');
 				// Remove the lock file
 				@unlink($phpbb_root_path . 'cache/install_lock');
 
@@ -425,7 +426,7 @@
 			'LEGEND_EXPLAIN'	=> $lang['FILES_REQUIRED_EXPLAIN'],
 		));
 
-		$directories = array('cache/', 'files/', 'store/');
+		$directories = array('cache/', 'files/', 'store/', 'phpbb_seo/cache/');
 
 		umask(0);
 
@@ -2170,6 +2171,9 @@
 				'ACP_MODULE_MANAGEMENT',
 			),
 			'ACP_CAT_DOT_MODS'		=> null,
+			'ACP_CAT_PHPBB_SEO'		=> array(
+				'ACP_MOD_REWRITE',
+			),
 		),
 		'mcp'	=> array(
 			'MCP_MAIN'		=> null,
Index: install/schemas/sqlite_schema.sql
===================================================================
--- install/schemas/sqlite_schema.sql	(revision 159)
+++ install/schemas/sqlite_schema.sql	(revision 161)
@@ -810,7 +810,8 @@
 CREATE INDEX phpbb_topics_topic_approved ON phpbb_topics (topic_approved);
 CREATE INDEX phpbb_topics_forum_appr_last ON phpbb_topics (forum_id, topic_approved, topic_last_post_id);
 CREATE INDEX phpbb_topics_fid_time_moved ON phpbb_topics (forum_id, topic_last_post_time, topic_moved_id);
-
+# Extra premod
+CREATE INDEX phpbb_topic_last_post_id ON phpbb_topics (topic_last_post_id);
 # Table: 'phpbb_topics_track'
 CREATE TABLE phpbb_topics_track (
 	user_id INTEGER UNSIGNED NOT NULL DEFAULT '0',
Index: install/schemas/oracle_schema.sql
===================================================================
--- install/schemas/oracle_schema.sql	(revision 159)
+++ install/schemas/oracle_schema.sql	(revision 161)
@@ -1621,7 +1621,9 @@
 /
 CREATE INDEX phpbb_topics_fid_time_moved ON phpbb_topics (forum_id, topic_last_post_time, topic_moved_id)
 /
-
+/* Extra premod */
+CREATE INDEX phpbb_topic_last_post_id ON phpbb_topics (topic_last_post_id)
+/
 CREATE SEQUENCE phpbb_topics_seq
 /
 
Index: install/schemas/firebird_schema.sql
===================================================================
--- install/schemas/firebird_schema.sql	(revision 159)
+++ install/schemas/firebird_schema.sql	(revision 161)
@@ -1227,7 +1227,8 @@
 CREATE INDEX phpbb_topics_topic_approved ON phpbb_topics(topic_approved);;
 CREATE INDEX phpbb_topics_forum_appr_last ON phpbb_topics(forum_id, topic_approved, topic_last_post_id);;
 CREATE INDEX phpbb_topics_fid_time_moved ON phpbb_topics(forum_id, topic_last_post_time, topic_moved_id);;
-
+# Extra premod
+CREATE INDEX phpbb_topic_last_post_id ON phpbb_topics(topic_last_post_id);;
 CREATE GENERATOR phpbb_topics_gen;;
 SET GENERATOR phpbb_topics_gen TO 0;;
 
Index: install/schemas/postgres_schema.sql
===================================================================
--- install/schemas/postgres_schema.sql	(revision 159)
+++ install/schemas/postgres_schema.sql	(revision 161)
@@ -1091,7 +1091,8 @@
 CREATE INDEX phpbb_topics_topic_approved ON phpbb_topics (topic_approved);
 CREATE INDEX phpbb_topics_forum_appr_last ON phpbb_topics (forum_id, topic_approved, topic_last_post_id);
 CREATE INDEX phpbb_topics_fid_time_moved ON phpbb_topics (forum_id, topic_last_post_time, topic_moved_id);
-
+/* Extra premod */
+CREATE INDEX phpbb_topic_last_post_id ON phpbb_topics (topic_last_post_id);
 /*
 	Table: 'phpbb_topics_track'
 */
Index: install/schemas/mysql_40_schema.sql
===================================================================
--- install/schemas/mysql_40_schema.sql	(revision 159)
+++ install/schemas/mysql_40_schema.sql	(revision 161)
@@ -839,8 +839,9 @@
 	KEY forum_appr_last (forum_id, topic_approved, topic_last_post_id),
 	KEY fid_time_moved (forum_id, topic_last_post_time, topic_moved_id)
 );
+# Extra premod
+ALTER TABLE `phpbb_topics` ADD INDEX ( `topic_last_post_id` );
 
-
 # Table: 'phpbb_topics_track'
 CREATE TABLE phpbb_topics_track (
 	user_id mediumint(8) UNSIGNED DEFAULT '0' NOT NULL,
Index: install/schemas/mysql_41_schema.sql
===================================================================
--- install/schemas/mysql_41_schema.sql	(revision 159)
+++ install/schemas/mysql_41_schema.sql	(revision 161)
@@ -839,8 +839,9 @@
 	KEY forum_appr_last (forum_id, topic_approved, topic_last_post_id),
 	KEY fid_time_moved (forum_id, topic_last_post_time, topic_moved_id)
 ) CHARACTER SET `utf8` COLLATE `utf8_bin`;
+# Extra premod 
+ALTER TABLE `phpbb_topics` ADD INDEX ( `topic_last_post_id` );
 
-
 # Table: 'phpbb_topics_track'
 CREATE TABLE phpbb_topics_track (
 	user_id mediumint(8) UNSIGNED DEFAULT '0' NOT NULL,
Index: install/schemas/mssql_schema.sql
===================================================================
--- install/schemas/mssql_schema.sql	(revision 159)
+++ install/schemas/mssql_schema.sql	(revision 161)
@@ -1466,8 +1466,10 @@
 
 CREATE  INDEX [fid_time_moved] ON [phpbb_topics]([forum_id], [topic_last_post_time], [topic_moved_id]) ON [PRIMARY]
 GO
+/* Extra premod */
+CREATE  INDEX [topic_last_post_id] ON [phpbb_topics]([topic_last_post_id]) ON [PRIMARY]
+GO
 
-
 /*
 	Table: 'phpbb_topics_track'
 */
Index: install/docs/COPYING
===================================================================
--- install/docs/COPYING	(revision 0)
+++ install/docs/COPYING	(revision 161)
@@ -0,0 +1,620 @@
+
+RECIPROCAL PUBLIC LICENSE
+
+Version 1.1, November 1, 2002
+
+Copyright (C) 2001-2002
+
+Technical Pursuit Inc.,
+
+All Rights Reserved.
+
+PREAMBLE
+
+This Preamble is intended to describe, in plain English, the nature,
+intent, and scope of this License. However, this Preamble is not a part
+of this License. The legal effect of this License is dependent only upon
+the terms of the License and not this Preamble.
+
+This License is based on the concept of reciprocity. In exchange for
+being granted certain rights under the terms of this License to
+Licensor's Software, whose Source Code You have access to, You are
+required to reciprocate by providing equal access and rights to all
+third parties to the Source Code of any Modifications, Derivative Works,
+and Required Components for execution of same (collectively defined as
+Extensions) that You Deploy by Deploying Your Extensions under the terms
+of this License. In this fashion the available Source Code related to
+the original Licensed Software is enlarged for the benefit of everyone.
+
+Under the terms of this License You may:
+
+a. Distribute the Licensed Software exactly as You received it under the
+terms of this License either alone or as a component of an aggregate
+software distribution containing programs from several different
+sources without payment of a royalty or other fee.
+
+b. Use the Licensed Software for any purpose consistent with the rights
+granted by this License, but the Licensor is not providing You any
+warranty whatsoever, nor is the Licensor accepting any liability in
+the event that the Licensed Software doesn't work properly or causes
+You any injury or damages.
+
+c. Create Extensions to the Licensed Software consistent with the rights
+granted by this License, provided that You make the Source Code to
+any Extensions You Deploy available to all third parties under the
+terms of this License, document Your Modifications clearly, and title
+all Extensions distinctly from the Licensed Software.
+
+d. Charge a fee for warranty or support, or for accepting indemnity or
+liability obligations for Your customers.
+
+Under the terms of this License You may not:
+
+a. Charge for the Source Code to the Licensed Software, or Your
+Extensions, other than a nominal fee not to exceed Your cost for
+reproduction and distribution where such reproduction and
+distribution involve physical media.
+
+b. Modify or delete any pre-existing copyright notices, change notices,
+or License text in the Licensed Software.
+
+c. Assert any patent claims against the Licensor or Contributors, or
+which would in any way restrict the ability of any third party to use
+the Licensed Software or portions thereof in any form under the terms
+of this License, or Your rights to the Licensed Software under this
+License automatically terminate.
+
+d. Represent either expressly or by implication, appearance, or
+otherwise that You represent Licensor or Contributors in any capacity
+or that You have any form of legal association by virtue of this
+License.
+
+Under the terms of this License You must:
+
+a. Document any Modifications You make to the Licensed Software
+including the nature of the change, the authors of the change, and
+the date of the change. This documentation must appear both in the
+Source Code and in a text file titled "CHANGES" distributed with the
+Licensed Software and Your Extensions.
+
+b. Make the Source Code for any Extensions You Deploy available in a
+timely fashion via an Electronic Distribution Mechanism such as FTP
+or HTTP download.
+
+c. Notify the Licensor of the availability of Source Code to Your
+Extensions in a timely fashion and include in such notice a brief
+description of the Extensions, the distinctive title used, and
+instructions on how to acquire the Source Code and future updates.
+
+d. Grant Licensor and all third parties a world-wide, non-exclusive,
+royalty-free license under any intellectual property rights owned or
+controlled by You to use, reproduce, display, perform, modify,
+sublicense, and distribute Your Extensions, in any form, under the
+terms of this License.
+
+LICENSE TERMS
+
+1.0 General; Applicability & Definitions. This Reciprocal Public License
+Version 1.1 ("License") applies to any programs or other works as well
+as any and all updates or maintenance releases of said programs or works
+("Software") not already covered by this License which the Software
+copyright holder ("Licensor") makes publicly available containing a
+Notice (hereinafter defined) from the Licensor specifying or allowing
+use or distribution under the terms of this License. As used in this
+License and Preamble:
+
+1.1 "Contributor" means any person or entity who created or contributed
+to the creation of an Extension.
+
+1.2 "Deploy" means to use, Serve, sublicense or distribute Licensed
+Software other than for Your internal Research and/or Personal Use, and
+includes without limitation, any and all internal use or distribution of
+Licensed Software within Your business or organization other than for
+Research and/or Personal Use, as well as direct or indirect sublicensing
+or distribution of Licensed Software by You to any third party in any
+form or manner.
+
+1.3 "Derivative Works" as used in this License is defined under U.S.
+copyright law.
+
+1.4 "Electronic Distribution Mechanism" means a mechanism generally
+accepted in the software development community for the electronic
+transfer of data such as download from an FTP or web site, where such
+mechanism is publicly accessible.
+
+1.5 "Extensions" means any Modifications, Derivative Works, or Required
+Components as those terms are defined in this License.
+
+1.6 "License" means this Reciprocal Public License.
+
+1.7 "Licensed Software" means any Software licensed pursuant to this
+License. Licensed Software also includes all previous Extensions from
+any Contributor that You receive.
+
+1.8 "Licensor" means the copyright holder of any Software previously
+uncovered by this License who releases the Software under the terms of
+this License.
+
+1.9 "Modifications" means any additions to or deletions from the
+substance or structure of (i) a file or other storage containing
+Licensed Software, or (ii) any new file or storage that contains any
+part of Licensed Software, or (iii) any file or storage which replaces
+or otherwise alters the original functionality of Licensed Software at
+runtime.
+
+1.10 "Notice" means the notice contained in EXHIBIT A.
+
+1.11 "Personal Use" means use of Licensed Software by an individual
+solely for his or her personal, private and non-commercial purposes. An
+individual's use of Licensed Software in his or her capacity as an
+officer, employee, member, independent contractor or agent of a
+corporation, business or organization (commercial or non-commercial)
+does not qualify as Personal Use.
+
+1.12 "Required Components" means any text, programs, scripts, schema,
+interface definitions, control files, or other works created by You
+which are required by a third party of average skill to successfully
+install and run Licensed Software containing Your Modifications, or to
+install and run Your Derivative Works.
+
+1.13 "Research" means investigation or experimentation for the purpose
+of understanding the nature and limits of the Licensed Software and its
+potential uses.
+
+1.14 "Serve" means to deliver Licensed Software and/or Your Extensions
+by means of a computer network to one or more computers for purposes of
+execution of Licensed Software and/or Your Extensions.
+
+1.15 "Software" means any computer programs or other works as well as
+any updates or maintenance releases of those programs or works which are
+distributed publicly by Licensor.
+
+1.16 "Source Code" means the preferred form for making modifications to
+the Licensed Software and/or Your Extensions, including all modules
+contained therein, plus any associated text, interface definition files,
+scripts used to control compilation and installation of an executable
+program or other components required by a third party of average skill
+to build a running version of the Licensed Software or Your Extensions.
+
+1.17 "You" or "Your" means an individual or a legal entity exercising
+rights under this License. For legal entities, "You" or "Your" includes
+any entity which controls, is controlled by, or is under common control
+with, You, where "control" means (a) the power, direct or indirect, to
+cause the direction or management of such entity, whether by contract
+or otherwise, or (b) ownership of fifty percent (50%) or more of the
+outstanding shares or beneficial ownership of such entity.
+
+2.0 Acceptance Of License. You are not required to accept this License
+since you have not signed it, however nothing else grants you permission
+to use, copy, distribute, modify, or create derivatives of either the
+Software or any Extensions created by a Contributor. These actions are
+prohibited by law if you do not accept this License. Therefore, by
+performing any of these actions You indicate Your acceptance of this
+License and Your agreement to be bound by all its terms and conditions.
+IF YOU DO NOT AGREE WITH ALL THE TERMS AND CONDITIONS OF THIS LICENSE DO
+NOT USE, MODIFY, CREATE DERIVATIVES, OR DISTRIBUTE THE SOFTWARE. IF IT
+IS IMPOSSIBLE FOR YOU TO COMPLY WITH ALL THE TERMS AND CONDITIONS OF
+THIS LICENSE THEN YOU CAN NOT USE, MODIFY, CREATE DERIVATIVES, OR
+DISTRIBUTE THE SOFTWARE.
+
+3.0 Grant of License From Licensor. Subject to the terms and conditions
+of this License, Licensor hereby grants You a world-wide, royalty-free,
+non-exclusive license, subject to Licensor's intellectual property
+rights, and any third party intellectual property claims derived from
+the Licensed Software under this License, to do the following:
+
+3.1 Use, reproduce, modify, display, perform, sublicense and distribute
+Licensed Software and Your Extensions in both Source Code form or as an
+executable program.
+
+3.2 Create Derivative Works (as that term is defined under U.S.
+copyright law) of Licensed Software by adding to or deleting from the
+substance or structure of said Licensed Software.
+
+3.3 Under claims of patents now or hereafter owned or controlled by
+Licensor, to make, use, have made, and/or otherwise dispose of Licensed
+Software or portions thereof, but solely to the extent that any such
+claim is necessary to enable You to make, use, have made, and/or
+otherwise dispose of Licensed Software or portions thereof.
+
+3.4 Licensor reserves the right to release new versions of the Software
+with different features, specifications, capabilities, functions,
+licensing terms, general availability or other characteristics. Title,
+ownership rights, and intellectual property rights in and to the
+Licensed Software shall remain in Licensor and/or its Contributors.
+
+4.0 Grant of License From Contributor. By application of the provisions
+in Section 6 below, each Contributor hereby grants You a world-wide,
+royalty-free, non-exclusive license, subject to said Contributor's
+intellectual property rights, and any third party intellectual property
+claims derived from the Licensed Software under this License, to do the
+following:
+
+4.1 Use, reproduce, modify, display, perform, sublicense and distribute
+any Extensions Deployed by such Contributor or portions thereof, in both
+Source Code form or as an executable program, either on an unmodified
+basis or as part of Derivative Works.
+
+4.2 Under claims of patents now or hereafter owned or controlled by
+Contributor, to make, use, have made, and/or otherwise dispose of
+Extensions or portions thereof, but solely to the extent that any such
+claim is necessary to enable You to make, use, have made, and/or
+otherwise dispose of Contributor's Extensions or portions thereof.
+
+5.0 Exclusions From License Grant. Nothing in this License shall be
+deemed to grant any rights to trademarks, copyrights, patents, trade
+secrets or any other intellectual property of Licensor or any
+Contributor except as expressly stated herein. Except as expressly
+stated in Sections 3 and 4, no other patent rights, express or implied,
+are granted herein. Your Extensions may require additional patent
+licenses from Licensor or Contributors which each may grant in its sole
+discretion. No right is granted to the trademarks of Licensor or any
+Contributor even if such marks are included in the Licensed Software.
+Nothing in this License shall be interpreted to prohibit Licensor from
+licensing under different terms from this License any code that Licensor
+otherwise would have a right to license.
+
+5.1 You expressly acknowledge and agree that although Licensor and each
+Contributor grants the licenses to their respective portions of the
+Licensed Software set forth herein, no assurances are provided by
+Licensor or any Contributor that the Licensed Software does not infringe
+the patent or other intellectual property rights of any other entity.
+Licensor and each Contributor disclaim any liability to You for claims
+brought by any other entity based on infringement of intellectual
+property rights or otherwise. As a condition to exercising the rights
+and licenses granted hereunder, You hereby assume sole responsibility to
+secure any other intellectual property rights needed, if any. For
+example, if a third party patent license is required to allow You to
+distribute the Licensed Software, it is Your responsibility to acquire
+that license before distributing the Licensed Software.
+
+6.0 Your Obligations And Grants. In consideration of, and as an express
+condition to, the licenses granted to You under this License You hereby
+agree that any Modifications, Derivative Works, or Required Components
+(collectively Extensions) that You create or to which You contribute are
+governed by the terms of this License including, without limitation,
+Section 4. Any Extensions that You create or to which You contribute
+must be Deployed under the terms of this License or a future version
+of this License released under Section 7. You hereby grant to Licensor
+and all third parties a world-wide, non-exclusive, royalty-free license
+under those intellectual property rights You own or control to use,
+reproduce, display, perform, modify, create derivatives, sublicense, and
+distribute Your Extensions, in any form. Any Extensions You make and
+Deploy must have a distinct title so as to readily tell any subsequent
+user or Contributor that the Extensions are by You. You must include a
+copy of this License with every copy of the Extensions You distribute.
+You agree not to offer or impose any terms on any Source Code or
+executable version of the Licensed Software, or its Extensions that
+alter or restrict the applicable version of this License or the
+recipients' rights hereunder.
+
+6.1 Availability of Source Code. You must make available, under the
+terms of this License, the Source Code of the Licensed Software and any
+Extensions that You Deploy, either on the same media as You distribute
+any executable or other form of the Licensed Software, or via an
+Electronic Distribution Mechanism. The Source Code for any version of
+Licensed Software, or its Extensions that You Deploy must be made
+available at the time of Deployment and must remain available for as
+long as You Deploy the Extensions or at least twelve (12) months after
+the date You Deploy, whichever is longer. You are responsible for
+ensuring that the Source Code version remains available even if the
+Electronic Distribution Mechanism is maintained by a third party. You
+may not charge a fee for the Source Code distributed under this Section
+in excess of Your actual cost of duplication and distribution where such
+duplication and distribution involve physical media.
+
+6.2 Description of Modifications. You must cause any Modifications that
+You create or to which You contribute, to update the file titled
+"CHANGES" distributed with Licensed Software documenting the additions,
+changes or deletions You made, the authors of such Modifications, and
+the dates of any such additions, changes or deletions. You must also
+cause a cross-reference to appear in the Source Code at the location of
+each change. You must include a prominent statement that the
+Modifications are derived, directly or indirectly, from the Licensed
+Software and include the names of the Licensor and any Contributor to
+the Licensed Software in (i) the Source Code and (ii) in any notice
+displayed by the Licensed Software You distribute or in related
+documentation in which You describe the origin or ownership of the
+Licensed Software. You may not modify or delete any pre-existing
+copyright notices, change notices or License text in the Licensed
+Software.
+
+6.3 Intellectual Property Matters.
+
+a. Third Party Claims. If You have knowledge that a license to a third
+party's intellectual property right is required to exercise the
+rights granted by this License, You must include a text file with the
+Source Code distribution titled "LEGAL" that describes the claim and
+the party making the claim in sufficient detail that a recipient will
+know whom to contact. If You obtain such knowledge after You make any
+Extensions available as described in Section 6.1, You shall promptly
+modify the LEGAL file in all copies You make available thereafter and
+shall take other steps (such as notifying appropriate mailing lists
+or newsgroups) reasonably calculated to inform those who received the
+Licensed Software from You that new knowledge has been obtained.
+
+b. Contributor APIs. If Your Extensions include an application
+programming interface ("API") and You have knowledge of patent
+licenses that are reasonably necessary to implement that API, You
+must also include this information in the LEGAL file.
+
+c. Representations. You represent that, except as disclosed pursuant to
+6.3(a) above, You believe that any Extensions You distribute are Your
+original creations and that You have sufficient rights to grant the
+rights conveyed by this License.
+
+6.4 Required Notices.
+
+a. License Text. You must duplicate this License in any documentation
+You provide along with the Source Code of any Extensions You create
+or to which You contribute, wherever You describe recipients' rights
+relating to Licensed Software. You must duplicate the notice
+contained in EXHIBIT A (the "Notice") in each file of the Source Code
+of any copy You distribute of the Licensed Software and Your
+Extensions. If You create an Extension, You may add Your name as a
+Contributor to the text file titled "CONTRIB" distributed with the
+Licensed Software along with a description of the contribution. If it
+is not possible to put the Notice in a particular Source Code file
+due to its structure, then You must include such Notice in a location
+(such as a relevant directory file) where a user would be likely to
+look for such a notice.
+
+b. Source Code Availability. You must notify Licensor within one (1)
+month of the date You initially Deploy of the availability of Source
+Code to Your Extensions and include in such notification the name
+under which you Deployed Your Extensions, a description of the
+Extensions, and instructions on how to acquire the Source Code,
+including instructions on how to acquire updates over time. Should
+such instructions change you must provide Licensor with revised
+instructions within one (1) month of the date of change. Should you
+be unable to notify Licensor directly, you must provide notification
+by posting to appropriate news groups, mailing lists, or web sites
+where a search engine would reasonably be expected to index them.
+
+6.5 Additional Terms. You may choose to offer, and charge a fee for,
+warranty, support, indemnity or liability obligations to one or more
+recipients of Licensed Software. However, You may do so only on Your
+own behalf, and not on behalf of the Licensor or any Contributor. You
+must make it clear that any such warranty, support, indemnity or
+liability obligation is offered by You alone, and You hereby agree to
+indemnify the Licensor and every Contributor for any liability plus
+attorney fees, costs, and related expenses due to any such action or
+claim incurred by the Licensor or such Contributor as a result of
+warranty, support, indemnity or liability terms You offer.
+
+6.6 Conflicts With Other Licenses. Where any portion of Your Extensions,
+by virtue of being Derivative Works of another product or similar
+circumstance, fall under the terms of another license, the terms of that
+license should be honored however You must also make Your Extensions
+available under this License. If the terms of this License continue to
+conflict with the terms of the other license you may write the Licensor
+for permission to resolve the conflict in a fashion that remains
+consistent with the intent of this License. Such permission will be
+granted at the sole discretion of the Licensor.
+
+7.0 Versions of This License. Licensor may publish from time to time
+revised and/or new versions of the License. Once Licensed Software has
+been published under a particular version of the License, You may always
+continue to use it under the terms of that version. You may also choose
+to use such Licensed Software under the terms of any subsequent version
+of the License published by Licensor. No one other than Licensor has the
+right to modify the terms applicable to Licensed Software created under
+this License.
+
+7.1 If You create or use a modified version of this License, which You
+may do only in order to apply it to software that is not already
+Licensed Software under this License, You must rename Your license so
+that it is not confusingly similar to this License, and must make it
+clear that Your license contains terms that differ from this License. In
+so naming Your license, You may not use any trademark of Licensor or of
+any Contributor. Should Your modifications to this License be limited to
+alteration of EXHIBIT A purely for purposes of adjusting the Notice You
+require of licensees, You may continue to refer to Your License as the
+Reciprocal Public License or simply the RPL.
+
+8.0 Disclaimer of Warranty. LICENSED SOFTWARE IS PROVIDED UNDER THIS
+LICENSE ON AN "AS IS" BASIS, WITHOUT WARRANTY OF ANY KIND, EITHER
+EXPRESS OR IMPLIED, INCLUDING, WITHOUT LIMITATION, WARRANTIES THAT THE
+LICENSED SOFTWARE IS FREE OF DEFECTS, MERCHANTABLE, FIT FOR A PARTICULAR
+PURPOSE OR NON-INFRINGING. FURTHER THERE IS NO WARRANTY MADE AND ALL
+IMPLIED WARRANTIES ARE DISCLAIMED THAT THE LICENSED SOFTWARE MEETS OR
+COMPLIES WITH ANY DESCRIPTION OF PERFORMANCE OR OPERATION, SAID
+COMPATIBILITY AND SUITABILITY BEING YOUR RESPONSIBILITY. LICENSOR
+DISCLAIMS ANY WARRANTY, IMPLIED OR EXPRESSED, THAT ANY CONTRIBUTOR'S
+EXTENSIONS MEET ANY STANDARD OF COMPATIBILITY OR DESCRIPTION OF
+PERFORMANCE. THE ENTIRE RISK AS TO THE QUALITY AND PERFORMANCE OF THE
+LICENSED SOFTWARE IS WITH YOU. SHOULD LICENSED SOFTWARE PROVE DEFECTIVE
+IN ANY RESPECT, YOU (AND NOT THE LICENSOR OR ANY OTHER CONTRIBUTOR)
+ASSUME THE COST OF ANY NECESSARY SERVICING, REPAIR OR CORRECTION. UNDER
+THE TERMS OF THIS LICENSOR WILL NOT SUPPORT THIS SOFTWARE AND IS UNDER
+NO OBLIGATION TO ISSUE UPDATES TO THIS SOFTWARE. LICENSOR HAS NO
+KNOWLEDGE OF ERRANT CODE OR VIRUS IN THIS SOFTWARE, BUT DOES NOT WARRANT
+THAT THE SOFTWARE IS FREE FROM SUCH ERRORS OR VIRUSES. THIS DISCLAIMER
+OF WARRANTY CONSTITUTES AN ESSENTIAL PART OF THIS LICENSE. NO USE OF
+LICENSED SOFTWARE IS AUTHORIZED HEREUNDER EXCEPT UNDER THIS DISCLAIMER.
+
+9.0 Limitation of Liability. UNDER NO CIRCUMSTANCES AND UNDER NO LEGAL
+THEORY, WHETHER TORT (INCLUDING NEGLIGENCE), CONTRACT, OR OTHERWISE,
+SHALL THE LICENSOR, ANY CONTRIBUTOR, OR ANY DISTRIBUTOR OF LICENSED
+SOFTWARE, OR ANY SUPPLIER OF ANY OF SUCH PARTIES, BE LIABLE TO ANY
+PERSON FOR ANY INDIRECT, SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES
+OF ANY CHARACTER INCLUDING, WITHOUT LIMITATION, DAMAGES FOR LOSS OF
+GOODWILL, WORK STOPPAGE, COMPUTER FAILURE OR MALFUNCTION, OR ANY AND ALL
+OTHER COMMERCIAL DAMAGES OR LOSSES, EVEN IF SUCH PARTY SHALL HAVE BEEN
+INFORMED OF THE POSSIBILITY OF SUCH DAMAGES. THIS LIMITATION OF
+LIABILITY SHALL NOT APPLY TO LIABILITY FOR DEATH OR PERSONAL INJURY
+RESULTING FROM SUCH PARTY'S NEGLIGENCE TO THE EXTENT APPLICABLE LAW
+PROHIBITS SUCH LIMITATION. SOME JURISDICTIONS DO NOT ALLOW THE EXCLUSION
+OR LIMITATION OF INCIDENTAL OR CONSEQUENTIAL DAMAGES, SO THIS EXCLUSION
+AND LIMITATION MAY NOT APPLY TO YOU.
+
+10.0 High Risk Activities. THE LICENSED SOFTWARE IS NOT FAULT-TOLERANT
+AND IS NOT DESIGNED, MANUFACTURED, OR INTENDED FOR USE OR DISTRIBUTION
+AS ON-LINE CONTROL EQUIPMENT IN HAZARDOUS ENVIRONMENTS REQUIRING
+FAIL-SAFE PERFORMANCE, SUCH AS IN THE OPERATION OF NUCLEAR FACILITIES,
+AIRCRAFT NAVIGATION OR COMMUNICATIONS SYSTEMS, AIR TRAFFIC CONTROL,
+DIRECT LIFE SUPPORT MACHINES, OR WEAPONS SYSTEMS, IN WHICH THE FAILURE
+OF THE LICENSED SOFTWARE COULD LEAD DIRECTLY TO DEATH, PERSONAL INJURY,
+OR SEVERE PHYSICAL OR ENVIRONMENTAL DAMAGE ("HIGH RISK ACTIVITIES").
+LICENSOR AND CONTRIBUTORS SPECIFICALLY DISCLAIM ANY EXPRESS OR IMPLIED
+WARRANTY OF FITNESS FOR HIGH RISK ACTIVITIES.
+
+11.0 Responsibility for Claims. As between Licensor and Contributors,
+each party is responsible for claims and damages arising, directly or
+indirectly, out of its utilization of rights under this License which
+specifically disclaims warranties and limits any liability of the
+Licensor. This paragraph is to be used in conjunction with and
+controlled by the Disclaimer Of Warranties of Section 8, the Limitation
+Of Damages in Section 9, and the disclaimer against use for High Risk
+Activities in Section 10. The Licensor has thereby disclaimed all
+warranties and limited any damages that it is or may be liable for. You
+agree to work with Licensor and Contributors to distribute such
+responsibility on an equitable basis consistent with the terms of this
+License including Sections 8, 9, and 10. Nothing herein is intended or
+shall be deemed to constitute any admission of liability.
+
+12.0 Termination. This License and all rights granted hereunder will
+terminate immediately in the event of the circumstances described in
+Section 13.6 or if applicable law prohibits or restricts You from
+fully and or specifically complying with Sections 3, 4 and/or 6, or
+prevents the enforceability of any of those Sections, and You must
+immediately discontinue any use of Licensed Software.
+
+12.1 Automatic Termination Upon Breach. This License and the rights
+granted hereunder will terminate automatically if You fail to comply
+with the terms herein and fail to cure such breach within thirty (30)
+days of becoming aware of the breach. All sublicenses to the Licensed
+Software that are properly granted shall survive any termination of this
+License. Provisions that, by their nature, must remain in effect beyond
+the termination of this License, shall survive.
+
+12.2 Termination Upon Assertion of Patent Infringement. If You initiate
+litigation by asserting a patent infringement claim (excluding
+declaratory judgment actions) against Licensor or a Contributor
+(Licensor or Contributor against whom You file such an action is
+referred to herein as "Respondent") alleging that Licensed Software
+directly or indirectly infringes any patent, then any and all rights
+granted by such Respondent to You under Sections 3 or 4 of this License
+shall terminate prospectively upon sixty (60) days notice from
+Respondent (the "Notice Period") unless within that Notice Period You
+either agree in writing (i) to pay Respondent a mutually agreeable
+reasonably royalty for Your past or future use of Licensed Software made
+by such Respondent, or (ii) withdraw Your litigation claim with respect
+to Licensed Software against such Respondent. If within said Notice
+Period a reasonable royalty and payment arrangement are not mutually
+agreed upon in writing by the parties or the litigation claim is not
+withdrawn, the rights granted by Licensor to You under Sections 3 and 4
+automatically terminate at the expiration of said Notice Period.
+
+12.3 Reasonable Value of This License. If You assert a patent
+infringement claim against Respondent alleging that Licensed Software
+directly or indirectly infringes any patent where such claim is resolved
+(such as by license or settlement) prior to the initiation of patent
+infringement litigation, then the reasonable value of the licenses
+granted by said Respondent under Sections 3 and 4 shall be taken into
+account in determining the amount or value of any payment or license.
+
+12.4 No Retroactive Effect of Termination. In the event of termination
+under this Section all end user license agreements (excluding licenses
+to distributors and resellers) that have been validly granted by You or
+any distributor hereunder prior to termination shall survive
+termination.
+
+13.0 Miscellaneous.
+
+13.1 U.S. Government End Users. The Licensed Software is a "commercial
+item," as that term is defined in 48 C.F.R. 2.101 (Oct. 1995),
+consisting of "commercial computer software" and "commercial computer
+software documentation," as such terms are used in 48 C.F.R. 12.212
+(Sept. 1995). Consistent with 48 C.F.R. 12.212 and 48 C.F.R. 227.7202-1
+through 227.7202-4 (June 1995), all U.S. Government End Users acquire
+Licensed Software with only those rights set forth herein.
+
+13.2 Relationship of Parties. This License will not be construed as
+creating an agency, partnership, joint venture, or any other form of
+legal association between or among You, Licensor, or any Contributor,
+and You will not represent to the contrary, whether expressly, by
+implication, appearance, or otherwise.
+
+13.3 Independent Development. Nothing in this License will impair
+Licensor's right to acquire, license, develop, subcontract, market, or
+distribute technology or products that perform the same or similar
+functions as, or otherwise compete with, Extensions that You may
+develop, produce, market, or distribute.
+
+13.4 Consent To Breach Not Waiver. Failure by Licensor or Contributor to
+enforce any provision of this License will not be deemed a waiver of
+future enforcement of that or any other provision.
+
+13.5 Severability. This License represents the complete agreement
+concerning the subject matter hereof. If any provision of this License
+is held to be unenforceable, such provision shall be reformed only to
+the extent necessary to make it enforceable.
+
+13.6 Inability to Comply Due to Statute or Regulation. If it is
+impossible for You to comply with any of the terms of this License with
+respect to some or all of the Licensed Software due to statute, judicial
+order, or regulation, then You cannot use, modify, or distribute the
+software.
+
+13.7 Export Restrictions. You may be restricted with respect to
+downloading or otherwise acquiring, exporting, or reexporting the
+Licensed Software or any underlying information or technology by United
+States and other applicable laws and regulations. By downloading or by
+otherwise obtaining the Licensed Software, You are agreeing to be
+responsible for compliance with all applicable laws and regulations.
+
+13.8 Arbitration, Jurisdiction & Venue. This License shall be governed
+by Colorado law provisions (except to the extent applicable law, if any,
+provides otherwise), excluding its conflict-of-law provisions. You
+expressly agree that any dispute relating to this License shall be
+submitted to binding arbitration under the rules then prevailing of the
+American Arbitration Association. You further agree that Adams County,
+Colorado USA is proper venue and grant such arbitration proceeding
+jurisdiction as may be appropriate for purposes of resolving any dispute
+under this License. Judgement upon any award made in arbitration may be
+entered and enforced in any court of competent jurisdiction. The
+arbitrator shall award attorney's fees and costs of arbitration to the
+prevailing party. Should either party find it necessary to enforce its
+arbitration award or seek specific performance of such award in a civil
+court of competent jurisdiction, the prevailing party shall be entitled
+to reasonable attorney's fees and costs. The application of the United
+Nations Convention on Contracts for the International Sale of Goods is
+expressly excluded. You and Licensor expressly waive any rights to a
+jury trial in any litigation concerning Licensed Software or this
+License. Any law or regulation that provides that the language of a
+contract shall be construed against the drafter shall not apply to this
+License.
+
+13.9 Entire Agreement. This License constitutes the entire agreement
+between the parties with respect to the subject matter hereof.
+
+EXHIBIT A
+
+The Notice below must appear in each file of the Source Code of any copy
+You distribute of the Licensed Software or any Extensions thereto,
+except as may be modified as allowed under the terms of Section 7.1
+
+    Copyright (C) 1999-2002 Technical Pursuit Inc., All Rights
+    Reserved. Patent Pending, Technical Pursuit Inc.
+
+    Unless explicitly acquired and licensed from Licensor under the
+    Technical Pursuit License ("TPL") Version 1.0 or greater, the
+    contents of this file are subject to the Reciprocal Public License
+    ("RPL") Version 1.1, or subsequent versions as allowed by the RPL,
+    and You may not copy or use this file in either source code or
+    executable form, except in compliance with the terms and conditions
+    of the RPL.
+
+    You may obtain a copy of both the TPL and the RPL (the "Licenses")
+    from Technical Pursuit Inc. at http://www.technicalpursuit.com.
+
+    All software distributed under the Licenses is provided strictly on
+    an "AS IS" basis, WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR
+    IMPLIED, AND TECHNICAL PURSUIT INC. HEREBY DISCLAIMS ALL SUCH
+    WARRANTIES, INCLUDING WITHOUT LIMITATION, ANY WARRANTIES OF
+    MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, QUIET ENJOYMENT,
+    OR NON-INFRINGEMENT. See the Licenses for specific language
+    governing rights and limitations under the Licenses. 
+
+
Index: install/database_update.php
===================================================================
--- install/database_update.php	(revision 159)
+++ install/database_update.php	(revision 161)
@@ -56,7 +56,7 @@
 require($phpbb_root_path . 'includes/session.' . $phpEx);
 require($phpbb_root_path . 'includes/auth.' . $phpEx);
 
-require($phpbb_root_path . 'includes/functions.' . $phpEx);
+require($phpbb_root_path . 'install/functions.' . $phpEx);
 
 if (file_exists($phpbb_root_path . 'includes/functions_content.' . $phpEx))
 {
@@ -1251,7 +1251,8 @@
 	SET config_value = '$updates_to_version'
 	WHERE config_name = 'version'";
 _sql($sql, $errored, $error_ary);
-
+// SEO premod
+set_config('seo_premod_version', '3.0.1');
 // Reset permissions
 $sql = 'UPDATE ' . USERS_TABLE . "
 	SET user_permissions = '',
Index: install/install_phpbb_seo.php
===================================================================
--- install/install_phpbb_seo.php	(revision 0)
+++ install/install_phpbb_seo.php	(revision 161)
@@ -0,0 +1,69 @@
+<?php
+/** 
+*
+* @package install
+* @version $Id: install_main.php,v 1.12 2006/08/06 17:25:29 naderman Exp $
+* @copyright (c) 2005 phpBB Group 
+* @license http://opensource.org/licenses/gpl-license.php GNU Public License 
+*
+*/
+
+/**
+*/
+
+if ( !defined('IN_INSTALL') )
+{
+	// Someone has tried to access the file direct. This is not a good idea, so exit
+	exit;
+}
+
+if (!empty($setmodules))
+{
+	$module[] = array(
+		'module_type'		=> 'install',
+		'module_title'		=> 'SEO_PREMOD',
+		'module_filename'	=> substr(basename(__FILE__), 0, -strlen($phpEx)-1),
+		'module_order'		=> -1,
+		'module_subs'		=> array('INTRO', 'LICENSE', 'SUPPORT'),
+		'module_stages'		=> '',
+		'module_reqs'		=> ''
+	);
+}
+
+/**
+* Main Tab - Installation
+* @package install
+*/
+class install_phpbb_seo extends module {
+	function install_phpbb_seo(&$p_master) {
+		$this->p_master = &$p_master;
+	}
+	function main($mode, $sub) {
+		global $lang, $template, $language;
+
+		switch ($sub) {
+			case 'intro' :
+				$title = $lang['SEO_PREMOD_TITLE'];
+				$body = $lang['SEO_PREMOD_BODY'];
+			break;
+			case 'license' :
+				$title = $lang['SEO_LICENCE_TITLE'];
+				$body = '<p>' . $lang['SEO_PREMOD_LICENCE'] . '</p><br/><hr/>' . implode("<br/>\n", file('./docs/COPYING'));
+			break;
+			case 'support' :
+				$title = $lang['SEO_SUPPORT_TITLE'];
+				$body = $lang['SEO_PREMOD_SUPPORT_BODY'];
+			break;
+		}
+		$this->tpl_name = 'install_main';
+		$this->page_title = $title;
+		$template->assign_vars(array(
+			'TITLE'		=> $title,
+			'BODY'		=> $body,
+
+			'S_LANG_SELECT'	=> '<select id="language" name="language">' . $this->p_master->inst_language_select($language) . '</select>',
+		));
+	}
+}
+
+?>
Index: install/index.php
===================================================================
--- install/index.php	(revision 159)
+++ install/index.php	(revision 161)
@@ -148,7 +148,7 @@
 @ini_set('memory_limit', $mem_limit);
 
 // Include essential scripts
-require($phpbb_root_path . 'includes/functions.' . $phpEx);
+require($phpbb_root_path . 'install/functions.' . $phpEx);
 
 if (file_exists($phpbb_root_path . 'includes/functions_content.' . $phpEx))
 {
@@ -227,10 +227,11 @@
 include($phpbb_root_path . 'language/' . $language . '/common.' . $phpEx);
 include($phpbb_root_path . 'language/' . $language . '/acp/common.' . $phpEx);
 include($phpbb_root_path . 'language/' . $language . '/acp/board.' . $phpEx);
+include($phpbb_root_path . 'language/' . $language . '/acp/phpbb_seo.' . $phpEx);
 include($phpbb_root_path . 'language/' . $language . '/install.' . $phpEx);
 include($phpbb_root_path . 'language/' . $language . '/posting.' . $phpEx);
 
-$mode = request_var('mode', 'overview');
+$mode = request_var('mode', 'seo_premod');
 $sub = request_var('sub', '');
 
 // Set PHP error handler to ours
Index: install/functions.php
===================================================================
--- install/functions.php	(revision 0)
+++ install/functions.php	(revision 161)
@@ -0,0 +1,3690 @@
+<?php
+/**
+*
+* @package phpBB3
+* @version $Id: functions.php 8491 2008-04-04 11:41:58Z acydburn $
+* @copyright (c) 2005 phpBB Group
+* @license http://opensource.org/licenses/gpl-license.php GNU Public License
+*
+*/
+
+/**
+* @ignore
+*/
+if (!defined('IN_PHPBB'))
+{
+	exit;
+}
+
+// Common global functions
+
+/**
+* set_var
+*
+* Set variable, used by {@link request_var the request_var function}
+*
+* @access private
+*/
+function set_var(&$result, $var, $type, $multibyte = false)
+{
+	settype($var, $type);
+	$result = $var;
+
+	if ($type == 'string')
+	{
+		$result = trim(htmlspecialchars(str_replace(array("\r\n", "\r"), array("\n", "\n"), $result), ENT_COMPAT, 'UTF-8'));
+
+		if (!empty($result))
+		{
+			// Make sure multibyte characters are wellformed
+			if ($multibyte)
+			{
+				if (!preg_match('/^./u', $result))
+				{
+					$result = '';
+				}
+			}
+			else
+			{
+				// no multibyte, allow only ASCII (0-127)
+				$result = preg_replace('/[\x80-\xFF]/', '?', $result);
+			}
+		}
+
+		$result = (STRIP) ? stripslashes($result) : $result;
+	}
+}
+
+/**
+* request_var
+*
+* Used to get passed variable
+*/
+function request_var($var_name, $default, $multibyte = false, $cookie = false)
+{
+	if (!$cookie && isset($_COOKIE[$var_name]))
+	{
+		if (!isset($_GET[$var_name]) && !isset($_POST[$var_name]))
+		{
+			return (is_array($default)) ? array() : $default;
+		}
+		$_REQUEST[$var_name] = isset($_POST[$var_name]) ? $_POST[$var_name] : $_GET[$var_name];
+	}
+
+	if (!isset($_REQUEST[$var_name]) || (is_array($_REQUEST[$var_name]) && !is_array($default)) || (is_array($default) && !is_array($_REQUEST[$var_name])))
+	{
+		return (is_array($default)) ? array() : $default;
+	}
+
+	$var = $_REQUEST[$var_name];
+	if (!is_array($default))
+	{
+		$type = gettype($default);
+	}
+	else
+	{
+		list($key_type, $type) = each($default);
+		$type = gettype($type);
+		$key_type = gettype($key_type);
+		if ($type == 'array')
+		{
+			reset($default);
+			$default = current($default);
+			list($sub_key_type, $sub_type) = each($default);
+			$sub_type = gettype($sub_type);
+			$sub_type = ($sub_type == 'array') ? 'NULL' : $sub_type;
+			$sub_key_type = gettype($sub_key_type);
+		}
+	}
+
+	if (is_array($var))
+	{
+		$_var = $var;
+		$var = array();
+
+		foreach ($_var as $k => $v)
+		{
+			set_var($k, $k, $key_type);
+			if ($type == 'array' && is_array($v))
+			{
+				foreach ($v as $_k => $_v)
+				{
+					if (is_array($_v))
+					{
+						$_v = null;
+					}
+					set_var($_k, $_k, $sub_key_type);
+					set_var($var[$k][$_k], $_v, $sub_type, $multibyte);
+				}
+			}
+			else
+			{
+				if ($type == 'array' || is_array($v))
+				{
+					$v = null;
+				}
+				set_var($var[$k], $v, $type, $multibyte);
+			}
+		}
+	}
+	else
+	{
+		set_var($var, $var, $type, $multibyte);
+	}
+
+	return $var;
+}
+
+/**
+* Set config value. Creates missing config entry.
+*/
+function set_config($config_name, $config_value, $is_dynamic = false)
+{
+	global $db, $cache, $config;
+
+	$sql = 'UPDATE ' . CONFIG_TABLE . "
+		SET config_value = '" . $db->sql_escape($config_value) . "'
+		WHERE config_name = '" . $db->sql_escape($config_name) . "'";
+	$db->sql_query($sql);
+
+	if (!$db->sql_affectedrows() && !isset($config[$config_name]))
+	{
+		$sql = 'INSERT INTO ' . CONFIG_TABLE . ' ' . $db->sql_build_array('INSERT', array(
+			'config_name'	=> $config_name,
+			'config_value'	=> $config_value,
+			'is_dynamic'	=> ($is_dynamic) ? 1 : 0));
+		$db->sql_query($sql);
+	}
+
+	$config[$config_name] = $config_value;
+
+	if (!$is_dynamic)
+	{
+		$cache->destroy('config');
+	}
+}
+
+/**
+* Generates an alphanumeric random string of given length
+*/
+function gen_rand_string($num_chars = 8)
+{
+	$rand_str = unique_id();
+	$rand_str = str_replace('0', 'Z', strtoupper(base_convert($rand_str, 16, 35)));
+
+	return substr($rand_str, 0, $num_chars);
+}
+
+/**
+* Return unique id
+* @param string $extra additional entropy
+*/
+function unique_id($extra = 'c')
+{
+	static $dss_seeded = false;
+	global $config;
+
+	$val = $config['rand_seed'] . microtime();
+	$val = md5($val);
+	$config['rand_seed'] = md5($config['rand_seed'] . $val . $extra);
+
+	if ($dss_seeded !== true && ($config['rand_seed_last_update'] < time() - rand(1,10)))
+	{
+		set_config('rand_seed', $config['rand_seed'], true);
+		set_config('rand_seed_last_update', time(), true);
+		$dss_seeded = true;
+	}
+
+	return substr($val, 4, 16);
+}
+
+/**
+* Return formatted string for filesizes
+*/
+function get_formatted_filesize($bytes, $add_size_lang = true)
+{
+	global $user;
+
+	if ($bytes >= pow(2, 20))
+	{
+		return ($add_size_lang) ? round($bytes / 1024 / 1024, 2) . ' ' . $user->lang['MIB'] : round($bytes / 1024 / 1024, 2);
+	}
+
+	if ($bytes >= pow(2, 10))
+	{
+		return ($add_size_lang) ? round($bytes / 1024, 2) . ' ' . $user->lang['KIB'] : round($bytes / 1024, 2);
+	}
+
+	return ($add_size_lang) ? ($bytes) . ' ' . $user->lang['BYTES'] : ($bytes);
+}
+
+/**
+* Determine whether we are approaching the maximum execution time. Should be called once
+* at the beginning of the script in which it's used.
+* @return	bool	Either true if the maximum execution time is nearly reached, or false
+*					if some time is still left.
+*/
+function still_on_time($extra_time = 15)
+{
+	static $max_execution_time, $start_time;
+
+	$time = explode(' ', microtime());
+	$current_time = $time[0] + $time[1];
+
+	if (empty($max_execution_time))
+	{
+		$max_execution_time = (function_exists('ini_get')) ? (int) @ini_get('max_execution_time') : (int) @get_cfg_var('max_execution_time');
+
+		// If zero, then set to something higher to not let the user catch the ten seconds barrier.
+		if ($max_execution_time === 0)
+		{
+			$max_execution_time = 50 + $extra_time;
+		}
+
+		$max_execution_time = min(max(10, ($max_execution_time - $extra_time)), 50);
+
+		// For debugging purposes
+		// $max_execution_time = 10;
+
+		global $starttime;
+		$start_time = (empty($starttime)) ? $current_time : $starttime;
+	}
+
+	return (ceil($current_time - $start_time) < $max_execution_time) ? true : false;
+}
+
+/**
+*
+* @version Version 0.1 / $Id: functions.php 8491 2008-04-04 11:41:58Z acydburn $
+*
+* Portable PHP password hashing framework.
+*
+* Written by Solar Designer <solar at openwall.com> in 2004-2006 and placed in
+* the public domain.
+*
+* There's absolutely no warranty.
+*
+* The homepage URL for this framework is:
+*
+*	http://www.openwall.com/phpass/
+*
+* Please be sure to update the Version line if you edit this file in any way.
+* It is suggested that you leave the main version number intact, but indicate
+* your project name (after the slash) and add your own revision information.
+*
+* Please do not change the "private" password hashing method implemented in
+* here, thereby making your hashes incompatible.  However, if you must, please
+* change the hash type identifier (the "$P$") to something different.
+*
+* Obviously, since this code is in the public domain, the above are not
+* requirements (there can be none), but merely suggestions.
+*
+*
+* Hash the password
+*/
+function phpbb_hash($password)
+{
+	$itoa64 = './0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
+
+	$random_state = unique_id();
+	$random = '';
+	$count = 6;
+
+	if (($fh = @fopen('/dev/urandom', 'rb')))
+	{
+		$random = fread($fh, $count);
+		fclose($fh);
+	}
+
+	if (strlen($random) < $count)
+	{
+		$random = '';
+
+		for ($i = 0; $i < $count; $i += 16)
+		{
+			$random_state = md5(unique_id() . $random_state);
+			$random .= pack('H*', md5($random_state));
+		}
+		$random = substr($random, 0, $count);
+	}
+
+	$hash = _hash_crypt_private($password, _hash_gensalt_private($random, $itoa64), $itoa64);
+
+	if (strlen($hash) == 34)
+	{
+		return $hash;
+	}
+
+	return md5($password);
+}
+
+/**
+* Check for correct password
+*/
+function phpbb_check_hash($password, $hash)
+{
+	$itoa64 = './0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
+	if (strlen($hash) == 34)
+	{
+		return (_hash_crypt_private($password, $hash, $itoa64) === $hash) ? true : false;
+	}
+
+	return (md5($password) === $hash) ? true : false;
+}
+
+/**
+* Generate salt for hash generation
+*/
+function _hash_gensalt_private($input, &$itoa64, $iteration_count_log2 = 6)
+{
+	if ($iteration_count_log2 < 4 || $iteration_count_log2 > 31)
+	{
+		$iteration_count_log2 = 8;
+	}
+
+	$output = '$H$';
+	$output .= $itoa64[min($iteration_count_log2 + ((PHP_VERSION >= 5) ? 5 : 3), 30)];
+	$output .= _hash_encode64($input, 6, $itoa64);
+
+	return $output;
+}
+
+/**
+* Encode hash
+*/
+function _hash_encode64($input, $count, &$itoa64)
+{
+	$output = '';
+	$i = 0;
+
+	do
+	{
+		$value = ord($input[$i++]);
+		$output .= $itoa64[$value & 0x3f];
+
+		if ($i < $count)
+		{
+			$value |= ord($input[$i]) << 8;
+		}
+
+		$output .= $itoa64[($value >> 6) & 0x3f];
+
+		if ($i++ >= $count)
+		{
+			break;
+		}
+
+		if ($i < $count)
+		{
+			$value |= ord($input[$i]) << 16;
+		}
+
+		$output .= $itoa64[($value >> 12) & 0x3f];
+
+		if ($i++ >= $count)
+		{
+			break;
+		}
+
+		$output .= $itoa64[($value >> 18) & 0x3f];
+	}
+	while ($i < $count);
+
+	return $output;
+}
+
+/**
+* The crypt function/replacement
+*/
+function _hash_crypt_private($password, $setting, &$itoa64)
+{
+	$output = '*';
+
+	// Check for correct hash
+	if (substr($setting, 0, 3) != '$H$')
+	{
+		return $output;
+	}
+
+	$count_log2 = strpos($itoa64, $setting[3]);
+
+	if ($count_log2 < 7 || $count_log2 > 30)
+	{
+		return $output;
+	}
+
+	$count = 1 << $count_log2;
+	$salt = substr($setting, 4, 8);
+
+	if (strlen($salt) != 8)
+	{
+		return $output;
+	}
+
+	/**
+	* We're kind of forced to use MD5 here since it's the only
+	* cryptographic primitive available in all versions of PHP
+	* currently in use.  To implement our own low-level crypto
+	* in PHP would result in much worse performance and
+	* consequently in lower iteration counts and hashes that are
+	* quicker to crack (by non-PHP code).
+	*/
+	if (PHP_VERSION >= 5)
+	{
+		$hash = md5($salt . $password, true);
+		do
+		{
+			$hash = md5($hash . $password, true);
+		}
+		while (--$count);
+	}
+	else
+	{
+		$hash = pack('H*', md5($salt . $password));
+		do
+		{
+			$hash = pack('H*', md5($hash . $password));
+		}
+		while (--$count);
+	}
+
+	$output = substr($setting, 0, 12);
+	$output .= _hash_encode64($hash, 16, $itoa64);
+
+	return $output;
+}
+
+// Compatibility functions
+
+if (!function_exists('array_combine'))
+{
+	/**
+	* A wrapper for the PHP5 function array_combine()
+	* @param array $keys contains keys for the resulting array
+	* @param array $values contains values for the resulting array
+	*
+	* @return Returns an array by using the values from the keys array as keys and the
+	* 	values from the values array as the corresponding values. Returns false if the
+	* 	number of elements for each array isn't equal or if the arrays are empty.
+	*/
+	function array_combine($keys, $values)
+	{
+		$keys = array_values($keys);
+		$values = array_values($values);
+
+		$n = sizeof($keys);
+		$m = sizeof($values);
+		if (!$n || !$m || ($n != $m))
+		{
+			return false;
+		}
+
+		$combined = array();
+		for ($i = 0; $i < $n; $i++)
+		{
+			$combined[$keys[$i]] = $values[$i];
+		}
+		return $combined;
+	}
+}
+
+if (!function_exists('str_split'))
+{
+	/**
+	* A wrapper for the PHP5 function str_split()
+	* @param array $string contains the string to be converted
+	* @param array $split_length contains the length of each chunk
+	*
+	* @return  Converts a string to an array. If the optional split_length parameter is specified,
+	*  	the returned array will be broken down into chunks with each being split_length in length,
+	*  	otherwise each chunk will be one character in length. FALSE is returned if split_length is
+	*  	less than 1. If the split_length length exceeds the length of string, the entire string is
+	*  	returned as the first (and only) array element.
+	*/
+	function str_split($string, $split_length = 1)
+	{
+		if ($split_length < 1)
+		{
+			return false;
+		}
+		else if ($split_length >= strlen($string))
+		{
+			return array($string);
+		}
+		else
+		{
+			preg_match_all('#.{1,' . $split_length . '}#s', $string, $matches);
+			return $matches[0];
+		}
+	}
+}
+
+if (!function_exists('stripos'))
+{
+	/**
+	* A wrapper for the PHP5 function stripos
+	* Find position of first occurrence of a case-insensitive string
+	*
+	* @param string $haystack is the string to search in
+	* @param string $needle is the string to search for
+	*
+	* @return mixed Returns the numeric position of the first occurrence of needle in the haystack string. Unlike strpos(), stripos() is case-insensitive.
+	* Note that the needle may be a string of one or more characters.
+	* If needle is not found, stripos() will return boolean FALSE.
+	*/
+	function stripos($haystack, $needle)
+	{
+		if (preg_match('#' . preg_quote($needle, '#') . '#i', $haystack, $m))
+		{
+			return strpos($haystack, $m[0]);
+		}
+
+		return false;
+	}
+}
+
+/**
+* Checks if a path ($path) is absolute or relative
+*
+* @param string $path Path to check absoluteness of
+* @return boolean
+*/
+function is_absolute($path)
+{
+	return ($path[0] == '/' || (DIRECTORY_SEPARATOR == '\\' && preg_match('#^[a-z]:/#i', $path))) ? true : false;
+}
+
+/**
+* @author Chris Smith <chris@project-minerva.org>
+* @copyright 2006 Project Minerva Team
+* @param string $path The path which we should attempt to resolve.
+* @return mixed
+*/
+function phpbb_own_realpath($path)
+{
+	// Now to perform funky shizzle
+
+	// Switch to use UNIX slashes
+	$path = str_replace(DIRECTORY_SEPARATOR, '/', $path);
+	$path_prefix = '';
+
+	// Determine what sort of path we have
+	if (is_absolute($path))
+	{
+		$absolute = true;
+
+		if ($path[0] == '/')
+		{
+			// Absolute path, *NIX style
+			$path_prefix = '';
+		}
+		else
+		{
+			// Absolute path, Windows style
+			// Remove the drive letter and colon
+			$path_prefix = $path[0] . ':';
+			$path = substr($path, 2);
+		}
+	}
+	else
+	{
+		// Relative Path
+		// Prepend the current working directory
+		if (function_exists('getcwd'))
+		{
+			// This is the best method, hopefully it is enabled!
+			$path = str_replace(DIRECTORY_SEPARATOR, '/', getcwd()) . '/' . $path;
+			$absolute = true;
+			if (preg_match('#^[a-z]:#i', $path))
+			{
+				$path_prefix = $path[0] . ':';
+				$path = substr($path, 2);
+			}
+			else
+			{
+				$path_prefix = '';
+			}
+		}
+		else if (isset($_SERVER['SCRIPT_FILENAME']) && !empty($_SERVER['SCRIPT_FILENAME']))
+		{
+			// Warning: If chdir() has been used this will lie!
+			// Warning: This has some problems sometime (CLI can create them easily)
+			$path = str_replace(DIRECTORY_SEPARATOR, '/', dirname($_SERVER['SCRIPT_FILENAME'])) . '/' . $path;
+			$absolute = true;
+			$path_prefix = '';
+		}
+		else
+		{
+			// We have no way of getting the absolute path, just run on using relative ones.
+			$absolute = false;
+			$path_prefix = '.';
+		}
+	}
+
+	// Remove any repeated slashes
+	$path = preg_replace('#/{2,}#', '/', $path);
+
+	// Remove the slashes from the start and end of the path
+	$path = trim($path, '/');
+
+	// Break the string into little bits for us to nibble on
+	$bits = explode('/', $path);
+
+	// Remove any . in the path, renumber array for the loop below
+	$bits = array_values(array_diff($bits, array('.')));
+
+	// Lets get looping, run over and resolve any .. (up directory)
+	for ($i = 0, $max = sizeof($bits); $i < $max; $i++)
+	{
+		// @todo Optimise
+		if ($bits[$i] == '..' )
+		{
+			if (isset($bits[$i - 1]))
+			{
+				if ($bits[$i - 1] != '..')
+				{
+					// We found a .. and we are able to traverse upwards, lets do it!
+					unset($bits[$i]);
+					unset($bits[$i - 1]);
+					$i -= 2;
+					$max -= 2;
+					$bits = array_values($bits);
+				}
+			}
+			else if ($absolute) // ie. !isset($bits[$i - 1]) && $absolute
+			{
+				// We have an absolute path trying to descend above the root of the filesystem
+				// ... Error!
+				return false;
+			}
+		}
+	}
+
+	// Prepend the path prefix
+	array_unshift($bits, $path_prefix);
+
+	$resolved = '';
+
+	$max = sizeof($bits) - 1;
+
+	// Check if we are able to resolve symlinks, Windows cannot.
+	$symlink_resolve = (function_exists('readlink')) ? true : false;
+
+	foreach ($bits as $i => $bit)
+	{
+		if (@is_dir("$resolved/$bit") || ($i == $max && @is_file("$resolved/$bit")))
+		{
+			// Path Exists
+			if ($symlink_resolve && is_link("$resolved/$bit") && ($link = readlink("$resolved/$bit")))
+			{
+				// Resolved a symlink.
+				$resolved = $link . (($i == $max) ? '' : '/');
+				continue;
+			}
+		}
+		else
+		{
+			// Something doesn't exist here!
+			// This is correct realpath() behaviour but sadly open_basedir and safe_mode make this problematic
+			// return false;
+		}
+		$resolved .= $bit . (($i == $max) ? '' : '/');
+	}
+
+	// @todo If the file exists fine and open_basedir only has one path we should be able to prepend it
+	// because we must be inside that basedir, the question is where...
+	// @internal The slash in is_dir() gets around an open_basedir restriction
+	if (!@file_exists($resolved) || (!is_dir($resolved . '/') && !is_file($resolved)))
+	{
+		return false;
+	}
+
+	// Put the slashes back to the native operating systems slashes
+	$resolved = str_replace('/', DIRECTORY_SEPARATOR, $resolved);
+
+	// Check for DIRECTORY_SEPARATOR at the end (and remove it!)
+	if (substr($resolved, -1) == DIRECTORY_SEPARATOR)
+	{
+		return substr($resolved, 0, -1);
+	}
+
+	return $resolved; // We got here, in the end!
+}
+
+if (!function_exists('realpath'))
+{
+	/**
+	* A wrapper for realpath
+	* @ignore
+	*/
+	function phpbb_realpath($path)
+	{
+		return phpbb_own_realpath($path);
+	}
+}
+else
+{
+	/**
+	* A wrapper for realpath
+	*/
+	function phpbb_realpath($path)
+	{
+		$realpath = realpath($path);
+
+		// Strangely there are provider not disabling realpath but returning strange values. :o
+		// We at least try to cope with them.
+		if ($realpath === $path || $realpath === false)
+		{
+			return phpbb_own_realpath($path);
+		}
+
+		// Check for DIRECTORY_SEPARATOR at the end (and remove it!)
+		if (substr($realpath, -1) == DIRECTORY_SEPARATOR)
+		{
+			$realpath = substr($realpath, 0, -1);
+		}
+
+		return $realpath;
+	}
+}
+
+if (!function_exists('htmlspecialchars_decode'))
+{
+	/**
+	* A wrapper for htmlspecialchars_decode
+	* @ignore
+	*/
+	function htmlspecialchars_decode($string, $quote_style = ENT_COMPAT)
+	{
+		return strtr($string, array_flip(get_html_translation_table(HTML_SPECIALCHARS, $quote_style)));
+	}
+}
+
+// functions used for building option fields
+
+/**
+* Pick a language, any language ...
+*/
+function language_select($default = '')
+{
+	global $db;
+
+	$sql = 'SELECT lang_iso, lang_local_name
+		FROM ' . LANG_TABLE . '
+		ORDER BY lang_english_name';
+	$result = $db->sql_query($sql);
+
+	$lang_options = '';
+	while ($row = $db->sql_fetchrow($result))
+	{
+		$selected = ($row['lang_iso'] == $default) ? ' selected="selected"' : '';
+		$lang_options .= '<option value="' . $row['lang_iso'] . '"' . $selected . '>' . $row['lang_local_name'] . '</option>';
+	}
+	$db->sql_freeresult($result);
+
+	return $lang_options;
+}
+
+/**
+* Pick a template/theme combo,
+*/
+function style_select($default = '', $all = false)
+{
+	global $db;
+
+	$sql_where = (!$all) ? 'WHERE style_active = 1 ' : '';
+	$sql = 'SELECT style_id, style_name
+		FROM ' . STYLES_TABLE . "
+		$sql_where
+		ORDER BY style_name";
+	$result = $db->sql_query($sql);
+
+	$style_options = '';
+	while ($row = $db->sql_fetchrow($result))
+	{
+		$selected = ($row['style_id'] == $default) ? ' selected="selected"' : '';
+		$style_options .= '<option value="' . $row['style_id'] . '"' . $selected . '>' . $row['style_name'] . '</option>';
+	}
+	$db->sql_freeresult($result);
+
+	return $style_options;
+}
+
+/**
+* Pick a timezone
+*/
+function tz_select($default = '', $truncate = false)
+{
+	global $user;
+
+	$tz_select = '';
+	foreach ($user->lang['tz_zones'] as $offset => $zone)
+	{
+		if ($truncate)
+		{
+			$zone_trunc = truncate_string($zone, 50, false, '...');
+		}
+		else
+		{
+			$zone_trunc = $zone;
+		}
+
+		if (is_numeric($offset))
+		{
+			$selected = ($offset == $default) ? ' selected="selected"' : '';
+			$tz_select .= '<option title="'.$zone.'" value="' . $offset . '"' . $selected . '>' . $zone_trunc . '</option>';
+		}
+	}
+
+	return $tz_select;
+}
+
+// Functions handling topic/post tracking/marking
+
+/**
+* Marks a topic/forum as read
+* Marks a topic as posted to
+*
+* @param int $user_id can only be used with $mode == 'post'
+*/
+function markread($mode, $forum_id = false, $topic_id = false, $post_time = 0, $user_id = 0)
+{
+	global $db, $user, $config;
+
+	if ($mode == 'all')
+	{
+		if ($forum_id === false || !sizeof($forum_id))
+		{
+			if ($config['load_db_lastread'] && $user->data['is_registered'])
+			{
+				// Mark all forums read (index page)
+				$db->sql_query('DELETE FROM ' . TOPICS_TRACK_TABLE . " WHERE user_id = {$user->data['user_id']}");
+				$db->sql_query('DELETE FROM ' . FORUMS_TRACK_TABLE . " WHERE user_id = {$user->data['user_id']}");
+				$db->sql_query('UPDATE ' . USERS_TABLE . ' SET user_lastmark = ' . time() . " WHERE user_id = {$user->data['user_id']}");
+			}
+			else if ($config['load_anon_lastread'] || $user->data['is_registered'])
+			{
+				$tracking_topics = (isset($_COOKIE[$config['cookie_name'] . '_track'])) ? ((STRIP) ? stripslashes($_COOKIE[$config['cookie_name'] . '_track']) : $_COOKIE[$config['cookie_name'] . '_track']) : '';
+				$tracking_topics = ($tracking_topics) ? tracking_unserialize($tracking_topics) : array();
+
+				unset($tracking_topics['tf']);
+				unset($tracking_topics['t']);
+				unset($tracking_topics['f']);
+				$tracking_topics['l'] = base_convert(time() - $config['board_startdate'], 10, 36);
+
+				$user->set_cookie('track', tracking_serialize($tracking_topics), time() + 31536000);
+				$_COOKIE[$config['cookie_name'] . '_track'] = (STRIP) ? addslashes(tracking_serialize($tracking_topics)) : tracking_serialize($tracking_topics);
+
+				unset($tracking_topics);
+
+				if ($user->data['is_registered'])
+				{
+					$db->sql_query('UPDATE ' . USERS_TABLE . ' SET user_lastmark = ' . time() . " WHERE user_id = {$user->data['user_id']}");
+				}
+			}
+		}
+
+		return;
+	}
+	else if ($mode == 'topics')
+	{
+		// Mark all topics in forums read
+		if (!is_array($forum_id))
+		{
+			$forum_id = array($forum_id);
+		}
+
+		// Add 0 to forums array to mark global announcements correctly
+		$forum_id[] = 0;
+
+		if ($config['load_db_lastread'] && $user->data['is_registered'])
+		{
+			$sql = 'DELETE FROM ' . TOPICS_TRACK_TABLE . "
+				WHERE user_id = {$user->data['user_id']}
+					AND " . $db->sql_in_set('forum_id', $forum_id);
+			$db->sql_query($sql);
+
+			$sql = 'SELECT forum_id
+				FROM ' . FORUMS_TRACK_TABLE . "
+				WHERE user_id = {$user->data['user_id']}
+					AND " . $db->sql_in_set('forum_id', $forum_id);
+			$result = $db->sql_query($sql);
+
+			$sql_update = array();
+			while ($row = $db->sql_fetchrow($result))
+			{
+				$sql_update[] = $row['forum_id'];
+			}
+			$db->sql_freeresult($result);
+
+			if (sizeof($sql_update))
+			{
+				$sql = 'UPDATE ' . FORUMS_TRACK_TABLE . '
+					SET mark_time = ' . time() . "
+					WHERE user_id = {$user->data['user_id']}
+						AND " . $db->sql_in_set('forum_id', $sql_update);
+				$db->sql_query($sql);
+			}
+
+			if ($sql_insert = array_diff($forum_id, $sql_update))
+			{
+				$sql_ary = array();
+				foreach ($sql_insert as $f_id)
+				{
+					$sql_ary[] = array(
+						'user_id'	=> (int) $user->data['user_id'],
+						'forum_id'	=> (int) $f_id,
+						'mark_time'	=> time()
+					);
+				}
+
+				$db->sql_multi_insert(FORUMS_TRACK_TABLE, $sql_ary);
+			}
+		}
+		else if ($config['load_anon_lastread'] || $user->data['is_registered'])
+		{
+			$tracking = (isset($_COOKIE[$config['cookie_name'] . '_track'])) ? ((STRIP) ? stripslashes($_COOKIE[$config['cookie_name'] . '_track']) : $_COOKIE[$config['cookie_name'] . '_track']) : '';
+			$tracking = ($tracking) ? tracking_unserialize($tracking) : array();
+
+			foreach ($forum_id as $f_id)
+			{
+				$topic_ids36 = (isset($tracking['tf'][$f_id])) ? $tracking['tf'][$f_id] : array();
+
+				if (isset($tracking['tf'][$f_id]))
+				{
+					unset($tracking['tf'][$f_id]);
+				}
+
+				foreach ($topic_ids36 as $topic_id36)
+				{
+					unset($tracking['t'][$topic_id36]);
+				}
+
+				if (isset($tracking['f'][$f_id]))
+				{
+					unset($tracking['f'][$f_id]);
+				}
+
+				$tracking['f'][$f_id] = base_convert(time() - $config['board_startdate'], 10, 36);
+			}
+
+			if (isset($tracking['tf']) && empty($tracking['tf']))
+			{
+				unset($tracking['tf']);
+			}
+
+			$user->set_cookie('track', tracking_serialize($tracking), time() + 31536000);
+			$_COOKIE[$config['cookie_name'] . '_track'] = (STRIP) ? addslashes(tracking_serialize($tracking)) : tracking_serialize($tracking);
+
+			unset($tracking);
+		}
+
+		return;
+	}
+	else if ($mode == 'topic')
+	{
+		if ($topic_id === false || $forum_id === false)
+		{
+			return;
+		}
+
+		if ($config['load_db_lastread'] && $user->data['is_registered'])
+		{
+			$sql = 'UPDATE ' . TOPICS_TRACK_TABLE . '
+				SET mark_time = ' . (($post_time) ? $post_time : time()) . "
+				WHERE user_id = {$user->data['user_id']}
+					AND topic_id = $topic_id";
+			$db->sql_query($sql);
+
+			// insert row
+			if (!$db->sql_affectedrows())
+			{
+				$db->sql_return_on_error(true);
+
+				$sql_ary = array(
+					'user_id'		=> (int) $user->data['user_id'],
+					'topic_id'		=> (int) $topic_id,
+					'forum_id'		=> (int) $forum_id,
+					'mark_time'		=> ($post_time) ? (int) $post_time : time(),
+				);
+
+				$db->sql_query('INSERT INTO ' . TOPICS_TRACK_TABLE . ' ' . $db->sql_build_array('INSERT', $sql_ary));
+
+				$db->sql_return_on_error(false);
+			}
+		}
+		else if ($config['load_anon_lastread'] || $user->data['is_registered'])
+		{
+			$tracking = (isset($_COOKIE[$config['cookie_name'] . '_track'])) ? ((STRIP) ? stripslashes($_COOKIE[$config['cookie_name'] . '_track']) : $_COOKIE[$config['cookie_name'] . '_track']) : '';
+			$tracking = ($tracking) ? tracking_unserialize($tracking) : array();
+
+			$topic_id36 = base_convert($topic_id, 10, 36);
+
+			if (!isset($tracking['t'][$topic_id36]))
+			{
+				$tracking['tf'][$forum_id][$topic_id36] = true;
+			}
+
+			$post_time = ($post_time) ? $post_time : time();
+			$tracking['t'][$topic_id36] = base_convert($post_time - $config['board_startdate'], 10, 36);
+
+			// If the cookie grows larger than 10000 characters we will remove the smallest value
+			// This can result in old topics being unread - but most of the time it should be accurate...
+			if (isset($_COOKIE[$config['cookie_name'] . '_track']) && strlen($_COOKIE[$config['cookie_name'] . '_track']) > 10000)
+			{
+				//echo 'Cookie grown too large' . print_r($tracking, true);
+
+				// We get the ten most minimum stored time offsets and its associated topic ids
+				$time_keys = array();
+				for ($i = 0; $i < 10 && sizeof($tracking['t']); $i++)
+				{
+					$min_value = min($tracking['t']);
+					$m_tkey = array_search($min_value, $tracking['t']);
+					unset($tracking['t'][$m_tkey]);
+
+					$time_keys[$m_tkey] = $min_value;
+				}
+
+				// Now remove the topic ids from the array...
+				foreach ($tracking['tf'] as $f_id => $topic_id_ary)
+				{
+					foreach ($time_keys as $m_tkey => $min_value)
+					{
+						if (isset($topic_id_ary[$m_tkey]))
+						{
+							$tracking['f'][$f_id] = $min_value;
+							unset($tracking['tf'][$f_id][$m_tkey]);
+						}
+					}
+				}
+
+				if ($user->data['is_registered'])
+				{
+					$user->data['user_lastmark'] = intval(base_convert(max($time_keys) + $config['board_startdate'], 36, 10));
+					$db->sql_query('UPDATE ' . USERS_TABLE . ' SET user_lastmark = ' . $user->data['user_lastmark'] . " WHERE user_id = {$user->data['user_id']}");
+				}
+				else
+				{
+					$tracking['l'] = max($time_keys);
+				}
+			}
+
+			$user->set_cookie('track', tracking_serialize($tracking), time() + 31536000);
+			$_COOKIE[$config['cookie_name'] . '_track'] = (STRIP) ? addslashes(tracking_serialize($tracking)) : tracking_serialize($tracking);
+		}
+
+		return;
+	}
+	else if ($mode == 'post')
+	{
+		if ($topic_id === false)
+		{
+			return;
+		}
+
+		$use_user_id = (!$user_id) ? $user->data['user_id'] : $user_id;
+
+		if ($config['load_db_track'] && $use_user_id != ANONYMOUS)
+		{
+			$db->sql_return_on_error(true);
+
+			$sql_ary = array(
+				'user_id'		=> (int) $use_user_id,
+				'topic_id'		=> (int) $topic_id,
+				'topic_posted'	=> 1
+			);
+
+			$db->sql_query('INSERT INTO ' . TOPICS_POSTED_TABLE . ' ' . $db->sql_build_array('INSERT', $sql_ary));
+
+			$db->sql_return_on_error(false);
+		}
+
+		return;
+	}
+}
+
+/**
+* Get topic tracking info by using already fetched info
+*/
+function get_topic_tracking($forum_id, $topic_ids, &$rowset, $forum_mark_time, $global_announce_list = false)
+{
+	global $config, $user;
+
+	$last_read = array();
+
+	if (!is_array($topic_ids))
+	{
+		$topic_ids = array($topic_ids);
+	}
+
+	foreach ($topic_ids as $topic_id)
+	{
+		if (!empty($rowset[$topic_id]['mark_time']))
+		{
+			$last_read[$topic_id] = $rowset[$topic_id]['mark_time'];
+		}
+	}
+
+	$topic_ids = array_diff($topic_ids, array_keys($last_read));
+
+	if (sizeof($topic_ids))
+	{
+		$mark_time = array();
+
+		// Get global announcement info
+		if ($global_announce_list && sizeof($global_announce_list))
+		{
+			if (!isset($forum_mark_time[0]))
+			{
+				global $db;
+
+				$sql = 'SELECT mark_time
+					FROM ' . FORUMS_TRACK_TABLE . "
+					WHERE user_id = {$user->data['user_id']}
+						AND forum_id = 0";
+				$result = $db->sql_query($sql);
+				$row = $db->sql_fetchrow($result);
+				$db->sql_freeresult($result);
+
+				if ($row)
+				{
+					$mark_time[0] = $row['mark_time'];
+				}
+			}
+			else
+			{
+				if ($forum_mark_time[0] !== false)
+				{
+					$mark_time[0] = $forum_mark_time[0];
+				}
+			}
+		}
+
+		if (!empty($forum_mark_time[$forum_id]) && $forum_mark_time[$forum_id] !== false)
+		{
+			$mark_time[$forum_id] = $forum_mark_time[$forum_id];
+		}
+
+		$user_lastmark = (isset($mark_time[$forum_id])) ? $mark_time[$forum_id] : $user->data['user_lastmark'];
+
+		foreach ($topic_ids as $topic_id)
+		{
+			if ($global_announce_list && isset($global_announce_list[$topic_id]))
+			{
+				$last_read[$topic_id] = (isset($mark_time[0])) ? $mark_time[0] : $user_lastmark;
+			}
+			else
+			{
+				$last_read[$topic_id] = $user_lastmark;
+			}
+		}
+	}
+
+	return $last_read;
+}
+
+/**
+* Get topic tracking info from db (for cookie based tracking only this function is used)
+*/
+function get_complete_topic_tracking($forum_id, $topic_ids, $global_announce_list = false)
+{
+	global $config, $user;
+
+	$last_read = array();
+
+	if (!is_array($topic_ids))
+	{
+		$topic_ids = array($topic_ids);
+	}
+
+	if ($config['load_db_lastread'] && $user->data['is_registered'])
+	{
+		global $db;
+
+		$sql = 'SELECT topic_id, mark_time
+			FROM ' . TOPICS_TRACK_TABLE . "
+			WHERE user_id = {$user->data['user_id']}
+				AND " . $db->sql_in_set('topic_id', $topic_ids);
+		$result = $db->sql_query($sql);
+
+		while ($row = $db->sql_fetchrow($result))
+		{
+			$last_read[$row['topic_id']] = $row['mark_time'];
+		}
+		$db->sql_freeresult($result);
+
+		$topic_ids = array_diff($topic_ids, array_keys($last_read));
+
+		if (sizeof($topic_ids))
+		{
+			$sql = 'SELECT forum_id, mark_time
+				FROM ' . FORUMS_TRACK_TABLE . "
+				WHERE user_id = {$user->data['user_id']}
+					AND forum_id " .
+					(($global_announce_list && sizeof($global_announce_list)) ? "IN (0, $forum_id)" : "= $forum_id");
+			$result = $db->sql_query($sql);
+
+			$mark_time = array();
+			while ($row = $db->sql_fetchrow($result))
+			{
+				$mark_time[$row['forum_id']] = $row['mark_time'];
+			}
+			$db->sql_freeresult($result);
+
+			$user_lastmark = (isset($mark_time[$forum_id])) ? $mark_time[$forum_id] : $user->data['user_lastmark'];
+
+			foreach ($topic_ids as $topic_id)
+			{
+				if ($global_announce_list && isset($global_announce_list[$topic_id]))
+				{
+					$last_read[$topic_id] = (isset($mark_time[0])) ? $mark_time[0] : $user_lastmark;
+				}
+				else
+				{
+					$last_read[$topic_id] = $user_lastmark;
+				}
+			}
+		}
+	}
+	else if ($config['load_anon_lastread'] || $user->data['is_registered'])
+	{
+		global $tracking_topics;
+
+		if (!isset($tracking_topics) || !sizeof($tracking_topics))
+		{
+			$tracking_topics = (isset($_COOKIE[$config['cookie_name'] . '_track'])) ? ((STRIP) ? stripslashes($_COOKIE[$config['cookie_name'] . '_track']) : $_COOKIE[$config['cookie_name'] . '_track']) : '';
+			$tracking_topics = ($tracking_topics) ? tracking_unserialize($tracking_topics) : array();
+		}
+
+		if (!$user->data['is_registered'])
+		{
+			$user_lastmark = (isset($tracking_topics['l'])) ? base_convert($tracking_topics['l'], 36, 10) + $config['board_startdate'] : 0;
+		}
+		else
+		{
+			$user_lastmark = $user->data['user_lastmark'];
+		}
+
+		foreach ($topic_ids as $topic_id)
+		{
+			$topic_id36 = base_convert($topic_id, 10, 36);
+
+			if (isset($tracking_topics['t'][$topic_id36]))
+			{
+				$last_read[$topic_id] = base_convert($tracking_topics['t'][$topic_id36], 36, 10) + $config['board_startdate'];
+			}
+		}
+
+		$topic_ids = array_diff($topic_ids, array_keys($last_read));
+
+		if (sizeof($topic_ids))
+		{
+			$mark_time = array();
+			if ($global_announce_list && sizeof($global_announce_list))
+			{
+				if (isset($tracking_topics['f'][0]))
+				{
+					$mark_time[0] = base_convert($tracking_topics['f'][0], 36, 10) + $config['board_startdate'];
+				}
+			}
+
+			if (isset($tracking_topics['f'][$forum_id]))
+			{
+				$mark_time[$forum_id] = base_convert($tracking_topics['f'][$forum_id], 36, 10) + $config['board_startdate'];
+			}
+
+			$user_lastmark = (isset($mark_time[$forum_id])) ? $mark_time[$forum_id] : $user_lastmark;
+
+			foreach ($topic_ids as $topic_id)
+			{
+				if ($global_announce_list && isset($global_announce_list[$topic_id]))
+				{
+					$last_read[$topic_id] = (isset($mark_time[0])) ? $mark_time[0] : $user_lastmark;
+				}
+				else
+				{
+					$last_read[$topic_id] = $user_lastmark;
+				}
+			}
+		}
+	}
+
+	return $last_read;
+}
+
+/**
+* Check for read forums and update topic tracking info accordingly
+*
+* @param int $forum_id the forum id to check
+* @param int $forum_last_post_time the forums last post time
+* @param int $f_mark_time the forums last mark time if user is registered and load_db_lastread enabled
+* @param int $mark_time_forum false if the mark time needs to be obtained, else the last users forum mark time
+*
+* @return true if complete forum got marked read, else false.
+*/
+function update_forum_tracking_info($forum_id, $forum_last_post_time, $f_mark_time = false, $mark_time_forum = false)
+{
+	global $db, $tracking_topics, $user, $config;
+
+	// Determine the users last forum mark time if not given.
+	if ($mark_time_forum === false)
+	{
+		if ($config['load_db_lastread'] && $user->data['is_registered'])
+		{
+			$mark_time_forum = (!empty($f_mark_time)) ? $f_mark_time : $user->data['user_lastmark'];
+		}
+		else if ($config['load_anon_lastread'] || $user->data['is_registered'])
+		{
+			$tracking_topics = (isset($_COOKIE[$config['cookie_name'] . '_track'])) ? ((STRIP) ? stripslashes($_COOKIE[$config['cookie_name'] . '_track']) : $_COOKIE[$config['cookie_name'] . '_track']) : '';
+			$tracking_topics = ($tracking_topics) ? tracking_unserialize($tracking_topics) : array();
+
+			if (!$user->data['is_registered'])
+			{
+				$user->data['user_lastmark'] = (isset($tracking_topics['l'])) ? (int) (base_convert($tracking_topics['l'], 36, 10) + $config['board_startdate']) : 0;
+			}
+
+			$mark_time_forum = (isset($tracking_topics['f'][$forum_id])) ? (int) (base_convert($tracking_topics['f'][$forum_id], 36, 10) + $config['board_startdate']) : $user->data['user_lastmark'];
+		}
+	}
+
+	// Check the forum for any left unread topics.
+	// If there are none, we mark the forum as read.
+	if ($config['load_db_lastread'] && $user->data['is_registered'])
+	{
+		if ($mark_time_forum >= $forum_last_post_time)
+		{
+			// We do not need to mark read, this happened before. Therefore setting this to true
+			$row = true;
+		}
+		else
+		{
+			$sql = 'SELECT t.forum_id FROM ' . TOPICS_TABLE . ' t
+				LEFT JOIN ' . TOPICS_TRACK_TABLE . ' tt ON (tt.topic_id = t.topic_id AND tt.user_id = ' . $user->data['user_id'] . ')
+				WHERE t.forum_id = ' . $forum_id . '
+					AND t.topic_last_post_time > ' . $mark_time_forum . '
+					AND t.topic_moved_id = 0
+					AND (tt.topic_id IS NULL OR tt.mark_time < t.topic_last_post_time)
+				GROUP BY t.forum_id';
+			$result = $db->sql_query_limit($sql, 1);
+			$row = $db->sql_fetchrow($result);
+			$db->sql_freeresult($result);
+		}
+	}
+	else if ($config['load_anon_lastread'] || $user->data['is_registered'])
+	{
+		// Get information from cookie
+		$row = false;
+
+		if (!isset($tracking_topics['tf'][$forum_id]))
+		{
+			// We do not need to mark read, this happened before. Therefore setting this to true
+			$row = true;
+		}
+		else
+		{
+			$sql = 'SELECT topic_id
+				FROM ' . TOPICS_TABLE . '
+				WHERE forum_id = ' . $forum_id . '
+					AND topic_last_post_time > ' . $mark_time_forum . '
+					AND topic_moved_id = 0';
+			$result = $db->sql_query($sql);
+
+			$check_forum = $tracking_topics['tf'][$forum_id];
+			$unread = false;
+
+			while ($row = $db->sql_fetchrow($result))
+			{
+				if (!isset($check_forum[base_convert($row['topic_id'], 10, 36)]))
+				{
+					$unread = true;
+					break;
+				}
+			}
+			$db->sql_freeresult($result);
+
+			$row = $unread;
+		}
+	}
+	else
+	{
+		$row = true;
+	}
+
+	if (!$row)
+	{
+		markread('topics', $forum_id);
+		return true;
+	}
+
+	return false;
+}
+
+/**
+* Transform an array into a serialized format
+*/
+function tracking_serialize($input)
+{
+	$out = '';
+	foreach ($input as $key => $value)
+	{
+		if (is_array($value))
+		{
+			$out .= $key . ':(' . tracking_serialize($value) . ');';
+		}
+		else
+		{
+			$out .= $key . ':' . $value . ';';
+		}
+	}
+	return $out;
+}
+
+/**
+* Transform a serialized array into an actual array
+*/
+function tracking_unserialize($string, $max_depth = 3)
+{
+	$n = strlen($string);
+	if ($n > 10010)
+	{
+		die('Invalid data supplied');
+	}
+	$data = $stack = array();
+	$key = '';
+	$mode = 0;
+	$level = &$data;
+	for ($i = 0; $i < $n; ++$i)
+	{
+		switch ($mode)
+		{
+			case 0:
+				switch ($string[$i])
+				{
+					case ':':
+						$level[$key] = 0;
+						$mode = 1;
+					break;
+					case ')':
+						unset($level);
+						$level = array_pop($stack);
+						$mode = 3;
+					break;
+					default:
+						$key .= $string[$i];
+				}
+			break;
+
+			case 1:
+				switch ($string[$i])
+				{
+					case '(':
+						if (sizeof($stack) >= $max_depth)
+						{
+							die('Invalid data supplied');
+						}
+						$stack[] = &$level;
+						$level[$key] = array();
+						$level = &$level[$key];
+						$key = '';
+						$mode = 0;
+					break;
+					default:
+						$level[$key] = $string[$i];
+						$mode = 2;
+					break;
+				}
+			break;
+
+			case 2:
+				switch ($string[$i])
+				{
+					case ')':
+						unset($level);
+						$level = array_pop($stack);
+						$mode = 3;
+					break;
+					case ';':
+						$key = '';
+						$mode = 0;
+					break;
+					default:
+						$level[$key] .= $string[$i];
+					break;
+				}
+			break;
+
+			case 3:
+				switch ($string[$i])
+				{
+					case ')':
+						unset($level);
+						$level = array_pop($stack);
+					break;
+					case ';':
+						$key = '';
+						$mode = 0;
+					break;
+					default:
+						die('Invalid data supplied');
+					break;
+				}
+			break;
+		}
+	}
+
+	if (sizeof($stack) != 0 || ($mode != 0 && $mode != 3))
+	{
+		die('Invalid data supplied');
+	}
+
+	return $level;
+}
+
+// Pagination functions
+
+/**
+* Pagination routine, generates page number sequence
+* tpl_prefix is for using different pagination blocks at one page
+*/
+function generate_pagination($base_url, $num_items, $per_page, $start_item, $add_prevnext_text = false, $tpl_prefix = '')
+{
+	global $template, $user;
+
+	// Make sure $per_page is a valid value
+	$per_page = ($per_page <= 0) ? 1 : $per_page;
+
+	$seperator = '<span class="page-sep">' . $user->lang['COMMA_SEPARATOR'] . '</span>';
+	$total_pages = ceil($num_items / $per_page);
+
+	if ($total_pages == 1 || !$num_items)
+	{
+		return false;
+	}
+
+	$on_page = floor($start_item / $per_page) + 1;
+	$url_delim = (strpos($base_url, '?') === false) ? '?' : '&amp;';
+
+	$page_string = ($on_page == 1) ? '<strong>1</strong>' : '<a href="' . $base_url . '">1</a>';
+
+	if ($total_pages > 5)
+	{
+		$start_cnt = min(max(1, $on_page - 4), $total_pages - 5);
+		$end_cnt = max(min($total_pages, $on_page + 4), 6);
+
+		$page_string .= ($start_cnt > 1) ? ' ... ' : $seperator;
+
+		for ($i = $start_cnt + 1; $i < $end_cnt; $i++)
+		{
+			$page_string .= ($i == $on_page) ? '<strong>' . $i . '</strong>' : '<a href="' . $base_url . "{$url_delim}start=" . (($i - 1) * $per_page) . '">' . $i . '</a>';
+			if ($i < $end_cnt - 1)
+			{
+				$page_string .= $seperator;
+			}
+		}
+
+		$page_string .= ($end_cnt < $total_pages) ? ' ... ' : $seperator;
+	}
+	else
+	{
+		$page_string .= $seperator;
+
+		for ($i = 2; $i < $total_pages; $i++)
+		{
+			$page_string .= ($i == $on_page) ? '<strong>' . $i . '</strong>' : '<a href="' . $base_url . "{$url_delim}start=" . (($i - 1) * $per_page) . '">' . $i . '</a>';
+			if ($i < $total_pages)
+			{
+				$page_string .= $seperator;
+			}
+		}
+	}
+
+	$page_string .= ($on_page == $total_pages) ? '<strong>' . $total_pages . '</strong>' : '<a href="' . $base_url . "{$url_delim}start=" . (($total_pages - 1) * $per_page) . '">' . $total_pages . '</a>';
+
+	if ($add_prevnext_text)
+	{
+		if ($on_page != 1)
+		{
+			$page_string = '<a href="' . $base_url . "{$url_delim}start=" . (($on_page - 2) * $per_page) . '">' . $user->lang['PREVIOUS'] . '</a>&nbsp;&nbsp;' . $page_string;
+		}
+
+		if ($on_page != $total_pages)
+		{
+			$page_string .= '&nbsp;&nbsp;<a href="' . $base_url . "{$url_delim}start=" . ($on_page * $per_page) . '">' . $user->lang['NEXT'] . '</a>';
+		}
+	}
+
+	$template->assign_vars(array(
+		$tpl_prefix . 'BASE_URL'		=> $base_url,
+		'A_' . $tpl_prefix . 'BASE_URL'	=> addslashes($base_url),
+		$tpl_prefix . 'PER_PAGE'		=> $per_page,
+
+		$tpl_prefix . 'PREVIOUS_PAGE'	=> ($on_page == 1) ? '' : $base_url . "{$url_delim}start=" . (($on_page - 2) * $per_page),
+		$tpl_prefix . 'NEXT_PAGE'		=> ($on_page == $total_pages) ? '' : $base_url . "{$url_delim}start=" . ($on_page * $per_page),
+		$tpl_prefix . 'TOTAL_PAGES'		=> $total_pages,
+	));
+
+	return $page_string;
+}
+
+/**
+* Return current page (pagination)
+*/
+function on_page($num_items, $per_page, $start)
+{
+	global $template, $user;
+
+	// Make sure $per_page is a valid value
+	$per_page = ($per_page <= 0) ? 1 : $per_page;
+
+	$on_page = floor($start / $per_page) + 1;
+
+	$template->assign_vars(array(
+		'ON_PAGE'		=> $on_page)
+	);
+
+	return sprintf($user->lang['PAGE_OF'], $on_page, max(ceil($num_items / $per_page), 1));
+}
+
+// Server functions (building urls, redirecting...)
+
+/**
+* Append session id to url.
+* This function supports hooks.
+*
+* @param string $url The url the session id needs to be appended to (can have params)
+* @param mixed $params String or array of additional url parameters
+* @param bool $is_amp Is url using &amp; (true) or & (false)
+* @param string $session_id Possibility to use a custom session id instead of the global one
+*
+* Examples:
+* <code>
+* append_sid("{$phpbb_root_path}viewtopic.$phpEx?t=1&amp;f=2");
+* append_sid("{$phpbb_root_path}viewtopic.$phpEx", 't=1&amp;f=2');
+* append_sid("{$phpbb_root_path}viewtopic.$phpEx", 't=1&f=2', false);
+* append_sid("{$phpbb_root_path}viewtopic.$phpEx", array('t' => 1, 'f' => 2));
+* </code>
+*
+*/
+function append_sid($url, $params = false, $is_amp = true, $session_id = false)
+{
+	global $_SID, $_EXTRA_URL, $phpbb_hook;
+
+	// Developers using the hook function need to globalise the $_SID and $_EXTRA_URL on their own and also handle it appropiatly.
+	// They could mimick most of what is within this function
+	if (!empty($phpbb_hook) && $phpbb_hook->call_hook(__FUNCTION__, $url, $params, $is_amp, $session_id))
+	{
+		if ($phpbb_hook->hook_return(__FUNCTION__))
+		{
+			return $phpbb_hook->hook_return_result(__FUNCTION__);
+		}
+	}
+
+	// Assign sid if session id is not specified
+	if ($session_id === false)
+	{
+		$session_id = $_SID;
+	}
+
+	$amp_delim = ($is_amp) ? '&amp;' : '&';
+	$url_delim = (strpos($url, '?') === false) ? '?' : $amp_delim;
+
+	// Appending custom url parameter?
+	$append_url = (!empty($_EXTRA_URL)) ? implode($amp_delim, $_EXTRA_URL) : '';
+
+	$anchor = '';
+	if (strpos($url, '#') !== false)
+	{
+		list($url, $anchor) = explode('#', $url, 2);
+		$anchor = '#' . $anchor;
+	}
+	else if (!is_array($params) && strpos($params, '#') !== false)
+	{
+		list($params, $anchor) = explode('#', $params, 2);
+		$anchor = '#' . $anchor;
+	}
+
+	// Use the short variant if possible ;)
+	if ($params === false)
+	{
+		// Append session id
+		if (!$session_id)
+		{
+			return $url . (($append_url) ? $url_delim . $append_url : '') . $anchor;
+		}
+		else
+		{
+			return $url . (($append_url) ? $url_delim . $append_url . $amp_delim : $url_delim) . 'sid=' . $session_id . $anchor;
+		}
+	}
+
+	// Build string if parameters are specified as array
+	if (is_array($params))
+	{
+		$output = array();
+
+		foreach ($params as $key => $item)
+		{
+			if ($item === NULL)
+			{
+				continue;
+			}
+
+			if ($key == '#')
+			{
+				$anchor = '#' . $item;
+				continue;
+			}
+
+			$output[] = $key . '=' . $item;
+		}
+
+		$params = implode($amp_delim, $output);
+	}
+
+	// Append session id and parameters (even if they are empty)
+	// If parameters are empty, the developer can still append his/her parameters without caring about the delimiter
+	return $url . (($append_url) ? $url_delim . $append_url . $amp_delim : $url_delim) . $params . ((!$session_id) ? '' : $amp_delim . 'sid=' . $session_id) . $anchor;
+}
+
+/**
+* Generate board url (example: http://www.example.com/phpBB)
+* @param bool $without_script_path if set to true the script path gets not appended (example: http://www.example.com)
+*/
+function generate_board_url($without_script_path = false)
+{
+	global $config, $user;
+
+	$server_name = $user->host;
+	$server_port = (!empty($_SERVER['SERVER_PORT'])) ? (int) $_SERVER['SERVER_PORT'] : (int) getenv('SERVER_PORT');
+
+	// Forcing server vars is the only way to specify/override the protocol
+	if ($config['force_server_vars'] || !$server_name)
+	{
+		$server_protocol = ($config['server_protocol']) ? $config['server_protocol'] : (($config['cookie_secure']) ? 'https://' : 'http://');
+		$server_name = $config['server_name'];
+		$server_port = (int) $config['server_port'];
+		$script_path = $config['script_path'];
+
+		$url = $server_protocol . $server_name;
+	}
+	else
+	{
+		// Do not rely on cookie_secure, users seem to think that it means a secured cookie instead of an encrypted connection
+		$cookie_secure = (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] == 'on') ? 1 : 0;
+		$url = (($cookie_secure) ? 'https://' : 'http://') . $server_name;
+
+		$script_path = $user->page['root_script_path'];
+	}
+
+	if ($server_port && (($config['cookie_secure'] && $server_port <> 443) || (!$config['cookie_secure'] && $server_port <> 80)))
+	{
+		// HTTP HOST can carry a port number...
+		if (strpos($server_name, ':') === false)
+		{
+			$url .= ':' . $server_port;
+		}
+	}
+
+	if (!$without_script_path)
+	{
+		$url .= $script_path;
+	}
+
+	// Strip / from the end
+	if (substr($url, -1, 1) == '/')
+	{
+		$url = substr($url, 0, -1);
+	}
+
+	return $url;
+}
+
+/**
+* Redirects the user to another page then exits the script nicely
+*/
+function redirect($url, $return = false)
+{
+	global $db, $cache, $config, $user, $phpbb_root_path;
+
+	if (empty($user->lang))
+	{
+		$user->add_lang('common');
+	}
+
+	if (!$return)
+	{
+		garbage_collection();
+	}
+
+	// Make sure no &amp;'s are in, this will break the redirect
+	$url = str_replace('&amp;', '&', $url);
+
+	// Determine which type of redirect we need to handle...
+	$url_parts = parse_url($url);
+
+	if ($url_parts === false)
+	{
+		// Malformed url, redirect to current page...
+		$url = generate_board_url() . '/' . $user->page['page'];
+	}
+	else if (!empty($url_parts['scheme']) && !empty($url_parts['host']))
+	{
+		// Full URL
+	}
+	else if ($url[0] == '/')
+	{
+		// Absolute uri, prepend direct url...
+		$url = generate_board_url(true) . $url;
+	}
+	else
+	{
+		// Relative uri
+		$pathinfo = pathinfo($url);
+
+		// Is the uri pointing to the current directory?
+		if ($pathinfo['dirname'] == '.')
+		{
+			$url = str_replace('./', '', $url);
+
+			// Strip / from the beginning
+			if ($url && substr($url, 0, 1) == '/')
+			{
+				$url = substr($url, 1);
+			}
+
+			if ($user->page['page_dir'])
+			{
+				$url = generate_board_url() . '/' . $user->page['page_dir'] . '/' . $url;
+			}
+			else
+			{
+				$url = generate_board_url() . '/' . $url;
+			}
+		}
+		else
+		{
+			// Used ./ before, but $phpbb_root_path is working better with urls within another root path
+			$root_dirs = explode('/', str_replace('\\', '/', phpbb_realpath($phpbb_root_path)));
+			$page_dirs = explode('/', str_replace('\\', '/', phpbb_realpath($pathinfo['dirname'])));
+			$intersection = array_intersect_assoc($root_dirs, $page_dirs);
+
+			$root_dirs = array_diff_assoc($root_dirs, $intersection);
+			$page_dirs = array_diff_assoc($page_dirs, $intersection);
+
+			$dir = str_repeat('../', sizeof($root_dirs)) . implode('/', $page_dirs);
+
+			// Strip / from the end
+			if ($dir && substr($dir, -1, 1) == '/')
+			{
+				$dir = substr($dir, 0, -1);
+			}
+
+			// Strip / from the beginning
+			if ($dir && substr($dir, 0, 1) == '/')
+			{
+				$dir = substr($dir, 1);
+			}
+
+			$url = str_replace($pathinfo['dirname'] . '/', '', $url);
+
+			// Strip / from the beginning
+			if (substr($url, 0, 1) == '/')
+			{
+				$url = substr($url, 1);
+			}
+
+			$url = $dir . '/' . $url;
+			$url = generate_board_url() . '/' . $url;
+		}
+	}
+
+	// Make sure no linebreaks are there... to prevent http response splitting for PHP < 4.4.2
+	if (strpos(urldecode($url), "\n") !== false || strpos(urldecode($url), "\r") !== false || strpos($url, ';') !== false)
+	{
+		trigger_error('Tried to redirect to potentially insecure url.', E_USER_ERROR);
+	}
+
+	// Now, also check the protocol and for a valid url the last time...
+	$allowed_protocols = array('http', 'https', 'ftp', 'ftps');
+	$url_parts = parse_url($url);
+
+	if ($url_parts === false || empty($url_parts['scheme']) || !in_array($url_parts['scheme'], $allowed_protocols))
+	{
+		trigger_error('Tried to redirect to potentially insecure url.', E_USER_ERROR);
+	}
+
+	if ($return)
+	{
+		return $url;
+	}
+
+	// Redirect via an HTML form for PITA webservers
+	if (@preg_match('#Microsoft|WebSTAR|Xitami#', getenv('SERVER_SOFTWARE')))
+	{
+		header('Refresh: 0; URL=' . $url);
+
+		echo '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">';
+		echo '<html xmlns="http://www.w3.org/1999/xhtml" dir="' . $user->lang['DIRECTION'] . '" lang="' . $user->lang['USER_LANG'] . '" xml:lang="' . $user->lang['USER_LANG'] . '">';
+		echo '<head>';
+		echo '<meta http-equiv="content-type" content="text/html; charset=utf-8" />';
+		echo '<meta http-equiv="refresh" content="0; url=' . str_replace('&', '&amp;', $url) . '" />';
+		echo '<title>' . $user->lang['REDIRECT'] . '</title>';
+		echo '</head>';
+		echo '<body>';
+		echo '<div style="text-align: center;">' . sprintf($user->lang['URL_REDIRECT'], '<a href="' . str_replace('&', '&amp;', $url) . '">', '</a>') . '</div>';
+		echo '</body>';
+		echo '</html>';
+
+		exit;
+	}
+
+	// Behave as per HTTP/1.1 spec for others
+	header('Location: ' . $url);
+	exit;
+}
+
+/**
+* Re-Apply session id after page reloads
+*/
+function reapply_sid($url)
+{
+	global $phpEx, $phpbb_root_path;
+
+	if ($url === "index.$phpEx")
+	{
+		return append_sid("index.$phpEx");
+	}
+	else if ($url === "{$phpbb_root_path}index.$phpEx")
+	{
+		return append_sid("{$phpbb_root_path}index.$phpEx");
+	}
+
+	// Remove previously added sid
+	if (strpos($url, '?sid=') !== false)
+	{
+		$url = preg_replace('/(\?)sid=[a-z0-9]+(&amp;|&)?/', '\1', $url);
+	}
+	else if (strpos($url, '&sid=') !== false)
+	{
+		$url = preg_replace('/&sid=[a-z0-9]+(&)?/', '\1', $url);
+	}
+	else if (strpos($url, '&amp;sid=') !== false)
+	{
+		$url = preg_replace('/&amp;sid=[a-z0-9]+(&amp;)?/', '\1', $url);
+	}
+
+	return append_sid($url);
+}
+
+/**
+* Returns url from the session/current page with an re-appended SID with optionally stripping vars from the url
+*/
+function build_url($strip_vars = false)
+{
+	global $user, $phpbb_root_path;
+
+	// Append SID
+	$redirect = append_sid($user->page['page'], false, false);
+
+	// Add delimiter if not there...
+	if (strpos($redirect, '?') === false)
+	{
+		$redirect .= '?';
+	}
+
+	// Strip vars...
+	if ($strip_vars !== false && strpos($redirect, '?') !== false)
+	{
+		if (!is_array($strip_vars))
+		{
+			$strip_vars = array($strip_vars);
+		}
+
+		$query = $_query = array();
+
+		$args = substr($redirect, strpos($redirect, '?') + 1);
+		$args = ($args) ? explode('&', $args) : array();
+		$redirect = substr($redirect, 0, strpos($redirect, '?'));
+
+		foreach ($args as $argument)
+		{
+			$arguments = explode('=', $argument);
+			$key = $arguments[0];
+			unset($arguments[0]);
+
+			$query[$key] = implode('=', $arguments);
+		}
+
+		// Strip the vars off
+		foreach ($strip_vars as $strip)
+		{
+			if (isset($query[$strip]))
+			{
+				unset($query[$strip]);
+			}
+		}
+
+		// Glue the remaining parts together... already urlencoded
+		foreach ($query as $key => $value)
+		{
+			$_query[] = $key . '=' . $value;
+		}
+		$query = implode('&', $_query);
+
+		$redirect .= ($query) ? '?' . $query : '';
+	}
+
+	return $phpbb_root_path . str_replace('&', '&amp;', $redirect);
+}
+
+/**
+* Meta refresh assignment
+*/
+function meta_refresh($time, $url)
+{
+	global $template;
+
+	$url = redirect($url, true);
+
+	// For XHTML compatibility we change back & to &amp;
+	$template->assign_vars(array(
+		'META' => '<meta http-equiv="refresh" content="' . $time . ';url=' . str_replace('&', '&amp;', $url) . '" />')
+	);
+}
+
+//Form validation
+
+/**
+* Add a secret token to the form (requires the S_FORM_TOKEN template variable)
+* @param string  $form_name The name of the form; has to match the name used in check_form_key, otherwise no restrictions apply
+*/
+function add_form_key($form_name)
+{
+	global $config, $template, $user;
+	$now = time();
+	$token_sid = ($user->data['user_id'] == ANONYMOUS && !empty($config['form_token_sid_guests'])) ? $user->session_id : '';
+	$token = sha1($now . $user->data['user_form_salt'] . $form_name . $token_sid);
+
+	$s_fields = build_hidden_fields(array(
+			'creation_time' => $now,
+			'form_token'	=> $token,
+	));
+	$template->assign_vars(array(
+			'S_FORM_TOKEN'	=> $s_fields,
+	));
+}
+
+/**
+* Check the form key. Required for all altering actions not secured by confirm_box
+* @param string  $form_name The name of the form; has to match the name used in add_form_key, otherwise no restrictions apply
+* @param int $timespan The maximum acceptable age for a submitted form in seconds. Defaults to the config setting.
+* @param string $return_page The address for the return link
+* @param bool $trigger If true, the function will triger an error when encountering an invalid form
+*/
+function check_form_key($form_name, $timespan = false, $return_page = '', $trigger = false)
+{
+	global $config, $user;
+
+	if ($timespan === false)
+	{
+		// we enforce a minimum value of half a minute here.
+		$timespan = ($config['form_token_lifetime'] == -1) ? -1 : max(30, $config['form_token_lifetime']);
+	}
+
+	if (isset($_POST['creation_time']) && isset($_POST['form_token']))
+	{
+		$creation_time	= abs(request_var('creation_time', 0));
+		$token = request_var('form_token', '');
+
+		$diff = (time() - $creation_time);
+
+		if (($diff <= $timespan) || $timespan === -1)
+		{
+			$token_sid = ($user->data['user_id'] == ANONYMOUS && !empty($config['form_token_sid_guests'])) ? $user->session_id : '';
+
+			$key = sha1($creation_time . $user->data['user_form_salt'] . $form_name . $token_sid);
+			if ($key === $token)
+			{
+				return true;
+			}
+		}
+	}
+	if ($trigger)
+	{
+		trigger_error($user->lang['FORM_INVALID'] . $return_page);
+	}
+	return false;
+}
+
+// Message/Login boxes
+
+/**
+* Build Confirm box
+* @param boolean $check True for checking if confirmed (without any additional parameters) and false for displaying the confirm box
+* @param string $title Title/Message used for confirm box.
+*		message text is _CONFIRM appended to title.
+*		If title cannot be found in user->lang a default one is displayed
+*		If title_CONFIRM cannot be found in user->lang the text given is used.
+* @param string $hidden Hidden variables
+* @param string $html_body Template used for confirm box
+* @param string $u_action Custom form action
+*/
+function confirm_box($check, $title = '', $hidden = '', $html_body = 'confirm_body.html', $u_action = '')
+{
+	global $user, $template, $db;
+	global $phpEx, $phpbb_root_path;
+
+	if (isset($_POST['cancel']))
+	{
+		return false;
+	}
+
+	$confirm = false;
+	if (isset($_POST['confirm']))
+	{
+		// language frontier
+		if ($_POST['confirm'] === $user->lang['YES'])
+		{
+			$confirm = true;
+		}
+	}
+
+	if ($check && $confirm)
+	{
+		$user_id = request_var('user_id', 0);
+		$session_id = request_var('sess', '');
+		$confirm_key = request_var('confirm_key', '');
+
+		if ($user_id != $user->data['user_id'] || $session_id != $user->session_id || !$confirm_key || !$user->data['user_last_confirm_key'] || $confirm_key != $user->data['user_last_confirm_key'])
+		{
+			return false;
+		}
+
+		// Reset user_last_confirm_key
+		$sql = 'UPDATE ' . USERS_TABLE . " SET user_last_confirm_key = ''
+			WHERE user_id = " . $user->data['user_id'];
+		$db->sql_query($sql);
+
+		return true;
+	}
+	else if ($check)
+	{
+		return false;
+	}
+
+	$s_hidden_fields = build_hidden_fields(array(
+		'user_id'	=> $user->data['user_id'],
+		'sess'		=> $user->session_id,
+		'sid'		=> $user->session_id)
+	);
+
+	// generate activation key
+	$confirm_key = gen_rand_string(10);
+
+	if (defined('IN_ADMIN') && isset($user->data['session_admin']) && $user->data['session_admin'])
+	{
+		adm_page_header((!isset($user->lang[$title])) ? $user->lang['CONFIRM'] : $user->lang[$title]);
+	}
+	else
+	{
+		page_header((!isset($user->lang[$title])) ? $user->lang['CONFIRM'] : $user->lang[$title]);
+	}
+
+	$template->set_filenames(array(
+		'body' => $html_body)
+	);
+
+	// If activation key already exist, we better do not re-use the key (something very strange is going on...)
+	if (request_var('confirm_key', ''))
+	{
+		// This should not occur, therefore we cancel the operation to safe the user
+		return false;
+	}
+
+	// re-add sid / transform & to &amp; for user->page (user->page is always using &)
+	$use_page = ($u_action) ? $phpbb_root_path . $u_action : $phpbb_root_path . str_replace('&', '&amp;', $user->page['page']);
+	$u_action = reapply_sid($use_page);
+	$u_action .= ((strpos($u_action, '?') === false) ? '?' : '&amp;') . 'confirm_key=' . $confirm_key;
+
+	$template->assign_vars(array(
+		'MESSAGE_TITLE'		=> (!isset($user->lang[$title])) ? $user->lang['CONFIRM'] : $user->lang[$title],
+		'MESSAGE_TEXT'		=> (!isset($user->lang[$title . '_CONFIRM'])) ? $title : $user->lang[$title . '_CONFIRM'],
+
+		'YES_VALUE'			=> $user->lang['YES'],
+		'S_CONFIRM_ACTION'	=> $u_action,
+		'S_HIDDEN_FIELDS'	=> $hidden . $s_hidden_fields)
+	);
+
+	$sql = 'UPDATE ' . USERS_TABLE . " SET user_last_confirm_key = '" . $db->sql_escape($confirm_key) . "'
+		WHERE user_id = " . $user->data['user_id'];
+	$db->sql_query($sql);
+
+	if (defined('IN_ADMIN') && isset($user->data['session_admin']) && $user->data['session_admin'])
+	{
+		adm_page_footer();
+	}
+	else
+	{
+		page_footer();
+	}
+}
+
+/**
+* Generate login box or verify password
+*/
+function login_box($redirect = '', $l_explain = '', $l_success = '', $admin = false, $s_display = true)
+{
+	global $db, $user, $template, $auth, $phpEx, $phpbb_root_path, $config;
+
+	$err = '';
+
+	// Make sure user->setup() has been called
+	if (empty($user->lang))
+	{
+		$user->setup();
+	}
+
+	// Print out error if user tries to authenticate as an administrator without having the privileges...
+	if ($admin && !$auth->acl_get('a_'))
+	{
+		// Not authd
+		// anonymous/inactive users are never able to go to the ACP even if they have the relevant permissions
+		if ($user->data['is_registered'])
+		{
+			add_log('admin', 'LOG_ADMIN_AUTH_FAIL');
+		}
+		trigger_error('NO_AUTH_ADMIN');
+	}
+
+	if (isset($_POST['login']))
+	{
+		// Get credential
+		if ($admin)
+		{
+			$credential = request_var('credential', '');
+
+			if (strspn($credential, 'abcdef0123456789') !== strlen($credential) || strlen($credential) != 32)
+			{
+				if ($user->data['is_registered'])
+				{
+					add_log('admin', 'LOG_ADMIN_AUTH_FAIL');
+				}
+				trigger_error('NO_AUTH_ADMIN');
+			}
+
+			$password	= request_var('password_' . $credential, '', true);
+		}
+		else
+		{
+			$password	= request_var('password', '', true);
+		}
+
+		$username	= request_var('username', '', true);
+		$autologin	= (!empty($_POST['autologin'])) ? true : false;
+		$viewonline = (!empty($_POST['viewonline'])) ? 0 : 1;
+		$admin 		= ($admin) ? 1 : 0;
+		$viewonline = ($admin) ? $user->data['session_viewonline'] : $viewonline;
+
+		// Check if the supplied username is equal to the one stored within the database if re-authenticating
+		if ($admin && utf8_clean_string($username) != utf8_clean_string($user->data['username']))
+		{
+			// We log the attempt to use a different username...
+			add_log('admin', 'LOG_ADMIN_AUTH_FAIL');
+			trigger_error('NO_AUTH_ADMIN_USER_DIFFER');
+		}
+
+		// If authentication is successful we redirect user to previous page
+		$result = $auth->login($username, $password, $autologin, $viewonline, $admin);
+
+		// If admin authentication and login, we will log if it was a success or not...
+		// We also break the operation on the first non-success login - it could be argued that the user already knows
+		if ($admin)
+		{
+			if ($result['status'] == LOGIN_SUCCESS)
+			{
+				add_log('admin', 'LOG_ADMIN_AUTH_SUCCESS');
+			}
+			else
+			{
+				// Only log the failed attempt if a real user tried to.
+				// anonymous/inactive users are never able to go to the ACP even if they have the relevant permissions
+				if ($user->data['is_registered'])
+				{
+					add_log('admin', 'LOG_ADMIN_AUTH_FAIL');
+				}
+			}
+		}
+
+		// The result parameter is always an array, holding the relevant information...
+		if ($result['status'] == LOGIN_SUCCESS)
+		{
+			$redirect = request_var('redirect', "{$phpbb_root_path}index.$phpEx");
+			$message = ($l_success) ? $l_success : $user->lang['LOGIN_REDIRECT'];
+			$l_redirect = ($admin) ? $user->lang['PROCEED_TO_ACP'] : (($redirect === "{$phpbb_root_path}index.$phpEx" || $redirect === "index.$phpEx") ? $user->lang['RETURN_INDEX'] : $user->lang['RETURN_PAGE']);
+
+			// append/replace SID (may change during the session for AOL users)
+			$redirect = reapply_sid($redirect);
+
+			// Special case... the user is effectively banned, but we allow founders to login
+			if (defined('IN_CHECK_BAN') && $result['user_row']['user_type'] != USER_FOUNDER)
+			{
+				return;
+			}
+
+			meta_refresh(3, $redirect);
+			trigger_error($message . '<br /><br />' . sprintf($l_redirect, '<a href="' . $redirect . '">', '</a>'));
+		}
+
+		// Something failed, determine what...
+		if ($result['status'] == LOGIN_BREAK)
+		{
+			trigger_error($result['error_msg']);
+		}
+
+		// Special cases... determine
+		switch ($result['status'])
+		{
+			case LOGIN_ERROR_ATTEMPTS:
+
+				// Show confirm image
+				$sql = 'DELETE FROM ' . CONFIRM_TABLE . "
+					WHERE session_id = '" . $db->sql_escape($user->session_id) . "'
+						AND confirm_type = " . CONFIRM_LOGIN;
+				$db->sql_query($sql);
+
+				// Generate code
+				$code = gen_rand_string(mt_rand(5, 8));
+				$confirm_id = md5(unique_id($user->ip));
+				$seed = hexdec(substr(unique_id(), 4, 10));
+
+				// compute $seed % 0x7fffffff
+				$seed -= 0x7fffffff * floor($seed / 0x7fffffff);
+
+				$sql = 'INSERT INTO ' . CONFIRM_TABLE . ' ' . $db->sql_build_array('INSERT', array(
+					'confirm_id'	=> (string) $confirm_id,
+					'session_id'	=> (string) $user->session_id,
+					'confirm_type'	=> (int) CONFIRM_LOGIN,
+					'code'			=> (string) $code,
+					'seed'			=> (int) $seed)
+				);
+				$db->sql_query($sql);
+
+				$template->assign_vars(array(
+					'S_CONFIRM_CODE'			=> true,
+					'CONFIRM_ID'				=> $confirm_id,
+					'CONFIRM_IMAGE'				=> '<img src="' . append_sid("{$phpbb_root_path}ucp.$phpEx", 'mode=confirm&amp;id=' . $confirm_id . '&amp;type=' . CONFIRM_LOGIN) . '" alt="" title="" />',
+					'L_LOGIN_CONFIRM_EXPLAIN'	=> sprintf($user->lang['LOGIN_CONFIRM_EXPLAIN'], '<a href="mailto:' . htmlspecialchars($config['board_contact']) . '">', '</a>'),
+				));
+
+				$err = $user->lang[$result['error_msg']];
+
+			break;
+
+			case LOGIN_ERROR_PASSWORD_CONVERT:
+				$err = sprintf(
+					$user->lang[$result['error_msg']],
+					($config['email_enable']) ? '<a href="' . append_sid("{$phpbb_root_path}ucp.$phpEx", 'mode=sendpassword') . '">' : '',
+					($config['email_enable']) ? '</a>' : '',
+					($config['board_contact']) ? '<a href="mailto:' . htmlspecialchars($config['board_contact']) . '">' : '',
+					($config['board_contact']) ? '</a>' : ''
+				);
+			break;
+
+			// Username, password, etc...
+			default:
+				$err = $user->lang[$result['error_msg']];
+
+				// Assign admin contact to some error messages
+				if ($result['error_msg'] == 'LOGIN_ERROR_USERNAME' || $result['error_msg'] == 'LOGIN_ERROR_PASSWORD')
+				{
+					$err = (!$config['board_contact']) ? sprintf($user->lang[$result['error_msg']], '', '') : sprintf($user->lang[$result['error_msg']], '<a href="mailto:' . htmlspecialchars($config['board_contact']) . '">', '</a>');
+				}
+
+			break;
+		}
+	}
+
+	if (!$redirect)
+	{
+		// We just use what the session code determined...
+		// If we are not within the admin directory we use the page dir...
+		$redirect = '';
+
+		if (!$admin)
+		{
+			$redirect .= ($user->page['page_dir']) ? $user->page['page_dir'] . '/' : '';
+		}
+
+		$redirect .= $user->page['page_name'] . (($user->page['query_string']) ? '?' . htmlspecialchars($user->page['query_string']) : '');
+	}
+
+	// Assign credential for username/password pair
+	$credential = ($admin) ? md5(unique_id()) : false;
+
+	$s_hidden_fields = array(
+		'redirect'	=> $redirect,
+		'sid'		=> $user->session_id,
+	);
+
+	if ($admin)
+	{
+		$s_hidden_fields['credential'] = $credential;
+	}
+
+	$s_hidden_fields = build_hidden_fields($s_hidden_fields);
+
+	$template->assign_vars(array(
+		'LOGIN_ERROR'		=> $err,
+		'LOGIN_EXPLAIN'		=> $l_explain,
+
+		'U_SEND_PASSWORD' 		=> ($config['email_enable']) ? append_sid("{$phpbb_root_path}ucp.$phpEx", 'mode=sendpassword') : '',
+		'U_RESEND_ACTIVATION'	=> ($config['require_activation'] != USER_ACTIVATION_NONE && $config['email_enable']) ? append_sid("{$phpbb_root_path}ucp.$phpEx", 'mode=resend_act') : '',
+		'U_TERMS_USE'			=> append_sid("{$phpbb_root_path}ucp.$phpEx", 'mode=terms'),
+		'U_PRIVACY'				=> append_sid("{$phpbb_root_path}ucp.$phpEx", 'mode=privacy'),
+
+		'S_DISPLAY_FULL_LOGIN'	=> ($s_display) ? true : false,
+		'S_LOGIN_ACTION'		=> (!$admin) ? append_sid("{$phpbb_root_path}ucp.$phpEx", 'mode=login') : append_sid("index.$phpEx", false, true, $user->session_id), // Needs to stay index.$phpEx because we are within the admin directory
+		'S_HIDDEN_FIELDS' 		=> $s_hidden_fields,
+
+		'S_ADMIN_AUTH'			=> $admin,
+		'USERNAME'				=> ($admin) ? $user->data['username'] : '',
+
+		'USERNAME_CREDENTIAL'	=> 'username',
+		'PASSWORD_CREDENTIAL'	=> ($admin) ? 'password_' . $credential : 'password',
+	));
+
+	page_header($user->lang['LOGIN'], false);
+
+	$template->set_filenames(array(
+		'body' => 'login_body.html')
+	);
+	make_jumpbox(append_sid("{$phpbb_root_path}viewforum.$phpEx"));
+
+	page_footer();
+}
+
+/**
+* Generate forum login box
+*/
+function login_forum_box($forum_data)
+{
+	global $db, $config, $user, $template, $phpEx;
+
+	$password = request_var('password', '', true);
+
+	$sql = 'SELECT forum_id
+		FROM ' . FORUMS_ACCESS_TABLE . '
+		WHERE forum_id = ' . $forum_data['forum_id'] . '
+			AND user_id = ' . $user->data['user_id'] . "
+			AND session_id = '" . $db->sql_escape($user->session_id) . "'";
+	$result = $db->sql_query($sql);
+	$row = $db->sql_fetchrow($result);
+	$db->sql_freeresult($result);
+
+	if ($row)
+	{
+		return true;
+	}
+
+	if ($password)
+	{
+		// Remove expired authorised sessions
+		$sql = 'SELECT f.session_id
+			FROM ' . FORUMS_ACCESS_TABLE . ' f
+			LEFT JOIN ' . SESSIONS_TABLE . ' s ON (f.session_id = s.session_id)
+			WHERE s.session_id IS NULL';
+		$result = $db->sql_query($sql);
+
+		if ($row = $db->sql_fetchrow($result))
+		{
+			$sql_in = array();
+			do
+			{
+				$sql_in[] = (string) $row['session_id'];
+			}
+			while ($row = $db->sql_fetchrow($result));
+
+			// Remove expired sessions
+			$sql = 'DELETE FROM ' . FORUMS_ACCESS_TABLE . '
+				WHERE ' . $db->sql_in_set('session_id', $sql_in);
+			$db->sql_query($sql);
+		}
+		$db->sql_freeresult($result);
+
+		if (phpbb_check_hash($password, $forum_data['forum_password']))
+		{
+			$sql_ary = array(
+				'forum_id'		=> (int) $forum_data['forum_id'],
+				'user_id'		=> (int) $user->data['user_id'],
+				'session_id'	=> (string) $user->session_id,
+			);
+
+			$db->sql_query('INSERT INTO ' . FORUMS_ACCESS_TABLE . ' ' . $db->sql_build_array('INSERT', $sql_ary));
+
+			return true;
+		}
+
+		$template->assign_var('LOGIN_ERROR', $user->lang['WRONG_PASSWORD']);
+	}
+
+	page_header($user->lang['LOGIN']);
+
+	$template->assign_vars(array(
+		'S_HIDDEN_FIELDS'		=> build_hidden_fields(array('f' => $forum_data['forum_id'])))
+	);
+
+	$template->set_filenames(array(
+		'body' => 'login_forum.html')
+	);
+
+	page_footer();
+}
+
+// Little helpers
+
+/**
+* Little helper for the build_hidden_fields function
+*/
+function _build_hidden_fields($key, $value, $specialchar, $stripslashes)
+{
+	$hidden_fields = '';
+
+	if (!is_array($value))
+	{
+		$value = ($stripslashes) ? stripslashes($value) : $value;
+		$value = ($specialchar) ? htmlspecialchars($value, ENT_COMPAT, 'UTF-8') : $value;
+
+		$hidden_fields .= '<input type="hidden" name="' . $key . '" value="' . $value . '" />' . "\n";
+	}
+	else
+	{
+		foreach ($value as $_key => $_value)
+		{
+			$_key = ($stripslashes) ? stripslashes($_key) : $_key;
+			$_key = ($specialchar) ? htmlspecialchars($_key, ENT_COMPAT, 'UTF-8') : $_key;
+
+			$hidden_fields .= _build_hidden_fields($key . '[' . $_key . ']', $_value, $specialchar, $stripslashes);
+		}
+	}
+
+	return $hidden_fields;
+}
+
+/**
+* Build simple hidden fields from array
+*
+* @param array $field_ary an array of values to build the hidden field from
+* @param bool $specialchar if true, keys and values get specialchared
+* @param bool $stripslashes if true, keys and values get stripslashed
+*
+* @return string the hidden fields
+*/
+function build_hidden_fields($field_ary, $specialchar = false, $stripslashes = false)
+{
+	$s_hidden_fields = '';
+
+	foreach ($field_ary as $name => $vars)
+	{
+		$name = ($stripslashes) ? stripslashes($name) : $name;
+		$name = ($specialchar) ? htmlspecialchars($name, ENT_COMPAT, 'UTF-8') : $name;
+
+		$s_hidden_fields .= _build_hidden_fields($name, $vars, $specialchar, $stripslashes);
+	}
+
+	return $s_hidden_fields;
+}
+
+/**
+* Parse cfg file
+*/
+function parse_cfg_file($filename, $lines = false)
+{
+	$parsed_items = array();
+
+	if ($lines === false)
+	{
+		$lines = file($filename);
+	}
+
+	foreach ($lines as $line)
+	{
+		$line = trim($line);
+
+		if (!$line || $line[0] == '#' || ($delim_pos = strpos($line, '=')) === false)
+		{
+			continue;
+		}
+
+		// Determine first occurrence, since in values the equal sign is allowed
+		$key = strtolower(trim(substr($line, 0, $delim_pos)));
+		$value = trim(substr($line, $delim_pos + 1));
+
+		if (in_array($value, array('off', 'false', '0')))
+		{
+			$value = false;
+		}
+		else if (in_array($value, array('on', 'true', '1')))
+		{
+			$value = true;
+		}
+		else if (!trim($value))
+		{
+			$value = '';
+		}
+		else if (($value[0] == "'" && $value[sizeof($value) - 1] == "'") || ($value[0] == '"' && $value[sizeof($value) - 1] == '"'))
+		{
+			$value = substr($value, 1, sizeof($value)-2);
+		}
+
+		$parsed_items[$key] = $value;
+	}
+
+	return $parsed_items;
+}
+
+/**
+* Add log event
+*/
+function add_log()
+{
+	global $db, $user;
+
+	$args = func_get_args();
+
+	$mode			= array_shift($args);
+	$reportee_id	= ($mode == 'user') ? intval(array_shift($args)) : '';
+	$forum_id		= ($mode == 'mod') ? intval(array_shift($args)) : '';
+	$topic_id		= ($mode == 'mod') ? intval(array_shift($args)) : '';
+	$action			= array_shift($args);
+	$data			= (!sizeof($args)) ? '' : serialize($args);
+
+	$sql_ary = array(
+		'user_id'		=> (empty($user->data)) ? ANONYMOUS : $user->data['user_id'],
+		'log_ip'		=> $user->ip,
+		'log_time'		=> time(),
+		'log_operation'	=> $action,
+		'log_data'		=> $data,
+	);
+
+	switch ($mode)
+	{
+		case 'admin':
+			$sql_ary['log_type'] = LOG_ADMIN;
+		break;
+
+		case 'mod':
+			$sql_ary += array(
+				'log_type'	=> LOG_MOD,
+				'forum_id'	=> $forum_id,
+				'topic_id'	=> $topic_id
+			);
+		break;
+
+		case 'user':
+			$sql_ary += array(
+				'log_type'		=> LOG_USERS,
+				'reportee_id'	=> $reportee_id
+			);
+		break;
+
+		case 'critical':
+			$sql_ary['log_type'] = LOG_CRITICAL;
+		break;
+
+		default:
+			return false;
+	}
+
+	$db->sql_query('INSERT INTO ' . LOG_TABLE . ' ' . $db->sql_build_array('INSERT', $sql_ary));
+
+	return $db->sql_nextid();
+}
+
+/**
+* Return a nicely formatted backtrace (parts from the php manual by diz at ysagoon dot com)
+*/
+function get_backtrace()
+{
+	global $phpbb_root_path;
+
+	$output = '<div style="font-family: monospace;">';
+	$backtrace = debug_backtrace();
+	$path = phpbb_realpath($phpbb_root_path);
+
+	foreach ($backtrace as $number => $trace)
+	{
+		// We skip the first one, because it only shows this file/function
+		if ($number == 0)
+		{
+			continue;
+		}
+
+		// Strip the current directory from path
+		if (empty($trace['file']))
+		{
+			$trace['file'] = '';
+		}
+		else
+		{
+			$trace['file'] = str_replace(array($path, '\\'), array('', '/'), $trace['file']);
+			$trace['file'] = substr($trace['file'], 1);
+		}
+		$args = array();
+
+		// If include/require/include_once is not called, do not show arguments - they may contain sensible information
+		if (!in_array($trace['function'], array('include', 'require', 'include_once')))
+		{
+			unset($trace['args']);
+		}
+		else
+		{
+			// Path...
+			if (!empty($trace['args'][0]))
+			{
+				$argument = htmlspecialchars($trace['args'][0]);
+				$argument = str_replace(array($path, '\\'), array('', '/'), $argument);
+				$argument = substr($argument, 1);
+				$args[] = "'{$argument}'";
+			}
+		}
+
+		$trace['class'] = (!isset($trace['class'])) ? '' : $trace['class'];
+		$trace['type'] = (!isset($trace['type'])) ? '' : $trace['type'];
+
+		$output .= '<br />';
+		$output .= '<b>FILE:</b> ' . htmlspecialchars($trace['file']) . '<br />';
+		$output .= '<b>LINE:</b> ' . ((!empty($trace['line'])) ? $trace['line'] : '') . '<br />';
+
+		$output .= '<b>CALL:</b> ' . htmlspecialchars($trace['class'] . $trace['type'] . $trace['function']) . '(' . ((sizeof($args)) ? implode(', ', $args) : '') . ')<br />';
+	}
+	$output .= '</div>';
+	return $output;
+}
+
+/**
+* This function returns a regular expression pattern for commonly used expressions
+* Use with / as delimiter for email mode and # for url modes
+* mode can be: email|bbcode_htm|url|url_inline|www_url|www_url_inline|relative_url|relative_url_inline|ipv4|ipv6
+*/
+function get_preg_expression($mode)
+{
+	switch ($mode)
+	{
+		case 'email':
+			return '(?:[a-z0-9\'\.\-_\+\|]|&amp;)+@[a-z0-9\-]+\.(?:[a-z0-9\-]+\.)*[a-z]+';
+		break;
+
+		case 'bbcode_htm':
+			return array(
+				'#<!\-\- e \-\-><a href="mailto:(.*?)">.*?</a><!\-\- e \-\->#',
+				'#<!\-\- l \-\-><a (?:class="[\w-]+" )?href="(.*?)(?:(&amp;|\?)sid=[0-9a-f]{32})?">.*?</a><!\-\- l \-\->#',
+				'#<!\-\- ([mw]) \-\-><a (?:class="[\w-]+" )?href="(.*?)">.*?</a><!\-\- \1 \-\->#',
+				'#<!\-\- s(.*?) \-\-><img src="\{SMILIES_PATH\}\/.*? \/><!\-\- s\1 \-\->#',
+				'#<!\-\- .*? \-\->#s',
+				'#<.*?>#s',
+			);
+		break;
+
+		// Whoa these look impressive!
+		// The code to generate the following two regular expressions which match valid IPv4/IPv6 addresses
+		// can be found in the develop directory
+		case 'ipv4':
+			return '#^(?:(?:\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(?:\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$#';
+		break;
+
+		case 'ipv6':
+			return '#^(?:(?:(?:[\dA-F]{1,4}:){6}(?:[\dA-F]{1,4}:[\dA-F]{1,4}|(?:(?:\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(?:\d{1,2}|1\d\d|2[0-4]\d|25[0-5])))|(?:::(?:[\dA-F]{1,4}:){5}(?:[\dA-F]{1,4}:[\dA-F]{1,4}|(?:(?:\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(?:\d{1,2}|1\d\d|2[0-4]\d|25[0-5])))|(?:(?:[\dA-F]{1,4}:):(?:[\dA-F]{1,4}:){4}(?:[\dA-F]{1,4}:[\dA-F]{1,4}|(?:(?:\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(?:\d{1,2}|1\d\d|2[0-4]\d|25[0-5])))|(?:(?:[\dA-F]{1,4}:){1,2}:(?:[\dA-F]{1,4}:){3}(?:[\dA-F]{1,4}:[\dA-F]{1,4}|(?:(?:\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(?:\d{1,2}|1\d\d|2[0-4]\d|25[0-5])))|(?:(?:[\dA-F]{1,4}:){1,3}:(?:[\dA-F]{1,4}:){2}(?:[\dA-F]{1,4}:[\dA-F]{1,4}|(?:(?:\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(?:\d{1,2}|1\d\d|2[0-4]\d|25[0-5])))|(?:(?:[\dA-F]{1,4}:){1,4}:(?:[\dA-F]{1,4}:)(?:[\dA-F]{1,4}:[\dA-F]{1,4}|(?:(?:\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(?:\d{1,2}|1\d\d|2[0-4]\d|25[0-5])))|(?:(?:[\dA-F]{1,4}:){1,5}:(?:[\dA-F]{1,4}:[\dA-F]{1,4}|(?:(?:\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(?:\d{1,2}|1\d\d|2[0-4]\d|25[0-5])))|(?:(?:[\dA-F]{1,4}:){1,6}:[\dA-F]{1,4})|(?:(?:[\dA-F]{1,4}:){1,7}:))$#i';
+		break;
+
+		case 'url':
+		case 'url_inline':
+			$inline = ($mode == 'url') ? ')' : '';
+			$scheme = ($mode == 'url') ? '[a-z\d+\-.]' : '[a-z\d+]'; // avoid automatic parsing of "word" in "last word.http://..."
+			// generated with regex generation file in the develop folder
+			return "[a-z]$scheme*:/{2}(?:(?:[a-z0-9\-._~!$&'($inline*+,;=:@|]+|%[\dA-F]{2})+|[0-9.]+|\[[a-z0-9.]+:[a-z0-9.]+:[a-z0-9.:]+\])(?::\d*)?(?:/(?:[a-z0-9\-._~!$&'($inline*+,;=:@|]+|%[\dA-F]{2})*)*(?:\?(?:[a-z0-9\-._~!$&'($inline*+,;=:@/?|]+|%[\dA-F]{2})*)?(?:\#(?:[a-z0-9\-._~!$&'($inline*+,;=:@/?|]+|%[\dA-F]{2})*)?";
+		break;
+
+		case 'www_url':
+		case 'www_url_inline':
+			$inline = ($mode == 'www_url') ? ')' : '';
+			return "www\.(?:[a-z0-9\-._~!$&'($inline*+,;=:@|]+|%[\dA-F]{2})+(?::\d*)?(?:/(?:[a-z0-9\-._~!$&'($inline*+,;=:@|]+|%[\dA-F]{2})*)*(?:\?(?:[a-z0-9\-._~!$&'($inline*+,;=:@/?|]+|%[\dA-F]{2})*)?(?:\#(?:[a-z0-9\-._~!$&'($inline*+,;=:@/?|]+|%[\dA-F]{2})*)?";
+		break;
+
+		case 'relative_url':
+		case 'relative_url_inline':
+			$inline = ($mode == 'relative_url') ? ')' : '';
+			return "(?:[a-z0-9\-._~!$&'($inline*+,;=:@|]+|%[\dA-F]{2})*(?:/(?:[a-z0-9\-._~!$&'($inline*+,;=:@|]+|%[\dA-F]{2})*)*(?:\?(?:[a-z0-9\-._~!$&'($inline*+,;=:@/?|]+|%[\dA-F]{2})*)?(?:\#(?:[a-z0-9\-._~!$&'($inline*+,;=:@/?|]+|%[\dA-F]{2})*)?";
+		break;
+	}
+
+	return '';
+}
+
+/**
+* Returns the first block of the specified IPv6 address and as many additional
+* ones as specified in the length paramater.
+* If length is zero, then an empty string is returned.
+* If length is greater than 3 the complete IP will be returned
+*/
+function short_ipv6($ip, $length)
+{
+	if ($length < 1)
+	{
+		return '';
+	}
+
+	// extend IPv6 addresses
+	$blocks = substr_count($ip, ':') + 1;
+	if ($blocks < 9)
+	{
+		$ip = str_replace('::', ':' . str_repeat('0000:', 9 - $blocks), $ip);
+	}
+	if ($ip[0] == ':')
+	{
+		$ip = '0000' . $ip;
+	}
+	if ($length < 4)
+	{
+		$ip = implode(':', array_slice(explode(':', $ip), 0, 1 + $length));
+	}
+
+	return $ip;
+}
+
+/**
+* Wrapper for php's checkdnsrr function.
+*
+* The windows failover is from the php manual
+* Please make sure to check the return value for === true and === false, since NULL could
+* be returned too.
+*
+* @return true if entry found, false if not, NULL if this function is not supported by this environment
+*/
+function phpbb_checkdnsrr($host, $type = '')
+{
+	$type = (!$type) ? 'MX' : $type;
+
+	if (DIRECTORY_SEPARATOR == '\\')
+	{
+		if (!function_exists('exec'))
+		{
+			return NULL;
+		}
+
+		// @exec('nslookup -retry=1 -timout=1 -type=' . escapeshellarg($type) . ' ' . escapeshellarg($host), $output);
+		@exec('nslookup -type=' . escapeshellarg($type) . ' ' . escapeshellarg($host), $output);
+
+		// If output is empty, the nslookup failed
+		if (empty($output))
+		{
+			return NULL;
+		}
+
+		foreach ($output as $line)
+		{
+			if (!trim($line))
+			{
+				continue;
+			}
+
+			// Valid records begin with host name:
+			if (strpos($line, $host) === 0)
+			{
+				return true;
+			}
+		}
+
+		return false;
+	}
+	else if (function_exists('checkdnsrr'))
+	{
+		return (checkdnsrr($host, $type)) ? true : false;
+	}
+
+	return NULL;
+}
+
+// Handler, header and footer
+
+/**
+* Error and message handler, call with trigger_error if reqd
+*/
+function msg_handler($errno, $msg_text, $errfile, $errline)
+{
+	global $cache, $db, $auth, $template, $config, $user;
+	global $phpEx, $phpbb_root_path, $msg_title, $msg_long_text;
+
+	// Do not display notices if we suppress them via @
+	if (error_reporting() == 0)
+	{
+		return;
+	}
+
+	// Message handler is stripping text. In case we need it, we are possible to define long text...
+	if (isset($msg_long_text) && $msg_long_text && !$msg_text)
+	{
+		$msg_text = $msg_long_text;
+	}
+
+	switch ($errno)
+	{
+		case E_NOTICE:
+		case E_WARNING:
+
+			// Check the error reporting level and return if the error level does not match
+			// If DEBUG is defined the default level is E_ALL
+			if (($errno & ((defined('DEBUG')) ? E_ALL : error_reporting())) == 0)
+			{
+				return;
+			}
+
+			if (strpos($errfile, 'cache') === false && strpos($errfile, 'template.') === false)
+			{
+				// flush the content, else we get a white page if output buffering is on
+				if ($config['gzip_compress'])
+				{
+					if (@extension_loaded('zlib') && !headers_sent())
+					{
+						@ob_flush();
+					}
+				}
+
+				// remove complete path to installation, with the risk of changing backslashes meant to be there
+				$errfile = str_replace(array(phpbb_realpath($phpbb_root_path), '\\'), array('', '/'), $errfile);
+				$msg_text = str_replace(array(phpbb_realpath($phpbb_root_path), '\\'), array('', '/'), $msg_text);
+
+				echo '<b>[phpBB Debug] PHP Notice</b>: in file <b>' . $errfile . '</b> on line <b>' . $errline . '</b>: <b>' . $msg_text . '</b><br />' . "\n";
+			}
+
+			return;
+
+		break;
+
+		case E_USER_ERROR:
+
+			if (!empty($user) && !empty($user->lang))
+			{
+				$msg_text = (!empty($user->lang[$msg_text])) ? $user->lang[$msg_text] : $msg_text;
+				$msg_title = (!isset($msg_title)) ? $user->lang['GENERAL_ERROR'] : ((!empty($user->lang[$msg_title])) ? $user->lang[$msg_title] : $msg_title);
+
+				$l_return_index = sprintf($user->lang['RETURN_INDEX'], '<a href="' . $phpbb_root_path . '">', '</a>');
+				$l_notify = '';
+
+				if (!empty($config['board_contact']))
+				{
+					$l_notify = '<p>' . sprintf($user->lang['NOTIFY_ADMIN_EMAIL'], $config['board_contact']) . '</p>';
+				}
+			}
+			else
+			{
+				$msg_title = 'General Error';
+				$l_return_index = '<a href="' . $phpbb_root_path . '">Return to index page</a>';
+				$l_notify = '';
+
+				if (!empty($config['board_contact']))
+				{
+					$l_notify = '<p>Please notify the board administrator or webmaster: <a href="mailto:' . $config['board_contact'] . '">' . $config['board_contact'] . '</a></p>';
+				}
+			}
+
+			garbage_collection();
+
+			// Try to not call the adm page data...
+
+			echo '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">';
+			echo '<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr">';
+			echo '<head>';
+			echo '<meta http-equiv="content-type" content="text/html; charset=utf-8" />';
+			echo '<title>' . $msg_title . '</title>';
+			echo '<style type="text/css">' . "\n" . '/* <![CDATA[ */' . "\n";
+			echo '* { margin: 0; padding: 0; } html { font-size: 100%; height: 100%; margin-bottom: 1px; background-color: #E4EDF0; } body { font-family: "Lucida Grande", Verdana, Helvetica, Arial, sans-serif; color: #536482; background: #E4EDF0; font-size: 62.5%; margin: 0; } ';
+			echo 'a:link, a:active, a:visited { color: #006699; text-decoration: none; } a:hover { color: #DD6900; text-decoration: underline; } ';
+			echo '#wrap { padding: 0 20px 15px 20px; min-width: 615px; } #page-header { text-align: right; height: 40px; } #page-footer { clear: both; font-size: 1em; text-align: center; } ';
+			echo '.panel { margin: 4px 0; background-color: #FFFFFF; border: solid 1px  #A9B8C2; } ';
+			echo '#errorpage #page-header a { font-weight: bold; line-height: 6em; } #errorpage #content { padding: 10px; } #errorpage #content h1 { line-height: 1.2em; margin-bottom: 0; color: #DF075C; } ';
+			echo '#errorpage #content div { margin-top: 20px; margin-bottom: 5px; border-bottom: 1px solid #CCCCCC; padding-bottom: 5px; color: #333333; font: bold 1.2em "Lucida Grande", Arial, Helvetica, sans-serif; text-decoration: none; line-height: 120%; text-align: left; } ';
+			echo "\n" . '/* ]]> */' . "\n";
+			echo '</style>';
+			echo '</head>';
+			echo '<body id="errorpage">';
+			echo '<div id="wrap">';
+			echo '	<div id="page-header">';
+			echo '		' . $l_return_index;
+			echo '	</div>';
+			echo '	<div id="acp">';
+			echo '	<div class="panel">';
+			echo '		<div id="content">';
+			echo '			<h1>' . $msg_title . '</h1>';
+
+			echo '			<div>' . $msg_text . '</div>';
+
+			echo $l_notify;
+
+			echo '		</div>';
+			echo '	</div>';
+			echo '	</div>';
+			echo '	<div id="page-footer">';
+			echo '		Powered by phpBB &copy; 2000, 2002, 2005, 2007 <a href="http://www.phpbb.com/">phpBB Group</a>';
+			echo '	</div>';
+			echo '</div>';
+			echo '</body>';
+			echo '</html>';
+
+			exit_handler();
+		break;
+
+		case E_USER_WARNING:
+		case E_USER_NOTICE:
+
+			define('IN_ERROR_HANDLER', true);
+
+			if (empty($user->data))
+			{
+				$user->session_begin();
+			}
+
+			// We re-init the auth array to get correct results on login/logout
+			$auth->acl($user->data);
+
+			if (empty($user->lang))
+			{
+				$user->setup();
+			}
+
+			$msg_text = (!empty($user->lang[$msg_text])) ? $user->lang[$msg_text] : $msg_text;
+			$msg_title = (!isset($msg_title)) ? $user->lang['INFORMATION'] : ((!empty($user->lang[$msg_title])) ? $user->lang[$msg_title] : $msg_title);
+
+			if (!defined('HEADER_INC'))
+			{
+				if (defined('IN_ADMIN') && isset($user->data['session_admin']) && $user->data['session_admin'])
+				{
+					adm_page_header($msg_title);
+				}
+				else
+				{
+					page_header($msg_title);
+				}
+			}
+
+			$template->set_filenames(array(
+				'body' => 'message_body.html')
+			);
+
+			$template->assign_vars(array(
+				'MESSAGE_TITLE'		=> $msg_title,
+				'MESSAGE_TEXT'		=> $msg_text,
+				'S_USER_WARNING'	=> ($errno == E_USER_WARNING) ? true : false,
+				'S_USER_NOTICE'		=> ($errno == E_USER_NOTICE) ? true : false)
+			);
+
+			// We do not want the cron script to be called on error messages
+			define('IN_CRON', true);
+
+			if (defined('IN_ADMIN') && isset($user->data['session_admin']) && $user->data['session_admin'])
+			{
+				adm_page_footer();
+			}
+			else
+			{
+				page_footer();
+			}
+
+			exit_handler();
+		break;
+	}
+
+	// If we notice an error not handled here we pass this back to PHP by returning false
+	// This may not work for all php versions
+	return false;
+}
+
+/**
+* Queries the session table to get information about online guests
+* @param int $forum_id Limits the search to the forum with this id
+* @return int The number of active distinct guest sessions
+*/
+function obtain_guest_count($forum_id = 0)
+{
+	global $db, $config;
+	
+	if ($forum_id)
+	{
+		$reading_sql = ' AND s.session_forum_id = ' . (int) $forum_id;
+	} 
+	else
+	{
+		$reading_sql = '';
+	}
+	$time = (time() - (intval($config['load_online_time']) * 60)); 
+
+	// Get number of online guests
+
+	if ($db->sql_layer === 'sqlite')
+	{
+		$sql = 'SELECT COUNT(session_ip) as num_guests
+			FROM (
+				SELECT DISTINCT s.session_ip
+				FROM ' . SESSIONS_TABLE . ' s
+				WHERE s.session_user_id = ' . ANONYMOUS . '
+					AND s.session_time >= ' . ($time - ((int) ($time % 60))) .
+				$reading_sql .
+			')';
+	}
+	else
+	{
+		$sql = 'SELECT COUNT(DISTINCT s.session_ip) as num_guests
+			FROM ' . SESSIONS_TABLE . ' s
+			WHERE s.session_user_id = ' . ANONYMOUS . '
+				AND s.session_time >= ' . ($time - ((int) ($time % 60))) .
+			$reading_sql;
+	}
+	$result = $db->sql_query($sql, 60);
+	$guests_online = (int) $db->sql_fetchfield('num_guests');
+	$db->sql_freeresult($result);
+	
+	return $guests_online;
+}
+
+/**
+* Queries the session table to get information about online users
+* @param int $forum_id Limits the search to the forum with this id
+* @return array An array containing the ids of online, hidden and visible users, as well as statistical info
+*/
+function obtain_users_online($forum_id = 0)
+{
+	global $db, $config, $user;
+
+	$reading_sql = '';
+	if ($forum_id !== 0)
+	{
+		$reading_sql = ' AND s.session_forum_id = ' . (int) $forum_id;
+	}
+
+	$online_users = array(
+		'online_users'			=> array(),
+		'hidden_users'			=> array(),
+		'total_online'			=> 0,
+		'visible_online'		=> 0,
+		'hidden_online'			=> 0,
+		'guests_online'			=> 0,
+	);
+
+	if ($config['load_online_guests'])
+	{
+		$online_users['guests_online'] = obtain_guest_count($forum_id);
+	}
+	
+	// a little discrete magic to cache this for 30 seconds
+	$time = (time() - (intval($config['load_online_time']) * 60)); 
+
+	$sql = 'SELECT s.session_user_id, s.session_ip, s.session_viewonline
+		FROM ' . SESSIONS_TABLE . ' s
+		WHERE s.session_time >= ' . ($time - ((int) ($time % 30))) .
+			$reading_sql .
+		' AND s.session_user_id <> ' . ANONYMOUS;
+	$result = $db->sql_query($sql, 30); 
+
+	while ($row = $db->sql_fetchrow($result))
+	{
+		// Skip multiple sessions for one user
+		if (!isset($online_users['online_users'][$row['session_user_id']]))
+		{
+			$online_users['online_users'][$row['session_user_id']] = (int) $row['session_user_id'];
+			if ($row['session_viewonline'])
+			{
+				$online_users['visible_online']++;
+			}
+			else
+			{
+				$online_users['hidden_users'][$row['session_user_id']] = (int) $row['session_user_id'];
+				$online_users['hidden_online']++;
+			}
+		}
+	}
+	$online_users['total_online'] = $online_users['guests_online'] + $online_users['visible_online'] + $online_users['hidden_online'];
+	$db->sql_freeresult($result);
+	
+	return $online_users;
+}
+
+/**
+* Uses the result of obtain_users_online to generate a localized, readable representation.
+* @param mixed $online_users result of obtain_users_online - array with user_id lists for total, hidden and visible users, and statistics
+* @param int $forum_id Indicate that the data is limited to one forum and not global.
+* @return array An array containing the string for output to the template
+*/
+function obtain_users_online_string($online_users, $forum_id = 0)
+{
+	global $config, $db, $user, $auth;
+
+	$user_online_link = $online_userlist = '';
+
+	if (sizeof($online_users['online_users']))
+	{
+		$sql = 'SELECT username, username_clean, user_id, user_type, user_allow_viewonline, user_colour
+				FROM ' . USERS_TABLE . '
+				WHERE ' . $db->sql_in_set('user_id', $online_users['online_users']) . '
+				ORDER BY username_clean ASC';
+		$result = $db->sql_query($sql);
+
+		while ($row = $db->sql_fetchrow($result))
+		{
+			// User is logged in and therefore not a guest
+			if ($row['user_id'] != ANONYMOUS)
+			{
+				if (isset($online_users['hidden_users'][$row['user_id']]))
+				{
+					$row['username'] = '<em>' . $row['username'] . '</em>';
+				}
+
+				if (!isset($online_users['hidden_users'][$row['user_id']]) || $auth->acl_get('u_viewonline'))
+				{
+					$user_online_link = get_username_string(($row['user_type'] <> USER_IGNORE) ? 'full' : 'no_profile', $row['user_id'], $row['username'], $row['user_colour']);
+					$online_userlist .= ($online_userlist != '') ? ', ' . $user_online_link : $user_online_link;
+				}
+			}
+		}
+		$db->sql_freeresult($result);
+	}
+
+	if (!$online_userlist)
+	{
+		$online_userlist = $user->lang['NO_ONLINE_USERS'];
+	}
+
+	if ($forum_id === 0)
+	{
+		$online_userlist = $user->lang['REGISTERED_USERS'] . ' ' . $online_userlist;
+	}
+	else if ($config['load_online_guests'])
+	{
+		$l_online = ($online_users['guests_online'] === 1) ? $user->lang['BROWSING_FORUM_GUEST'] : $user->lang['BROWSING_FORUM_GUESTS'];
+		$online_userlist = sprintf($l_online, $online_userlist, $online_users['guests_online']);
+	}
+	else
+	{
+		$online_userlist = sprintf($user->lang['BROWSING_FORUM'], $online_userlist);
+	}
+	// Build online listing
+	$vars_online = array(
+		'ONLINE'	=> array('total_online', 'l_t_user_s', 0),
+		'REG'		=> array('visible_online', 'l_r_user_s', !$config['load_online_guests']),
+		'HIDDEN'	=> array('hidden_online', 'l_h_user_s', $config['load_online_guests']),
+		'GUEST'		=> array('guests_online', 'l_g_user_s', 0)
+	);
+
+	foreach ($vars_online as $l_prefix => $var_ary)
+	{
+		if ($var_ary[2])
+		{
+			$l_suffix = '_AND';
+		}
+		else
+		{
+			$l_suffix = '';
+		}
+		switch ($online_users[$var_ary[0]])
+		{
+			case 0:
+				${$var_ary[1]} = $user->lang[$l_prefix . '_USERS_ZERO_TOTAL' . $l_suffix];
+			break;
+
+			case 1:
+				${$var_ary[1]} = $user->lang[$l_prefix . '_USER_TOTAL' . $l_suffix];
+			break;
+
+			default:
+				${$var_ary[1]} = $user->lang[$l_prefix . '_USERS_TOTAL' . $l_suffix];
+			break;
+		}
+	}
+	unset($vars_online);
+
+	$l_online_users = sprintf($l_t_user_s, $online_users['total_online']);
+	$l_online_users .= sprintf($l_r_user_s, $online_users['visible_online']);
+	$l_online_users .= sprintf($l_h_user_s, $online_users['hidden_online']);
+
+	if ($config['load_online_guests'])
+	{
+		$l_online_users .= sprintf($l_g_user_s, $online_users['guests_online']);
+	}
+
+
+
+	return array(
+		'online_userlist'	=> $online_userlist,
+		'l_online_users'	=> $l_online_users,
+	);
+}
+
+
+/**
+* Generate page header
+*/
+function page_header($page_title = '', $display_online_list = true)
+{
+	global $db, $config, $template, $SID, $_SID, $user, $auth, $phpEx, $phpbb_root_path;
+
+	if (defined('HEADER_INC'))
+	{
+		return;
+	}
+
+	define('HEADER_INC', true);
+
+	// gzip_compression
+	if ($config['gzip_compress'])
+	{
+		if (@extension_loaded('zlib') && !headers_sent())
+		{
+			ob_start('ob_gzhandler');
+		}
+	}
+
+	// Generate logged in/logged out status
+	if ($user->data['user_id'] != ANONYMOUS)
+	{
+		$u_login_logout = append_sid("{$phpbb_root_path}ucp.$phpEx", 'mode=logout', true, $user->session_id);
+		$l_login_logout = sprintf($user->lang['LOGOUT_USER'], $user->data['username']);
+	}
+	else
+	{
+		$u_login_logout = append_sid("{$phpbb_root_path}ucp.$phpEx", 'mode=login');
+		$l_login_logout = $user->lang['LOGIN'];
+	}
+
+	// Last visit date/time
+	$s_last_visit = ($user->data['user_id'] != ANONYMOUS) ? $user->format_date($user->data['session_last_visit']) : '';
+
+	// Get users online list ... if required
+	$l_online_users = $online_userlist = $l_online_record = '';
+
+	if ($config['load_online'] && $config['load_online_time'] && $display_online_list)
+	{
+		$f = request_var('f', 0);
+		$f = max($f, 0);
+		$online_users = obtain_users_online($f);
+		$user_online_strings = obtain_users_online_string($online_users, $f);
+
+		$l_online_users = $user_online_strings['l_online_users'];
+		$online_userlist = $user_online_strings['online_userlist'];
+		$total_online_users = $online_users['total_online'];
+
+		if ($total_online_users > $config['record_online_users'])
+		{
+			set_config('record_online_users', $total_online_users, true);
+			set_config('record_online_date', time(), true);
+		}
+
+		$l_online_record = sprintf($user->lang['RECORD_ONLINE_USERS'], $config['record_online_users'], $user->format_date($config['record_online_date']));
+
+		$l_online_time = ($config['load_online_time'] == 1) ? 'VIEW_ONLINE_TIME' : 'VIEW_ONLINE_TIMES';
+		$l_online_time = sprintf($user->lang[$l_online_time], $config['load_online_time']);
+	}
+	else
+	{
+		$l_online_time = '';
+	}
+
+	$l_privmsgs_text = $l_privmsgs_text_unread = '';
+	$s_privmsg_new = false;
+
+	// Obtain number of new private messages if user is logged in
+	if (isset($user->data['is_registered']) && $user->data['is_registered'])
+	{
+		if ($user->data['user_new_privmsg'])
+		{
+			$l_message_new = ($user->data['user_new_privmsg'] == 1) ? $user->lang['NEW_PM'] : $user->lang['NEW_PMS'];
+			$l_privmsgs_text = sprintf($l_message_new, $user->data['user_new_privmsg']);
+
+			if (!$user->data['user_last_privmsg'] || $user->data['user_last_privmsg'] > $user->data['session_last_visit'])
+			{
+				$sql = 'UPDATE ' . USERS_TABLE . '
+					SET user_last_privmsg = ' . $user->data['session_last_visit'] . '
+					WHERE user_id = ' . $user->data['user_id'];
+				$db->sql_query($sql);
+
+				$s_privmsg_new = true;
+			}
+			else
+			{
+				$s_privmsg_new = false;
+			}
+		}
+		else
+		{
+			$l_privmsgs_text = $user->lang['NO_NEW_PM'];
+			$s_privmsg_new = false;
+		}
+
+		$l_privmsgs_text_unread = '';
+
+		if ($user->data['user_unread_privmsg'] && $user->data['user_unread_privmsg'] != $user->data['user_new_privmsg'])
+		{
+			$l_message_unread = ($user->data['user_unread_privmsg'] == 1) ? $user->lang['UNREAD_PM'] : $user->lang['UNREAD_PMS'];
+			$l_privmsgs_text_unread = sprintf($l_message_unread, $user->data['user_unread_privmsg']);
+		}
+	}
+
+	// Which timezone?
+	$tz = ($user->data['user_id'] != ANONYMOUS) ? strval(doubleval($user->data['user_timezone'])) : strval(doubleval($config['board_timezone']));
+
+	// Send a proper content-language to the output
+	$user_lang = $user->lang['USER_LANG'];
+	if (strpos($user_lang, '-x-') !== false)
+	{
+		$user_lang = substr($user_lang, 0, strpos($user_lang, '-x-'));
+	}
+
+	// The following assigns all _common_ variables that may be used at any point in a template.
+	$template->assign_vars(array(
+		'SITENAME'						=> $config['sitename'],
+		'SITE_DESCRIPTION'				=> $config['site_desc'],
+		'PAGE_TITLE'					=> $page_title,
+		'SCRIPT_NAME'					=> str_replace('.' . $phpEx, '', $user->page['page_name']),
+		'LAST_VISIT_DATE'				=> sprintf($user->lang['YOU_LAST_VISIT'], $s_last_visit),
+		'LAST_VISIT_YOU'				=> $s_last_visit,
+		'CURRENT_TIME'					=> sprintf($user->lang['CURRENT_TIME'], $user->format_date(time(), false, true)),
+		'TOTAL_USERS_ONLINE'			=> $l_online_users,
+		'LOGGED_IN_USER_LIST'			=> $online_userlist,
+		'RECORD_USERS'					=> $l_online_record,
+		'PRIVATE_MESSAGE_INFO'			=> $l_privmsgs_text,
+		'PRIVATE_MESSAGE_INFO_UNREAD'	=> $l_privmsgs_text_unread,
+
+		'S_USER_NEW_PRIVMSG'			=> $user->data['user_new_privmsg'],
+		'S_USER_UNREAD_PRIVMSG'			=> $user->data['user_unread_privmsg'],
+
+		'SID'				=> $SID,
+		'_SID'				=> $_SID,
+		'SESSION_ID'		=> $user->session_id,
+		'ROOT_PATH'			=> $phpbb_root_path,
+
+		'L_LOGIN_LOGOUT'	=> $l_login_logout,
+		'L_INDEX'			=> $user->lang['FORUM_INDEX'],
+		'L_ONLINE_EXPLAIN'	=> $l_online_time,
+
+		'U_PRIVATEMSGS'			=> append_sid("{$phpbb_root_path}ucp.$phpEx", 'i=pm&amp;folder=inbox'),
+		'U_RETURN_INBOX'		=> append_sid("{$phpbb_root_path}ucp.$phpEx", 'i=pm&amp;folder=inbox'),
+		'U_POPUP_PM'			=> append_sid("{$phpbb_root_path}ucp.$phpEx", 'i=pm&amp;mode=popup'),
+		'UA_POPUP_PM'			=> addslashes(append_sid("{$phpbb_root_path}ucp.$phpEx", 'i=pm&amp;mode=popup')),
+		'U_MEMBERLIST'			=> append_sid("{$phpbb_root_path}memberlist.$phpEx"),
+		'U_VIEWONLINE'			=> ($auth->acl_gets('u_viewprofile', 'a_user', 'a_useradd', 'a_userdel')) ? append_sid("{$phpbb_root_path}viewonline.$phpEx") : '',
+		'U_LOGIN_LOGOUT'		=> $u_login_logout,
+		'U_INDEX'				=> append_sid("{$phpbb_root_path}index.$phpEx"),
+		'U_SEARCH'				=> append_sid("{$phpbb_root_path}search.$phpEx"),
+		'U_REGISTER'			=> append_sid("{$phpbb_root_path}ucp.$phpEx", 'mode=register'),
+		'U_PROFILE'				=> append_sid("{$phpbb_root_path}ucp.$phpEx"),
+		'U_MODCP'				=> append_sid("{$phpbb_root_path}mcp.$phpEx", false, true, $user->session_id),
+		'U_FAQ'					=> append_sid("{$phpbb_root_path}faq.$phpEx"),
+		'U_SEARCH_SELF'			=> append_sid("{$phpbb_root_path}search.$phpEx", 'search_id=egosearch'),
+		'U_SEARCH_NEW'			=> append_sid("{$phpbb_root_path}search.$phpEx", 'search_id=newposts'),
+		'U_SEARCH_UNANSWERED'	=> append_sid("{$phpbb_root_path}search.$phpEx", 'search_id=unanswered'),
+		'U_SEARCH_ACTIVE_TOPICS'=> append_sid("{$phpbb_root_path}search.$phpEx", 'search_id=active_topics'),
+		'U_DELETE_COOKIES'		=> append_sid("{$phpbb_root_path}ucp.$phpEx", 'mode=delete_cookies'),
+		'U_TEAM'				=> append_sid("{$phpbb_root_path}memberlist.$phpEx", 'mode=leaders'),
+		'U_RESTORE_PERMISSIONS'	=> ($user->data['user_perm_from'] && $auth->acl_get('a_switchperm')) ? append_sid("{$phpbb_root_path}ucp.$phpEx", 'mode=restore_perm') : '',
+
+		'S_USER_LOGGED_IN'		=> ($user->data['user_id'] != ANONYMOUS) ? true : false,
+		'S_AUTOLOGIN_ENABLED'	=> ($config['allow_autologin']) ? true : false,
+		'S_BOARD_DISABLED'		=> ($config['board_disable']) ? true : false,
+		'S_REGISTERED_USER'		=> $user->data['is_registered'],
+		'S_IS_BOT'				=> $user->data['is_bot'],
+		'S_USER_PM_POPUP'		=> $user->optionget('popuppm'),
+		'S_USER_LANG'			=> $user_lang,
+		'S_USER_BROWSER'		=> (isset($user->data['session_browser'])) ? $user->data['session_browser'] : $user->lang['UNKNOWN_BROWSER'],
+		'S_USERNAME'			=> $user->data['username'],
+		'S_CONTENT_DIRECTION'	=> $user->lang['DIRECTION'],
+		'S_CONTENT_FLOW_BEGIN'	=> ($user->lang['DIRECTION'] == 'ltr') ? 'left' : 'right',
+		'S_CONTENT_FLOW_END'	=> ($user->lang['DIRECTION'] == 'ltr') ? 'right' : 'left',
+		'S_CONTENT_ENCODING'	=> 'UTF-8',
+		'S_TIMEZONE'			=> ($user->data['user_dst'] || ($user->data['user_id'] == ANONYMOUS && $config['board_dst'])) ? sprintf($user->lang['ALL_TIMES'], $user->lang['tz'][$tz], $user->lang['tz']['dst']) : sprintf($user->lang['ALL_TIMES'], $user->lang['tz'][$tz], ''),
+		'S_DISPLAY_ONLINE_LIST'	=> ($l_online_time) ? 1 : 0,
+		'S_DISPLAY_SEARCH'		=> (!$config['load_search']) ? 0 : (isset($auth) ? ($auth->acl_get('u_search') && $auth->acl_getf_global('f_search')) : 1),
+		'S_DISPLAY_PM'			=> ($config['allow_privmsg'] && $user->data['is_registered'] && ($auth->acl_get('u_readpm') || $auth->acl_get('u_sendpm'))) ? true : false,
+		'S_DISPLAY_MEMBERLIST'	=> (isset($auth)) ? $auth->acl_get('u_viewprofile') : 0,
+		'S_NEW_PM'				=> ($s_privmsg_new) ? 1 : 0,
+		'S_REGISTER_ENABLED'	=> ($config['require_activation'] != USER_ACTIVATION_DISABLE) ? true : false,
+
+		'T_THEME_PATH'			=> "{$phpbb_root_path}styles/" . $user->theme['theme_path'] . '/theme',
+		'T_TEMPLATE_PATH'		=> "{$phpbb_root_path}styles/" . $user->theme['template_path'] . '/template',
+		'T_IMAGESET_PATH'		=> "{$phpbb_root_path}styles/" . $user->theme['imageset_path'] . '/imageset',
+		'T_IMAGESET_LANG_PATH'	=> "{$phpbb_root_path}styles/" . $user->theme['imageset_path'] . '/imageset/' . $user->data['user_lang'],
+		'T_IMAGES_PATH'			=> "{$phpbb_root_path}images/",
+		'T_SMILIES_PATH'		=> "{$phpbb_root_path}{$config['smilies_path']}/",
+		'T_AVATAR_PATH'			=> "{$phpbb_root_path}{$config['avatar_path']}/",
+		'T_AVATAR_GALLERY_PATH'	=> "{$phpbb_root_path}{$config['avatar_gallery_path']}/",
+		'T_ICONS_PATH'			=> "{$phpbb_root_path}{$config['icons_path']}/",
+		'T_RANKS_PATH'			=> "{$phpbb_root_path}{$config['ranks_path']}/",
+		'T_UPLOAD_PATH'			=> "{$phpbb_root_path}{$config['upload_path']}/",
+		'T_STYLESHEET_LINK'		=> (!$user->theme['theme_storedb']) ? "{$phpbb_root_path}styles/" . $user->theme['theme_path'] . '/theme/stylesheet.css' : "{$phpbb_root_path}style.$phpEx?sid=$user->session_id&amp;id=" . $user->theme['style_id'] . '&amp;lang=' . $user->data['user_lang'],
+		'T_STYLESHEET_NAME'		=> $user->theme['theme_name'],
+
+		'SITE_LOGO_IMG'			=> $user->img('site_logo'))
+	);
+
+	// application/xhtml+xml not used because of IE
+	header('Content-type: text/html; charset=UTF-8');
+
+	header('Cache-Control: private, no-cache="set-cookie"');
+	header('Expires: 0');
+	header('Pragma: no-cache');
+
+	return;
+}
+
+/**
+* Generate page footer
+*/
+function page_footer($run_cron = true)
+{
+	global $db, $config, $template, $user, $auth, $cache, $starttime, $phpbb_root_path, $phpEx;
+
+	// Output page creation time
+	if (defined('DEBUG'))
+	{
+		$mtime = explode(' ', microtime());
+		$totaltime = $mtime[0] + $mtime[1] - $starttime;
+
+		if (!empty($_REQUEST['explain']) && $auth->acl_get('a_') && defined('DEBUG_EXTRA') && method_exists($db, 'sql_report'))
+		{
+			$db->sql_report('display');
+		}
+
+		$debug_output = sprintf('Time : %.3fs | ' . $db->sql_num_queries() . ' Queries | GZIP : ' . (($config['gzip_compress']) ? 'On' : 'Off') . (($user->load) ? ' | Load : ' . $user->load : ''), $totaltime);
+
+		if ($auth->acl_get('a_') && defined('DEBUG_EXTRA'))
+		{
+			if (function_exists('memory_get_usage'))
+			{
+				if ($memory_usage = memory_get_usage())
+				{
+					global $base_memory_usage;
+					$memory_usage -= $base_memory_usage;
+					$memory_usage = get_formatted_filesize($memory_usage);
+
+					$debug_output .= ' | Memory Usage: ' . $memory_usage;
+				}
+			}
+
+			$debug_output .= ' | <a href="' . build_url() . '&amp;explain=1">Explain</a>';
+		}
+	}
+
+	$template->assign_vars(array(
+		'DEBUG_OUTPUT'			=> (defined('DEBUG')) ? $debug_output : '',
+		'TRANSLATION_INFO'		=> (!empty($user->lang['TRANSLATION_INFO'])) ? $user->lang['TRANSLATION_INFO'] : '',
+
+		'U_ACP' => ($auth->acl_get('a_') && $user->data['is_registered']) ? append_sid("{$phpbb_root_path}adm/index.$phpEx", false, true, $user->session_id) : '')
+	);
+
+	// Call cron-type script
+	if (!defined('IN_CRON') && $run_cron && !$config['board_disable'])
+	{
+		$cron_type = '';
+
+		if (time() - $config['queue_interval'] > $config['last_queue_run'] && !defined('IN_ADMIN') && file_exists($phpbb_root_path . 'cache/queue.' . $phpEx))
+		{
+			// Process email queue
+			$cron_type = 'queue';
+		}
+		else if (method_exists($cache, 'tidy') && time() - $config['cache_gc'] > $config['cache_last_gc'])
+		{
+			// Tidy the cache
+			$cron_type = 'tidy_cache';
+		}
+		else if (time() - $config['warnings_gc'] > $config['warnings_last_gc'])
+		{
+			$cron_type = 'tidy_warnings';
+		}
+		else if (time() - $config['database_gc'] > $config['database_last_gc'])
+		{
+			// Tidy the database
+			$cron_type = 'tidy_database';
+		}
+		else if (time() - $config['search_gc'] > $config['search_last_gc'])
+		{
+			// Tidy the search
+			$cron_type = 'tidy_search';
+		}
+		else if (time() - $config['session_gc'] > $config['session_last_gc'])
+		{
+			$cron_type = 'tidy_sessions';
+		}
+
+		if ($cron_type)
+		{
+			$template->assign_var('RUN_CRON_TASK', '<img src="' . append_sid($phpbb_root_path . 'cron.' . $phpEx, 'cron_type=' . $cron_type) . '" width="1" height="1" alt="cron" />');
+		}
+	}
+
+	$template->display('body');
+
+	garbage_collection();
+	exit_handler();
+}
+
+/**
+* Closing the cache object and the database
+* Cool function name, eh? We might want to add operations to it later
+*/
+function garbage_collection()
+{
+	global $cache, $db;
+
+	// Unload cache, must be done before the DB connection if closed
+	if (!empty($cache))
+	{
+		$cache->unload();
+	}
+
+	// Close our DB connection.
+	if (!empty($db))
+	{
+		$db->sql_close();
+	}
+}
+
+/**
+* Handler for exit calls in phpBB.
+* This function supports hooks.
+*
+* Note: This function is called after the template has been outputted.
+*/
+function exit_handler()
+{
+	global $phpbb_hook;
+
+	if (!empty($phpbb_hook) && $phpbb_hook->call_hook(__FUNCTION__))
+	{
+		if ($phpbb_hook->hook_return(__FUNCTION__))
+		{
+			return $phpbb_hook->hook_return_result(__FUNCTION__);
+		}
+	}
+
+	// As a pre-caution... some setups display a blank page if the flush() is not there.
+	@flush();
+
+	exit;
+}
+
+/**
+* Handler for init calls in phpBB. This function is called in user::setup();
+* This function supports hooks.
+*/
+function phpbb_user_session_handler()
+{
+	global $phpbb_hook;
+
+	if (!empty($phpbb_hook) && $phpbb_hook->call_hook(__FUNCTION__))
+	{
+		if ($phpbb_hook->hook_return(__FUNCTION__))
+		{
+			return $phpbb_hook->hook_return_result(__FUNCTION__);
+		}
+	}
+
+	return;
+}
+
+?>
\ No newline at end of file
Index: includes/db/dbal.php
===================================================================
--- includes/db/dbal.php	(revision 159)
+++ includes/db/dbal.php	(revision 161)
@@ -616,7 +616,9 @@
 	function sql_report($mode, $query = '')
 	{
 		global $cache, $starttime, $phpbb_root_path, $user;
-
+		// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+		global $phpbb_seo;
+		// www.phpBB-SEO.com SEO TOOLKIT END
 		if (empty($_REQUEST['explain']))
 		{
 			return false;
@@ -646,7 +648,7 @@
 						<meta http-equiv="Content-Style-Type" content="text/css" />
 						<meta http-equiv="imagetoolbar" content="no" />
 						<title>SQL Report</title>
-						<link href="' . $phpbb_root_path . 'adm/style/admin.css" rel="stylesheet" type="text/css" media="screen" />
+						<link href="' . $phpbb_seo->seo_path['phpbb_url'] . 'adm/style/admin.css" rel="stylesheet" type="text/css" media="screen" />
 					</head>
 					<body id="errorpage">
 					<div id="wrap">
Index: includes/functions_content.php
===================================================================
--- includes/functions_content.php	(revision 159)
+++ includes/functions_content.php	(revision 161)
@@ -1118,7 +1118,9 @@
 function get_username_string($mode, $user_id, $username, $username_colour = '', $guest_username = false, $custom_profile_url = false)
 {
 	global $phpbb_root_path, $phpEx, $user, $auth;
-
+	// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+	global $phpbb_seo;
+	// www.phpBB-SEO.com SEO TOOLKIT END
 	$profile_url = '';
 	$username_colour = ($username_colour) ? '#' . $username_colour : '';
 
@@ -1142,6 +1144,9 @@
 		}
 		else
 		{
+			// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+			$phpbb_seo->set_user_url( strip_tags($username), $user_id );
+			// www.phpBB-SEO.com SEO TOOLKIT END
 			$profile_url = ($custom_profile_url !== false) ? $custom_profile_url . '&amp;u=' . (int) $user_id : append_sid("{$phpbb_root_path}memberlist.$phpEx", 'mode=viewprofile&amp;u=' . (int) $user_id);
 		}
 	}
Index: includes/functions_posting.php
===================================================================
--- includes/functions_posting.php	(revision 159)
+++ includes/functions_posting.php	(revision 161)
@@ -1550,7 +1550,9 @@
 function submit_post($mode, $subject, $username, $topic_type, &$poll, &$data, $update_message = true)
 {
 	global $db, $auth, $user, $config, $phpEx, $template, $phpbb_root_path;
-
+	// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+	global $phpbb_seo;
+	// www.phpBB-SEO.com SEO TOOLKIT END
 	// We do not handle erasing posts here
 	if ($mode == 'delete')
 	{
@@ -2440,7 +2442,17 @@
 	{
 		$params .= '&amp;t=' . $data['topic_id'];
 	}
-
+	// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+	if ($topic_type == POST_GLOBAL) {
+		$phpbb_seo->seo_opt['topic_type'][$data['topic_id']] = POST_GLOBAL;
+	}
+	if ( $params && empty($phpbb_seo->seo_url['topic'][$data['topic_id']]) ) {
+		$phpbb_seo->seo_url['topic'][$data['topic_id']] = $phpbb_seo->format_url(censor_text($data['topic_title']));
+	}
+	if ( empty($phpbb_seo->seo_url['forum'][$data['forum_id']]) ) {
+		$phpbb_seo->seo_url['forum'][$data['forum_id']] = $phpbb_seo->set_url($data['forum_name'], $data['forum_id'], $phpbb_seo->seo_static['forum']);
+	}
+	// www.phpBB-SEO.com SEO TOOLKIT END
 	$url = (!$params) ? "{$phpbb_root_path}viewforum.$phpEx" : "{$phpbb_root_path}viewtopic.$phpEx";
 	$url = append_sid($url, 'f=' . $data['forum_id'] . $params) . $add_anchor;
 
Index: includes/acp/acp_update.php
===================================================================
--- includes/acp/acp_update.php	(revision 159)
+++ includes/acp/acp_update.php	(revision 161)
@@ -2,7 +2,7 @@
 /**
 *
 * @package acp
-* @version $Id: acp_update.php 8479 2008-03-29 00:22:48Z naderman $
+* @version $Id: acp_update.php,v 1.9 2007/11/19 17:00:13 acydburn Exp $
 * @copyright (c) 2005 phpBB Group
 * @license http://opensource.org/licenses/gpl-license.php GNU Public License
 *
@@ -37,7 +37,10 @@
 		$errstr = '';
 		$errno = 0;
 
-		$info = get_remote_file('www.phpbb.com', '/updatecheck', ((defined('PHPBB_QA')) ? '30x_qa.txt' : '30x.txt'), $errstr, $errno);
+		// PREMOD
+		$url = 'www.phpbb-seo.com';
+		$dir = (strpos($config['default_lang'], 'fr') !== false ? '/forums' : '/boards') . '/updatecheck';
+		$info = get_remote_file($url, $dir, ((defined('PHPBB_SEO_QA')) ? 'test_30x.txt' : 'premod_30x.txt'), $errstr, $errno);
 
 		if ($info === false)
 		{
@@ -62,7 +65,19 @@
 
 		$up_to_date_automatic = (version_compare(str_replace('rc', 'RC', strtolower($current_version)), str_replace('rc', 'RC', strtolower($latest_version)), '<')) ? false : true;
 		$up_to_date = (version_compare(str_replace('rc', 'RC', strtolower($config['version'])), str_replace('rc', 'RC', strtolower($latest_version)), '<')) ? false : true;
-
+		$phpbb_seo_update = '';
+		if ($up_to_date) {
+			$phpbb_seo_update = trim(str_replace($current_version, '', $latest_version));
+		}
+		$update_instruction = sprintf($user->lang['UPDATE_INSTRUCTIONS'], $announcement_url, $update_link);
+		if (!empty($phpbb_seo_update)) {
+			$auto_package = trim($info[2]);
+			$auto_update = $auto_package === 'auto_update:yes' ? true : false;
+			$up_to_date = ($latest_version === $config['seo_premod_version']) ? true : false;
+			if (!$auto_update) {
+				$update_instruction = '<br/><br/><hr/>' . sprintf($user->lang['ACP_PREMOD_UPDATE'], $latest_version, $announcement_url) . '<br/><hr/>';
+			}
+		}
 		$template->assign_vars(array(
 			'S_UP_TO_DATE'		=> $up_to_date,
 			'S_UP_TO_DATE_AUTO'	=> $up_to_date_automatic,
@@ -73,9 +88,9 @@
 			'CURRENT_VERSION'	=> $config['version'],
 			'AUTO_VERSION'		=> $version_update_from,
 
-			'UPDATE_INSTRUCTIONS'	=> sprintf($user->lang['UPDATE_INSTRUCTIONS'], $announcement_url, $update_link),
+			'UPDATE_INSTRUCTIONS'	=> $update_instruction,
 		));
 	}
 }
 
-?>
\ No newline at end of file
+?>
Index: includes/acp/info/acp_phpbb_seo.php
===================================================================
--- includes/acp/info/acp_phpbb_seo.php	(revision 0)
+++ includes/acp/info/acp_phpbb_seo.php	(revision 161)
@@ -0,0 +1,36 @@
+<?php
+/** 
+*
+* @package acp
+* @version $Id: acp_board.php,v 1.5 2006/06/28 02:43:43 davidmj Exp $
+* @copyright (c) 2005 phpBB Group 
+* @license http://opensource.org/licenses/gpl-license.php GNU Public License 
+*
+*/
+
+/**
+* @package module_install
+*/
+class acp_phpbb_seo_info {
+	function module() {
+		return array(
+			'filename'	=> 'phpbb_seo',
+			'title'		=> 'ACP_CAT_PHPBB_SEO',
+			'version'	=> '0.4.0RC2',
+			'modes'		=> array(
+				'settings'		=> array('title' => 'ACP_PHPBB_SEO_CLASS', 'auth' => 'acl_a_board', 'cat' => array('ACP_MOD_REWRITE')),
+				'forum_url'		=> array('title' => 'ACP_FORUM_URL', 'auth' => 'acl_a_board', 'cat' => array('ACP_MOD_REWRITE')),
+				'htaccess'		=> array('title' => 'ACP_HTACCESS', 'auth' => 'acl_a_board', 'cat' => array('ACP_MOD_REWRITE'))),
+		);
+	}
+
+	function install()
+	{
+	}
+
+	function uninstall()
+	{
+	}
+}
+
+?>
Index: includes/acp/acp_phpbb_seo.php
===================================================================
--- includes/acp/acp_phpbb_seo.php	(revision 0)
+++ includes/acp/acp_phpbb_seo.php	(revision 161)
@@ -0,0 +1,767 @@
+<?php
+/** 
+*
+* @package Advanced phpBB SEO mod Rewrite
+* @version $Id: phpbb_seo_class.php 2007/08/30 13:48:48 dcz Exp $
+* @copyright (c) 2006, 2007 dcz - www.phpbb-seo.com
+* @license http://www.opensource.org/licenses/rpl.php RPL Public License 
+*
+*/
+/**
+* phpBB_SEO Class
+* www.phpBB-SEO.com
+* @package Advanced phpBB3 SEO mod Rewrite
+*/
+class acp_phpbb_seo {
+	var $u_action;
+	var $new_config = array();
+	var $dyn_select = array();
+	var $forum_ids = array();
+	var $array_type_cfg = array();
+	var $multiple_options = array();
+	var $modrtype_lang = array();
+	var $write_type = 'forum';
+	var $lengh_limit = 20;
+	var $word_limit = 3;
+	var $seo_unset_opts = array();
+	/**
+	* Constructor
+	*/
+	function main($id, $mode) {
+		global $config, $db, $user, $auth, $template, $cache;
+		global $phpbb_root_path, $phpbb_admin_path, $phpEx, $table_prefix, $phpbb_seo;
+		// Start the phpbb_seo class
+		if ( !is_object($phpbb_seo) ) {
+			include_once($phpbb_root_path . 'phpbb_seo/phpbb_seo_class.' . $phpEx);
+			$phpbb_seo = new phpbb_seo();
+		}
+		$user->add_lang('acp/phpbb_seo');
+		$action	= request_var('action', '');
+		$submit = (isset($_POST['submit'])) ? true : false;
+		$display_vars = array();
+		// --> Zero Dupe
+		if (@isset($phpbb_seo->seo_opt['zero_dupe']) ) {
+			$this->multiple_options['zero_dupe']['post_redir_values'] = array('off' => 'off', 'post' => 'post', 'guest' => 'guest', 'all' => 'all'); // do not change
+			$this->multiple_options['zero_dupe']['post_redir_lang'] = array('off' => $user->lang['ACP_ZERO_DUPE_OFF'], 'post' => $user->lang['ACP_ZERO_DUPE_MSG'], 'guest' => $user->lang['ACP_ZERO_DUPE_GUEST'], 'all' => $user->lang['ACP_ZERO_DUPE_ALL']); // do not change
+		}
+		// <-- Mod rewrite selector
+		if ($phpbb_seo->modrtype == 1) {
+			$this->seo_unset_opts = array('cache_layer', 'rem_ids');
+		} elseif (!$phpbb_seo->seo_opt['cache_layer']) {
+			$this->seo_unset_opts = array('rem_ids');
+		}
+		$this->modrtype_lang = $this->set_phpbb_seo_links();
+		$this->multiple_options['modrtype_lang'] = $this->modrtype_lang['titles'];
+		if (@isset($phpbb_seo->seo_opt['modrtype']) ) {
+			$this->multiple_options['modrtype_values'] = array( 1 => 1, 2 => 2, 3 => 3 ); // do not change;
+		}
+		// <-- Mod rewrite selector
+		foreach ( $this->seo_unset_opts as $opt ) {
+			if ( $optkey = array_search($opt, $phpbb_seo->cache_config['dynamic_options']) ) {
+				unset($phpbb_seo->cache_config['dynamic_options'][$optkey]);
+			}
+		}
+		// We need shorter URLs with Virtual Folder Trick
+		if ($phpbb_seo->seo_opt['virtual_folder']) {
+			$this->lengh_limit = 20;
+			$this->word_limit = 3;
+		} else {
+			$this->lengh_limit = 30;
+			$this->word_limit = 5;
+		}
+		switch ($mode) {
+			case 'settings':
+				$this->write_type = 'forum';
+				$display_vars['title'] = 'ACP_PHPBB_SEO_CLASS';
+				$user->lang['ACP_PHPBB_SEO_CLASS_EXPLAIN'] = sprintf($user->lang['ACP_PHPBB_SEO_CLASS_EXPLAIN'], '<br/><br/><hr/><b>' . $user->lang['ACP_PHPBB_SEO_VERSION'] . ' : ' . $this->modrtype_lang['link'] . ' - ' . $phpbb_seo->version . ' ( ' . $this->modrtype_lang['forumlink'] . ' )</b><br/><br/><hr/>');
+				$display_vars['vars'] = array();
+				$i = 2;
+				$display_vars['vars']['legend1'] = 'ACP_PHPBB_SEO_CLASS';
+				foreach($phpbb_seo->cache_config['dynamic_options'] as $optionname => $optionvalue) {
+					if ( @is_bool($phpbb_seo->seo_opt[$optionvalue]) ) {
+						$display_vars['vars'][$optionvalue] = array('lang' => $optionvalue, 'validate' => 'bool', 'type' => 'radio:yes_no', 'explain' => true, 'lang_explain' => $optionvalue . '_explain');
+						$this->new_config[$optionvalue] = $phpbb_seo->seo_opt[$optionvalue];
+					} elseif ( @isset($this->multiple_options[$optionvalue . '_values']) ) {
+						$this->dyn_select[$optionvalue] = $this->multiple_options[$optionvalue . '_values'];
+						$display_vars['vars'][$optionvalue] = array('lang' => $optionvalue, 'validate' => 'string', 'type' => 'select', 'method' => 'select_string', 'explain' => true, 'lang_explain' => $optionvalue . '_explain');
+						$this->new_config[$optionvalue] = $phpbb_seo->seo_opt[$optionvalue];
+					} elseif ( is_array($optionvalue)) {
+						$display_vars['vars']['legend' . $i] = $optionname;
+						$i++;
+						foreach ($optionvalue as $key => $value) {
+							$this->array_type_cfg[$optionname . '_' . $key] = array('main' => $optionname, 'sub' => $key);
+							if ( is_bool($value) ) {
+								$display_vars['vars'][$optionname . '_' . $key] = array('lang' => $optionname . '_' . $key, 'validate' => 'bool', 'type' => 'radio:yes_no', 'explain' => true, 'lang_explain' => $optionname . '_' . $key . '_explain');
+								$this->new_config[$optionname . '_' . $key] = $phpbb_seo->seo_opt[$optionname][$key];
+							} elseif ( @isset($this->multiple_options[$optionname][$key . '_values'] )) {
+  								$this->dyn_select[$optionname . '_' . $key] = $this->multiple_options[$optionname][$key . '_values'];
+								$display_vars['vars'][$optionname . '_' . $key] = array('lang' => $optionname . '_' . $key, 'validate' => 'string', 'type' => 'select', 'method' => 'select_string', 'explain' => true, 'lang_explain' => $optionname . '_' . $key . '_explain');
+								$this->new_config[$optionname . '_' . $key] = $phpbb_seo->seo_opt[$optionname][$key];
+							} else {
+								$display_vars['vars'][$optionname . '_' . $key] = array('lang' => $optionname . '_' . $key, 'validate' => 'string:0:50', 'type' => 'text:50:50', 'explain' => true, 'lang_explain' => $optionname . '_' . $key . '_explain');
+								$this->new_config[$optionname . '_' . $key] = $phpbb_seo->seo_opt[$optionname][$key];
+							}
+
+						}
+					}
+				}
+			break;
+			case 'forum_url':
+				// used for cache
+				$this->write_type = 'forum';
+				$forbidden = array($phpbb_seo->seo_static['forum'], $phpbb_seo->seo_static['global_announce'], $phpbb_seo->seo_static['user'], $phpbb_seo->seo_static['topic'], $phpbb_seo->seo_static['atopic'], $phpbb_seo->seo_static['utopic'], $phpbb_seo->seo_static['leaders'], $phpbb_seo->seo_static['post'], $phpbb_seo->seo_static['group'], $phpbb_seo->seo_static['npost'], $phpbb_seo->seo_static['index']);
+				if ( $phpbb_seo->modrtype == 1 || !$phpbb_seo->seo_opt['cache_layer'] ) {
+					trigger_error($user->lang['ACP_NO_FORUM_URL'] . preg_replace('`(&amp;|&|\?)mode=forum_url`i', '', adm_back_link($this->u_action)));
+					break;
+				}
+				$display_vars['title'] = 'ACP_FORUM_URL';
+				$user->lang['ACP_FORUM_URL_EXPLAIN'] .= '<hr/><b>' . $user->lang['ACP_PHPBB_SEO_VERSION'] . ' : ' . $this->modrtype_lang['link'] . ' - ' . $phpbb_seo->version . ' ( ' . $this->modrtype_lang['forumlink'] . ' )</b><br/><br/><hr/>';
+				$display_vars['vars'] = array();
+				$display_vars['vars']['legend1'] = 'ACP_FORUM_URL';
+				$sql = "SELECT forum_id, forum_name
+					FROM " . FORUMS_TABLE . "
+					ORDER BY forum_id ASC";
+				$result = $db->sql_query($sql);
+				$row = array();
+				$forum_url_title = $error_cust = '';
+				while( $row = $db->sql_fetchrow($result) ) {
+					// Only trust ids from the db
+					$forum_id = $row['forum_id'];
+					$this->forum_ids[$forum_id] = $row['forum_name'];
+					$error_cust = '';
+					// Is the URL cached already ?
+					if ( empty($phpbb_seo->cache_config['forum'][$forum_id]) ) {
+						// Suggest the one from the title
+						$forum_url_title = $phpbb_seo->format_url($row['forum_name'], $phpbb_seo->seo_static['forum']);
+						if (!in_array($forum_url_title, $forbidden)) {
+							if (array_search($forum_url_title, $phpbb_seo->cache_config['forum'])) {
+								$this->new_config['forum_url' . $forum_id] = $forum_url_title .  $phpbb_seo->seo_delim['forum'] . $forum_id;
+								$error_cust = '<li>&nbsp;' . sprintf($user->lang['SEO_ADVICE_DUPE'], $forum_url_title) . '</li>';
+							} else {
+								$this->new_config['forum_url' . $forum_id] = $forum_url_title . (@$phpbb_seo->cache_config['settings']['rem_ids'] ? '': $phpbb_seo->seo_delim['forum'] . $forum_id);
+			}
+						} else {
+							$this->new_config['forum_url' . $forum_id] = $forum_url_title . $phpbb_seo->seo_delim['forum'] . $forum_id;
+							$error_cust = '<li>&nbsp;' . sprintf($user->lang['SEO_ADVICE_RESERVED'], $forum_url_title) . '</li>';
+						}
+						$title = '<b style="color:red">' . $row['forum_name'] . '</b>';
+						$status_msg = '<b>' . $user->lang['SEO_CACHE_URL_NOT_OK'] . '</b>';
+						$status_msg .= '<br/><u style="color:red">' . $user->lang['SEO_CACHE_URL'] . '&nbsp;:</u>&nbsp;' . $this->new_config['forum_url' . $forum_id] . $phpbb_seo->seo_ext['forum'];
+						$display_vars['vars']['forum_url' . $forum_id] = array('lang' => $title, 'validate' => 'string', 'type' => 'custom', 'method' => 'forum_url_input', 'explain' => true, 'lang_explain_custom' => $status_msg,'append' => $this->seo_advices($this->new_config['forum_url' . $forum_id], $forum_id,  FALSE, $error_cust));
+					} else { // Cached
+						$this->new_config['forum_url' . $forum_id] = $phpbb_seo->cache_config['forum'][$forum_id];
+						$title = '<b style="color:green">' . $row['forum_name'] . '</b>';
+						$status_msg = '<u style="color:green">' . $user->lang['SEO_CACHE_URL_OK'] . '&nbsp;:</u>&nbsp;<b style="color:green">' . $this->new_config['forum_url' . $forum_id] . '</b>';
+						$status_msg .= '<br/><u style="color:green">' . $user->lang['SEO_CACHE_URL'] . '&nbsp;:</u>&nbsp;' . $this->new_config['forum_url' . $forum_id] . $phpbb_seo->seo_ext['forum'];
+						$display_vars['vars']['forum_url' . $forum_id] = array('lang' => $title, 'validate' => 'string', 'type' => 'custom', 'method' => 'forum_url_input', 'explain' => true, 'lang_explain_custom' => $status_msg,'append' => $this->seo_advices($this->new_config['forum_url' . $forum_id], $forum_id, TRUE));
+					}
+				}
+			break;
+			case 'htaccess':
+				$this->write_type = 'htaccess';
+				$display_vars['title'] = 'ACP_HTACCESS';
+				$user->lang['ACP_HTACCESS_EXPLAIN'] .= '<br/><hr/><b>' . $user->lang['ACP_PHPBB_SEO_VERSION'] . ' : ' . $this->modrtype_lang['link'] . ' - ' . $phpbb_seo->version . ' ( ' . $this->modrtype_lang['forumlink'] . ' )</b><br/><br/>';
+				$display_vars['vars'] = array();
+				$display_vars['vars']['legend1'] = 'ACP_HTACCESS';
+				$display_vars['vars']['save'] = array('lang' => 'SEO_HTACCESS_SAVE', 'validate' => 'bool', 'type' => 'radio:yes_no', 'explain' => true,);
+				$display_vars['vars']['more_options'] = array('lang' => 'SEO_MORE_OPTION', 'validate' => 'bool', 'type' => 'radio:yes_no', 'explain' => true,);
+				$this->new_config['save'] = false;
+				$cfg_array = (isset($_REQUEST['config'])) ? utf8_normalize_nfc(request_var('config', array('' => ''), true)) : $this->new_config;
+				$this->new_config['more_options'] = isset($cfg_array['more_options']) ? $cfg_array['more_options'] : false;
+				$this->new_config['slash'] = isset($cfg_array['slash']) ? $cfg_array['slash'] : false;
+				$this->new_config['wslash'] = isset($cfg_array['wslash']) ? $cfg_array['wslash'] : false;
+				$this->new_config['rbase'] = isset($cfg_array['rbase']) ? $cfg_array['rbase'] : false;
+
+				if ($this->new_config['more_options']) {
+					$display_vars['vars']['slash'] = array('lang' => 'SEO_HTACCESS_SLASH', 'validate' => 'bool', 'type' => 'radio:yes_no', 'explain' => true,);
+					$display_vars['vars']['wslash'] = array('lang' => 'SEO_HTACCESS_WSLASH', 'validate' => 'bool', 'type' => 'radio:yes_no', 'explain' => true,);
+					$phpbb_path = trim($phpbb_seo->seo_path['phpbb_script'], '/');
+					if (!empty($phpbb_path ) && !$phpbb_seo->seo_opt['virtual_root']) {
+						$display_vars['vars']['rbase'] = array('lang' => 'SEO_HTACCESS_RBASE', 'validate' => 'bool', 'type' => 'radio:yes_no', 'explain' => true,);
+					}
+				}
+				// Dirty yet simple templating
+				$user->lang['ACP_HTACCESS_EXPLAIN'] .= $this->seo_htaccess();
+				
+			break;
+			default:
+				trigger_error('NO_MODE', E_USER_ERROR);
+			break;
+		}
+	//	if (isset($display_vars['lang']))
+	//	{
+	//		$user->add_lang($display_vars['lang']);
+	//	}
+		$error = array();
+		$seo_msg = array();
+		$cfg_array = (isset($_REQUEST['config'])) ? utf8_normalize_nfc(request_var('config', array('' => ''), true)) : $this->new_config;
+		// We validate the complete config if whished
+		validate_config_vars($display_vars['vars'], $cfg_array, $error);
+		// Do not write values if there is an error
+		if (sizeof($error)) {
+			$submit = false;
+		}
+		// We go through the display_vars to make sure no one is trying to set variables he/she is not allowed to...
+		foreach ($display_vars['vars'] as $config_name => $null) {
+			if (!isset($cfg_array[$config_name]) || strpos($config_name, 'legend') !== false) {
+				continue;
+			}
+			$this->new_config[$config_name] = $config_value = $cfg_array[$config_name];
+			if ($submit) {
+				// In case we deal with forum URLs
+				if ($mode == 'forum_url' && preg_match('`^forum_url([0-9]+)$`', $config_name, $matches)) {
+					// Check if this is an actual forum_id
+					if ( isset($this->forum_ids[$matches[1]]) ) {
+						$forum_id = intval($matches[1]);
+						$config_value = $phpbb_seo->format_url($config_value, $phpbb_seo->seo_static['forum']);
+						// Remove delim if required
+						while (preg_match('`^[a-z0-9_-]+' . $phpbb_seo->seo_delim['forum'] . '[0-9]+$`i', $config_value)) {
+							$config_value = preg_replace('`^([a-z0-9_-]+)' . $phpbb_seo->seo_delim['forum'] . '[0-9]+$`i', '\\1', $config_value);
+							if (@$phpbb_seo->cache_config['settings']['rem_ids']) {
+								$seo_msg['SEO_ADVICE_DELIM_REM'] = '<li>&nbsp;' . $user->lang['SEO_ADVICE_DELIM_REM'] . '</li>';
+							}
+						}
+						// Forums cannot end with the pagination param
+						while (preg_match('`^[a-z0-9_-]+' . $phpbb_seo->seo_delim['start'] . '[0-9]+$`i', $config_value)) {
+							$config_value = preg_replace('`^([a-z0-9_-]+)' . $phpbb_seo->seo_delim['start'] . '[0-9]+$`i', "\\1", $config_value);
+							$seo_msg['SEO_ADVICE_START'] = '<li>&nbsp;' . $user->lang['SEO_ADVICE_START'] . '</li>';
+						}
+						// Only update if the value is not a static one for forums
+						if (!in_array($config_value, $forbidden)) {
+							// and updated (sic)
+							if ($config_value != @$phpbb_seo->cache_config['forum'][$forum_id]) {
+								// and if not already set
+								if (!array_search($config_value, $phpbb_seo->cache_config['forum'])) {
+								$phpbb_seo->cache_config['forum'][$forum_id] = $config_value . (@$phpbb_seo->cache_config['settings']['rem_ids'] ? '': $phpbb_seo->seo_delim['forum'] . $forum_id);
+								} else {
+									$seo_msg['SEO_ADVICE_DUPE_' . $forum_id] = '<li>&nbsp;' . sprintf($user->lang['SEO_ADVICE_DUPE'], $config_value) . '</li>';
+								}
+							}
+						} else {
+							$seo_msg['SEO_ADVICE_RESERVED_' . $forum_id] = '<li>&nbsp;' . sprintf($user->lang['SEO_ADVICE_RESERVED'], $config_value) . '</li>';
+						}
+					}
+				} elseif ($mode == 'settings') {
+					if (isset($this->array_type_cfg[$config_name]) && isset($phpbb_seo->seo_opt[$this->array_type_cfg[$config_name]['main']][$this->array_type_cfg[$config_name]['sub']])) {
+						if ( is_bool($phpbb_seo->seo_opt[$this->array_type_cfg[$config_name]['main']][$this->array_type_cfg[$config_name]['sub']]) ) {
+							$phpbb_seo->cache_config['settings'][$this->array_type_cfg[$config_name]['main']][$this->array_type_cfg[$config_name]['sub']] = ($config_value == 1) ? true : false;
+						} elseif (is_numeric($phpbb_seo->seo_opt[$this->array_type_cfg[$config_name]['main']][$this->array_type_cfg[$config_name]['sub']])) {
+							$phpbb_seo->cache_config['settings'][$this->array_type_cfg[$config_name]['main']][$this->array_type_cfg[$config_name]['sub']] = intval($config_value);
+						} elseif (is_string($phpbb_seo->seo_opt[$this->array_type_cfg[$config_name]['main']][$this->array_type_cfg[$config_name]['sub']])) {
+							$phpbb_seo->cache_config['settings'][$this->array_type_cfg[$config_name]['main']][$this->array_type_cfg[$config_name]['sub']] = $config_value;
+						}
+					} elseif ( isset($phpbb_seo->seo_opt[$config_name]) ) {
+						if ( is_bool($phpbb_seo->seo_opt[$config_name]) ) {
+							$phpbb_seo->cache_config['settings'][$config_name] = ($config_value == 1) ? true : false;
+						} elseif ( is_numeric($phpbb_seo->seo_opt[$config_name]) ) {
+							$phpbb_seo->cache_config['settings'][$config_name] = intval($config_value);
+						} elseif ( is_string($phpbb_seo->seo_opt[$config_name]) ) {
+							$phpbb_seo->cache_config['settings'][$config_name] = $config_value;
+						}
+					}
+				}
+			}
+		}
+		if ($submit) {
+			if ($mode == 'htaccess') {
+				if ($this->new_config['save']) {
+					$this->write_cache($this->write_type);
+					add_log('admin', 'SEO_LOG_CONFIG_' . strtoupper($mode));
+				}
+			} else {
+				if ( $this->write_cache($this->write_type) ) {
+					ksort($phpbb_seo->cache_config[$this->write_type]);
+					add_log('admin', 'SEO_LOG_CONFIG_' . strtoupper($mode));
+					$msg = !empty($seo_msg) ? '<br /><h1 style="color:red;text-align:left;">' . $user->lang['SEO_VALIDATE_INFO'] . '</h1><ul style="text-align:left;">' . implode(' ',$seo_msg) . '</ul><br />' : '';
+					global $msg_long_text;
+					$msg_long_text = $user->lang['SEO_CACHE_MSG_OK'] . $msg . adm_back_link($this->u_action);
+					trigger_error(false);
+				} else {
+					trigger_error($user->lang['SEO_CACHE_MSG_FAIL'] . adm_back_link($this->u_action));
+				}
+			}
+		}
+		$this->tpl_name = 'acp_board';
+		$this->page_title = $display_vars['title'];
+		$phpbb_seo->seo_end();
+		$l_title_explain = $user->lang[$display_vars['title'] . '_EXPLAIN'];
+		$l_title_explain .= $mode == 'htaccess' ? '' : $this->check_cache_folder(SEO_CACHE_PATH);
+		$template->assign_vars(array(
+			'L_TITLE'			=> $user->lang[$display_vars['title']],
+			'L_TITLE_EXPLAIN'	=> $l_title_explain,
+
+			'S_ERROR'			=> (sizeof($error)) ? true : false,
+			'ERROR_MSG'			=> implode('<br />', $error),
+
+			'U_ACTION'			=> $this->u_action)
+		);
+		// Output relevant page
+		foreach ($display_vars['vars'] as $config_key => $vars) {
+			if (!is_array($vars) && strpos($config_key, 'legend') === false) {
+				continue;
+			}
+			if (strpos($config_key, 'legend') !== false) {
+				$template->assign_block_vars('options', array(
+					'S_LEGEND'		=> true,
+					'LEGEND'		=> (isset($user->lang[$vars])) ? $user->lang[$vars] : $vars)
+				);
+				continue;
+			}
+			$type = explode(':', $vars['type']);
+			$l_explain = '';
+			if ($vars['explain'] && isset($vars['lang_explain'])) {
+				$l_explain = (isset($user->lang[$vars['lang_explain']])) ? $user->lang[$vars['lang_explain']] : $vars['lang_explain'];
+			} elseif ($vars['explain'] && isset($vars['lang_explain_custom'])) {
+				$l_explain = $vars['lang_explain_custom'];
+			} elseif ($vars['explain']) {
+				$l_explain = (isset($user->lang[$vars['lang'] . '_EXPLAIN'])) ? $user->lang[$vars['lang'] . '_EXPLAIN'] : '';
+			}
+			$template->assign_block_vars('options', array(
+				'KEY'			=> $config_key,
+				'TITLE'			=> (isset($user->lang[$vars['lang']])) ? $user->lang[$vars['lang']] : $vars['lang'],
+				'S_EXPLAIN'		=> $vars['explain'],
+				'TITLE_EXPLAIN'	=> $l_explain,
+				'CONTENT'		=> build_cfg_template($type, $config_key, $this->new_config, $config_key, $vars),
+				)
+			);
+			unset($display_vars['vars'][$config_key]);
+		}
+	}
+	/**
+	*  forum_url_check validation
+	*/
+	function forum_url_input($value, $key) {
+		global $user, $phpbb_seo;
+
+		return '<input id="' . $key . '" type="text" size="40" maxlength="255" name="config[' . $key . ']" value="' . $value . '" /> ';
+	}
+	/**
+	*  select_string custom select string
+	*/
+	function select_string($value, $key) {
+		global $phpbb_seo;
+		$select_ary = $this->dyn_select[$key];
+		$html = '';
+		foreach ($select_ary as $sel_value) {
+			if ( @isset($this->array_type_cfg[$key]) ) {
+				$selected = ($sel_value == @$phpbb_seo->cache_config['settings'][$this->array_type_cfg[$key]['main']][$this->array_type_cfg[$key]['sub']]) ? ' selected="selected"' : '';
+				$sel_title = @isset($this->multiple_options[$this->array_type_cfg[$key]['main']][$this->array_type_cfg[$key]['sub'] . '_lang'][$sel_value]) ? $this->multiple_options[$this->array_type_cfg[$key]['main']][$this->array_type_cfg[$key]['sub'] . '_lang'][$sel_value] : $sel_value;
+			} else {
+				$selected = ($sel_value == @$phpbb_seo->cache_config['settings'][$key]) ? ' selected="selected"' : '';
+				$sel_title = @isset($this->multiple_options[$key . '_lang'][$sel_value]) ? $this->multiple_options[$key . '_lang'][$sel_value] : $sel_value;
+			}
+			$html .= '<option value="' . $sel_value . '"' . $selected . '>' . $sel_title . '</option>';
+		}
+
+		return $html;
+	}
+	/**
+	*  seo_advices Always needed :-)
+	*/
+	function seo_advices($url, $forum_id, $cached = FALSE, $error_cust = '') {
+		global $phpbb_seo, $user;
+		$seo_advice = '';
+		// Check how well is the URL SEO wise
+		if ( !empty($error_cust) ) {
+			$seo_advice .= $error_cust;
+		}
+		if (strlen($url) > $this->lengh_limit) { // Size
+			$seo_advice .= '<li>&nbsp;' . $user->lang['SEO_ADVICE_LENGTH'] . '</li>';
+		}
+		if (preg_match('`^[a-z0-9_-]+' . $phpbb_seo->seo_delim['forum'] . '[0-9]+$`i', $url)) { // With delimiter and id
+			if (@$phpbb_seo->cache_config['settings']['rem_ids']) {
+				$seo_advice .= '<li style="color:red">&nbsp;' . $user->lang['SEO_ADVICE_DELIM'] . '</li>';
+			}
+		}
+		if ($phpbb_seo->seo_static['forum'] == $url) { // default
+			$seo_advice .= '<li>&nbsp;' . $user->lang['SEO_ADVICE_DEFAULT'] . '</li>';
+		}
+		// Check the number of word
+		$url_words = explode('-', $url);
+		if (count($url_words) > $this->word_limit) {
+			$seo_advice .= '<li>&nbsp;' . $user->lang['SEO_ADVICE_WORDS'] . '</li>';
+		}
+		return '<ul  style="color:red">' . $seo_advice . '</ul>';
+	}
+	/**
+	*  seo_htaccess The evil one ;-)
+	*/
+	function seo_htaccess($html = true) {
+		global $phpbb_seo, $user, $error, $phpEx;
+		static $htaccess_code = '';
+		$htaccess_tpl = '';
+		if ( empty($htaccess_code) ) { // Only generate one .htaccess per submit (saves 338 lines)
+			$colors = array( 'color' => '<b style="color:%1$s">%2$s</b>',
+				'static' => '#A020F0',
+				'ext' => '#6A5ACD',
+				'delim' => '#FF00FF',
+			);
+			$tpl = array('paginpage' => '/?(<b style="color:#A020F0">%1$s</b>([0-9]+)<b style="color:#6A5ACD">%2$s</b>)?',
+				'pagin' => '(<b style="color:#FF00FF">%1$s</b>([0-9]+))?<b style="color:#6A5ACD">%2$s</b>',
+				'static' => sprintf($colors['color'] , $colors['static'], '%1$s'),
+				'ext' => sprintf($colors['color'] , $colors['ext'], '%1$s'),
+				'delim' => sprintf($colors['color'] , $colors['delim'], '%1$s'),
+			);
+			$modrtype = array( 1 => 'SIMPLE', 2 => 'MIXED', 1 => 'SIMPLE', 3 => 'ADVANCED', 'type' => intval($phpbb_seo->modrtype));
+			$htaccess_tpl = '<b style="color:blue"># Lines That should already be in your .htacess</b>' . "\n";
+			$htaccess_tpl .= '<b style="color:brown">&lt;Files</b> <b style="color:#FF00FF">"config.{PHP_EX}"</b><b style="color:brown">&gt;</b>' . "\n";
+			$htaccess_tpl .= 'Order Allow,Deny' . "\n";
+			$htaccess_tpl .= 'Deny from All' . "\n";
+			$htaccess_tpl .= '<b style="color:brown">&lt;/Files&gt;</b>' . "\n";
+			$htaccess_tpl .= '<b style="color:brown">&lt;Files</b> <b style="color:#FF00FF">"common.{PHP_EX}"</b><b style="color:brown">&gt;</b>' . "\n";
+			$htaccess_tpl .= 'Order Allow,Deny' . "\n";
+			$htaccess_tpl .= 'Deny from All' . "\n";
+			$htaccess_tpl .= '<b style="color:brown">&lt;/Files&gt;</b>' . "\n\n";
+			$htaccess_tpl .= '<b style="color:blue"># You may need to un-comment the following line' . "\n";
+			$htaccess_tpl .= '# Options +FollowSymlinks' . "\n";
+			$htaccess_tpl .= '# REMEBER YOU ONLY NEED TO STARD MOD REWRITE ONCE</b> </b>' . "\n";
+			$htaccess_tpl .= '<b style="color:green">RewriteEngine</b> <b style="color:#FF00FF">On</b>' . "\n";
+			$htaccess_tpl .= '<b style="color:blue"># REWRITE BASE</b>' . "\n";
+			$htaccess_tpl .= '<b style="color:green">RewriteBase</b> <b>/{REWRITEBASE}</b>' . "\n";
+			$htaccess_tpl .= '<b style="color:blue"># HERE IS A GOOD PLACE TO ADD THE WWW PREFIXE REDIRECTION</b>' . "\n\n";
+			$htaccess_tpl .= '<b style="color:blue">#####################################################' . "\n";
+			$htaccess_tpl .= '# PHPBB SEO REWRITE RULES - {MOD_RTYPE}' . "\n";
+			$htaccess_tpl .= '#####################################################' . "\n";
+			$htaccess_tpl .= '# AUTHOR : dcz www.phpbb-seo.com' . "\n";
+			$htaccess_tpl .= '# STARTED : 01/2006' . "\n";
+			$htaccess_tpl .= '#################################' . "\n";
+			$htaccess_tpl .= '# FORUMS PAGES' . "\n";
+			$htaccess_tpl .= '###############</b>' . "\n";
+			if (!empty($phpbb_seo->seo_static['index'])){
+				$htaccess_tpl .= '<b style="color:blue"># FORUM INDEX</b>' . "\n";
+				$htaccess_tpl .= '<b style="color:green">RewriteRule</b> ^{WIERD_SLASH}{PHPBB_LPATH}{STATIC_INDEX}{EXT_INDEX}$ {DEFAULT_SLASH}{PHPBB_RPATH}index.{PHP_EX} [QSA,L,NC]' . "\n";
+			} else {
+				$htaccess_tpl .= '<b style="color:blue"># FORUM INDEX REWRITERULE WOULD STAND HERE IF USED. \'forum\' REQUIRES TO BE SET AS FORUM INDEX' . "\n";
+				$htaccess_tpl .= '# RewriteRule ^{WIERD_SLASH}{PHPBB_LPATH}<b style="color:#A020F0">forum</b>\.<b style="color:#6A5ACD">html</b>$ {DEFAULT_SLASH}{PHPBB_RPATH}index.{PHP_EX} [QSA,L,NC]</b>' . "\n";
+			}
+			$htaccess_common_tpl = '';
+			if ( $phpbb_seo->seo_opt['profile_noids'] ) {
+				$htaccess_common_tpl .= '<b style="color:blue"># PROFILES THROUGH USERNAME</b>' . "\n";
+				$htaccess_common_tpl .= '<b style="color:green">RewriteRule</b> ^{WIERD_SLASH}{PHPBB_LPATH}{STATIC_MEMBERS}/([^/]+)/?$ {DEFAULT_SLASH}{PHPBB_RPATH}memberlist.{PHP_EX}?mode=viewprofile&un=$1 [QSA,L,NC]' . "\n";
+				$htaccess_common_tpl .= '<b style="color:blue"># USER MESSAGES THROUGH USERNAME</b>' . "\n";
+				$htaccess_common_tpl .= '<b style="color:green">RewriteRule</b> ^{WIERD_SLASH}{PHPBB_LPATH}{STATIC_MEMBERS}/([^/]+)/(topics|posts){USERMSG_PAGINATION}$ {DEFAULT_SLASH}{PHPBB_RPATH}search.{PHP_EX}?author=$1&sr=$2&start=$4 [QSA,L,NC]' . "\n";
+			} elseif ( $phpbb_seo->seo_opt['profile_inj'] ) {
+				$htaccess_common_tpl .= '<b style="color:blue"># PROFILES ADVANCED</b>' . "\n";
+				$htaccess_common_tpl .= '<b style="color:green">RewriteRule</b> ^{WIERD_SLASH}{PHPBB_LPATH}[a-z0-9_-]*{DELIM_MEMBERS}([0-9]+){EXT_MEMBERS}$ {DEFAULT_SLASH}{PHPBB_RPATH}memberlist.{PHP_EX}?mode=viewprofile&u=$1 [QSA,L,NC]' . "\n";
+				$htaccess_common_tpl .= '<b style="color:blue"># USER MESSAGES ADVANCED</b>' . "\n";
+				$htaccess_common_tpl .= '<b style="color:green">RewriteRule</b> ^{WIERD_SLASH}{PHPBB_LPATH}[a-z0-9_-]*{DELIM_MEMBERS}([0-9]+){DELIM_SR}(topics|posts){USERMSG_PAGINATION}$ {DEFAULT_SLASH}{PHPBB_RPATH}search.{PHP_EX}?author_id=$1&sr=$2&start=$4 [QSA,L,NC]' . "\n";
+			} else {
+				$htaccess_common_tpl .= '<b style="color:blue"># PROFILES SIMPLE</b>' . "\n";
+				$htaccess_common_tpl .= '<b style="color:green">RewriteRule</b> ^{WIERD_SLASH}{PHPBB_LPATH}{STATIC_MEMBERS}([0-9]+){EXT_MEMBERS}$ {DEFAULT_SLASH}{PHPBB_RPATH}memberlist.{PHP_EX}?mode=viewprofile&u=$1 [QSA,L,NC]' . "\n";
+				$htaccess_common_tpl .= '<b style="color:blue"># USER MESSAGES SIMPLE</b>' . "\n";
+				$htaccess_common_tpl .= '<b style="color:green">RewriteRule</b> ^{WIERD_SLASH}{PHPBB_LPATH}{STATIC_MEMBERS}([0-9]+){DELIM_SR}(topics|posts){USERMSG_PAGINATION}$ {DEFAULT_SLASH}{PHPBB_RPATH}search.{PHP_EX}?author_id=$1&sr=$2&start=$4 [QSA,L,NC]' . "\n";
+			}
+			if ( $phpbb_seo->seo_opt['profile_inj'] ) {
+				$htaccess_common_tpl .= '<b style="color:blue"># GROUPS ADVANCED</b>' . "\n";
+				$htaccess_common_tpl .= '<b style="color:green">RewriteRule</b> ^{WIERD_SLASH}{PHPBB_LPATH}[a-z0-9_-]*{DELIM_GROUPS}([0-9]+){GROUP_PAGINATION}$ {DEFAULT_SLASH}{PHPBB_RPATH}memberlist.{PHP_EX}?mode=group&g=$1&start=$3 [QSA,L,NC]' . "\n";
+			} else {
+				$htaccess_common_tpl .= '<b style="color:blue"># GROUPS SIMPLE</b>' . "\n";
+				$htaccess_common_tpl .= '<b style="color:green">RewriteRule</b> ^{WIERD_SLASH}{PHPBB_LPATH}{STATIC_GROUPS}([0-9]+){GROUP_PAGINATION}$ {DEFAULT_SLASH}{PHPBB_RPATH}memberlist.{PHP_EX}?mode=group&g=$1&start=$3 [QSA,L,NC]' . "\n";
+			}
+			$htaccess_common_tpl .= '<b style="color:blue"># POST</b>' . "\n";
+			$htaccess_common_tpl .= '<b style="color:green">RewriteRule</b> ^{WIERD_SLASH}{PHPBB_LPATH}{STATIC_POST}([0-9]+){EXT_ATOPIC}$ {DEFAULT_SLASH}{PHPBB_RPATH}viewtopic.{PHP_EX}?p=$1 [QSA,L,NC]' . "\n";
+			$htaccess_common_tpl .= '<b style="color:blue"># ACTIVE TOPICS</b>' . "\n";
+			$htaccess_common_tpl .= '<b style="color:green">RewriteRule</b> ^{WIERD_SLASH}{PHPBB_LPATH}{STATIC_ATOPIC}{ATOPIC_PAGINATION}$ {DEFAULT_SLASH}{PHPBB_RPATH}search.{PHP_EX}?search_id=active_topics&start=$2&sr=topics [QSA,L,NC]' . "\n";
+			$htaccess_common_tpl .= '<b style="color:blue"># UNANSWERED TOPICS</b>' . "\n";
+			$htaccess_common_tpl .= '<b style="color:green">RewriteRule</b> ^{WIERD_SLASH}{PHPBB_LPATH}{STATIC_UTOPIC}{UTOPIC_PAGINATION}$ {DEFAULT_SLASH}{PHPBB_RPATH}search.{PHP_EX}?search_id=unanswered&start=$2&sr=topics [QSA,L,NC]' . "\n";
+			$htaccess_common_tpl .= '<b style="color:blue"># NEW POSTS</b>' . "\n";
+			$htaccess_common_tpl .= '<b style="color:green">RewriteRule</b> ^{WIERD_SLASH}{PHPBB_LPATH}{STATIC_NPOST}{NPOST_PAGINATION}$ {DEFAULT_SLASH}{PHPBB_RPATH}search.{PHP_EX}?search_id=newposts&start=$2&sr=topics [QSA,L,NC]' . "\n";
+			$htaccess_common_tpl .= '<b style="color:blue"># THE TEAM</b>' . "\n";
+			$htaccess_common_tpl .= '<b style="color:green">RewriteRule</b> ^{WIERD_SLASH}{PHPBB_LPATH}{STATIC_TEAM}{EXT_TEAM}$ {DEFAULT_SLASH}{PHPBB_RPATH}memberlist.{PHP_EX}?mode=leaders [QSA,L,NC]' . "\n";
+			if ($modrtype['type'] == 3) { // Advanced
+				$htaccess_tpl .= '<b style="color:blue"># FORUM</b>' . "\n";
+				$htaccess_tpl .= '<b style="color:green">RewriteRule</b> ^{WIERD_SLASH}{PHPBB_LPATH}[a-z0-9_-]*{DELIM_FORUM}([0-9]+){FORUM_PAGINATION}$ {DEFAULT_SLASH}{PHPBB_RPATH}viewforum.{PHP_EX}?f=$1&start=$3 [QSA,L,NC]' . "\n";
+				$htaccess_tpl .= '<b style="color:blue"># TOPIC WITH VIRTUAL FOLDER</b>' . "\n";
+				$htaccess_tpl .= '<b style="color:green">RewriteRule</b> ^{WIERD_SLASH}{PHPBB_LPATH}[a-z0-9_-]*{DELIM_FORUM}([0-9]+)/[a-z0-9_-]*{DELIM_TOPIC}([0-9]+){TOPIC_PAGINATION}$ {DEFAULT_SLASH}{PHPBB_RPATH}viewtopic.{PHP_EX}?f=$1&t=$2&start=$4 [QSA,L,NC]' . "\n";
+				$htaccess_tpl .= '<b style="color:blue"># GLOBAL ANNOUNCES WITH VIRTUAL FOLDER</b>' . "\n";
+				$htaccess_tpl .= '<b style="color:green">RewriteRule</b> ^{WIERD_SLASH}{PHPBB_LPATH}{STATIC_ANNOUNCES}{EXT_ANNOUNCES}[a-z0-9_-]*{DELIM_TOPIC}([0-9]+){TOPIC_PAGINATION}$ {DEFAULT_SLASH}{PHPBB_RPATH}viewtopic.{PHP_EX}?t=$1&start=$3 [QSA,L,NC]' . "\n";
+				$htaccess_tpl .= '<b style="color:blue"># TOPIC WITHOUT FORUM ID & DELIM</b>' . "\n";
+				$htaccess_tpl .= '<b style="color:green">RewriteRule</b> ^{WIERD_SLASH}{PHPBB_LPATH}([a-z0-9_-]*)/?[a-z0-9_-]*{DELIM_TOPIC}([0-9]+){TOPIC_PAGINATION}$ {DEFAULT_SLASH}{PHPBB_RPATH}viewtopic.{PHP_EX}?forum_uri=$1&t=$2&start=$4 [QSA,L,NC]' . "\n";
+				$htaccess_tpl .= $htaccess_common_tpl . '<b style="color:blue"># HERE IS A GOOD PLACE TO ADD OTHER PHPBB RELATED REWRITERULES</b>' . "\n\n";
+				$htaccess_tpl .= '<b style="color:blue"># FORUM WITHOUT ID & DELIM</b>' . "\n";
+				$htaccess_tpl .= '<b style="color:blue"># THESE FOUR LINES MUST BE LOCATED AT THE END OF YOUR HTACCESS TO WORK PROPERLY</b>' . "\n";
+				$htaccess_tpl .= '<b style="color:green">RewriteCond</b> %{REQUEST_FILENAME} !-f' . "\n";
+				$htaccess_tpl .= '<b style="color:green">RewriteCond</b> %{REQUEST_FILENAME} !-d' . "\n";
+				$htaccess_tpl .= '<b style="color:green">RewriteCond</b> %{REQUEST_FILENAME} !-l' . "\n";
+				$htaccess_tpl .= '<b style="color:green">RewriteRule</b> ^{WIERD_SLASH}{PHPBB_LPATH}([a-z0-9_-]+){FORUM_PAGINATION}$ {DEFAULT_SLASH}{PHPBB_RPATH}viewforum.{PHP_EX}?forum_uri=$1&start=$3 [QSA,L,NC]' . "\n";
+			} elseif ($modrtype['type'] == 2) { // Mixed
+				$htaccess_tpl .= '<b style="color:blue"># FORUM</b>' . "\n";
+				$htaccess_tpl .= '<b style="color:green">RewriteRule</b> ^{WIERD_SLASH}{PHPBB_LPATH}[a-z0-9_-]*{DELIM_FORUM}([0-9]+){FORUM_PAGINATION}$ {DEFAULT_SLASH}{PHPBB_RPATH}viewforum.{PHP_EX}?f=$1&start=$3 [QSA,L,NC]' . "\n";
+				$htaccess_tpl .= '<b style="color:blue"># TOPIC WITH VIRTUAL FOLDER</b>' . "\n";
+				$htaccess_tpl .= '<b style="color:green">RewriteRule</b> ^{WIERD_SLASH}{PHPBB_LPATH}[a-z0-9_-]*{DELIM_FORUM}([0-9]+)/{STATIC_TOPIC}([0-9]+){TOPIC_PAGINATION}$ {DEFAULT_SLASH}{PHPBB_RPATH}viewtopic.{PHP_EX}?f=$1&t=$2&start=$4 [QSA,L,NC]' . "\n";
+				$htaccess_tpl .= '<b style="color:blue"># GLOBAL ANNOUNCES WITH VIRTUAL FOLDER</b>' . "\n";
+				$htaccess_tpl .= '<b style="color:green">RewriteRule</b> ^{WIERD_SLASH}{PHPBB_LPATH}{STATIC_ANNOUNCES}{EXT_ANNOUNCES}{STATIC_TOPIC}([0-9]+){TOPIC_PAGINATION}$ {DEFAULT_SLASH}{PHPBB_RPATH}viewtopic.{PHP_EX}?t=$1&start=$3 [QSA,L,NC]' . "\n";
+				$htaccess_tpl .= '<b style="color:blue"># TOPIC WITHOUT FORUM ID & DELIM</b>' . "\n";
+				$htaccess_tpl .= '<b style="color:green">RewriteRule</b> ^{WIERD_SLASH}{PHPBB_LPATH}([a-z0-9_-]*)/?{STATIC_TOPIC}([0-9]+){TOPIC_PAGINATION}$ {DEFAULT_SLASH}{PHPBB_RPATH}viewtopic.{PHP_EX}?forum_uri=$1&t=$2&start=$4 [QSA,L,NC]' . "\n";
+				$htaccess_tpl .= $htaccess_common_tpl . '<b style="color:blue"># HERE IS A GOOD PLACE TO ADD OTHER PHPBB RELATED REWRITERULES</b>' . "\n\n";
+				$htaccess_tpl .= '<b style="color:blue"># FORUM WITHOUT ID & DELIM</b>' . "\n";
+				$htaccess_tpl .= '<b style="color:blue"># THESE FOUR LINES MUST BE LOCATED AT THE END OF YOUR HTACCESS TO WORK PROPERLY</b>' . "\n";
+				$htaccess_tpl .= '<b style="color:green">RewriteCond</b> %{REQUEST_FILENAME} !-f' . "\n";
+				$htaccess_tpl .= '<b style="color:green">RewriteCond</b> %{REQUEST_FILENAME} !-d' . "\n";
+				$htaccess_tpl .= '<b style="color:green">RewriteCond</b> %{REQUEST_FILENAME} !-l' . "\n";
+				$htaccess_tpl .= '<b style="color:green">RewriteRule</b> ^{WIERD_SLASH}{PHPBB_LPATH}([a-z0-9_-]+){FORUM_PAGINATION}$ {DEFAULT_SLASH}{PHPBB_RPATH}viewforum.{PHP_EX}?forum_uri=$1&start=$3 [QSA,L,NC]' . "\n";
+			} elseif ($modrtype['type'] == 1) { // Simple
+				$htaccess_tpl .= '<b style="color:blue"># FORUM</b>' . "\n";
+				$htaccess_tpl .= '<b style="color:green">RewriteRule</b> ^{WIERD_SLASH}{PHPBB_LPATH}{STATIC_FORUM}([0-9]+){FORUM_PAGINATION}$ {DEFAULT_SLASH}{PHPBB_RPATH}viewforum.{PHP_EX}?f=$1&start=$3 [QSA,L,NC]' . "\n";
+				$htaccess_tpl .= '<b style="color:blue"># TOPIC WITH VIRTUAL FOLDER</b>' . "\n";
+				$htaccess_tpl .= '<b style="color:green">RewriteRule</b> ^{WIERD_SLASH}{PHPBB_LPATH}{STATIC_FORUM}([0-9]+)/{STATIC_TOPIC}([0-9]+){TOPIC_PAGINATION}$ {DEFAULT_SLASH}{PHPBB_RPATH}viewtopic.{PHP_EX}?f=$1&t=$2&start=$4 [QSA,L,NC]' . "\n";
+				$htaccess_tpl .= '<b style="color:blue"># GLOBAL ANNOUNCES WITH VIRTUAL FOLDER</b>' . "\n";
+				$htaccess_tpl .= '<b style="color:green">RewriteRule</b> ^{WIERD_SLASH}{PHPBB_LPATH}{STATIC_ANNOUNCES}{EXT_ANNOUNCES}{STATIC_TOPIC}([0-9]+){TOPIC_PAGINATION}$ {DEFAULT_SLASH}{PHPBB_RPATH}viewtopic.{PHP_EX}?t=$1&start=$3 [QSA,L,NC]' . "\n";
+				$htaccess_tpl .= '<b style="color:blue"># TOPIC WITHOUT FORUM ID & DELIM</b>' . "\n";
+				$htaccess_tpl .= '<b style="color:green">RewriteRule</b> ^{WIERD_SLASH}{PHPBB_LPATH}[a-z0-9_-]*/?{STATIC_TOPIC}([0-9]+){TOPIC_PAGINATION}$ {DEFAULT_SLASH}{PHPBB_RPATH}viewtopic.{PHP_EX}?t=$1&start=$3 [QSA,L,NC]' . "\n";
+				$htaccess_tpl .= $htaccess_common_tpl . '<b style="color:blue"># HERE IS A GOOD PLACE TO ADD OTHER PHPBB RELATED REWRITERULES</b>' . "\n\n";
+			} else { // error
+				$error[] = $user->lang['SEO_MOD_TYPE_ER'];
+				return;
+			}
+			$htaccess_tpl .= '<b style="color:blue"># END PHPBB PAGES' . "\n";
+			$htaccess_tpl .= '#####################################################</b>' . "\n";
+			$default_slash = '/';
+			$wierd_slash = '';
+			$phpbb_path = trim($phpbb_seo->seo_path['phpbb_script'], '/');
+			$show_rewritebase_opt = false;
+			$rewritebase = '';
+			$wierd_slash = $this->new_config['wslash'] ? '<b style="color:red">/</b>' : '';
+			$default_slash = $this->new_config['slash'] ? '' : '/';
+			if (!empty($phpbb_path )) {
+				$phpbb_path = $phpbb_path . '/';
+				if ($this->new_config['rbase']) {
+					$rewritebase = $phpbb_path;
+					$default_slash = $this->new_config['slash'] ? '/' : '';
+				}
+				$rewritebase = $this->new_config['rbase'] ? $phpbb_path : '';
+				$show_rewritebase_opt = $phpbb_seo->seo_opt['virtual_root'] ? false : true;
+			}
+			if (!empty($default_slash) && $this->new_config['more_options']) {
+				$default_slash = '<b style="color:red">' . $default_slash . '</b>';
+			}
+			// handle the suffixes proper in the RegEx
+			$seo_ext = array();
+			foreach ( $phpbb_seo->seo_ext as $type => $value) {
+				$seo_ext[$type] = str_replace('.', '\.', $value);
+			}
+			$reg_ex_page = sprintf($tpl['paginpage'], $phpbb_seo->seo_static['pagination'], $seo_ext['pagination']);
+			if ($phpbb_seo->seo_opt['virtual_folder'] || $phpbb_seo->seo_ext['forum'] === '/') {
+				$reg_ex_fpage = $reg_ex_page;
+			} else {
+				$reg_ex_fpage = sprintf($tpl['pagin'], $phpbb_seo->seo_delim['start'], $seo_ext['forum']);
+			}
+			if ($phpbb_seo->seo_ext['topic'] === '/') {
+				$reg_ex_tpage = $reg_ex_page;
+			} else {
+				$reg_ex_tpage = sprintf($tpl['pagin'], $phpbb_seo->seo_delim['start'], $seo_ext['topic']);
+			}
+			if ($phpbb_seo->seo_ext['atopic'] === '/') {
+				$reg_ex_atpage = $reg_ex_page;
+			} else {
+				$reg_ex_atpage = sprintf($tpl['pagin'], $phpbb_seo->seo_delim['start'], $seo_ext['atopic']);
+			}
+			if ($phpbb_seo->seo_ext['utopic'] === '/') {
+				$reg_ex_utpage = $reg_ex_page;
+			} else {
+				$reg_ex_utpage = sprintf($tpl['pagin'], $phpbb_seo->seo_delim['start'], $seo_ext['utopic']);
+			}
+			if ($phpbb_seo->seo_ext['npost'] === '/') {
+				$reg_ex_nppage = $reg_ex_page;
+			} else {
+				$reg_ex_nppage = sprintf($tpl['pagin'], $phpbb_seo->seo_delim['start'], $seo_ext['npost']);
+			}
+			if ($phpbb_seo->seo_ext['group'] === '/') {
+				$reg_ex_gpage = $reg_ex_page;
+			} else {
+				$reg_ex_gpage = sprintf($tpl['pagin'], $phpbb_seo->seo_delim['start'], $seo_ext['group']);
+			}
+			if ($phpbb_seo->seo_ext['user'] === '/') {
+				$reg_ex_umpage = $reg_ex_page;
+			} else {
+				$reg_ex_umpage = sprintf($tpl['pagin'], $phpbb_seo->seo_delim['start'], $seo_ext['user']);
+			}
+			// Load the .htaccess vars
+			$htaccess_tpl_vars = array(
+				'{REWRITEBASE}' => $rewritebase,
+				'{PHP_EX}' => $phpEx,
+				'{PHPBB_LPATH}' => ($this->new_config['rbase'] || $phpbb_seo->seo_opt['virtual_root']) ? '' : $phpbb_path, 
+				'{PHPBB_RPATH}' => $this->new_config['rbase'] ? '' : $phpbb_path, 
+				'{STATIC_INDEX}' => sprintf($tpl['static'] , $phpbb_seo->seo_static['index']),
+				'{STATIC_FORUM}' => sprintf($tpl['static'] , $phpbb_seo->seo_static['forum']),
+				'{STATIC_TOPIC}' => sprintf($tpl['static'] , $phpbb_seo->seo_static['topic']),
+				'{STATIC_POST}' => sprintf($tpl['static'] , $phpbb_seo->seo_static['post']),
+				'{STATIC_ATOPIC}' => sprintf($tpl['static'] , $phpbb_seo->seo_static['atopic']),
+				'{STATIC_UTOPIC}' => sprintf($tpl['static'] , $phpbb_seo->seo_static['utopic']),
+				'{STATIC_NPOST}' => sprintf($tpl['static'] , $phpbb_seo->seo_static['npost']),
+				'{STATIC_MEMBERS}' => sprintf($tpl['static'] , $phpbb_seo->seo_static['user']),
+				'{STATIC_GROUPS}' => sprintf($tpl['static'] , $phpbb_seo->seo_static['group']),
+				'{STATIC_ANNOUNCES}' => sprintf($tpl['static'] , $phpbb_seo->seo_static['global_announce']),
+				'{STATIC_TEAM}' => sprintf($tpl['static'] , $phpbb_seo->seo_static['leaders']),
+     		  		'{EXT_INDEX}' => sprintf($tpl['static'] , $seo_ext['index']),
+				'{EXT_FORUM}' => sprintf($tpl['static'] , $seo_ext['forum']),
+				'{EXT_TOPIC}' => sprintf($tpl['static'] , $seo_ext['topic']),
+				'{EXT_ATOPIC}' => sprintf($tpl['static'] , $seo_ext['atopic']),
+				'{EXT_UTOPIC}' => sprintf($tpl['static'] , $seo_ext['utopic']),
+				'{EXT_POST}' => sprintf($tpl['static'] , $seo_ext['post']),
+				'{EXT_MEMBERS}' => sprintf($tpl['static'] , $seo_ext['user']),
+				'{EXT_GROUPS}' => sprintf($tpl['static'] , $seo_ext['group']),
+				'{EXT_ANNOUNCES}' => sprintf($tpl['static'] , $seo_ext['global_announce']),
+				'{EXT_TEAM}' => sprintf($tpl['static'] , $seo_ext['leaders']),
+				'{DELIM_FORUM}' => sprintf($tpl['delim'] , $phpbb_seo->seo_delim['forum']),
+				'{DELIM_TOPIC}' => sprintf($tpl['delim'] , $phpbb_seo->seo_delim['topic']),
+				'{DELIM_MEMBERS}' => sprintf($tpl['delim'] , $phpbb_seo->seo_delim['user']),
+				'{DELIM_GROUPS}' => sprintf($tpl['delim'] , $phpbb_seo->seo_delim['group']),
+				'{DELIM_START}' => sprintf($tpl['delim'] , $phpbb_seo->seo_delim['start']),
+				'{DELIM_SR}' => sprintf($tpl['delim'] , $phpbb_seo->seo_delim['sr']),
+				'{FORUM_PAGINATION}' => $reg_ex_fpage,
+				'{TOPIC_PAGINATION}' => $reg_ex_tpage,
+				'{ATOPIC_PAGINATION}' => $reg_ex_atpage,
+				'{UTOPIC_PAGINATION}' => $reg_ex_utpage,
+				'{NPOST_PAGINATION}' => $reg_ex_nppage,
+				'{USERMSG_PAGINATION}' => $reg_ex_umpage,
+				'{GROUP_PAGINATION}' => $reg_ex_gpage,
+				'{DEFAULT_SLASH}' => $default_slash,
+				'{WIERD_SLASH}' => $wierd_slash,
+				'{MOD_RTYPE}' => $modrtype[$modrtype['type']],
+			);
+			// Parse .htaccess
+			$htaccess_code = str_replace(array_keys($htaccess_tpl_vars), array_values($htaccess_tpl_vars), $htaccess_tpl);
+		} // else the .htaccess is already generated
+		if ( $html ) { // HTML output
+			$htaccess_output = "\n" . '<script type="text/javascript">' . "\n";
+			$htaccess_output .= '<!--' . "\n";
+			$htaccess_output .= 'function selectCode(a) {' . "\n";
+			$htaccess_output .= "\t" . 'var e = a.parentNode.parentNode.getElementsByTagName(\'CODE\')[0]; // Get ID of code block' . "\n";
+			$htaccess_output .= "\t" . 'if (window.getSelection) { // Not IE' . "\n";
+			$htaccess_output .= "\t\t" . 'var s = window.getSelection();' . "\n";
+			$htaccess_output .= "\t\t" . 'if (s.setBaseAndExtent) { // Safari' . "\n";
+			$htaccess_output .= "\t\t\t" . 's.setBaseAndExtent(e, 0, e, e.innerText.length - 1);' . "\n";
+			$htaccess_output .= "\t\t" . '} else { // Firefox and Opera' . "\n";
+			$htaccess_output .= "\t\t\t" . 'var r = document.createRange();' . "\n";
+			$htaccess_output .= "\t\t\t" . 'r.selectNodeContents(e);' . "\n";
+			$htaccess_output .= "\t\t\t" . 's.removeAllRanges();' . "\n";
+			$htaccess_output .= "\t\t\t" . 's.addRange(r);' . "\n";
+			$htaccess_output .= "\t\t" . '}' . "\n";
+			$htaccess_output .= "\t" . '} else if (document.getSelection) { // Some older browsers' . "\n";
+			$htaccess_output .= "\t\t" . 'var s = document.getSelection();' . "\n";
+			$htaccess_output .= "\t\t" . 'var r = document.createRange();' . "\n";
+			$htaccess_output .= "\t\t" . 'r.selectNodeContents(e);' . "\n";
+			$htaccess_output .= "\t\t" . 's.removeAllRanges();' . "\n";
+			$htaccess_output .= "\t\t" . 's.addRange(r);' . "\n";
+			$htaccess_output .= "\t" . '} else if (document.selection) { // IE' . "\n";
+			$htaccess_output .= "\t\t" . 'var r = document.body.createTextRange();' . "\n";
+			$htaccess_output .= "\t\t" . 'r.moveToElementText(e);' . "\n";
+			$htaccess_output .= "\t\t" . 'r.select();' . "\n";
+			$htaccess_output .= "\t" . '}' . "\n";
+			$htaccess_output .= '}' . "\n";
+			$htaccess_output .= '//-->' . "\n";
+			$htaccess_output .= '</script>' . "\n";
+			$htaccess_output .= '<hr/><div class="content">' . "\n" . '<b style="color:red">&rArr;&nbsp;' . (($show_rewritebase_opt && $this->new_config['rbase']) ? $user->lang['SEO_HTACCESS_FOLDER_MSG'] : $user->lang['SEO_HTACCESS_ROOT_MSG']) . '</b><br/><br/><hr/>' . "\n";
+			$htaccess_output .= '<b>. htaccess :&nbsp;<a href="#" onclick="dE(\'htaccess_code\',1); return false;">' . $user->lang['SEO_SHOW'] . '</a>&nbsp;/&nbsp;<a href="#" onclick="dE(\'htaccess_code\',-1); return false;">' . $user->lang['SEO_HIDE'] . '</a></b>' . "\n";
+			$htaccess_output .= '<div id="htaccess_code"><dl style="padding:5px;background-color:#FFFFFF;border:1px solid #d8d8d8;font-size:12px;"><dt style="border-bottom:1px solid #CCCCCC;margin-bottom:3px;font-weight:bold;display:block;">&nbsp;<a href="#" onclick="selectCode(this); return false;">' . $user->lang['SEO_SELECT_ALL'] . '</a></dt>' . "\n";
+			$htaccess_output .= '<dd ><code style="padding-top:5px;font:Monaco,Courier,mono;line-height:1.3em;color:#8b8b8b;font-weight:bold"><br/><br/>' . str_replace( "\n", '<br/>', $htaccess_code) . '</code></dd>' . "\n";
+			$htaccess_output .= '</dl>' . "\n";
+			$htaccess_output .= '<dl style="padding:5px;margin-top:10px;background-color:#FFFFFF;border:1px solid #d8d8d8;font-size:12px;"><br/><b>' . $user->lang['SEO_HTACCESS_CAPTION'] . ':</b><ul style="margin-left:30px;margin-top:10px;font-weight:bold;font-size:12px;">' . "\n";
+			$htaccess_output .= '<li style="color:blue">&nbsp;' . $user->lang['SEO_HTACCESS_CAPTION_COMMENT'] . '</li><br/>' . "\n";
+			$htaccess_output .= '<li style="color:#A020F0">&nbsp;' . $user->lang['SEO_HTACCESS_CAPTION_STATIC'] . '</li><br/>' . "\n";
+			$htaccess_output .= '<li style="color:#6A5ACD">&nbsp;' . $user->lang['SEO_HTACCESS_CAPTION_SUFFIX'] . '</li><br/>' . "\n";	
+			$htaccess_output .= '<li style="color:#FF00FF">&nbsp;' . $user->lang['SEO_HTACCESS_CAPTION_DELIM'] . '</li><br/>' . "\n";
+			if ($this->new_config['more_options']) {
+				$htaccess_output .= '<li style="color:red">&nbsp;' . $user->lang['SEO_HTACCESS_CAPTION_SLASH'] . '</li>&nbsp;' . "\n";
+			}
+			$htaccess_output .= '</ul></dl>' . "\n" . '</div></div>' . "\n";
+		} else { // File output
+			$htaccess_output = str_replace(array('&lt;', '&gt;'), array('<', '>'), strip_tags($htaccess_code));
+		}
+		return $htaccess_output;
+	}
+	/**
+	*  set_phpbb_seo_links Builds links to support threads
+	*/
+	function set_phpbb_seo_links() {
+		global $user, $phpbb_seo, $config;
+		$modrtype_lang = array();
+		$phpbb_seo->version = htmlspecialchars($phpbb_seo->version);
+		$phpbb_seo->modrtype = intval($phpbb_seo->modrtype);
+		if ($phpbb_seo->modrtype < 1 || $phpbb_seo->modrtype > 3) {
+			$phpbb_seo->modrtype = 1;
+		}
+		$modrtype_lang['titles'] = array( 1 => $user->lang['ACP_SEO_SIMPLE'], 2 =>  $user->lang['ACP_SEO_MIXED'], 3 =>  $user->lang['ACP_SEO_ADVANCED']);
+		$modrtype_lang['title'] = $modrtype_lang['titles'][$phpbb_seo->modrtype];
+		$modrtype_lang['types'] = array( 1 => 'SIMPLE', 2 => 'MIXED', 1 => 'SIMPLE', 3 => 'ADVANCED');
+		$modrtype_lang['type'] = $modrtype_lang['types'][$phpbb_seo->modrtype];
+		$modrtype_lang['modrlinks_en'] = array( 1 =>  'http://www.phpbb-seo.com/boards/simple-seo-url/simple-phpbb3-seo-url-vt1566.html', 2 =>  'http://www.phpbb-seo.com/boards/mixed-seo-url/mixed-phpbb3-seo-url-vt1565.html', 3 =>  'http://www.phpbb-seo.com/boards/advanced-seo-url/advanced-phpbb3-seo-url-vt1219.html' );
+		$modrtype_lang['modrlinks_fr'] = array( 1 =>  'http://www.phpbb-seo.com/forums/reecriture-url-simple/seo-url-phpbb3-simple-vt1945.html', 2 =>  'http://www.phpbb-seo.com/forums/reecriture-url-intermediaire/seo-url-intermediaire-vt1946.html', 3 =>  'http://www.phpbb-seo.com/forums/reecriture-url-avancee/seo-url-phpbb3-avance-vt1501.html' );
+		$modrtype_lang['modrforumlinks_en'] = array( 1 =>  'http://www.phpbb-seo.com/boards/simple-seo-url-vf60/', 2 =>  'http://www.phpbb-seo.com/boards/mixed-seo-url-vf59/', 3 =>  'http://www.phpbb-seo.com/boards/advanced-seo-url-vf54/' );
+		$modrtype_lang['modrforumlinks_fr'] = array( 1 =>  'http://www.phpbb-seo.com/forums/reecriture-url-simple-vf63/', 2 =>  'http://www.phpbb-seo.com/forums/reecriture-url-intermediaire-vf62/', 3 =>  'http://www.phpbb-seo.com/forums/reecriture-url-avancee-vf56/' );
+		if (strpos($config['default_lang'], 'fr') !== false ) {
+			$modrtype_lang['linkurl'] = $modrtype_lang['modrlinks_fr'][$phpbb_seo->modrtype];
+			$modrtype_lang['forumlinkurl'] = $modrtype_lang['modrforumlinks_fr'][$phpbb_seo->modrtype];
+		} else {
+			$modrtype_lang['linkurl'] = $modrtype_lang['modrlinks_en'][$phpbb_seo->modrtype];
+			$modrtype_lang['forumlinkurl'] = $modrtype_lang['modrforumlinks_en'][$phpbb_seo->modrtype];
+		}
+		$modrtype_lang['link'] = '<a href="' . $modrtype_lang['linkurl'] . '" title="' . $user->lang['ACP_PHPBB_SEO_VERSION'] . ' ' . $modrtype_lang['title'] . '" target="_phpBBSEO"><b>' . $modrtype_lang['title'] . '</b></a>';
+		$modrtype_lang['forumlink'] = '<a href="' . $modrtype_lang['forumlinkurl'] . '" title="' . $user->lang['ACP_SEO_SUPPORT_FORUM'] . '" target="_phpBBSEO"><b>' . $user->lang['ACP_SEO_SUPPORT_FORUM'] . '</b></a>';
+		return $modrtype_lang;
+	}
+	/**
+	*  check_cache_folder Validates the cache folder status
+	*/
+	function check_cache_folder($cache_dir, $msg = TRUE) {
+		global $user;
+		$exists = $write = FALSE;
+		$cache_msg = '';
+		if (file_exists($cache_dir) && is_dir($cache_dir)) {
+			$exists = TRUE;
+			if (!is_writeable($cache_dir)) {
+				@chmod($cache_dir, 0777);
+					$fp = @fopen($cache_dir . 'test_lock', 'wb');
+					if ($fp !== false) {
+						$write = true;
+					}
+					@fclose($fp);
+					@unlink($phpbb_root_path . $dir . 'test_lock');
+			} else {
+				$write = true;
+			}
+		}
+		if ($msg) {
+			$exists = ($exists) ? '<b style="color:green">' . $user->lang['SEO_CACHE_FOUND'] . '</b>' : '<b style="color:red">' . $user->lang['SEO_CACHE_NOT_FOUND'] . '</b>';
+			$write = ($write) ? '<br/> <b style="color:green">' . $user->lang['SEO_CACHE_WRITABLE'] . '</b>' : (($exists) ? '<br/> <b style="color:red">' . $user->lang['SEO_CACHE_UNWRITABLE'] . '</b>' : '');
+			$cache_msg = sprintf($user->lang['SEO_CACHE_STATUS'], $cache_dir) . '<br/>' . $exists . $write;
+			return '<br/><br/><b>' . $user->lang['SEO_CACHE_FILE_TITLE'] . ':</b><ul>' . $cache_msg . '</ul><br/>';
+		} else {
+			return ($exists && $write);
+		}
+	}
+	/**
+	* write_cache( ) will write the cached file and keep backups.
+	*/
+	function write_cache( $type = 'forum' ) {
+		global $phpbb_seo;
+		if(!$phpbb_seo->cache_config['cache_enable'] || (!@is_array($phpbb_seo->cache_config[$type]) && $type != 'htaccess' ) || !array_key_exists($type, $phpbb_seo->cache_config['files'])) {
+			return FALSE;
+		}
+		$cache_tpl = '<?php' . "\n" . '/**' . "\n" . '* phpBB_SEO Class' . "\n" . '* www.phpBB-SEO.com' . "\n" . '* @package Advanced phpBB3 SEO mod Rewrite' . "\n" . '*/' . "\n" . 'if (!defined(\'IN_PHPBB\')) {' . "\n\t" . 'exit;' . "\n" . '}' . "\n";
+		if ($type == 'forum') { // Add the phpbb_seo_config
+			$update = '$this->cache_config[\'settings\'] = ' . preg_replace('`[\s]+`', ' ', var_export($phpbb_seo->cache_config['settings'], true)) . ';'. "\n";
+			$update .= '$this->cache_config[\'forum\'] = ' . preg_replace('`[\s]+`', ' ', var_export($phpbb_seo->cache_config['forum'], true)) . ';'. "\n";
+			$update = $cache_tpl . $update . '?>';
+		} elseif ($type == 'htaccess') { // .htaccess case
+			$update = $this->seo_htaccess(false);
+		} else { // Allow additional types
+			$update = '$this->cache_config[\'' . $type . '\'] = ' . preg_replace('`[\s]+`', ' ', var_export($phpbb_seo->cache_config[$type], true)) . ';'. "\n";
+			$update = $cache_tpl . $update . '?>';
+		}
+		$file = SEO_CACHE_PATH . $phpbb_seo->cache_config['files'][$type];
+		// Keep a backup of the previous settings
+		@copy($file, $file . '.old');
+		$handle = @fopen($file, 'wb');
+		@fputs($handle, $update);
+		@fclose ($handle);
+		unset($update);
+		@umask(0000);
+		@chmod($file,  0666);
+		// Keep a backup of the current settings
+		@copy($file, $file . '.current');
+		return TRUE;
+	}
+} // End of acp class
+?>
Index: includes/functions_display.php
===================================================================
--- includes/functions_display.php	(revision 159)
+++ includes/functions_display.php	(revision 161)
@@ -23,7 +23,9 @@
 {
 	global $db, $auth, $user, $template;
 	global $phpbb_root_path, $phpEx, $config;
-
+	// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+	global $phpbb_seo;
+	// www.phpBB-SEO.com SEO TOOLKIT END
 	$forum_rows = $subforums = $forum_ids = $forum_ids_moderator = $forum_moderators = $active_forum_ary = array();
 	$parent_id = $visible_forums = 0;
 	$sql_from = '';
@@ -87,7 +89,15 @@
 
 		$sql_array['SELECT'] .= ', fa.user_id';
 	}
-
+	// www.phpBB-SEO.com SEO TOOLKIT BEGIN -> no dupe
+	if ($phpbb_seo->seo_opt['no_dupe']['on']) {
+		$sql_array['SELECT'] .= ', t.topic_id, t.topic_title, t.topic_replies, t.topic_replies_real, t.topic_status, t.topic_type, t.topic_moved_id';
+		$sql_array['LEFT_JOIN'][] = array(
+			'FROM'	=> array(TOPICS_TABLE => 't'),
+			'ON'	=> "t.topic_last_post_id = f.forum_last_post_id" 
+		);
+	}
+	// www.phpBB-SEO.com SEO TOOLKIT END -> no dupe
 	$sql = $db->sql_build_query('SELECT', array(
 		'SELECT'	=> $sql_array['SELECT'],
 		'FROM'		=> $sql_array['FROM'],
@@ -105,7 +115,11 @@
 	while ($row = $db->sql_fetchrow($result))
 	{
 		$forum_id = $row['forum_id'];
-
+		// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+		if ( empty($phpbb_seo->seo_url['forum'][$forum_id]) ) {
+			$phpbb_seo->seo_url['forum'][$forum_id] = $phpbb_seo->set_url($row['forum_name'], $forum_id, $phpbb_seo->seo_static['forum']);
+		}
+		// www.phpBB-SEO.com SEO TOOLKIT END
 		// Mark forums read?
 		if ($mark_read == 'forums' || $mark_read == 'all')
 		{
@@ -154,8 +168,35 @@
 			$forum_tracking_info[$forum_id] = (isset($tracking_topics['f'][$forum_id])) ? (int) (base_convert($tracking_topics['f'][$forum_id], 36, 10) + $config['board_startdate']) : $user->data['user_lastmark'];
 		}
 
-		$row['forum_topics'] = ($auth->acl_get('m_approve', $forum_id)) ? $row['forum_topics_real'] : $row['forum_topics'];
+		// www.phpBB-SEO.com SEO TOOLKIT BEGIN -> no dupe
+		if ($phpbb_seo->seo_opt['no_dupe']['on']) {
+			if ($row['topic_status'] == ITEM_MOVED) {
+				$row['topic_id'] = $row['topic_moved_id'];
+			}
+			if ( empty($phpbb_seo->seo_url['topic'][$row['topic_id']]) ) {
+				if ($row['topic_type'] == POST_GLOBAL) {
+					$phpbb_seo->seo_opt['topic_type'][$row['topic_id']] = POST_GLOBAL;
+				}
+				$phpbb_seo->seo_censored[$row['topic_id']] = censor_text($row['topic_title']);
+				$phpbb_seo->seo_url['topic'][$row['topic_id']] = $phpbb_seo->format_url($phpbb_seo->seo_censored[$row['topic_id']]);
+				$phpbb_seo->seo_opt['topic_forum_name'][$row['topic_id']] = $row['forum_name']; 
 
+			}
+			if ($auth->acl_get('m_approve', $forum_id)) {
+				$row['forum_topics'] = $row['forum_topics_real'];
+				$replies = $row['topic_replies_real'];
+			} else {
+				$row['forum_topics'] = $row['forum_topics'];
+				$replies = $row['topic_replies'];
+			}
+			if (($replies + 1) > $phpbb_seo->seo_opt['topic_per_page']) {
+				$phpbb_seo->seo_opt['topic_last_page'][$row['topic_id']] = floor($replies / $phpbb_seo->seo_opt['topic_per_page']) * $phpbb_seo->seo_opt['topic_per_page'];
+			}
+		} else {
+			$row['forum_topics'] = ($auth->acl_get('m_approve', $forum_id)) ? $row['forum_topics_real'] : $row['forum_topics'];
+		}
+		// www.phpBB-SEO.com SEO TOOLKIT END -> no dupe
+
 		// Display active topics from this forum?
 		if ($show_active && $row['forum_type'] == FORUM_POST && $auth->acl_get('f_read', $forum_id) && ($row['forum_flags'] & FORUM_FLAG_ACTIVE_TOPICS))
 		{
@@ -223,6 +264,12 @@
 				$forum_rows[$parent_id]['forum_last_poster_name'] = $row['forum_last_poster_name'];
 				$forum_rows[$parent_id]['forum_last_poster_colour'] = $row['forum_last_poster_colour'];
 				$forum_rows[$parent_id]['forum_id_last_post'] = $forum_id;
+				// www.phpBB-SEO.com SEO TOOLKIT BEGIN -> no dupe
+				if ($phpbb_seo->seo_opt['no_dupe']['on']) {
+					$forum_rows[$parent_id]['topic_id'] = $row['topic_id'];
+					$forum_rows[$parent_id]['forum_password'] = $row['forum_password'];
+				}
+				// www.phpBB-SEO.com SEO TOOLKIT END -> no dupe
 			}
 		}
 	}
@@ -350,11 +397,23 @@
 		{
 			$last_post_subject = $row['forum_last_post_subject'];
 			$last_post_time = $user->format_date($row['forum_last_post_time']);
-			$last_post_url = append_sid("{$phpbb_root_path}viewtopic.$phpEx", 'f=' . $row['forum_id_last_post'] . '&amp;p=' . $row['forum_last_post_id']) . '#p' . $row['forum_last_post_id'];
+			// www.phpBB-SEO.com SEO TOOLKIT BEGIN -> no dupe
+			if ($phpbb_seo->seo_opt['no_dupe']['on'] && !$row['forum_password'] && $auth->acl_get('f_read', $row['forum_id_last_post'])) {
+				$last_post_url =  append_sid("{$phpbb_root_path}viewtopic.$phpEx", 'f=' . $row['forum_id_last_post'] . '&amp;t=' . $row['topic_id'] . '&amp;start=' . @intval($phpbb_seo->seo_opt['topic_last_page'][$row['topic_id']]) ) . '#p' . $row['forum_last_post_id'];
+				// Limit in chars for the last post link text.
+				$char_limit = 25;
+				// Limit topic text link to $char_limit, without breacking words
+				$topic_text_lilnk = $char_limit > 0 && ( ( $length = utf8_strlen($phpbb_seo->seo_censored[$row['topic_id']]) ) > $char_limit ) ? utf8_strlen($fragment = utf8_substr($phpbb_seo->seo_censored[$row['topic_id']], 0, $char_limit + 1 - 4)) < $length + 1 ? preg_replace('`\s*\S*$`', '', $fragment) . ' ...' : $phpbb_seo->seo_censored[$row['topic_id']] : $phpbb_seo->seo_censored[$row['topic_id']];
+				$last_post_link = '<a href="' . append_sid("{$phpbb_root_path}viewtopic.$phpEx", 'f=' . $row['forum_id_last_post'] . '&amp;t=' . $row['topic_id']) . '" title="' . $phpbb_seo->seo_censored[$row['topic_id']] . ' : ' . $phpbb_seo->seo_opt['topic_forum_name'][$row['topic_id']] . '">' . $topic_text_lilnk . '</a>';
+			} else {	
+				$last_post_url =  append_sid("{$phpbb_root_path}viewtopic.$phpEx", 'f=' . $row['forum_id_last_post'] . '&amp;p=' . $row['forum_last_post_id']) . '#p' . $row['forum_last_post_id'];
+				$last_post_link = '';
+			}
 		}
 		else
 		{
-			$last_post_subject = $last_post_time = $last_post_url = '';
+			$last_post_subject = $last_post_time = $last_post_url = $last_post_link = '';
+			// www.phpBB-SEO.com SEO TOOLKIT END -> no dupe
 		}
 
 		// Output moderator listing ... if applicable
@@ -427,6 +486,9 @@
 
 			'U_VIEWFORUM'		=> $u_viewforum,
 			'U_LAST_POSTER'		=> get_username_string('profile', $row['forum_last_poster_id'], $row['forum_last_poster_name'], $row['forum_last_poster_colour']),
+			// www.phpBB-SEO.com SEO TOOLKIT BEGIN -> no dupe
+			'LAST_POST_LINK'	=> $last_post_link,
+			// www.phpBB-SEO.com SEO TOOLKIT END -> no dupe
 			'U_LAST_POST'		=> $last_post_url)
 		);
 
@@ -490,7 +552,9 @@
 {
 	global $db, $user, $template, $auth;
 	global $phpEx, $phpbb_root_path;
-
+	// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+	global $phpbb_seo;
+	// www.phpBB-SEO.com SEO TOOLKIT END
 	if (!$auth->acl_get('f_list', $forum_data['forum_id']))
 	{
 		return;
@@ -505,7 +569,11 @@
 		foreach ($forum_parents as $parent_forum_id => $parent_data)
 		{
 			list($parent_name, $parent_type) = array_values($parent_data);
-
+			// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+			if ( empty($phpbb_seo->seo_url['forum'][$parent_forum_id]) ) {
+				$phpbb_seo->seo_url['forum'][$parent_forum_id] = $phpbb_seo->set_url($parent_name, $parent_forum_id, $phpbb_seo->seo_static['forum']);
+			}
+			// www.phpBB-SEO.com SEO TOOLKIT END
 			// Skip this parent if the user does not have the permission to view it
 			if (!$auth->acl_get('f_list', $parent_forum_id))
 			{
@@ -589,7 +657,9 @@
 function topic_generate_pagination($replies, $url)
 {
 	global $config, $user;
-
+	// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+	global $phpbb_seo, $phpEx;
+	// www.phpBB-SEO.com SEO TOOLKIT END
 	// Make sure $per_page is a valid value
 	$per_page = ($config['posts_per_page'] <= 0) ? 1 : $config['posts_per_page'];
 
@@ -616,6 +686,18 @@
 			}
 			$times++;
 		}
+		// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+		if (!empty($phpbb_seo->seo_opt['url_rewrite'])) {
+			static $pagin_find = array();
+			static $pagin_replace = array();
+			if (empty($pagin_find)) {
+				$pagin_find = array( '`(\.(?!' . $phpEx . ')[a-z0-9]+)([\w\#$%&~\-;:=,?@+]*)&amp;start=([0-9]+)`i', '`/([\w\#$%&~\-;:=,?@+]*)&amp;start=([0-9]+)`i' );
+				$pagin_replace = array( $phpbb_seo->seo_delim['start'] . '\\3\\1\\2', '/' . $phpbb_seo->seo_static['pagination'] . '\\2' . $phpbb_seo->seo_ext['pagination'] .'\\1' );
+			}
+			$pagination = str_replace( '&amp;start=0', '', $pagination );
+			$pagination = preg_replace( $pagin_find, $pagin_replace, $pagination );
+		}
+		// www.phpBB-SEO.com SEO TOOLKIT END
 	}
 	else
 	{
@@ -631,7 +713,9 @@
 function get_moderators(&$forum_moderators, $forum_id = false)
 {
 	global $config, $template, $db, $phpbb_root_path, $phpEx;
-
+	// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+	global $phpbb_seo;
+	// www.phpBB-SEO.com SEO TOOLKIT END
 	// Have we disabled the display of moderators? If so, then return
 	// from whence we came ...
 	if (!$config['load_moderators'])
@@ -689,6 +773,11 @@
 		}
 		else
 		{
+			// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+			if ( $phpbb_seo->seo_opt['profile_inj'] && empty($phpbb_seo->seo_url['group'][$row['group_id']]) ) {
+				$phpbb_seo->seo_url['group'][$row['group_id']] = $phpbb_seo->format_url($row['group_name'], $phpbb_seo->seo_static['group']);
+			}
+			// www.phpBB-SEO.com SEO TOOLKIT END
 			$forum_moderators[$row['forum_id']][] = '<a' . (($row['group_colour']) ? ' style="color:#' . $row['group_colour'] . ';"' : '') . ' href="' . append_sid("{$phpbb_root_path}memberlist.$phpEx", 'mode=group&amp;g=' . $row['group_id']) . '">' . (($row['group_type'] == GROUP_SPECIAL) ? $user->lang['G_' . $row['group_name']] : $row['group_name']) . '</a>';
 		}
 	}
@@ -875,6 +964,9 @@
 {
 	global $auth, $template, $db, $user;
 	global $phpbb_root_path, $phpEx;
+	// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+	global $phpbb_seo;
+	// www.phpBB-SEO.com SEO TOOLKIT END
 
 	// Do not display user activity for users having more than 5000 posts...
 	if ($userdata['user_posts'] > 5000)
@@ -934,11 +1026,14 @@
 
 	if (!empty($active_t_row))
 	{
-		$sql = 'SELECT topic_title
-			FROM ' . TOPICS_TABLE . '
-			WHERE topic_id = ' . $active_t_row['topic_id'];
+		// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+		$sql = 'SELECT t.topic_title, t.topic_type, f.forum_id, f.forum_name
+			FROM ' . TOPICS_TABLE . ' AS t, ' . FORUMS_TABLE . ' AS f
+			WHERE t.topic_id = ' . $active_t_row['topic_id'] . '
+			AND f.forum_id = t.forum_id';
 		$result = $db->sql_query($sql);
-		$active_t_row['topic_title'] = (string) $db->sql_fetchfield('topic_title');
+		$seo_active_t_row = $db->sql_fetchrow($result);
+		if ($seo_active_t_row) {
+			$active_t_row = array_merge($active_t_row, $seo_active_t_row);
+		}
+		// www.phpBB-SEO.com SEO TOOLKIT END
 		$db->sql_freeresult($result);
 	}
 
@@ -952,6 +1047,11 @@
 		$active_f_id = $active_f_row['forum_id'];
 		$active_f_count = $active_f_row['num_posts'];
 		$active_f_pct = ($userdata['user_posts']) ? ($active_f_count / $userdata['user_posts']) * 100 : 0;
+		// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+		if ( empty($phpbb_seo->seo_url['forum'][$active_f_id]) ) {
+			$phpbb_seo->seo_url['forum'][$active_f_id] = $phpbb_seo->set_url($active_f_name, $active_f_id, $phpbb_seo->seo_static['forum']);
+		}
+		// www.phpBB-SEO.com SEO TOOLKIT END
 	}
 
 	$active_t_name = $active_t_id = $active_t_count = $active_t_pct = '';
@@ -961,6 +1061,18 @@
 		$active_t_id = $active_t_row['topic_id'];
 		$active_t_count = $active_t_row['num_posts'];
 		$active_t_pct = ($userdata['user_posts']) ? ($active_t_count / $userdata['user_posts']) * 100 : 0;
+		// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+		if (!empty($seo_active_t_row)) {
+			if ( empty($phpbb_seo->seo_url['topic'][$active_t_id]) ) {
+				if ($active_t_row['topic_type'] == POST_GLOBAL) {
+					$phpbb_seo->seo_opt['topic_type'][$active_t_id] = POST_GLOBAL;
+				}
+				$phpbb_seo->seo_url['topic'][$active_t_id] = $phpbb_seo->format_url(censor_text($active_t_name));
+			}
+			$active_t_forum_id = (int) $active_t_row['forum_id'];
+			if ( empty($phpbb_seo->seo_url['forum'][$active_t_forum_id]) ) {
+				$phpbb_seo->seo_url['forum'][$active_t_forum_id] = $phpbb_seo->set_url($active_t_row['forum_name'], $active_t_forum_id, $phpbb_seo->seo_static['forum']);
+			}
+		}
+		// www.phpBB-SEO.com SEO TOOLKIT END
 	}
 
 	$l_active_pct = ($userdata['user_id'] != ANONYMOUS && $userdata['user_id'] == $user->data['user_id']) ? $user->lang['POST_PCT_ACTIVE_OWN'] : $user->lang['POST_PCT_ACTIVE'];
@@ -973,7 +1085,9 @@
 		'ACTIVE_TOPIC_POSTS'	=> ($active_t_count == 1) ? sprintf($user->lang['USER_POST'], 1) : sprintf($user->lang['USER_POSTS'], $active_t_count),
 		'ACTIVE_TOPIC_PCT'		=> sprintf($l_active_pct, $active_t_pct),
 		'U_ACTIVE_FORUM'		=> append_sid("{$phpbb_root_path}viewforum.$phpEx", 'f=' . $active_f_id),
-		'U_ACTIVE_TOPIC'		=> append_sid("{$phpbb_root_path}viewtopic.$phpEx", 't=' . $active_t_id),
+		// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+		'U_ACTIVE_TOPIC'		=> append_sid("{$phpbb_root_path}viewtopic.$phpEx", (!empty($active_t_forum_id) ? "f=$active_t_forum_id&amp;" : '' ) . 't=' . $active_t_id),
+		// www.phpBB-SEO.com SEO TOOLKIT END
 		'S_SHOW_ACTIVITY'		=> true)
 	);
 }
@@ -1172,4 +1286,4 @@
 	return '<img src="' . $avatar_img . '" width="' . $avatar_width . '" height="' . $avatar_height . '" alt="' . ((!empty($user->lang[$alt])) ? $user->lang[$alt] : $alt) . '" />';
 }
 
-?>
\ No newline at end of file
+?>
Index: includes/functions.php
===================================================================
--- includes/functions.php	(revision 159)
+++ includes/functions.php	(revision 161)
@@ -1549,7 +1549,9 @@
 function generate_pagination($base_url, $num_items, $per_page, $start_item, $add_prevnext_text = false, $tpl_prefix = '')
 {
 	global $template, $user;
-
+	// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+	global $phpbb_seo, $phpEx;
+	// www.phpBB-SEO.com SEO TOOLKIT END
 	// Make sure $per_page is a valid value
 	$per_page = ($per_page <= 0) ? 1 : $per_page;
 
@@ -1613,16 +1615,34 @@
 		}
 	}
 
+	// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+	$prev =  ($on_page == 1) ? '' : $base_url . "{$url_delim}start=" . (($on_page - 2) * $per_page);
+	$next = ($on_page == $total_pages) ? '' : $base_url . "{$url_delim}start=" . ($on_page * $per_page);
+	if (!empty($phpbb_seo->seo_opt['url_rewrite'])) {
+		static $pagin_find = array();
+		static $pagin_replace = array();
+		static $prev_find = array();
+		if (empty($pagin_replace)) {
+			$pagin_find = array('`(\.(?!' . $phpEx . ')[a-z0-9]+)([\w\#$%&~\-;:=,?@+]*)(&amp;|\?)start=([0-9]+)`i', '`/([\w\#$%&~\-;:=,?@+]*)(&amp;|\?)start=([0-9]+)`i' );
+			$pagin_replace = array( $phpbb_seo->seo_delim['start'] . '\\4\\1\\2', '/' . $phpbb_seo->seo_static['pagination'] . '\\3' . $phpbb_seo->seo_ext['pagination'] . '\\1' );
+			$prev_find = array($phpbb_seo->seo_delim['start'] . '0', $phpbb_seo->seo_static['pagination'] . '0' . $phpbb_seo->seo_ext['pagination']);
+		}
+		$page_string = str_replace($url_delim . 'start=0', '', $page_string);
+		$page_string = preg_replace($pagin_find, $pagin_replace, $page_string);
+		$prev = preg_replace($pagin_find, $pagin_replace, $prev);
+		$prev = str_replace($prev_find, '', $prev);
+		$next = preg_replace( $pagin_find, $pagin_replace, $next);
+	}
 	$template->assign_vars(array(
-		$tpl_prefix . 'BASE_URL'		=> $base_url,
+		$tpl_prefix . 'BASE_URL'	=> $base_url,
 		'A_' . $tpl_prefix . 'BASE_URL'	=> addslashes($base_url),
-		$tpl_prefix . 'PER_PAGE'		=> $per_page,
+		$tpl_prefix . 'PER_PAGE'	=> $per_page,
+		$tpl_prefix . 'PREVIOUS_PAGE'	=> $prev,
+		$tpl_prefix . 'NEXT_PAGE'	=> $next,
+		$tpl_prefix . 'TOTAL_PAGES'	=> $total_pages)
+	);
+	// www.phpBB-SEO.com SEO TOOLKIT END
 
-		$tpl_prefix . 'PREVIOUS_PAGE'	=> ($on_page == 1) ? '' : $base_url . "{$url_delim}start=" . (($on_page - 2) * $per_page),
-		$tpl_prefix . 'NEXT_PAGE'		=> ($on_page == $total_pages) ? '' : $base_url . "{$url_delim}start=" . ($on_page * $per_page),
-		$tpl_prefix . 'TOTAL_PAGES'		=> $total_pages,
-	));
-
 	return $page_string;
 }
 
@@ -1668,7 +1688,9 @@
 function append_sid($url, $params = false, $is_amp = true, $session_id = false)
 {
 	global $_SID, $_EXTRA_URL, $phpbb_hook;
-
+	// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+	global $phpbb_seo;
+	// www.phpBB-SEO.com SEO TOOLKIT END
 	// Developers using the hook function need to globalise the $_SID and $_EXTRA_URL on their own and also handle it appropiatly.
 	// They could mimick most of what is within this function
 	if (!empty($phpbb_hook) && $phpbb_hook->call_hook(__FUNCTION__, $url, $params, $is_amp, $session_id))
@@ -1709,11 +1731,17 @@
 		// Append session id
 		if (!$session_id)
 		{
-			return $url . (($append_url) ? $url_delim . $append_url : '') . $anchor;
+			// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+			$url .= (($append_url) ? $url_delim . $append_url : '') . $anchor;
+			return $phpbb_seo->url_rewrite($url, $is_amp);
+			// www.phpBB-SEO.com SEO TOOLKIT END
 		}
 		else
 		{
-			return $url . (($append_url) ? $url_delim . $append_url . $amp_delim : $url_delim) . 'sid=' . $session_id . $anchor;
+			// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+			$url .= (($append_url) ? $url_delim . $append_url . $amp_delim : $url_delim) . 'sid=' . $session_id . $anchor;
+			return $phpbb_seo->url_rewrite($url, $is_amp);
+			// www.phpBB-SEO.com SEO TOOLKIT END
 		}
 	}
 
@@ -1743,7 +1771,10 @@
 
 	// Append session id and parameters (even if they are empty)
 	// If parameters are empty, the developer can still append his/her parameters without caring about the delimiter
-	return $url . (($append_url) ? $url_delim . $append_url . $amp_delim : $url_delim) . $params . ((!$session_id) ? '' : $amp_delim . 'sid=' . $session_id) . $anchor;
+	// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+	$url .= (($append_url) ? $url_delim . $append_url . $amp_delim : $url_delim) . $params . ((!$session_id) ? '' : $amp_delim . 'sid=' . $session_id) . $anchor;
+	return $phpbb_seo->url_rewrite($url, $is_amp);
+	// www.phpBB-SEO.com SEO TOOLKIT END
 }
 
 /**
@@ -2034,7 +2065,9 @@
 		$redirect .= ($query) ? '?' . $query : '';
 	}
 
-	return $phpbb_root_path . str_replace('&', '&amp;', $redirect);
+	// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+	return strpos($redirect, 'http://') !== false ? trim($redirect, '?') : reapply_sid(str_replace('&', '&amp;', $redirect));
+	// www.phpBB-SEO.com SEO TOOLKIT END
 }
 
 /**
@@ -3329,7 +3362,19 @@
 	{
 		return;
 	}
-
+	// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+	global $phpbb_seo;
+	$template->assign_vars( array( 'PHPBB_FULL_URL' => $phpbb_seo->seo_path['phpbb_url'], 
+			'SEO_BASE_HREF' => $phpbb_seo->seo_opt['seo_base_href'], 
+			'SEO_START_DELIM' => $phpbb_seo->seo_delim['start'], 
+			'SEO_SATIC_PAGE' => $phpbb_seo->seo_static['pagination'], 
+			'SEO_EXT_PAGE' => $phpbb_seo->seo_ext['pagination'])
+	);
+	// www.phpBB-SEO.com SEO TOOLKIT END
+	// www.phpBB-SEO.com SEO TOOLKIT BEGIN  - META
+	global $seo_meta;
+	$seo_meta->seo_meta_tags();
+	// www.phpBB-SEO.com SEO TOOLKIT END  - META
 	define('HEADER_INC', true);
 
 	// gzip_compression
@@ -3441,6 +3486,9 @@
 		'SITENAME'						=> $config['sitename'],
 		'SITE_DESCRIPTION'				=> $config['site_desc'],
 		'PAGE_TITLE'					=> $page_title,
+		// www.phpBB-SEO.com - META
+		'META_TAG' => $seo_meta->build_meta($page_title),
+ 		// www.phpBB-SEO.com - META
 		'SCRIPT_NAME'					=> str_replace('.' . $phpEx, '', $user->page['page_name']),
 		'LAST_VISIT_DATE'				=> sprintf($user->lang['YOU_LAST_VISIT'], $s_last_visit),
 		'LAST_VISIT_YOU'				=> $s_last_visit,
@@ -3538,7 +3586,12 @@
 function page_footer($run_cron = true)
 {
 	global $db, $config, $template, $user, $auth, $cache, $starttime, $phpbb_root_path, $phpEx;
-
+	// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+	global $phpbb_seo;
+	if (is_object($phpbb_seo)) {
+		$phpbb_seo->seo_end();
+	}
+	// www.phpBB-SEO.com SEO TOOLKIT END
 	// Output page creation time
 	if (defined('DEBUG'))
 	{
@@ -3566,7 +3619,10 @@
 				}
 			}
 
-			$debug_output .= ' | <a href="' . build_url() . '&amp;explain=1">Explain</a>';
+			// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+			$url_prefix = build_url();
+			$debug_output .= ' | <a href="' . $url_prefix . ((strpos($url_prefix, '?') === false) ? '?' : '&amp;') . 'explain=1">Explain</a>';
+			// www.phpBB-SEO.com SEO TOOLKIT END
 		}
 	}
 
@@ -3686,5 +3742,96 @@
 
 	return;
 }
-
-?>
\ No newline at end of file
+// www.phpBB-SEO.com SEO TOOLKIT BEGIN  - META
+class seo_meta {
+	var $meta = array();
+	/**
+	* Returns meta tag code
+	*/
+	function build_meta( $page_title = '') {
+		$this->meta['meta_desc'] = ( !empty($this->meta['meta_desc']) ) ? $this->meta['meta_desc'] : $this->meta_filter_txt($page_title . ' : ' . $this->meta['meta_desc_def']);
+		$this->meta['keywords'] = ( !empty($this->meta['keywords']) ) ? $this->meta['keywords'] : $this->make_keywords( $page_title . ' ' . $this->meta['meta_keywords_def']);
+		$this->meta['meta_title'] = ( !empty($this->meta['meta_title']) ) ? meta_filter_txt($this->meta['meta_title']) : $page_title;
+		return sprintf( $this->meta['meta_tpl'], $this->meta['meta_title'], $this->meta['meta_lang'], $this->meta['meta_desc'], $this->meta['keywords'], $this->meta['meta_cat'], $this->meta['meta_robots'], $this->meta['meta_distrib'], $this->meta['meta_restype'], $this->meta['meta_copy'] );
+	}
+	/**
+	* Returns a word list separated by comas
+	* you can as well change the minimum word size here : if ( utf8_strlen($word) >2 ) {
+	* Possible Options :
+	* - $limit = 0 means no limit.
+	*   By default, ' . and , are deleted.
+	*/
+	function make_keywords($text, $limit = 15) {
+		$keywords = '';
+		$num = 0;
+		$text = preg_replace(array('`&(amp;)?[a-z0-9]+;`i', "`[[:punct:]]+`", "`[\s]+`"), ' ', strip_tags($text) );
+		$text = explode(' ', $text);
+		// We take the most used words first
+		$text = array_count_values($text);
+		arsort($text);
+		foreach ($text as $word => $count) {
+			if ( utf8_strlen($word) > 2 ) {
+				$keywords .= ($keywords == '') ? $word : ', ' . $word;
+				$num++;
+				if ( $limit > 0 && $num >= $limit ) {
+					break;
+				}
+			}	
+		}
+		return $keywords;
+	}
+	/**
+	* Filter php/html tags and white spaces and returns htmlspecialchared string with limit in words
+	*/
+	function meta_filter_txt($text, $bbcode = true) {
+		if ($bbcode) {
+			static $RegEx = array();
+			static $bbcode_strip = 'img|url|flash|code';
+			if (empty($RegEx)) {
+				$RegEx = array('`<[^>]*>(.*<[^>]*>)?`Usi', // HTML code
+					'`\[(' . $bbcode_strip . ')[^\[\]]+\].*\[/(' . $bbcode_strip . ')[^\[\]]+\]`Usi', // bbcode to strip
+					'`\[/?[^\[\]]+\]`mi', // Strip all bbcode tags
+					'`[\s]+`' // Multiple spaces
+				);
+			}
+			return $this->word_limit(htmlspecialchars(preg_replace($RegEx, ' ', $text), ENT_COMPAT, 'UTF-8'));
+		}
+		return $this->word_limit(htmlspecialchars(preg_replace('`<[^>]*>(.*<[^>]*>)?`mi', '`[\s]+`', ' ', $text), ENT_COMPAT, 'UTF-8'));
+	}
+	/**
+	* Cut the text according to the number of words.
+	* Borrowed from www.php.net http://www.php.net/preg_replace
+	*/
+	function word_limit($string, $length = 25, $ellipsis = ' ...') {
+		return count($words = preg_split('/\s+/', ltrim($string), $length + 1)) > $length ? rtrim(utf8_substr($string, 0, utf8_strlen($string) - utf8_strlen(end($words)))) . $ellipsis : $string;
+	}
+	/**
+	* Initialize meta tags
+	*/
+	function seo_meta_tags() {
+		global $config;
+		$this->meta['meta_tpl'] =  '<meta name="title" content="%s" />' . "\n" . '<meta name="description" lang="%s" content="%s" />' . "\n" . '<meta name="keywords"    content="%s" />' . "\n" . '<meta name="category"    content="%s" />' . "\n" . '<meta name="robots"      content="%s" />'. "\n" . '<meta name="distribution" content="%s" />' . "\n" . '<meta name="resource-type" content="%s" />' . "\n" . '<meta name="copyright" content="%s" />';
+		// Here you can hard code a static default title, description and keywords
+		// As is, the mod will return information based on the phpbb config
+		$this->meta['meta_title_def'] = $config['sitename'];
+		$this->meta['meta_desc_def'] = $config['site_desc'];
+		$this->meta['meta_keywords_def'] =  $config['site_desc'];
+		$this->meta['meta_lang'] =  $config['default_lang'];
+		$this->meta['meta_cat'] =  'general';
+		$this->meta['meta_robots'] =  'index,follow';
+		$this->meta['meta_distrib'] =  'global';
+		$this->meta['meta_restype'] =  'document';
+		$this->meta['meta_copy'] =  $config['sitename'];
+		return;
+	}
+}
+$seo_meta = new seo_meta();
+// www.phpBB-SEO.com SEO TOOLKIT END - META
+function nice_print($input) {
+	if (is_array($input) || is_object($input) ) {
+		echo '<pre>' . var_export($input, true) . '</pre>';
+	} else {
+		echo '<pre>' . $input . '</pre>';
+	}
+}
+?>
Index: includes/constants.php
===================================================================
--- includes/constants.php	(revision 159)
+++ includes/constants.php	(revision 161)
@@ -25,7 +25,7 @@
 */
 
 // QA-related
-// define('PHPBB_QA', 1);
+// define('PHPBB_SEO_QA', 1);
 
 // User related
 define('ANONYMOUS', 1);
@@ -242,4 +242,4 @@
 // Additional tables
 
 
-?>
\ No newline at end of file
+?>
Index: viewforum.php
===================================================================
--- viewforum.php	(revision 159)
+++ viewforum.php	(revision 161)
@@ -16,7 +16,16 @@
 $phpEx = substr(strrchr(__FILE__, '.'), 1);
 include($phpbb_root_path . 'common.' . $phpEx);
 include($phpbb_root_path . 'includes/functions_display.' . $phpEx);
-
+// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+if (empty($_REQUEST['f'])) {
+	$phpbb_seo->get_forum_id($session_forum_id);
+	if ($session_forum_id == 0) {
+		header('HTTP/1.1 404 Not Found');
+	} else {
+		$_REQUEST['f'] = (int) $session_forum_id;
+	}
+}
+// www.phpBB-SEO.com SEO TOOLKIT END
 // Start session
 $user->session_begin();
 $auth->acl($user->data);
@@ -65,8 +74,12 @@
 {
 	trigger_error('NO_FORUM');
 }
+// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+if ( empty($phpbb_seo->seo_url['forum'][$forum_data['forum_id']]) ) {
+	$phpbb_seo->seo_url['forum'][$forum_data['forum_id']] = $phpbb_seo->set_url($forum_data['forum_name'], $forum_data['forum_id'], $phpbb_seo->seo_static['forum']);
+}
+// www.phpBB-SEO.com SEO TOOLKIT END
 
-
 // Configure style, language, etc.
 $user->setup('viewforum', $forum_data['forum_style']);
 
@@ -109,7 +122,28 @@
 
 	redirect($forum_data['forum_link']);
 }
-
+// www.phpBB-SEO.com SEO TOOLKIT BEGIN -> Zero dupe
+if ($forum_data['forum_topics_per_page']) {
+	$config['topics_per_page'] = $forum_data['forum_topics_per_page'];
+}
+$phpbb_seo->seo_opt['zero_dupe']['start'] = $phpbb_seo->seo_chk_start( $start, $config['topics_per_page'] );
+$seo_watch = request_var('watch', '');
+$seo_unwatch = request_var('unwatch', '');
+$keep_watch = (boolean) ($seo_watch == 'forum' && $user->data['is_registered']);
+$keep_unwatch = (boolean) ($seo_unwatch == 'forum' && $user->data['is_registered']);
+$keep_mark = in_array($mark_read, array('topics', 'forums', 'all')) ? (boolean) ($user->data['is_registered'] || $config['load_anon_lastread']) : false;
+$phpbb_seo->seo_opt['zero_dupe']['redir_def'] = array(
+	'f' => array('val' => $forum_id, 'keep' => true, 'force' => true),
+	'st' => array('val' => $sort_days, 'keep' => true),
+	'sk' => array('val' => $sort_key, 'keep' => true),
+	'sd' => array('val' => $sort_dir, 'keep' => true),
+	'mark' => array('val' => $mark_read, 'keep' => $keep_mark),
+	'watch' => array('val' => $seo_watch, 'keep' => $keep_watch),
+	'unwatch' => array('val' => $seo_unwatch, 'keep' => $keep_unwatch),
+	'start' => array('val' => $phpbb_seo->seo_opt['zero_dupe']['start'], 'keep' => true),
+);
+$phpbb_seo->seo_chk_dupe();
+// www.phpBB-SEO.com SEO TOOLKIT END -> Zero dupe
 // Build navigation links
 generate_forum_nav($forum_data);
 
@@ -133,7 +167,14 @@
 }
 
 // Dump out the page header and load viewforum template
-page_header($user->lang['VIEW_FORUM'] . ' - ' . $forum_data['forum_name']);
+// www.phpBB-SEO.com SEO TOOLKIT BEGIN - TITLE
+$extra_title = ($start > 0) ? ' - ' . $user->lang['Page'] . ( floor( $start / $config['topics_per_page'] ) + 1 ) : '';
+// www.phpBB-SEO.com SEO TOOLKIT BEGIN - META
+$seo_meta->meta['meta_desc'] = $seo_meta->meta_filter_txt($forum_data['forum_name'] . ' : ' . (!empty($forum_data['forum_desc']) ? $forum_data['forum_desc'] : $config['site_desc']));
+$seo_meta->meta['keywords'] = $seo_meta->make_keywords($seo_meta->meta['meta_desc']);
+// www.phpBB-SEO.com SEO TOOLKIT END - META
+page_header($forum_data['forum_name'] . $extra_title);
+// www.phpBB-SEO.com SEO TOOLKIT END - TITLE
 
 $template->set_filenames(array(
 	'body' => 'viewforum_body.html')
@@ -175,11 +216,14 @@
 	trigger_error($user->lang['TOPICS_MARKED'] . '<br /><br />' . sprintf($user->lang['RETURN_FORUM'], '<a href="' . $redirect_url . '">', '</a>'));
 }
 
+// www.phpBB-SEO.com SEO TOOLKIT BEGIN -> Zero dupe
+// Moved this a little above for the zero dupe
 // Is a forum specific topic count required?
-if ($forum_data['forum_topics_per_page'])
-{
-	$config['topics_per_page'] = $forum_data['forum_topics_per_page'];
-}
+//if ($forum_data['forum_topics_per_page'])
+//{
+//	$config['topics_per_page'] = $forum_data['forum_topics_per_page'];
+//}
+// www.phpBB-SEO.com SEO TOOLKIT END -> Zero dupe
 
 // Do the forum Prune thang - cron type job ...
 if ($forum_data['prune_next'] < time() && $forum_data['enable_prune'])
@@ -249,7 +293,12 @@
 {
 	$start = ($start < 0) ? 0 : floor(($topics_count - 1) / $config['topics_per_page']) * $config['topics_per_page'];
 }
-
+// www.phpBB-SEO.com SEO TOOLKIT BEGIN -> Zero dupe
+if ($start != $phpbb_seo->seo_opt['zero_dupe']['start']) {
+	$phpbb_seo->seo_opt['zero_dupe']['redir_def']['start'] = array('val' => $start, 'keep' => true);
+	$phpbb_seo->seo_chk_dupe();
+}
+// www.phpBB-SEO.com SEO TOOLKIT END -> Zero dupe
 // Basic pagewide vars
 $post_alt = ($forum_data['forum_status'] == ITEM_LOCKED) ? $user->lang['FORUM_LOCKED'] : $user->lang['POST_NEW_TOPIC'];
 
@@ -364,11 +413,20 @@
 		if ($row['topic_type'] == POST_GLOBAL)
 		{
 			$global_announce_list[$row['topic_id']] = true;
+			// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+			$phpbb_seo->seo_opt['topic_type'][$row['topic_id']] = POST_GLOBAL;
+			// www.phpBB-SEO.com SEO TOOLKIT END
 		}
 		else
 		{
 			$topics_count--;
 		}
+		// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+		if ( empty($phpbb_seo->seo_url['topic'][$row['topic_id']]) ) {
+			$phpbb_seo->seo_censored[$row['topic_id']] = censor_text($row['topic_title']);
+			$phpbb_seo->seo_url['topic'][$row['topic_id']] = $phpbb_seo->format_url($phpbb_seo->seo_censored[$row['topic_id']]);
+		}
+		// www.phpBB-SEO.com SEO TOOLKIT END
 	}
 	$db->sql_freeresult($result);
 }
@@ -454,6 +512,12 @@
 		}
 
 		$rowset[$row['topic_id']] = $row;
+		// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+		if ( empty($phpbb_seo->seo_url['topic'][$row['topic_id']]) ) {
+			$phpbb_seo->seo_censored[$row['topic_id']] = censor_text($row['topic_title']);
+			$phpbb_seo->seo_url['topic'][$row['topic_id']] = $phpbb_seo->format_url($phpbb_seo->seo_censored[$row['topic_id']]);
+		}
+		// www.phpBB-SEO.com SEO TOOLKIT END
 	}
 	$db->sql_freeresult($result);
 }
@@ -500,6 +564,12 @@
 		));
 
 		$rowset[$orig_topic_id] = $row;
+		// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+		if ( empty($phpbb_seo->seo_url['topic'][$row['topic_moved_id']]) ) {
+			$phpbb_seo->seo_censored[$row['topic_moved_id']] = censor_text($row['topic_title']);
+			$phpbb_seo->seo_url['topic'][$row['topic_moved_id']] = $phpbb_seo->format_url($phpbb_seo->seo_censored[$row['topic_moved_id']]);
+		}
+		// www.phpBB-SEO.com SEO TOOLKIT END
 	}
 	$db->sql_freeresult($result);
 }
@@ -605,7 +675,13 @@
 		$topic_unapproved = (!$row['topic_approved'] && $auth->acl_get('m_approve', $forum_id)) ? true : false;
 		$posts_unapproved = ($row['topic_approved'] && $row['topic_replies'] < $row['topic_replies_real'] && $auth->acl_get('m_approve', $forum_id)) ? true : false;
 		$u_mcp_queue = ($topic_unapproved || $posts_unapproved) ? append_sid("{$phpbb_root_path}mcp.$phpEx", 'i=queue&amp;mode=' . (($topic_unapproved) ? 'approve_details' : 'unapproved_posts') . "&amp;t=$topic_id", true, $user->session_id) : '';
-
+		// www.phpBB-SEO.com SEO TOOLKIT BEGIN -> no dupe
+		if ($phpbb_seo->seo_opt['no_dupe']['on']) {
+			if (($replies + 1) > $phpbb_seo->seo_opt['topic_per_page']) {
+				$phpbb_seo->seo_opt['topic_last_page'][$topic_id] = floor($replies / $phpbb_seo->seo_opt['topic_per_page']) * $phpbb_seo->seo_opt['topic_per_page'];
+			}
+		}
+		// www.phpBB-SEO.com SEO TOOLKIT END -> no dupe
 		// Send vars to template
 		$template->assign_block_vars('topicrow', array(
 			'FORUM_ID'					=> $forum_id,
@@ -624,7 +700,9 @@
 			'PAGINATION'		=> topic_generate_pagination($replies, $view_topic_url),
 			'REPLIES'			=> $replies,
 			'VIEWS'				=> $row['topic_views'],
-			'TOPIC_TITLE'		=> censor_text($row['topic_title']),
+			// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+			'TOPIC_TITLE'		=> (isset($phpbb_seo->seo_censored[$topic_id]) ) ? $phpbb_seo->seo_censored[$topic_id] : censor_text($row['topic_title']),
+			// www.phpBB-SEO.com SEO TOOLKIT END
 			'TOPIC_TYPE'		=> $topic_type,
 
 			'TOPIC_FOLDER_IMG'		=> $user->img($folder_img, $folder_alt),
@@ -649,8 +727,10 @@
 			'S_TOPIC_LOCKED'		=> ($row['topic_status'] == ITEM_LOCKED) ? true : false,
 			'S_TOPIC_MOVED'			=> ($row['topic_status'] == ITEM_MOVED) ? true : false,
 
-			'U_NEWEST_POST'			=> $view_topic_url . '&amp;view=unread#unread',
-			'U_LAST_POST'			=> $view_topic_url . '&amp;p=' . $row['topic_last_post_id'] . '#p' . $row['topic_last_post_id'],
+			// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+			'U_NEWEST_POST'			=> append_sid("{$phpbb_root_path}viewtopic.$phpEx", 'f=' . $forum_id . '&amp;t=' . $topic_id . '&amp;view=unread') . '#unread',
+			'U_LAST_POST'			=> $phpbb_seo->seo_opt['no_dupe']['on'] ? append_sid("{$phpbb_root_path}viewtopic.$phpEx", 'f=' . $forum_id . '&amp;t=' . $topic_id . '&amp;start=' . @intval($phpbb_seo->seo_opt['topic_last_page'][$topic_id])) . '#p' . $row['topic_last_post_id'] : append_sid("{$phpbb_root_path}viewtopic.$phpEx", 'f=' . $forum_id . '&amp;t=' . $topic_id . '&amp;p=' . $row['topic_last_post_id']) . '#p' . $row['topic_last_post_id'],
+			// www.phpBB-SEO.com SEO TOOLKIT END
 			'U_LAST_POST_AUTHOR'	=> get_username_string('profile', $row['topic_last_poster_id'], $row['topic_last_poster_name'], $row['topic_last_poster_colour']),
 			'U_TOPIC_AUTHOR'		=> get_username_string('profile', $row['topic_poster'], $row['topic_first_poster_name'], $row['topic_first_poster_colour']),
 			'U_VIEW_TOPIC'			=> $view_topic_url,
@@ -682,4 +762,4 @@
 
 page_footer();
 
-?>
\ No newline at end of file
+?>
Index: common.php
===================================================================
--- common.php	(revision 159)
+++ common.php	(revision 161)
@@ -214,7 +214,12 @@
 
 // Grab global variables, re-cache if necessary
 $config = $cache->obtain_config();
-
+// www.phpBB-SEO.com SEO TOOLKIT BEGIN
+if (empty($phpbb_seo) ) {
+	require_once($phpbb_root_path . 'phpbb_seo/phpbb_seo_class.'.$phpEx);
+	$phpbb_seo = new phpbb_seo();
+}
+// www.phpBB-SEO.com SEO TOOLKIT END
 // Add own hook handler
 require($phpbb_root_path . 'includes/hooks/index.' . $phpEx);
 $phpbb_hook = new phpbb_hook(array('exit_handler', 'phpbb_user_session_handler', 'append_sid', array('template', 'display')));
